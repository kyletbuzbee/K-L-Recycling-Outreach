
================================================================================
FILE_BEGIN: CRM_Styles.html
METADATA: Size=5628 bytes | Last_Modified=2026-02-05 14:37:16.025731
================================================================================
<style>
    :root {
        --bg: #f3f4f6;
        --sidebar: #0f172a;
        --card: #ffffff;
        --accent: #10b981;
        /* K&L Green */
        --text-main: #1f2937;
        --text-dim: #6b7280;
    }

    body {
        margin: 0;
        font-family: 'Segoe UI', system-ui, sans-serif;
        background: var(--bg);
        color: var(--text-main);
    }

    .suite-wrapper {
        display: flex;
        height: 100vh;
    }

    /* Navigation */
    .suite-nav {
        width: 260px;
        background: var(--sidebar);
        color: white;
        display: flex;
        flex-direction: column;
    }

    .brand {
        padding: 30px;
        font-weight: 800;
        font-size: 1.4rem;
        letter-spacing: 1px;
        color: var(--accent);
    }

    .nav-links {
        flex: 1;
        padding: 10px;
    }

    .nav-item {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 5px;
        cursor: pointer;
        transition: 0.2s;
        color: #94a3b8;
    }

    .nav-item:hover {
        background: #1e293b;
        color: white;
    }

    .nav-item.active {
        background: var(--accent);
        color: white;
    }

    .nav-footer {
        padding: 20px;
        font-size: 0.8rem;
        color: #475569;
    }

    /* Main Area */
    .suite-main {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .suite-header {
        background: white;
        padding: 20px 40px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .suite-header h1 {
        font-size: 1.5rem;
        margin: 0;
    }

    /* Dashboard Widgets */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        padding: 30px 40px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .stat-card.accent {
        border-top: 4px solid #ef4444;
    }

    .stat-card.win {
        border-top: 4px solid var(--accent);
    }

    .stat-card h4 {
        margin: 0;
        font-size: 0.8rem;
        color: var(--text-dim);
        text-transform: uppercase;
    }

    .stat-card h2 {
        margin: 10px 0 0 0;
        font-size: 2rem;
    }

    .content-split {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 20px;
        padding: 0 40px 30px;
    }

    .card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .data-list {
        margin-top: 15px;
    }

    .list-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #f3f4f6;
    }

    .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 700;
    }

    .badge.high {
        background: #fee2e2;
        color: #b91c1c;
    }

    .badge.overdue {
        background: #000;
        color: #fff;
    }

    /* Pipeline View */
    .tab-content {
        padding: 30px 40px;
    }

    .pipeline-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
    }

    .pipeline-stage {
        background: white;
        border-radius: 12px;
        padding: 20px;
        min-height: 300px;
    }

    .pipeline-stage h4 {
        margin: 0 0 15px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #e5e7eb;
        font-size: 0.9rem;
    }

    .pipeline-deals {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .pipeline-deal {
        background: #f8fafc;
        padding: 12px;
        border-radius: 8px;
        border-left: 3px solid var(--accent);
    }

    .pipeline-deal strong {
        color: var(--text-main);
    }

    .pipeline-deal small {
        color: var(--text-dim);
        font-size: 0.8rem;
    }

    /* Prospects View */
    .prospects-toolbar {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .prospects-toolbar input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .prospects-toolbar select {
        padding: 12px 15px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9rem;
        background: white;
        cursor: pointer;
    }

    .prospects-table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .prospects-table {
        width: 100%;
        border-collapse: collapse;
    }

    .prospects-table th {
        background: #f8fafc;
        padding: 15px;
        text-align: left;
        font-size: 0.8rem;
        text-transform: uppercase;
        color: var(--text-dim);
        border-bottom: 1px solid #e5e7eb;
    }

    .prospects-table td {
        padding: 15px;
        border-bottom: 1px solid #f3f4f6;
    }

    .prospects-table tr:hover {
        background: #f8fafc;
    }

    /* Badge variations */
    .badge.hot {
        background: #fee2e2;
        color: #b91c1c;
    }

    .badge.warm {
        background: #fef3c7;
        color: #d97706;
    }

    .badge.cold {
        background: #e0f2fe;
        color: #0369a1;
    }

    .badge.won {
        background: #d1fae5;
        color: #059669;
    }
</style>

[FILE_END: CRM_Styles.html]
################################################################################

================================================================================
FILE_BEGIN: CRM_Suite.html
METADATA: Size=11046 bytes | Last_Modified=2026-02-05 14:37:16.025731
================================================================================
<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <?!= HtmlService.createHtmlOutputFromFile('CRM_Styles').getContent(); ?>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
  <div class="suite-wrapper">
    <nav class="suite-nav">
      <div class="brand">K&L RECYCLING</div>
      <div class="nav-links">
        <div class="nav-item active" onclick="switchTab('dashboard', this)">
          <i class="fas fa-th-large"></i> Dashboard
        </div>
        <div class="nav-item" onclick="switchTab('pipeline', this)">
          <i class="fas fa-filter"></i> Pipeline
        </div>
        <div class="nav-item" onclick="switchTab('prospects', this)">
          <i class="fas fa-address-book"></i> Prospects
        </div>
      </div>
      <div class="nav-footer">System v2.5.0</div>
    </nav>

    <main class="suite-main">
      <header class="suite-header">
        <h1 id="tab-title">Executive Dashboard</h1>
        <div class="user-profile">Operations Analyst</div>
      </header>

      <div id="view-dashboard" class="tab-content">
        <div class="stats-grid" id="stat-cards">
        </div>

        <div class="content-split">
          <div class="card">
            <h3>üî• Urgent Follow-ups</h3>
            <div id="urgent-list" class="data-list">Loading...</div>
          </div>
          <div class="card">
            <h3>‚úÖ Recent Wins</h3>
            <div id="wins-list" class="data-list">Loading...</div>
          </div>
        </div>
      </div>

      <div id="view-pipeline" class="tab-content" style="display: none;">
        <div class="pipeline-container" id="pipeline-container">
          <div class="pipeline-stage">
            <h4>üî• Hot</h4>
            <div id="pipeline-hot" class="pipeline-deals">Loading...</div>
          </div>
          <div class="pipeline-stage">
            <h4>‚òÄÔ∏è Warm</h4>
            <div id="pipeline-warm" class="pipeline-deals">Loading...</div>
          </div>
          <div class="pipeline-stage">
            <h4>‚ùÑÔ∏è Cold</h4>
            <div id="pipeline-cold" class="pipeline-deals">Loading...</div>
          </div>
          <div class="pipeline-stage">
            <h4>‚úÖ Won</h4>
            <div id="pipeline-won" class="pipeline-deals">Loading...</div>
          </div>
        </div>
      </div>

      <div id="view-prospects" class="tab-content" style="display: none;">
        <div class="prospects-toolbar">
          <input type="text" id="prospects-search" placeholder="Search prospects..." onkeyup="filterProspects()">
          <select id="prospects-filter" onchange="filterProspects()">
            <option value="all">All Statuses</option>
            <option value="hot">Hot</option>
            <option value="warm">Warm</option>
            <option value="cold">Cold</option>
          </select>
        </div>
        <div class="prospects-table-container">
          <table class="prospects-table">
            <thead>
              <tr>
                <th>Company Name</th>
                <th>Contact Status</th>
                <th>Urgency</th>
                <th>Priority Score</th>
                <th>Created Date</th>
              </tr>
            </thead>
            <tbody id="prospects-table-body">
              <tr><td colspan="5">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Global data storage
    var crmData = {
      dashboard: null,
      pipeline: null,
      prospects: null
    };

    function callAPI(action, payload = {}) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .crmGateway({ action, payload });
      });
    }

    async function init() {
      console.log('CRM Dashboard initializing...');
      try {
        console.log('Calling GET_DASHBOARD_STATS...');
        const res = await callAPI('GET_DASHBOARD_STATS');
        console.log('API Response:', res);
        if (res.success) {
          console.log('Dashboard data loaded successfully, rendering...');
          crmData.dashboard = res;
          renderDashboard(res);
        } else {
          console.error('Failed to load dashboard stats:', res.error);
          showError('Failed to load dashboard data: ' + (res.error || 'Unknown error'));
        }
      } catch (e) {
        console.error('Error initializing dashboard:', e);
        console.error('Error stack:', e.stack);
        showError('Error loading dashboard: ' + (e.message || 'Unknown error'));
      }
    }

    function showError(message) {
      document.getElementById('urgent-list').innerHTML = '<div style="color: red; padding: 10px;">' + message + '</div>';
      document.getElementById('wins-list').innerHTML = '<div style="color: red; padding: 10px;">' + message + '</div>';
    }

    function renderDashboard(data) {
      // Render Stat Cards
      const stats = data.pipeline;
      document.getElementById('stat-cards').innerHTML = `
        <div class="stat-card"><h4>PROSPECTS</h4><h2>${stats.total}</h2></div>
        <div class="stat-card accent"><h4>HOT LEADS</h4><h2>${stats.hot}</h2></div>
        <div class="stat-card"><h4>WARM LEADS</h4><h2>${stats.warm}</h2></div>
        <div class="stat-card win"><h4>TOTAL WINS</h4><h2>${stats.won}</h2></div>
      `;

      // Render Urgent List
      if (data.prospects && data.prospects.length > 0) {
        document.getElementById('urgent-list').innerHTML = data.prospects.map(p => `
          <div class="list-item">
            <span><strong>${p['company name'] || 'Unknown'}</strong></span>
            <span class="badge ${(p.urgencyband || '').toLowerCase()}">${p.urgencyband || 'N/A'}</span>
          </div>
        `).join('');
      } else {
        document.getElementById('urgent-list').innerHTML = '<div style="padding: 10px; color: #666;">No urgent prospects</div>';
      }

      // Render Wins
      if (data.accounts && data.accounts.length > 0) {
        document.getElementById('wins-list').innerHTML = data.accounts.map(a => `
          <div class="list-item">
            <span>${a['company name'] || 'Unknown Company'}</span>
            <small>${a['roll off container size'] || 'N/A'}</small>
          </div>
        `).join('');
      } else {
        document.getElementById('wins-list').innerHTML = '<div style="padding: 10px; color: #666;">No recent wins</div>';
      }
    }

    function renderPipeline(data) {
      const stages = {
        hot: data.hot || [],
        warm: data.warm || [],
        cold: data.cold || [],
        won: data.won || []
      };

      document.getElementById('pipeline-hot').innerHTML = stages.hot.length > 0 ? 
        stages.hot.map(p => `<div class="pipeline-deal"><strong>${p['company name'] || 'Unknown'}</strong><br><small>${p['urgencyband'] || ''}</small></div>`).join('') : 
        '<div style="color: #999; padding: 10px; text-align: center;">No hot prospects</div>';

      document.getElementById('pipeline-warm').innerHTML = stages.warm.length > 0 ? 
        stages.warm.map(p => `<div class="pipeline-deal"><strong>${p['company name'] || 'Unknown'}</strong><br><small>${p['urgencyband'] || ''}</small></div>`).join('') : 
        '<div style="color: #999; padding: 10px; text-align: center;">No warm prospects</div>';

      document.getElementById('pipeline-cold').innerHTML = stages.cold.length > 0 ? 
        stages.cold.map(p => `<div class="pipeline-deal"><strong>${p['company name'] || 'Unknown'}</strong><br><small>${p['urgencyband'] || ''}</small></div>`).join('') : 
        '<div style="color: #999; padding: 10px; text-align: center;">No cold prospects</div>';

      document.getElementById('pipeline-won').innerHTML = stages.won.length > 0 ? 
        stages.won.map(p => `<div class="pipeline-deal"><strong>${p['company name'] || 'Unknown'}</strong><br><small>${p['timestamp'] || ''}</small></div>`).join('') : 
        '<div style="color: #999; padding: 10px; text-align: center;">No wins yet</div>';
    }

    function renderProspects(data) {
      crmData.prospects = data.all || [];
      updateProspectsTable(crmData.prospects);
    }

    function updateProspectsTable(prospects) {
      const tbody = document.getElementById('prospects-table-body');
      if (!prospects || prospects.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No prospects found</td></tr>';
        return;
      }
      tbody.innerHTML = prospects.map(p => `
        <tr>
          <td><strong>${p['company name'] || 'Unknown'}</strong></td>
          <td><span class="badge ${(p['contact status'] || '').toLowerCase()}">${p['contact status'] || 'N/A'}</span></td>
          <td>${p['urgencyband'] || 'N/A'}</td>
          <td>${p['priority score'] || 'N/A'}</td>
          <td>${p['created date'] || 'N/A'}</td>
        </tr>
      `).join('');
    }

    function filterProspects() {
      const searchTerm = document.getElementById('prospects-search').value.toLowerCase();
      const filterStatus = document.getElementById('prospects-filter').value;

      if (!crmData.prospects) return;

      let filtered = crmData.prospects.filter(p => {
        const matchesSearch = (p['company name'] || '').toLowerCase().includes(searchTerm);
        const status = (p['contact status'] || '').toLowerCase();
        const matchesFilter = filterStatus === 'all' || status === filterStatus;
        return matchesSearch && matchesFilter;
      });

      updateProspectsTable(filtered);
    }

    async function switchTab(view, el) {
      // Update nav state
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('tab-title').innerText = view.charAt(0).toUpperCase() + view.slice(1);

      // Hide all views
      document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

      // Show selected view
      const viewEl = document.getElementById('view-' + view);
      if (viewEl) {
        viewEl.style.display = 'block';
      }

      // Load data for non-dashboard views
      if (view === 'pipeline' && !crmData.pipeline) {
        try {
          const res = await callAPI('GET_PIPELINE');
          if (res.success) {
            crmData.pipeline = res;
            renderPipeline(res);
          }
        } catch (e) {
          console.error('Error loading pipeline:', e);
        }
      } else if (view === 'pipeline' && crmData.pipeline) {
        renderPipeline(crmData.pipeline);
      }

      if (view === 'prospects' && !crmData.prospects) {
        try {
          const res = await callAPI('GET_PROSPECTS');
          if (res.success) {
            renderProspects(res);
          }
        } catch (e) {
          console.error('Error loading prospects:', e);
        }
      }
    }

    window.onload = init;
  </script>
</body>

</html>

[FILE_END: CRM_Suite.html]
################################################################################

================================================================================
FILE_BEGIN: dashboard.html
METADATA: Size=118284 bytes | Last_Modified=2026-02-05 14:37:16.025731
================================================================================
<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>K&L CRM Dashboard</title>
  <style>
    /* ========================================
       CSS Variables - Design System
       ======================================== */
    :root {
      --primary: #0F2537;
      --primary-light: #1a3a52;
      --primary-dark: #0a1929;
      --success: #27ae60;
      --success-light: #2ecc71;
      --warning: #f39c12;
      --warning-light: #f1c40f;
      --danger: #c0392b;
      --danger-light: #e74c3c;
      --bg: #f2f2f6;
      --bg-dark: #e5e5ea;
      --card-bg: #ffffff;
      --text: #1c1c1e;
      --text-secondary: #8e8e93;
      --text-light: #ffffff;
      --border: #dcdde1;
      --border-light: #e9ecef;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
      --shadow-hover: 0 4px 16px rgba(0, 0, 0, 0.12);
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
      --transition: all 0.2s ease;
      --transition-slow: all 0.3s ease;
      --sidebar-width: 450px;
      --sidebar-min-width: 320px;
      --sidebar-max-width: 600px;
      --header-height: 64px;
    }

    /* CRM Dashboard Panel */
    .crm-summary-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .crm-tile {
      padding: 10px;
      border-radius: var(--radius-sm);
      color: var(--text-light);
      text-align: center;
      font-size: 12px;
      font-weight: 700;
      box-shadow: var(--shadow);
    }

    .crm-tile.red {
      background: var(--danger);
    }

    .crm-tile.yellow {
      background: var(--warning);
      color: var(--text);
    }

    .crm-tile.green {
      background: var(--success);
    }

    .crm-tile.orange {
      background: var(--warning-light);
      color: var(--text);
    }

    .crm-tile.blue {
      background: var(--primary-light);
    }

    .crm-tile.teal {
      background: #1abc9c;
    }

    .crm-tile.gray {
      background: var(--text-secondary);
    }

    .crm-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }

    .crm-table th,
    .crm-table td {
      padding: 8px;
      border-bottom: 1px solid var(--border-light);
      font-size: 12px;
    }

    .crm-table th {
      text-transform: uppercase;
      font-size: 10px;
      color: var(--text-secondary);
    }

    /* ========================================
       Reset & Base Styles
       ======================================== */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ========================================
       Sidebar Container (works in both dialog and sidebar contexts)
       ======================================== */
    .sidebar-container {
      position: relative;
      height: 100%;
      width: 100%;
      min-width: var(--sidebar-min-width);
      max-width: var(--sidebar-max-width);
      background: var(--card-bg);
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      z-index: 999999;
      transition: box-shadow var(--transition), transform var(--transition-slow);
      overflow: hidden;
      /* Prevent container overflow */
    }

    /* Dialog context - make it floating */
    body:has(.dialog-context) .sidebar-container {
      position: absolute;
      top: 0;
      left: 0;
      width: var(--sidebar-width);
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
    }

    .sidebar-container.floating {
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
      transform: translateX(-10px);
    }

    .sidebar-container.resizing {
      transition: none;
    }

    /* ========================================
       Resize Handle
       ======================================== */
    .resize-handle {
      position: absolute;
      top: 0;
      right: -8px;
      width: 16px;
      height: 100%;
      cursor: ew-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000000;
      background: linear-gradient(90deg, transparent, rgba(15, 37, 55, 0.1));
      border-radius: 0 8px 8px 0;
    }

    .resize-handle::before {
      content: '';
      height: 60px;
      width: 6px;
      background: var(--border);
      border-radius: 3px;
      transition: var(--transition);
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .resize-handle:hover::before,
    .resize-handle.active::before {
      background: var(--primary);
      box-shadow: 0 0 8px rgba(15, 37, 55, 0.4);
    }

    /* ========================================
       Sidebar Header
       ======================================== */
    .sidebar-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-shrink: 0;
      cursor: move;
      user-select: none;
      position: relative;
    }

    .sidebar-header::before {
      content: '‚ãÆ‚ãÆ';
      position: absolute;
      left: 8px;
      font-size: 10px;
      opacity: 0.6;
      letter-spacing: 2px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-icon {
      font-size: 24px;
      line-height: 1;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
    }

    .brand-title {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.3px;
      line-height: 1.2;
    }

    .brand-subtitle {
      font-size: 11px;
      opacity: 0.85;
      font-weight: 500;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .time-badge {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(8px);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }

    /* ========================================
       Sidebar Content
       ======================================== */
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      scroll-behavior: smooth;
    }

    .sidebar-content::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar-content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .sidebar-content::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* ========================================
       Section Styles
       ======================================== */
    .section {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid var(--border-light);
      transition: var(--transition);
    }

    .section:hover {
      box-shadow: var(--shadow-hover);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .section-title-icon {
      font-size: 14px;
    }

    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, var(--border-light), transparent);
      margin-left: 8px;
    }

    /* ========================================
       Form Elements
       ======================================== */
    .form-group {
      margin-bottom: 8px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 9px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 3px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 6px 8px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-family: inherit;
      background: var(--card-bg);
      color: var(--text);
      transition: var(--transition);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(15, 37, 55, 0.1);
      transform: translateY(-1px);
    }

    .form-input::placeholder,
    .form-textarea::placeholder {
      color: var(--text-secondary);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
      max-height: 200px;
    }

    /* ========================================
       Status Buttons
       ======================================== */
    .status-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    /* ========================================
       Date Grid
       ======================================== */
    .date-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    /* ========================================
       Buttons
       ======================================== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
      opacity: 0;
      transition: var(--transition);
    }

    .btn:hover::before {
      opacity: 1;
    }

    .btn-primary {
      width: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      box-shadow: 0 4px 12px rgba(15, 37, 55, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(15, 37, 55, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-warning {
      width: 100%;
      background: linear-gradient(135deg, var(--warning) 0%, var(--warning-light) 100%);
      color: var(--text);
      box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
    }

    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
    }

    /* ========================================
       Stats Grid
       ======================================== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-dark) 100%);
      padding: 14px 10px;
      border-radius: var(--radius-sm);
      text-align: center;
      border: 1px solid var(--border-light);
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .stat-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--primary);
      line-height: 1.2;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ========================================
       Quick Links
       ======================================== */
    .quick-links {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .quick-link {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 12px 8px;
      background: var(--card-bg);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
      font-family: inherit;
      color: var(--text);
      text-decoration: none;
      cursor: pointer;
      transition: var(--transition);
    }

    .quick-link:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.05) 0%, transparent 100%);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    /* ========================================
       Suggestions / Autocomplete
       ======================================== */
    .suggestions-container {
      position: relative;
    }

    .suggestions {
      position: absolute;
      top: calc(100% - 2px);
      left: 0;
      right: 0;
      background: var(--card-bg);
      border: 2px solid var(--primary);
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      max-height: 180px;
      overflow-y: auto;
      display: none;
      z-index: 1000001;
      box-shadow: var(--shadow-lg);
      border-top: none;
    }

    .suggestions.active {
      display: block;
      animation: slideDown 0.2s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .suggestion-item {
      padding: 12px 14px;
      font-size: 14px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-light);
      transition: var(--transition);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item:hover,
    .suggestion-item.highlighted {
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.08) 0%, transparent 100%);
      color: var(--primary);
    }

    /* ========================================
       Last Touch Card
       ======================================== */
    .last-touch-card {
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-dark) 100%);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      padding: 14px;
      margin-top: 12px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .last-touch-card.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .last-touch-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .last-touch-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 13px;
    }

    .last-touch-item {
      background: var(--card-bg);
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border-light);
    }

    .last-touch-label {
      display: block;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 4px;
    }

    .last-touch-value {
      font-weight: 700;
      color: var(--text);
      word-break: break-word;
    }

    .days-since {
      font-weight: 800;
      color: var(--warning);
    }

    .days-since.low {
      color: var(--success);
    }

    .days-since.high {
      color: var(--danger);
    }

    /* ========================================
       Account Form
       ======================================== */
    .account-form {
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.08) 0%, rgba(46, 204, 113, 0.05) 100%);
      border: 2px solid var(--success);
      border-radius: var(--radius-sm);
      padding: 14px;
      margin-top: 12px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .account-form.active {
      display: block;
    }

    .account-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 700;
      color: var(--success);
      margin-bottom: 12px;
    }

    /* ========================================
       Voice Section
       ======================================== */
    .voice-section {
      margin-top: 12px;
    }

    .voice-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      font-family: inherit;
      transition: var(--transition);
      box-shadow: 0 4px 12px rgba(15, 37, 55, 0.3);
    }

    .voice-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(15, 37, 55, 0.4);
    }

    .voice-btn.recording {
      background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
      animation: pulse 1.2s ease-in-out infinite;
      box-shadow: 0 4px 12px rgba(192, 57, 43, 0.3);
    }

    .voice-btn.recording:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 20px rgba(192, 57, 43, 0.4);
    }

    @keyframes pulse {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.4);
      }

      50% {
        box-shadow: 0 0 0 12px rgba(192, 57, 43, 0);
      }
    }

    .voice-preview {
      background: var(--bg);
      border: 2px dashed var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 8px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      transition: var(--transition);
    }

    .voice-preview.has-content {
      border-style: solid;
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.05) 0%, transparent 100%);
      color: var(--text);
    }

    /* ========================================
       Shortcut Hint
       ======================================== */
    .shortcut-hint {
      font-size: 11px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 12px;
      font-style: italic;
      opacity: 0.8;
    }

    /* ========================================
       Toast Notifications
       ======================================== */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--primary);
      color: var(--text-light);
      padding: 14px 24px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 600;
      display: none;
      z-index: 1000002;
      box-shadow: var(--shadow-lg);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .toast.show {
      display: block;
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.warning {
      background: var(--warning);
      color: var(--text);
    }

    /* ========================================
       Loading Overlay
       ======================================== */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .loading-overlay.active {
      display: flex;
      opacity: 1;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ========================================
       Prospect Status Indicator
       ======================================== */
    .prospect-status-indicator {
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-dark) 100%);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      margin-bottom: 12px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .status-icon {
      font-size: 18px;
      margin-bottom: 6px;
    }

    .status-message {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .prospect-status-indicator.existing {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.08) 0%, transparent 100%);
    }

    .prospect-status-indicator.new {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.08) 0%, transparent 100%);
    }

    .prospect-status-indicator.existing .status-icon {
      color: var(--success);
    }

    .prospect-status-indicator.new .status-icon {
      color: var(--primary);
    }

    /* ========================================
       Workflow Display
       ======================================== */
    .workflow-display {
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-dark) 100%);
      border: 2px solid var(--primary);
      border-radius: var(--radius-sm);
      padding: 14px;
      margin-top: 12px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .workflow-display.urgent {
      border-color: var(--danger);
      background: linear-gradient(135deg, rgba(192, 57, 43, 0.08) 0%, rgba(192, 57, 43, 0.05) 100%);
    }

    .workflow-display.high {
      border-color: var(--warning);
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.08) 0%, rgba(243, 156, 18, 0.05) 100%);
    }

    .workflow-display.medium {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.08) 0%, rgba(15, 37, 55, 0.05) 100%);
    }

    .workflow-display.low {
      border-color: var(--text-secondary);
      background: linear-gradient(135deg, rgba(142, 142, 147, 0.08) 0%, rgba(142, 142, 147, 0.05) 100%);
    }

    .workflow-status {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .workflow-item {
      background: var(--card-bg);
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid var(--border-light);
      text-align: center;
    }

    .workflow-label {
      display: block;
      font-size: 9px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .workflow-value {
      font-size: 12px;
      font-weight: 700;
      color: var(--text);
    }

    .workflow-value.success {
      color: var(--success);
    }

    .workflow-value.warning {
      color: var(--warning);
    }

    .workflow-value.info {
      color: var(--primary);
    }

    .workflow-value.danger {
      color: var(--danger);
    }

    /* ========================================
       Outcome Buttons
       ======================================== */
    .outcome-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 4px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--card-bg);
      cursor: pointer;
      font-size: 11px;
      font-weight: 700;
      font-family: inherit;
      color: var(--text-secondary);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      text-align: center;
      min-height: 48px;
    }

    .outcome-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
      opacity: 0;
      transition: var(--transition);
    }

    .outcome-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .outcome-btn:hover::before {
      opacity: 1;
    }

    .outcome-btn.active {
      border-color: var(--primary);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      box-shadow: 0 4px 12px rgba(15, 37, 55, 0.3);
      transform: translateY(-2px);
    }

    .outcome-btn.active::before {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
      opacity: 1;
    }

    .outcome-btn-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    /* ========================================
       Quick Date Options
       ======================================== */
    .quick-date-options {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .quick-date-btn {
      flex: 1;
      min-width: 70px;
      padding: 8px 6px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 600;
      font-family: inherit;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
    }

    .quick-date-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.05) 0%, transparent 100%);
    }

    /* ========================================
       Report Output
       ======================================== */
    .copy-report-btn {
      padding: 6px 12px;
      background: var(--success);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .copy-report-btn:hover {
      background: var(--success-light);
    }

    .report-textarea {
      width: 100%;
      min-height: 150px;
      max-height: 300px;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
      font-size: 11px;
      line-height: 1.5;
      background: var(--bg);
      color: var(--text);
      resize: vertical;
    }

    .report-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* ========================================
       Control Center - Tabbed Utilities
       ======================================== */
    .control-center-content {
      display: block;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .control-center-content.collapsed {
      max-height: 0;
      overflow: hidden;
    }

    .control-center-tabs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      margin-bottom: 12px;
    }

    .control-tab {
      padding: 8px 4px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 600;
      font-family: inherit;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
    }

    .control-tab:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.05) 0%, transparent 100%);
    }

    .control-tab.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(15, 37, 55, 0.2);
      transform: translateY(-1px);
    }

    .control-tool {
      display: none;
      animation: fadeIn 0.2s ease;
    }

    .control-tool.active {
      display: block;
    }

    /* ========================================
       Responsive Design
       ======================================== */
    @media (max-width: 768px) {
      .sidebar-container {
        width: 100% !important;
        min-width: 100% !important;
        max-width: 100% !important;
        height: 100vh;
        border-radius: 0;
      }

      .resize-handle {
        display: none;
      }

      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
      }

      .stat-card {
        padding: 10px 6px;
      }

      .stat-value {
        font-size: 20px;
      }

      .control-center-tabs {
        grid-template-columns: repeat(2, 1fr);
      }

      .control-tab {
        font-size: 9px;
        padding: 6px 4px;
      }
    }
  </style>
</head>

<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
  </div>

  <!-- Floating Sidebar -->
  <div class="sidebar-container" id="sidebar">
    <!-- Resize Handle -->
    <div class="resize-handle" id="resizeHandle"></div>

    <!-- Header -->
    <div class="sidebar-header">
      <div class="header-left">
        <span class="brand-icon">üó∫Ô∏è</span>
        <div class="brand-text">
          <span class="brand-title">K&L CRM</span>
          <span class="brand-subtitle">Field Operations</span>
        </div>
      </div>
      <div class="header-right">
        <div class="time-badge" id="currentTime">--:--</div>
      </div>
    </div>

    <!-- Content -->
    <div class="sidebar-content">
      <!-- Visit Entry Section -->
      <div class="section">
        <div class="visit-header">
          <div class="visit-title">
            <span>üìù</span>
            <span>Log Visit</span>
          </div>
        </div>

        <!-- Outreach ID -->
        <div class="form-group">
          <label for="outreachId" class="form-label">Outreach ID</label>
          <input type="text" id="outreachId" class="form-input"
            placeholder="Leave empty to auto-generate (e.g., LID-00128)">
        </div>

        <!-- Company Search -->
        <div class="form-group suggestions-container">
          <label for="companyInput" class="form-label">Company <span class="required">*</span></label>
          <input type="text" id="companyInput" class="form-input" oninput="searchCompany(this)"
            placeholder="Search or type new company..." autocomplete="off">
          <div class="suggestions" id="suggestions"></div>
        </div>

        <!-- New Company Info Toggle -->
        <div class="form-group">
          <button type="button" class="quick-link" style="width:100%;" onclick="toggleNewCompanyFields()">
            <span id="newCompanyToggleIcon">+</span>
            <span id="newCompanyToggleText">Add New Company Details</span>
          </button>
        </div>

        <!-- New Company Additional Fields -->
        <div id="newCompanyFields" class="new-company-fields" style="display:none;">
          <div class="form-group">
            <label for="newAddress" class="form-label">Address</label>
            <input type="text" id="newAddress" class="form-input" placeholder="Street address">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newCity" class="form-label">City</label>
              <input type="text" id="newCity" class="form-input" placeholder="City" value="Tyler">
            </div>
            <div class="form-group">
              <label for="newState" class="form-label">State</label>
              <input type="text" id="newState" class="form-input" placeholder="State" value="TX">
            </div>
            <div class="form-group">
              <label for="newZip" class="form-label">Zip</label>
              <input type="text" id="newZip" class="form-input" placeholder="Zip Code">
            </div>
          </div>
          <div class="form-group">
            <label for="newIndustry" class="form-label">Industry</label>
            <select id="newIndustry" class="form-select">
              <option value="">Select Industry...</option>
              <option value="Construction">Construction</option>
              <option value="Auto">Auto Repair/Body</option>
              <option value="HVAC">HVAC</option>
              <option value="Plumber">Plumbing</option>
              <option value="Roofing">Roofing</option>
              <option value="Electrical">Electrical</option>
              <option value="Metal">Metal Fabrication</option>
              <option value="Welder">Welding</option>
              <option value="Gutter">Gutter</option>
              <option value="Manufacturing">Manufacturing</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newContact" class="form-label">Contact Name</label>
              <input type="text" id="newContact" class="form-input" placeholder="Contact">
            </div>
            <div class="form-group">
              <label for="newPhone" class="form-label">Phone</label>
              <input type="tel" id="newPhone" class="form-input" placeholder="Phone">
            </div>
          </div>
          <div class="form-group">
            <label for="newEmail" class="form-label">Email</label>
            <input type="email" id="newEmail" class="form-input" placeholder="Email">
          </div>
          <div class="form-group">
            <label for="newCompetitor" class="form-label">Current Vendor/Competitor</label>
            <input type="text" id="newCompetitor" class="form-input" placeholder="e.g., AIM, Tyler Iron, etc.">
          </div>
        </div>

        <!-- Last Touch Card -->
        <div class="last-touch-card" id="lastTouchCard">
          <div class="last-touch-header">
            <span>üìä</span>
            <span>Last Touch</span>
          </div>
          <div class="last-touch-grid">
            <div class="last-touch-item">
              <span class="last-touch-label">Last Contact</span>
              <span class="last-touch-value" id="lastContactDate">--</span>
            </div>
            <div class="last-touch-item">
              <span class="last-touch-label">Days Since</span>
              <span class="last-touch-value days-since" id="daysSince">--</span>
            </div>
            <div class="last-touch-item">
              <span class="last-touch-label">Last Outcome</span>
              <span class="last-touch-value" id="lastOutcome">--</span>
            </div>
            <div class="last-touch-item">
              <span class="last-touch-label">Next Steps</span>
              <span class="last-touch-value" id="nextSteps">--</span>
            </div>
          </div>
        </div>

        <!-- Outcome Selection (UPDATED TO MATCH SETTINGS) -->
        <label class="visit-type-label">Visit Outcome</label>
        <div class="outcome-btn-grid">
          <button type="button" class="outcome-btn" onclick="setOutcome('Account Won', this)">
            <span>üèÜ</span> Account Won
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Interested (Hot)', this)">
            <span>üî•</span> Interested (Hot)
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Interested (Warm)', this)">
            <span>üéØ</span> Interested (Warm)
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Initial Contact', this)">
            <span>üëã</span> Initial Contact
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Follow-Up', this)">
            <span>üîÑ</span> Follow-Up
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('No Answer', this)">
            <span>üìû</span> No Answer
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Not Interested', this)">
            <span>üö´</span> Not Interested
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Disqualified', this)">
            <span>‚ùå</span> Disqualified
          </button>
        </div>

        <!-- Stage & Status Display (Auto-populated based on Outcome) -->
        <div class="workflow-display" id="workflowDisplay" style="display:none;">
          <div class="form-group">
            <label class="visit-type-label">Workflow Status</label>
            <div class="workflow-status">
              <div class="workflow-item">
                <span class="workflow-label">Outcome:</span>
                <span class="workflow-value" id="outcomeValue">--</span>
              </div>
              <div class="workflow-item">
                <span class="workflow-label">Stage:</span>
                <span class="workflow-value" id="stageValue">--</span>
              </div>
              <div class="workflow-item">
                <span class="workflow-label">Status:</span>
                <span class="workflow-value" id="statusValue">--</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Date and Type -->
        <div class="date-grid">
          <div class="form-group">
            <label for="nextDate" class="form-label">Next Action</label>
            <input type="date" id="nextDate" class="form-input">
          </div>
          <div class="form-group">
            <label for="activityType" class="form-label">Type</label>
            <select id="activityType" class="form-select">
              <option value="Visit">Visit</option>
              <option value="Call">Call</option>
              <option value="Email">Email</option>
            </select>
          </div>
        </div>

        <!-- Notes -->
        <div class="form-group">
          <label for="notes" class="form-label">Notes</label>
          <textarea id="notes" class="form-textarea" rows="3" placeholder="Site details..."></textarea>
        </div>

        <!-- New Account Form (Only shows for WON) -->
        <div class="account-form" id="accountForm">
          <div class="account-title">
            <span>üöÄ</span>
            <span>New Account Details</span>
          </div>
          <div class="form-group">
            <input type="text" id="newContact" class="form-input" placeholder="Contact Name">
          </div>
          <div class="date-grid">
            <input type="text" id="newPhone" class="form-input" placeholder="Phone">
            <input type="text" id="newAddress" class="form-input" placeholder="Address">
          </div>
        </div>

        <!-- Prospect Status Indicator -->
        <div class="prospect-status-indicator" id="prospectStatusIndicator" style="margin-bottom: 12px; display: none;">
          <div class="status-icon" id="prospectStatusIcon">‚è≥</div>
          <div class="status-message" id="prospectStatusMessage">Checking company status...</div>
        </div>

        <!-- Save Button -->
        <button type="button" class="btn btn-primary" onclick="saveEntry()">
          <span>üíæ</span> Save Entry
        </button>

        <!-- Voice Section -->
        <div class="voice-section">
          <button type="button" class="voice-btn" id="voiceBtn" onclick="toggleVoice()">
            <span id="micIcon">üé§</span>
            <span id="micText">Voice Notes</span>
          </button>
          <div class="voice-preview" id="voicePreview">Tap to record...</div>
        </div>

        <!-- Keyboard Shortcuts -->
        <div class="shortcut-hint">Keyboard: Enter=Save ‚Ä¢ /=Search ‚Ä¢ R=Route</div>
      </div>

      <!-- Stats Section -->
      <div class="section">
        <div class="section-header">
          <div class="section-title">
            <span class="section-title-icon">üìä</span>
            Today's Overview
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statWon">0</div>
            <div class="stat-label">Wins</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statHot">0</div>
            <div class="stat-label">Hot</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statVisits">0</div>
            <div class="stat-label">Visits</div>
          </div>
        </div>
      </div>

      <!-- Summary Tiles -->
      <div id="crm-summary" class="crm-summary-grid"></div>

      <!-- Follow-Up Table -->
      <table id="crm-followups" class="crm-table">
        <thead>
          <tr>
            <th>Company</th>
            <th>Notes</th>
            <th>Countdown</th>
            <th>Urgency</th>
            <th>Priority</th>
            <th>Next Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Control Center - Collapsible Utility Panel -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">
          <span class="section-title-icon">‚öôÔ∏è</span>
          Control Center
        </div>
        <button type="button" class="quick-link" style="padding: 4px 8px; font-size: 10px;"
          onclick="toggleControlCenter()">
          <span id="controlCenterToggleIcon">‚ñº</span>
        </button>
      </div>

      <div id="controlCenterContent" class="control-center-content">
        <!-- Control Center Tabs -->
        <div class="control-center-tabs">
          <button type="button" class="control-tab active" onclick="showTool('route', this)">
            üó∫Ô∏è Route
          </button>
          <button type="button" class="control-tab" onclick="showTool('quick-actions', this)">
            ‚ö° Quick Actions
          </button>
          <button type="button" class="control-tab" onclick="showTool('csv', this)">
            üìÅ CSV Import
          </button>
          <button type="button" class="control-tab" onclick="showTool('report', this)">
            üìä Reports
          </button>
        </div>

        <!-- Route Planning Tool -->
        <div id="tool-route" class="control-tool active">
          <div class="date-grid">
            <div class="form-group">
              <label for="routeStart" class="form-label">Start</label>
              <input type="date" id="routeStart" class="form-input">
            </div>
            <div class="form-group">
              <label for="routeEnd" class="form-label">End</label>
              <input type="date" id="routeEnd" class="form-input">
            </div>
          </div>
          <button type="button" class="btn btn-warning" onclick="generateRoute()">
            <span>üó∫Ô∏è</span> Generate Route
          </button>
        </div>

        <!-- Quick Actions Tool -->
        <div id="tool-quick-actions" class="control-tool">
          <div class="quick-links">
            <button type="button" class="quick-link" onclick="quickAction('pipeline')">
              <span>üìä</span> Pipeline
            </button>
            <button type="button" class="quick-link" onclick="quickAction('accounts')">
              <span>üè¢</span> Accounts
            </button>
            <button type="button" class="quick-link" onclick="quickAction('calendar')">
              <span>üìÖ</span> Calendar
            </button>
            <button type="button" class="quick-link" onclick="quickAction('reports')">
              <span>üìà</span> Reports
            </button>
          </div>
        </div>

        <!-- CSV Import Tool -->
        <div id="tool-csv" class="control-tool">
          <div class="form-group">
            <label for="csvText" class="form-label">Paste CSV Data</label>
            <textarea id="csvText" class="form-textarea" rows="4" placeholder="Paste your CSV data here..."></textarea>
          </div>
          <div class="form-group">
            <label for="importSheet" class="form-label">Target Sheet</label>
            <select id="importSheet" class="form-select">
              <option value="Outreach">Outreach</option>
              <option value="Prospects">Prospects</option>
              <option value="New Accounts">New Accounts</option>
            </select>
          </div>
          <button type="button" class="btn btn-warning" onclick="importCSV()">
            <span>üì•</span> Import CSV
          </button>
        </div>

        <!-- Report Generation Tool -->
        <div id="tool-report" class="control-tool">
          <!-- Quick Date Options -->
          <div class="quick-date-options">
            <button type="button" class="quick-date-btn" onclick="setReportDates('thisWeek')">This Week</button>
            <button type="button" class="quick-date-btn" onclick="setReportDates('thisMonth')">This Month</button>
            <button type="button" class="quick-date-btn" onclick="setReportDates('last7')">Last 7 Days</button>
            <button type="button" class="quick-date-btn" onclick="setReportDates('last30')">Last 30 Days</button>
          </div>

          <div class="date-grid">
            <div class="form-group">
              <label for="reportStart" class="form-label">Start Date</label>
              <input type="date" id="reportStart" class="form-input">
            </div>
            <div class="form-group">
              <label for="reportEnd" class="form-label">End Date</label>
              <input type="date" id="reportEnd" class="form-input">
            </div>
          </div>
          <button type="button" class="btn btn-primary" onclick="generateDateRangeReport()">
            <span>üìä</span> Generate Report
          </button>
        </div>
      </div>
    </div>

    <!-- Report Output Section (hidden until report generated) -->
    <div class="section" id="reportOutputSection" style="display: none;">
      <div class="section-header">
        <div class="section-title">
          <span class="section-title-icon">üìã</span>
          Report Output
        </div>
        <button type="button" class="copy-report-btn" onclick="copyReportToClipboard()">
          üìã Copy
        </button>
      </div>
      <textarea id="reportOutput" class="report-textarea" readonly></textarea>
    </div>
  </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <script>
    // ========================================
    // Non-Blocking UI Logic
    // ========================================

    const state = {
      selectedStatus: '',
      isRecording: false,
      recognition: null,
      searchTimeout: null,
      selectedCompanyData: null
    };

    document.addEventListener('DOMContentLoaded', () => {
      detectDisplayContext();
      initializeDates();
      initializeResize();
      initializeEventListeners();
      updateTime();
      setInterval(updateTime, 60000);

      // Initialize control center tabs
      showTool('route');

      // Staggered loading to prevent server-side queuing bottlenecks
      setTimeout(loadStats, 100);
      setTimeout(loadValidationLists, 500);
    });

    function initializeDates() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('nextDate').value = today;
      document.getElementById('routeStart').value = today;
      document.getElementById('routeEnd').value = today;
    }

    function initializeEventListeners() {
      // Close suggestions on outside click
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#companyInput') && !e.target.closest('.suggestions')) {
          document.getElementById('suggestions').classList.remove('active');
        }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', handleKeyboardShortcuts);
    }

    // ========================================
    // Sidebar Resize & Drag Functionality
    // ========================================
    function initializeResize() {
      const sidebar = document.getElementById('sidebar');
      const handle = document.getElementById('resizeHandle');
      const header = document.querySelector('.sidebar-header');
      let isResizing = false;
      let isDragging = false;
      let startX, startY, startWidth, startLeft, startTop;

      // Resize functionality
      handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startWidth = sidebar.offsetWidth;
        sidebar.classList.add('resizing');
        handle.classList.add('active');
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
      });

      document.addEventListener('mousemove', (e) => {
        if (isResizing) {
          const diff = e.clientX - startX;
          const minWidth = 280;
          const maxWidth = 600;
          const newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth + diff));
          sidebar.style.width = newWidth + 'px';
        } else if (isDragging) {
          const diffX = e.clientX - startX;
          const diffY = e.clientY - startY;
          sidebar.style.left = (startLeft + diffX) + 'px';
          sidebar.style.top = (startTop + diffY) + 'px';
          sidebar.style.right = 'auto';
        }
      });

      document.addEventListener('mouseup', () => {
        if (isResizing || isDragging) {
          isResizing = false;
          isDragging = false;
          sidebar.classList.remove('resizing');
          handle.classList.remove('active');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });

      // Drag functionality (from header)
      header.addEventListener('mousedown', (e) => {
        // Only start drag if not clicking on header buttons
        if (e.target.closest('.header-right')) return;

        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        startLeft = sidebar.offsetLeft;
        startTop = sidebar.offsetTop;
        sidebar.classList.add('floating');
        document.body.style.cursor = 'move';
        document.body.style.userSelect = 'none';
      });

      // Touch support for resize
      handle.addEventListener('touchstart', (e) => {
        isResizing = true;
        startX = e.touches[0].clientX;
        startWidth = sidebar.offsetWidth;
        sidebar.classList.add('resizing');
      });

      document.addEventListener('touchmove', (e) => {
        if (isResizing) {
          e.preventDefault();
          const diff = e.touches[0].clientX - startX;
          const newWidth = Math.max(280, Math.min(600, startWidth + diff));
          sidebar.style.width = newWidth + 'px';
        }
      });

      document.addEventListener('touchend', () => {
        if (isResizing) {
          isResizing = false;
          sidebar.classList.remove('resizing');
        }
      });
    }

    // ========================================
    // Time Display
    // ========================================
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').innerText =
        now.toLocaleDateString('en-US', { weekday: 'short' }) + ' ' +
        now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    // ========================================
    // Keyboard Shortcuts
    // ========================================
    function handleKeyboardShortcuts(e) {
      // Ignore if typing in form fields
      if (e.target.matches('input, textarea, select')) {
        // Allow Enter to submit if in input and Shift not pressed
        if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey) {
          const tagName = e.target.tagName.toLowerCase();
          if (tagName !== 'textarea') {
            e.preventDefault();
            saveEntry();
          }
        }
        return;
      }

      switch (e.key) {
        case 'Enter':
          e.preventDefault();
          saveEntry();
          break;
        case '/':
          e.preventDefault();
          document.getElementById('companyInput').focus();
          break;
        case 'r':
        case 'R':
          generateRoute();
          break;
      }
    }

    // ========================================
    // Workflow-Based Status Selection
    // ========================================

    // Standardized workflow mapping based on user's unified approach
    const workflowMap = {
      'Account Won': {
        stage: 'Won',
        status: 'Active',
        priority: 'urgent',
        days: 1
      },
      'Interested (Hot)': {
        stage: 'Nurture',
        status: 'Hot',
        priority: 'high',
        days: 7
      },
      'Interested (Warm)': {
        stage: 'Nurture',
        status: 'Warm',
        priority: 'medium',
        days: 14
      },
      'Initial Contact': {
        stage: 'Prospect',
        status: 'Warm',
        priority: 'medium',
        days: 30
      },
      'Follow-Up': {
        stage: 'Nurture',
        status: 'Warm',
        priority: 'medium',
        days: 14
      },
      'No Answer': {
        stage: 'Outreach',
        status: 'Cold',
        priority: 'high',
        days: 3
      },
      'Not Interested': {
        stage: 'Lost',
        status: 'Disqualified',
        priority: 'low',
        days: 180
      },
      'Disqualified': {
        stage: 'Lost',
        status: 'Disqualified',
        priority: 'low',
        days: 0
      }
    };

    // Set outcome and auto-populate workflow
    function setOutcome(outcome, btn) {
      // Clear previous selections
      document.querySelectorAll('.outcome-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Get workflow details for this outcome
      const workflow = workflowMap[outcome];
      if (workflow) {
        // Update state with full workflow status
        state.selectedOutcome = outcome;
        state.selectedStage = workflow.stage;
        state.selectedStatus = workflow.status;

        // Update display
        document.getElementById('outcomeValue').textContent = outcome;
        document.getElementById('stageValue').textContent = workflow.stage;
        document.getElementById('statusValue').textContent = workflow.status;

        // Show workflow display
        document.getElementById('workflowDisplay').style.display = 'block';

        // Show account form for won accounts
        document.getElementById('accountForm').classList.toggle('active', outcome === 'Account Won');

        // Auto-set next date
        const nextDate = new Date();
        nextDate.setDate(nextDate.getDate() + workflow.days);
        document.getElementById('nextDate').value = nextDate.toISOString().split('T')[0];

        // Visual feedback based on priority
        updateWorkflowStyling(workflow.priority);
      }
    }

    // Update workflow display styling based on priority
    function updateWorkflowStyling(priority) {
      const display = document.getElementById('workflowDisplay');
      display.className = 'workflow-display';

      // Remove previous priority classes
      display.classList.remove('urgent', 'high', 'medium', 'low');

      // Add new priority class
      display.classList.add(priority);

      // Update status value styling
      const statusEl = document.getElementById('statusValue');
      statusEl.className = 'workflow-value';

      const statusColors = {
        'Won': 'success',
        'Hot': 'warning',
        'Warm': 'info',
        'Disqualified': 'danger',
        'Cold': 'danger',
        'Active': 'success'
      };

      const status = state.selectedStatus;
      if (statusColors[status]) {
        statusEl.classList.add(statusColors[status]);
      }
    }

    // ========================================
    // Company Search
    // ========================================
    function searchCompany(input) {
      console.log('searchCompany called with input:', input.value);
      clearTimeout(state.searchTimeout);

      if (input.value.length < 2) {
        console.log('Input too short, hiding suggestions');
        document.getElementById('suggestions').classList.remove('active');
        document.getElementById('lastTouchCard').classList.remove('active');
        document.getElementById('prospectStatusIndicator').classList.remove('active');
        return;
      }

      console.log('Setting timeout for search');
      state.searchTimeout = setTimeout(() => {
        console.log('Calling apiSearchProspects with:', input.value);
        google.script.run
          .withSuccessHandler(handleSearchResults)
          .withFailureHandler(error => handleApiError(error, 'Search failed'))
          .apiSearchProspects(input.value);
      }, 300);
    }

    function handleSearchResults(result) {
      console.log('handleSearchResults called with:', result);
      let companies = [];

      if (result && typeof result === 'object') {
        if (Array.isArray(result)) {
          companies = result;
          console.log('Direct array result:', companies.length, 'companies');
        } else if (result.success && result.data) {
          companies = result.data;
          console.log('Object result with data:', companies.length, 'companies');
        } else if (result.success === false) {
          console.log('Search failed with error:', result.error);
          showToast('‚ùå ' + (result.error || 'Search failed'), 'error');
          return;
        } else {
          console.log('Unexpected result format:', result);
        }
      } else {
        console.log('Invalid result:', result);
      }

      console.log('Final companies array:', companies);
      if (companies.length > 0) {
        console.log('Calling showSuggestions with', companies.length, 'companies');
        showSuggestions(companies);
      } else {
        console.log('No companies found, hiding suggestions');
        // No results found - still hide dropdown
        document.getElementById('suggestions').classList.remove('active');
      }
    }

    // ========================================
    // Toast & Loading Helpers
    // ========================================
    function handleApiError(error, defaultMsg) {
      showLoading(false);
      showToast('‚ùå ' + (error.message || defaultMsg), 'error');
    }

    function showSuggestions(results) {
      console.log('showSuggestions called with:', results);
      const dropdown = document.getElementById('suggestions');
      console.log('Dropdown element:', dropdown);

      if (results && results.length > 0) {
        console.log('Generating HTML for', results.length, 'results');
        // Use data attributes instead of inline onclick to handle special characters
        dropdown.innerHTML = results.map((r, index) => {
          const escapedName = escapeHtml(r.companyName || r.company);
          const companyId = r.companyId || '';
          const address = escapeHtml(r.address || '');
          const phone = escapeHtml(r.phone || '');
          const email = escapeHtml(r.email || '');
          const contactName = escapeHtml(r.contactName || '');
          return `<div class="suggestion-item" data-index="${index}" data-name="${escapedName}" data-id="${companyId}" data-address="${address}" data-phone="${phone}" data-email="${email}" data-contact="${contactName}">${escapedName}</div>`;
        }).join('');

        console.log('HTML set, adding click listeners');
        // Add click listeners to suggestion items
        dropdown.querySelectorAll('.suggestion-item').forEach(item => {
          item.onclick = function () {
            console.log('Suggestion clicked:', this.dataset.name);
            const companyData = {
              companyName: this.dataset.name,
              companyId: this.dataset.id,
              address: this.dataset.address,
              phone: this.dataset.phone,
              email: this.dataset.email,
              contactName: this.dataset.contact
            };
            selectCompany(companyData);
          };
        });

        console.log('Adding active class to dropdown');
        dropdown.classList.add('active');
      } else {
        console.log('No results, removing active class');
        dropdown.classList.remove('active');
      }
    }

    function selectCompany(companyData) {
      // Handle both object and string input for backwards compatibility
      if (typeof companyData === 'string') {
        // Legacy: received just company name string
        document.getElementById('companyInput').value = companyData;
        document.getElementById('suggestions').classList.remove('active');
        loadLastTouchInfo(companyData);
        checkProspectStatus(companyData);
        return;
      }

      // New: receive company object with companyId - get comprehensive data for autofill
      const companyId = companyData.companyId;
      const companyName = companyData.companyName || companyData.company || '';

      document.getElementById('companyInput').value = companyName;
      document.getElementById('suggestions').classList.remove('active');

      // Visual feedback
      const input = document.getElementById('companyInput');
      input.style.borderColor = 'var(--success)';
      setTimeout(() => input.style.borderColor = 'var(--border)', 500);

      // Get comprehensive company details for autofill
      if (companyId) {
        showLoading(true);
        google.script.run
          .withSuccessHandler(function (result) {
            showLoading(false);
            if (result && result.success && result.data) {
              // Store comprehensive company data
              state.selectedCompanyData = result.data;
              // Autofill form with comprehensive data
              autofillCompanyData(result.data);
            } else {
              // Fallback to basic data if API call fails
              state.selectedCompanyData = companyData;
              autofillCompanyData(companyData);
            }
          })
          .withFailureHandler(function (error) {
            showLoading(false);
            console.warn('Failed to get comprehensive company details:', error);
            // Fallback to basic data
            state.selectedCompanyData = companyData;
            autofillCompanyData(companyData);
          })
          .getCompanyDetailsForAutofill(companyId);
      } else {
        // No companyId available, use basic data
        state.selectedCompanyData = companyData;
        autofillCompanyData(companyData);
      }

      // Load last touch information
      loadLastTouchInfo(companyName);

      // Check prospect status
      checkProspectStatus(companyName);
    }

    function autofillCompanyData(companyData) {
      console.log('üîç autofillCompanyData called with:', companyData);

      // Only autofill if we have a companyId (meaning it came from prospect sheet)
      if (!companyData.companyId) {
        console.log('‚ùå Skipping autofill - no companyId (company not found in prospect sheet)');
        console.log('Available data:', {
          companyName: companyData.companyName,
          companyId: companyData.companyId,
          hasContact: !!companyData.contactName,
          hasPhone: !!companyData.phone,
          hasAddress: !!companyData.address,
          hasEmail: !!companyData.email
        });
        showToast('‚ö†Ô∏è Company not found in prospects - manual entry required', 'warning');
        return;
      }

      console.log('‚úÖ Autofilling company data for:', companyData.companyName);
      console.log('Data to fill:', {
        contactName: companyData.contactName,
        phone: companyData.phone,
        address: companyData.address,
        email: companyData.email
      });

      // Show the "Add New Company Details" section so user can see the autofilled data
      const newCompanyFields = document.getElementById('newCompanyFields');
      const toggleIcon = document.getElementById('newCompanyToggleIcon');
      const toggleText = document.getElementById('newCompanyToggleText');

      if (newCompanyFields.style.display === 'none') {
        console.log('üìÇ Expanding new company details section');
        newCompanyFields.style.display = 'block';
        toggleIcon.textContent = '-';
        toggleText.textContent = 'Hide New Company Details';
      }

      let filledCount = 0;
      const autofillResults = [];

      // Autofill the expanded new company fields with existing company data
      // Contact Name
      if (companyData.contactName && companyData.contactName.trim()) {
        const contactField = document.getElementById('newContact');
        if (contactField) {
          contactField.value = companyData.contactName.trim();
          autofillResults.push('Contact Name');
          filledCount++;
          console.log('‚úÖ Autofilled contact name:', companyData.contactName);
        } else {
          console.log('‚ùå Contact field not found');
        }
      }

      // Phone
      if (companyData.phone && companyData.phone.trim()) {
        const phoneField = document.getElementById('newPhone');
        if (phoneField) {
          phoneField.value = companyData.phone.trim();
          autofillResults.push('Phone');
          filledCount++;
          console.log('‚úÖ Autofilled phone:', companyData.phone);
        } else {
          console.log('‚ùå Phone field not found');
        }
      }

      // Address
      if (companyData.address && companyData.address.trim()) {
        const addressField = document.getElementById('newAddress');
        if (addressField) {
          addressField.value = companyData.address.trim();
          autofillResults.push('Address');
          filledCount++;
          console.log('‚úÖ Autofilled address:', companyData.address);
        } else {
          console.log('‚ùå Address field not found');
        }
      }

      // Email
      if (companyData.email && companyData.email.trim()) {
        const emailField = document.getElementById('newEmail');
        if (emailField) {
          emailField.value = companyData.email.trim();
          autofillResults.push('Email');
          filledCount++;
          console.log('‚úÖ Autofilled email:', companyData.email);
        } else {
          console.log('‚ùå Email field not found');
        }
      }

      // Industry (if available)
      if (companyData.industry && companyData.industry.trim()) {
        const industryField = document.getElementById('newIndustry');
        if (industryField) {
          industryField.value = companyData.industry.trim();
          autofillResults.push('Industry');
          filledCount++;
          console.log('‚úÖ Autofilled industry:', companyData.industry);
        } else {
          console.log('‚ùå Industry field not found');
        }
      }

      // City (if available)
      if (companyData.city && companyData.city.trim()) {
        const cityField = document.getElementById('newCity');
        if (cityField) {
          cityField.value = companyData.city.trim();
          autofillResults.push('City');
          filledCount++;
          console.log('‚úÖ Autofilled city:', companyData.city);
        } else {
          console.log('‚ùå City field not found');
        }
      }

      // State (if available)
      if (companyData.state && companyData.state.trim()) {
        const stateField = document.getElementById('newState');
        if (stateField) {
          stateField.value = companyData.state.trim();
          autofillResults.push('State');
          filledCount++;
          console.log('‚úÖ Autofilled state:', companyData.state);
        } else {
          console.log('‚ùå State field not found');
        }
      }

      // Zip Code (if available)
      if (companyData.zip && companyData.zip.trim()) {
        const zipField = document.getElementById('newZip');
        if (zipField) {
          zipField.value = companyData.zip.trim();
          autofillResults.push('Zip Code');
          filledCount++;
          console.log('‚úÖ Autofilled zip code:', companyData.zip);
        } else {
          console.log('‚ùå Zip field not found');
        }
      }

      console.log(`üìä Filled ${filledCount} fields:`, autofillResults);

      // Show success feedback with detailed information
      if (filledCount > 0) {
        const fieldList = autofillResults.join(', ');
        showToast(`‚úÖ Company data loaded from prospects (${filledCount} fields: ${fieldList})`, 'success');
      } else {
        showToast('‚ö†Ô∏è Company found but no additional data available', 'warning');
      }

      // Ensure consistent company naming by using the exact name from prospect sheet
      if (companyData.companyName && companyData.companyName.trim()) {
        document.getElementById('companyInput').value = companyData.companyName.trim();
      }

      // Highlight the autofilled fields temporarily
      if (filledCount > 0) {
        autofillResults.forEach(function (fieldName) {
          const fieldId = fieldName.toLowerCase().replace(' ', '');
          const field = document.getElementById('new' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1));
          if (field) {
            const originalBackground = field.style.backgroundColor;
            field.style.backgroundColor = 'rgba(39, 174, 96, 0.1)';
            field.style.borderColor = 'var(--success)';
            field.style.boxShadow = '0 0 0 3px rgba(39, 174, 96, 0.1)';

            // Remove highlight after 2 seconds
            setTimeout(() => {
              field.style.backgroundColor = originalBackground;
              field.style.borderColor = 'var(--border)';
              field.style.boxShadow = 'none';
            }, 2000);
          }
        });
      }
    }

    // ========================================
    // Last Touch Info
    // ========================================
    function loadLastTouchInfo(companyName) {
      google.script.run
        .withSuccessHandler(displayLastTouchInfo)
        .withFailureHandler((error) => handleApiError(error, 'Last touch info failed'))
        .getLastTouchInfo(companyName);
    }

    function displayLastTouchInfo(result) {
      const card = document.getElementById('lastTouchCard');

      if (result && result.success && result.data) {
        const data = result.data;

        document.getElementById('lastContactDate').innerText = data.lastContact || '--';
        document.getElementById('daysSince').innerText = (data.daysSince || 0) + ' days';
        document.getElementById('lastOutcome').innerText = data.lastOutcome || '--';
        document.getElementById('nextSteps').innerText = data.nextSteps || '--';

        // Color coding based on days since
        const daysEl = document.getElementById('daysSince');
        daysEl.className = 'last-touch-value days-since';

        if (data.daysSince <= 7) {
          daysEl.classList.add('low');
        } else if (data.daysSince > 30) {
          daysEl.classList.add('high');
        }

        card.classList.add('active');
      } else {
        card.classList.remove('active');
      }
    }

    // ========================================
    // Prospect Status Checking
    // ========================================
    function checkProspectStatus(companyName) {
      if (!companyName || companyName.length < 2) {
        document.getElementById('prospectStatusIndicator').classList.remove('active');
        return;
      }

      // Show loading state
      const statusIndicator = document.getElementById('prospectStatusIndicator');
      const statusIcon = document.getElementById('prospectStatusIcon');
      const statusMessage = document.getElementById('prospectStatusMessage');

      statusIcon.textContent = '‚è≥';
      statusMessage.textContent = 'Checking company status...';
      statusIndicator.classList.remove('existing', 'new');
      statusIndicator.classList.add('active');

      google.script.run
        .withSuccessHandler(handleProspectStatusResult)
        .withFailureHandler(handleProspectStatusError)
        .checkProspectStatus(companyName);
    }

    function handleProspectStatusResult(result) {
      const statusIndicator = document.getElementById('prospectStatusIndicator');
      const statusIcon = document.getElementById('prospectStatusIcon');
      const statusMessage = document.getElementById('prospectStatusMessage');

      if (result && result.success) {
        if (result.exists) {
          // Company exists in prospects
          statusIndicator.classList.remove('new');
          statusIndicator.classList.add('existing');
          statusIcon.textContent = '‚úÖ';
          statusMessage.textContent = 'Existing prospect - ' + (result.status || 'Active');

          // Store company data for later use
          state.selectedCompanyData = {
            companyName: document.getElementById('companyInput').value,
            companyId: result.companyId,
            status: result.status,
            lastOutcome: result.lastOutcome,
            daysSinceLastContact: result.daysSinceLastContact
          };
        } else {
          // Company does not exist in prospects
          statusIndicator.classList.remove('existing');
          statusIndicator.classList.add('new');
          statusIcon.textContent = 'üÜï';
          statusMessage.textContent = 'New prospect - not in database';

          // Clear any stored company data
          state.selectedCompanyData = null;
        }
      } else {
        // Error case
        statusIndicator.classList.remove('existing', 'new');
        statusIcon.textContent = '‚ùå';
        statusMessage.textContent = 'Error checking status: ' + (result.error || 'Unknown error');
      }
    }

    function handleProspectStatusError(error) {
      const statusIndicator = document.getElementById('prospectStatusIndicator');
      const statusIcon = document.getElementById('prospectStatusIcon');
      const statusMessage = document.getElementById('prospectStatusMessage');

      statusIndicator.classList.remove('existing', 'new');
      statusIcon.textContent = '‚ùå';
      statusMessage.textContent = 'Error checking status: ' + (error.message || 'Unknown error');
      console.error('Prospect status check error:', error);
    }

    // ========================================
    // Save Entry with Duplicate LID Check
    // ========================================
    function loadStats() {
      const today = new Date().toISOString().split('T')[0];

      google.script.run
        .withSuccessHandler(res => {
          if (res && res.success && res.data) {
            const accs = res.data;
            document.getElementById('statVisits').innerText = accs.length || 0;
            document.getElementById('statWon').innerText = accs.filter(a => a.Status === 'WON').length || 0;
            document.getElementById('statHot').innerText = accs.filter(a =>
              (a.Status && a.Status.includes('HOT')) || (a.Status && a.Status.includes('STRONG'))
            ).length || 0;
          }
        })
        .withFailureHandler(error => console.error('Failed to load stats:', error))
        .getOutreachData(today, today);
    }

    // ========================================
    // Voice Recording
    // ========================================
    function toggleVoice() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showToast('‚ùå Voice not supported in this browser', 'error');
        return;
      }

      state.isRecording ? stopVoice() : startVoice();
    }

    function startVoice() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      state.recognition = new SpeechRecognition();
      state.recognition.continuous = true;
      state.recognition.interimResults = true;
      state.recognition.lang = 'en-US';

      state.recognition.onstart = () => {
        state.isRecording = true;
        updateVoiceUI(true);
      };

      state.recognition.onresult = (event) => {
        let transcript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          transcript += event.results[i][0].transcript;
        }

        const preview = document.getElementById('voicePreview');
        preview.textContent = transcript || 'Listening...';
        preview.classList.toggle('has-content', transcript.length > 0);
      };

      state.recognition.onend = () => {
        if (state.isRecording) {
          stopVoice();
        }
      };

      state.recognition.onerror = (event) => {
        console.error('Voice recognition error:', event.error);
        showToast('‚ùå Voice error: ' + event.error, 'error');
        stopVoice();
      };

      try {
        state.recognition.start();
      } catch (e) {
        showToast('‚ùå Failed to start voice recognition', 'error');
      }
    }

    function stopVoice() {
      if (state.recognition) {
        state.recognition.stop();
      }

      state.isRecording = false;
      updateVoiceUI(false);

      const text = document.getElementById('voicePreview').textContent;

      if (text && text !== 'Tap to record...' && text !== 'Listening...') {
        document.getElementById('notes').value = text;
        document.getElementById('voicePreview').classList.add('has-content');
      } else {
        document.getElementById('voicePreview').textContent = 'Tap to record...';
        document.getElementById('voicePreview').classList.remove('has-content');
      }
    }

    function updateVoiceUI(recording) {
      const btn = document.getElementById('voiceBtn');
      const icon = document.getElementById('micIcon');
      const text = document.getElementById('micText');

      btn.classList.toggle('recording', recording);
      icon.textContent = recording ? 'üéôÔ∏è' : 'üé§';
      text.textContent = recording ? 'Stop Recording' : 'Voice Notes';
    }

    /**
     * REFACTORED: Route Generation (Tab-Safe)
     */
    function generateRoute() {
      const today = new Date().toISOString().split('T')[0];
      showLoading(true);
      showToast('üöõ Fetching today\'s stops...', 'info');

      google.script.run
        .withSuccessHandler(res => {
          showLoading(false);
          if (res.success && res.data && res.data.length > 0) {
            const companies = res.data.map(e => e.company || e.Company || '').filter(n => n !== '');

            // Open in NEW TAB via Backend to bypass popup blockers
            google.script.run.generateRouteForCompanies(companies);
            showToast('üó∫Ô∏è Route sent to Maps!', 'success');
          } else {
            showToast('‚ö†Ô∏è No stops logged for today.', 'warning');
          }
        })
        .withFailureHandler(e => handleApiError(e, 'Route failed'))
        .getOutreachData(today, today);
    }

    function handleRouteResult(result) {
      showLoading(false);

      if (result.success && result.data) {
        const url = result.data.url;
        const failures = result.data.failures;

        // Open route in new tab
        if (url) {
          window.open(url, '_blank');
        }

        let message = 'üöõ Route generated!';

        if (failures && failures.length > 0) {
          message += ` (${failures.length} not found)`;
        }

        showToast(message, 'success');
      } else {
        showToast('‚ùå Route generation failed', 'error');
      }
    }

    /**
     * REFACTORED: Quick Action Handler (Non-Blocking)
     */
    function quickAction(action) {
      console.log('Action triggered:', action);

      // Turn off loading spinner immediately for UI fluidity
      if (action === 'reports') {
        showToast('üìä Initializing Report...', 'info');
        // Fire and Forget: Do not wait for success handler to finish before allowing interaction
        google.script.run
          .withFailureHandler(e => showToast('‚ùå Report Error: ' + e.message, 'error'))
          .showProfessionalReport();
        return;
      }

      switch (action) {
        case 'pipeline':
          showToast('üöÄ Opening Pipeline...', 'info');
          google.script.run.openSuiteCRM(); // Routes to the new Suite View
          break;
        case 'accounts':
          // Direct link to sheet to avoid modal blocking
          window.open('https://docs.google.com/spreadsheets/d/1veh2zY5h6sVktA7tdH8k85-TwNEEpdgUYYR16J2a3bdWFeLoTcP2TbJq/edit#gid=0', '_blank');
          break;
        case 'calendar':
          showCalendarView();
          break;
        default:
          showToast('‚ö†Ô∏è Feature in development', 'warning');
      }
    }

    // Show pipeline overview with stats by stage
    function showPipelineView() {
      showLoading(true);
      google.script.run
        .withSuccessHandler(function (data) {
          showLoading(false);
          if (data.success && data.data) {
            displayPipelineModal(data.data);
          } else {
            showToast('‚ùå Failed to load pipeline data', 'error');
          }
        })
        .withFailureHandler(function (error) {
          showLoading(false);
          showToast('‚ùå Pipeline error: ' + (error.message || 'Unknown error'), 'error');
        })
        .getDashboardMetrics();
    }

    // Show accounts management view
    function showAccountsView() {
      showLoading(true);

      // First try to open the New Accounts sheet
      try {
        var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
        var sheet = spreadsheet.getSheetByName('New Accounts');
        if (sheet) {
          sheet.activate();
          showLoading(false);
          showToast('‚úÖ New Accounts sheet opened', 'success');
          return;
        }
      } catch (e) {
        // Sheet not accessible, continue to show modal
      }

      // If sheet not accessible, show a summary modal instead
      google.script.run
        .withSuccessHandler(function (result) {
          showLoading(false);
          if (result.success && result.data) {
            displayAccountsModal(result.data);
          } else {
            showToast('‚ùå Failed to load account data', 'error');
          }
        })
        .withFailureHandler(function (error) {
          showLoading(false);
          showToast('‚ùå Accounts error: ' + (error.message || 'Unknown error'), 'error');
        })
        .getOutreachData(new Date().toISOString().split('T')[0], new Date().toISOString().split('T')[0]);
    }

    // Show calendar view of upcoming follow-ups
    function showCalendarView() {
      showLoading(true);

      // Get today's date and future dates
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(today.getDate() + 1);
      const nextWeek = new Date(today);
      nextWeek.setDate(today.getDate() + 7);

      // Get today's tasks
      google.script.run
        .withSuccessHandler(function (todayResult) {
          // Get tomorrow's tasks
          google.script.run
            .withSuccessHandler(function (tomorrowResult) {
              // Get this week's tasks
              google.script.run
                .withSuccessHandler(function (weekResult) {
                  showLoading(false);
                  displayCalendarModal({
                    today: todayResult.success ? todayResult.data : [],
                    tomorrow: tomorrowResult.success ? tomorrowResult.data : [],
                    thisWeek: weekResult.success ? weekResult.data : []
                  });
                })
                .withFailureHandler(function (error) {
                  showLoading(false);
                  showToast('‚ùå Calendar error: ' + (error.message || 'Unknown error'), 'error');
                })
                .getOutreachData(today.toISOString().split('T')[0], nextWeek.toISOString().split('T')[0]);
            })
            .withFailureHandler(function (error) {
              showLoading(false);
              showToast('‚ùå Calendar error: ' + (error.message || 'Unknown error'), 'error');
            })
            .getOutreachData(tomorrow.toISOString().split('T')[0], tomorrow.toISOString().split('T')[0]);
        })
        .withFailureHandler(function (error) {
          showLoading(false);
          showToast('‚ùå Calendar error: ' + (error.message || 'Unknown error'), 'error');
        })
        .getOutreachData(today.toISOString().split('T')[0], today.toISOString().split('T')[0]);
    }

    // Display pipeline overview modal
    function displayPipelineModal(data) {
      const pipeline = data.pipeline || {};
      const activity = data.activity || [];

      let html = `
        <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #0F2537; margin-bottom: 10px;">üìä Sales Pipeline Overview</h1>
            <p style="color: #666;">Current status of all leads and opportunities</p>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${pipeline.totalActive || 0}</div>
              <div style="font-size: 14px; opacity: 0.9;">Active Opportunities</div>
            </div>
            <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${(pipeline.byStage || {}).Lost || 0}</div>
              <div style="font-size: 14px; opacity: 0.9;">Lost Deals</div>
            </div>
          </div>

          <h3 style="color: #0F2537; margin-bottom: 15px;">üìà Pipeline by Stage</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
      `;

      // Pipeline stages
      const stages = ['Prospect', 'Nurture', 'Active Pursuit', 'Customer', 'Lost'];
      stages.forEach(stage => {
        const count = (pipeline.byStage || {})[stage] || 0;
        const colors = {
          'Prospect': '#3498db',
          'Nurture': '#f39c12',
          'Active Pursuit': '#e74c3c',
          'Customer': '#27ae60',
          'Lost': '#95a5a6'
        };
        html += `
          <div style="background: ${colors[stage]}; color: white; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${count}</div>
            <div style="font-size: 12px;">${stage}</div>
          </div>
        `;
      });

      html += `
          </div>

          <h3 style="color: #0F2537; margin-bottom: 15px;">üî• Recent Activity</h3>
          <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
      `;

      if (activity.length > 0) {
        activity.slice(0, 5).forEach(item => {
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;">
              <div>
                <div style="font-weight: 600; color: #2c3e50;">${item.company || 'Unknown Company'}</div>
                <div style="font-size: 12px; color: #7f8c8d;">${item.outcome || 'No outcome'}</div>
              </div>
              <div style="font-size: 12px; color: #95a5a6;">${item.date || 'No date'}</div>
            </div>
          `;
        });
      } else {
        html += '<p style="color: #666; text-align: center; margin: 20px 0;">No recent activity found</p>';
      }

      html += `
          </div>
        </div>
      `;

      const htmlOutput = HtmlService
        .createHtmlOutput(html)
        .setWidth(800)
        .setHeight(600);

      SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üìä Sales Pipeline');
    }

    // Display calendar modal with upcoming follow-ups
    function displayCalendarModal(data) {
      const today = new Date();
      const nextWeek = new Date(today);
      nextWeek.setDate(today.getDate() + 7);

      let html = `
        <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #0F2537; margin-bottom: 10px;">üìÖ Upcoming Follow-ups</h1>
            <p style="color: #666;">Scheduled activities and reminders</p>
          </div>

          <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h4 style="color: #856404; margin-bottom: 10px;">üìã Today's Tasks</h4>
      `;

      // Display today's tasks
      if (data.today && data.today.length > 0) {
        data.today.slice(0, 3).forEach(task => {
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #ffeaa7;">
              <div>
                <div style="font-weight: 600; color: #856404;">${task.company || task['Company Name'] || 'Unknown Company'}</div>
                <div style="font-size: 12px; color: #856404;">${task.Notes || 'No notes'}</div>
              </div>
              <div style="font-size: 12px; color: #856404; font-weight: 600;">${task.Status || 'Pending'}</div>
            </div>
          `;
        });
      } else {
        html += `<p style="color: #856404; margin: 0;">No tasks scheduled for today</p>`;
      }

      html += `
          </div>

          <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h4 style="color: #0c5460; margin-bottom: 10px;">‚è∞ This Week</h4>
      `;

      // Display this week's tasks
      if (data.thisWeek && data.thisWeek.length > 0) {
        data.thisWeek.slice(0, 5).forEach(task => {
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #bee5eb;">
              <div>
                <div style="font-weight: 600; color: #0c5460;">${task.company || task['Company Name'] || 'Unknown Company'}</div>
                <div style="font-size: 12px; color: #0c5460;">${task.Notes || 'No notes'}</div>
              </div>
              <div style="font-size: 12px; color: #0c5460; font-weight: 600;">${task.Status || 'Pending'}</div>
            </div>
          `;
        });
      } else {
        html += `<p style="color: #0c5460; margin: 0;">No follow-ups scheduled this week</p>`;
      }

      html += `
          </div>

          <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
            <h4 style="color: #495057; margin-bottom: 10px;">üìä Activity Summary</h4>
      `;

      // Calculate summary statistics
      const totalToday = data.today ? data.today.length : 0;
      const totalThisWeek = data.thisWeek ? data.thisWeek.length : 0;
      const totalActivities = totalToday + totalThisWeek;

      if (totalActivities > 0) {
        html += `<p style="color: #495057; margin: 0;">${totalActivities} scheduled activities this week (${totalToday} today, ${totalThisWeek} remaining)</p>`;
      } else {
        html += `<p style="color: #6c757d; margin: 0;">No scheduled activities found</p>`;
      }

      html += `
          </div>
        </div>
      `;

      const htmlOutput = HtmlService
        .createHtmlOutput(html)
        .setWidth(750)
        .setHeight(600);

      SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üìÖ Calendar View');
    }

    // Display accounts summary modal
    function displayAccountsModal(data) {
      // Calculate account statistics
      const totalAccounts = data.length;
      const deployedAccounts = data.filter(a => a.Status && a.Status.toUpperCase().includes('DEPLOYED')).length;
      const pendingAccounts = totalAccounts - deployedAccounts;

      let html = `
        <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #0F2537; margin-bottom: 10px;">üè¢ Account Management</h1>
            <p style="color: #666;">New account deployments and status</p>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${totalAccounts}</div>
              <div style="font-size: 14px; opacity: 0.9;">Total Accounts</div>
            </div>
            <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${deployedAccounts}</div>
              <div style="font-size: 14px; opacity: 0.9;">Deployed</div>
            </div>
            <div style="background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${pendingAccounts}</div>
              <div style="font-size: 14px; opacity: 0.9;">Pending</div>
            </div>
          </div>

          <h3 style="color: #0F2537; margin-bottom: 15px;">üìã Recent Account Activity</h3>
          <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
      `;

      if (data && data.length > 0) {
        // Show last 5 accounts
        data.slice(-5).reverse().forEach(account => {
          const statusColor = account.Status && account.Status.toUpperCase().includes('DEPLOYED') ? '#27ae60' : '#f39c12';
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee;">
              <div>
                <div style="font-weight: 600; color: #2c3e50;">${account.company || account['Company Name'] || 'Unknown Company'}</div>
                <div style="font-size: 12px; color: #7f8c8d;">${account.Notes || 'No notes available'}</div>
              </div>
              <div style="font-size: 12px; color: ${statusColor}; font-weight: 600;">${account.Status || 'Pending'}</div>
            </div>
          `;
        });
      } else {
        html += '<p style="color: #666; text-align: center; margin: 20px 0;">No account data available</p>';
      }

      html += `
          </div>

          <div style="margin-top: 20px; text-align: center;">
            <button onclick="window.open('', '_blank').close();" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
              üìä Open Full Accounts Sheet
            </button>
          </div>
        </div>
      `;

      const htmlOutput = HtmlService
        .createHtmlOutput(html)
        .setWidth(750)
        .setHeight(600);

      SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üè¢ Account Management');
    }

    // ========================================
    // Generate Date Range Report
    // ========================================
    function generateDateRangeReport() {
      const startDate = document.getElementById('reportStart').value;
      const endDate = document.getElementById('reportEnd').value;

      if (!startDate || !endDate) {
        showToast('Please select both start and end dates', 'error');
        return;
      }

      // Show loading immediately
      showLoading(true);

      // Set timeout to prevent infinite freeze
      const timeoutId = setTimeout(() => {
        showLoading(false);
        showToast('Report generation timed out. Try a shorter date range.', 'error');
      }, 30000); // 30 second timeout

      google.script.run
        .withSuccessHandler(function () { showLoading(false); showToast('Report opened', 'success'); })
        .withFailureHandler(function (e) { showLoading(false); handleApiError(e, 'Report generation failed'); })
        .showProfessionalReport(startDate, endDate);
    }

    // ========================================
    // Quick Date Selection
    // ========================================
    function setReportDates(range) {
      const today = new Date();
      let start, end;

      switch (range) {
        case 'thisWeek':
          // Start from Sunday of current week
          start = new Date(today);
          start.setDate(today.getDate() - today.getDay());
          break;
        case 'thisMonth':
          start = new Date(today.getFullYear(), today.getMonth(), 1);
          break;
        case 'last7':
          start = new Date(today);
          start.setDate(today.getDate() - 7);
          break;
        case 'last30':
          start = new Date(today);
          start.setDate(today.getDate() - 30);
          break;
      }

      end = today;

      document.getElementById('reportStart').value = formatDate(start);
      document.getElementById('reportEnd').value = formatDate(end);
    }

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    // ========================================
    // Copy Report to Clipboard
    // ========================================
    function copyReportToClipboard() {
      const textarea = document.getElementById('reportOutput');

      // Try modern API first
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textarea.value)
          .then(() => {
            showToast('üìã Report copied to clipboard!', 'success');
          })
          .catch(err => {
            fallbackCopy(textarea);
          });
      } else {
        fallbackCopy(textarea);
      }
    }

    function fallbackCopy(textarea) {
      textarea.select();
      textarea.setSelectionRange(0, 99999); // For mobile

      try {
        document.execCommand('copy');
        showToast('üìã Report copied to clipboard!', 'success');
      } catch (err) {
        showToast('‚ùå Failed to copy. Please select and copy manually.', 'error');
      }
    }

    // ========================================
    // Utility Functions
    // ========================================
    function showLoading(show) {
      const loading = document.getElementById('loading');
      loading.classList.toggle('active', show);
    }

    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.innerText = message;
      toast.className = 'toast ' + type;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========================================
    // New Company Fields Toggle
    // ========================================
    function toggleNewCompanyFields() {
      const fields = document.getElementById('newCompanyFields');
      const icon = document.getElementById('newCompanyToggleIcon');
      const text = document.getElementById('newCompanyToggleText');

      if (fields.style.display === 'none') {
        fields.style.display = 'block';
        icon.textContent = '-';
        text.textContent = 'Hide New Company Details';
      } else {
        fields.style.display = 'none';
        icon.textContent = '+';
        text.textContent = 'Add New Company Details';
      }
    }

    // ========================================
    // Control Center Toggle
    // ========================================
    function toggleControlCenter() {
      const content = document.getElementById('controlCenterContent');
      const icon = document.getElementById('controlCenterToggleIcon');

      content.classList.toggle('collapsed');
      icon.textContent = content.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
    }

    // ========================================
    // Control Center Tab Switching
    // ========================================
    function showTool(toolId, clickedTab = null) {
      // Hide all tools
      document.querySelectorAll('.control-tool').forEach(tool => {
        tool.classList.remove('active');
      });

      // Remove active class from all tabs
      document.querySelectorAll('.control-tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Show selected tool
      const selectedTool = document.getElementById('tool-' + toolId);
      if (selectedTool) {
        selectedTool.classList.add('active');
      }

      // Add active class to clicked tab (or find it if called programmatically)
      if (clickedTab) {
        clickedTab.classList.add('active');
      } else {
        // Find the tab by its onclick attribute
        const tab = document.querySelector(`[onclick="showTool('${toolId}')"]`);
        if (tab) {
          tab.classList.add('active');
        }
      }
    }

    // ========================================
    // CSV Import
    // ========================================
    function importCSV() {
      const csvText = document.getElementById('csvText').value.trim();
      const targetSheet = document.getElementById('importSheet').value;

      if (!csvText) {
        showToast('‚ö†Ô∏è Please paste CSV data first', 'warning');
        document.getElementById('csvText').focus();
        return;
      }

      showLoading(true);

      google.script.run
        .withSuccessHandler(handleCSVImportSuccess)
        .withFailureHandler(handleCSVImportError)
        .importCSVData(csvText, targetSheet);
    }

    function handleCSVImportSuccess(result) {
      showLoading(false);

      if (result.success) {
        const importedCount = result.data.importedCount || 0;
        const skippedCount = result.data.skippedCount || 0;

        let message = `‚úÖ Successfully imported ${importedCount} rows to ${result.data.sheetName}`;
        if (skippedCount > 0) {
          message += ` (${skippedCount} skipped due to validation)`;
        }

        showToast(message, 'success');

        // Clear the form
        document.getElementById('csvText').value = '';
      } else {
        showToast('‚ùå ' + (result.error || 'Import failed'), 'error');
      }
    }

    function handleCSVImportError(error) {
      showLoading(false);
      showToast('‚ùå CSV import error: ' + (error.message || error), 'error');
    }



    // ========================================
    // Context Detection (Dialog vs Sidebar)
    // ========================================
    function detectDisplayContext() {
      // Check if we're in a narrow container (sidebar) vs wide (dialog)
      const isSidebar = window.innerWidth < 500 || document.body.clientWidth < 500;

      if (isSidebar) {
        // Sidebar context - ensure proper styling
        document.body.classList.remove('dialog-context');
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
          sidebar.style.position = 'relative';
          sidebar.style.width = '100%';
          sidebar.style.left = 'auto';
          sidebar.style.top = 'auto';
        }
      } else {
        // Dialog context - apply floating styles
        document.body.classList.add('dialog-context');
      }
    }

    // ========================================
    // Load Validation Lists
    // ========================================
    function loadValidationLists() {
      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success && result.data) {
            populateValidationLists(result.data);
          } else {
            console.warn('Failed to load validation lists:', result.error);
          }
        })
        .withFailureHandler(function (error) {
          console.warn('Error loading validation lists:', error);
        })
        .getValidationLists();
    }

    function populateValidationLists(validationLists) {
      // Populate activity types
      const activityTypeSelect = document.getElementById('activityType');
      if (validationLists['Activity Types']) {
        // Clear existing options except the first
        while (activityTypeSelect.options.length > 1) {
          activityTypeSelect.remove(1);
        }
        // Add new options
        validationLists['Activity Types'].values.forEach(function (type) {
          const option = document.createElement('option');
          option.value = type;
          option.textContent = type;
          activityTypeSelect.appendChild(option);
        });
      }

      // Populate container sizes for new accounts
      // This would be used when implementing the account form validation

      // Store validation lists for form validation
      state.validationLists = validationLists;

      console.log('Validation lists loaded:', validationLists);
    }

    // ========================================
    // Save Callbacks
    // ========================================
    function handleSaveSuccess(result) {
      showLoading(false);

      if (result && result.success) {
        // Success - show confirmation and reset form
        const company = document.getElementById('companyInput').value.trim();
        showToast('‚úÖ Visit logged for ' + company, 'success');

        // Reset ALL form fields comprehensively
        document.getElementById('companyInput').value = '';
        document.getElementById('notes').value = '';
        document.getElementById('outreachId').value = '';

        // Reset new company fields
        document.getElementById('newAddress').value = '';
        document.getElementById('newPhone').value = '';
        document.getElementById('newContact').value = '';
        document.getElementById('newCity').value = 'Tyler';
        document.getElementById('newState').value = 'TX';
        document.getElementById('newZip').value = '';
        document.getElementById('newEmail').value = '';
        document.getElementById('newCompetitor').value = '';
        document.getElementById('newIndustry').value = '';

        // Reset date fields to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('nextDate').value = today;
        document.getElementById('activityType').value = 'Visit';

        // Reset status selection and UI elements
        state.selectedStatus = '';
        state.selectedOutcome = '';
        state.selectedStage = '';
        document.querySelectorAll('.outcome-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('workflowDisplay').style.display = 'none';

        // Hide informational cards
        document.getElementById('lastTouchCard').classList.remove('active');
        document.getElementById('prospectStatusIndicator').classList.remove('active');
        document.getElementById('accountForm').classList.remove('active');

        // Collapse new company fields section if it was expanded
        const newCompanyFields = document.getElementById('newCompanyFields');
        if (newCompanyFields.style.display !== 'none') {
          newCompanyFields.style.display = 'none';
          document.getElementById('newCompanyToggleIcon').textContent = '+';
          document.getElementById('newCompanyToggleText').textContent = 'Add New Company Details';
        }

        // Clear company data and voice preview
        state.selectedCompanyData = null;
        const voicePreview = document.getElementById('voicePreview');
        voicePreview.textContent = 'Tap to record...';
        voicePreview.classList.remove('has-content');

        // Refresh stats to show updated counts
        loadStats();

        // Focus on company input for quick next entry
        document.getElementById('companyInput').focus();
      } else {
        // Server returned failure
        showToast('‚ùå ' + (result.error || 'Save failed'), 'error');
      }
    }

    function handleSaveError(error) {
      showLoading(false);
      showToast('‚ùå ' + (error.message || error || 'Save failed'), 'error');
      console.error('Save error:', error);
    }

    /**
     * Standard Save Entry (Reliable Pattern)
     */
    function saveEntry() {
      const company = document.getElementById('companyInput').value.trim();
      if (!company || !state.selectedStatus) {
        showToast('‚ö†Ô∏è Company and Status required', 'warning');
        return;
      }

      showLoading(true);
      const formData = {
        company: company,
        outcome: state.selectedOutcome,
        stage: state.selectedStage,
        status: state.selectedStatus,
        notes: document.getElementById('notes').value,
        nextVisitDate: document.getElementById('nextDate').value,
        activityType: document.getElementById('activityType').value
      };

      google.script.run
        .withSuccessHandler(res => {
          showLoading(false);
          if (res.success) {
            showToast('‚úÖ Logged: ' + company, 'success');
            resetForm();
            loadStats();
          } else {
            showToast('‚ùå ' + res.error, 'error');
          }
        })
        .withFailureHandler(e => {
          showLoading(false);
          showToast('‚ùå Server error during save', 'error');
        })
        .addOutreachComplete(formData);
    }

    function resetForm() {
      document.getElementById('companyInput').value = '';
      document.getElementById('notes').value = '';
      document.querySelectorAll('.outcome-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('workflowDisplay').style.display = 'none';
    }

    function handleDuplicateCheck(result) {
      const company = document.getElementById('companyInput').value.trim();
      const outreachId = document.getElementById('outreachId').value.trim();

      if (result.success && result.isDuplicate) {
        showLoading(false);
        const message = `‚ö†Ô∏è Duplicate Outreach ID: ${outreachId}\n\n` +
          `Already exists for: ${result.existingCompany || 'Unknown'}\n` +
          `Do you want to save anyway?`;

        if (confirm(message)) {
          proceedWithSave(company, outreachId);
        }
      } else {
        proceedWithSave(company, outreachId);
      }
    }

    function handleDuplicateCheckError(error) {
      console.warn('Duplicate check failed, proceeding anyway:', error);
      const company = document.getElementById('companyInput').value.trim();
      const outreachId = document.getElementById('outreachId').value.trim();

      showLoading(false);
      if (confirm('‚ö†Ô∏è Could not verify Outreach ID uniqueness.\n\nSave anyway?')) {
        proceedWithSave(company, outreachId);
      }
    }

    function proceedWithSave(company, outreachId) {
      const data = {
        company: company,
        companyName: company,
        outcome: state.selectedOutcome, // NEW: Pass the Outcome
        stage: state.selectedStage,     // NEW: Pass the Stage
        status: state.selectedStatus,   // NEW: Pass the Status
        notes: document.getElementById('notes').value,
        nextVisitDate: document.getElementById('nextDate').value,
        activityType: document.getElementById('activityType').value
      };

      if (outreachId) {
        data.outreachId = outreachId;
      }

      if (state.selectedCompanyData && state.selectedCompanyData.companyId) {
        data.companyId = state.selectedCompanyData.companyId;
      }

      // Collect new company details for prospect creation
      const newCompanyFields = document.getElementById('newCompanyFields');
      if (newCompanyFields && newCompanyFields.style.display !== 'none') {
        // Only collect new company data if the section is expanded
        data.newCompanyData = {
          address: document.getElementById('newAddress').value,
          city: document.getElementById('newCity').value,
          state: document.getElementById('newState').value,
          zip: document.getElementById('newZip').value,
          industry: document.getElementById('newIndustry').value,
          contactName: document.getElementById('newContact').value,
          phone: document.getElementById('newPhone').value,
          email: document.getElementById('newEmail').value,
          competitor: document.getElementById('newCompetitor').value
        };
      }

      if (state.selectedOutcome === 'Account Won') {
        data.contact = document.getElementById('newContact').value;
        data.phone = document.getElementById('newPhone').value;
        data.site = document.getElementById('newAddress').value;
      }

      showLoading(true);

      google.script.run
        .withSuccessHandler(handleSaveSuccess)
        .withFailureHandler(handleSaveError)
        .addOutreachComplete(data);
    }
  </script>
</body>

</html>

[FILE_END: dashboard.html]
################################################################################

================================================================================
FILE_BEGIN: dateRangeReport.html
METADATA: Size=5402 bytes | Last_Modified=2026-02-05 14:37:16.025731
================================================================================
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #666;
      margin-bottom: 5px;
      text-transform: uppercase;
    }
    input[type="date"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .btn {
      width: 100%;
      padding: 12px;
      background: #0F2537;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }
    .btn:hover {
      background: #1a3a52;
    }
    .quick-options {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .quick-btn {
      flex: 1;
      padding: 8px;
      background: #e0e0e0;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
    }
    .quick-btn:hover {
      background: #d0d0d0;
    }
    #reportOutput {
      display: none;
      margin-top: 20px;
    }
    #reportText {
      width: 100%;
      height: 300px;
      font-family: monospace;
      font-size: 11px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }
    .copy-btn {
      width: 100%;
      padding: 10px;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="inputForm">
    <h3 style="margin-top: 0; color: #0F2537;">Generate Date Range Report</h3>
    
    <div class="quick-options">
      <button class="quick-btn" onclick="setThisWeek()">This Week</button>
      <button class="quick-btn" onclick="setThisMonth()">This Month</button>
      <button class="quick-btn" onclick="setLast7Days()">Last 7 Days</button>
      <button class="quick-btn" onclick="setLast30Days()">Last 30 Days</button>
    </div>
    
    <div class="form-group">
      <label for="startDate">Start Date</label>
      <input type="date" id="startDate">
    </div>
    
    <div class="form-group">
      <label for="endDate">End Date</label>
      <input type="date" id="endDate">
    </div>
    
    <button class="btn" onclick="generateReport()">Generate Report</button>
  </div>
  
  <div id="reportOutput">
    <button class="copy-btn" onclick="copyReport()">üìã Copy to Clipboard</button>
    <textarea id="reportText" readonly></textarea>
  </div>
  
  <script>
    // Set default dates to this week
    function setThisWeek() {
      var today = new Date();
      var startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - today.getDay());
      
      document.getElementById('startDate').value = formatDate(startOfWeek);
      document.getElementById('endDate').value = formatDate(today);
    }
    
    function setThisMonth() {
      var today = new Date();
      var startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      
      document.getElementById('startDate').value = formatDate(startOfMonth);
      document.getElementById('endDate').value = formatDate(today);
    }
    
    function setLast7Days() {
      var today = new Date();
      var sevenDaysAgo = new Date(today);
      sevenDaysAgo.setDate(today.getDate() - 7);
      
      document.getElementById('startDate').value = formatDate(sevenDaysAgo);
      document.getElementById('endDate').value = formatDate(today);
    }
    
    function setLast30Days() {
      var today = new Date();
      var thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 30);
      
      document.getElementById('startDate').value = formatDate(thirtyDaysAgo);
      document.getElementById('endDate').value = formatDate(today);
    }
    
    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }
    
    function generateReport() {
      var startDate = document.getElementById('startDate').value;
      var endDate = document.getElementById('endDate').value;
      
      if (!startDate || !endDate) {
        alert('Please select both start and end dates.');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(report) {
          document.getElementById('reportText').value = report;
          document.getElementById('inputForm').style.display = 'none';
          document.getElementById('reportOutput').style.display = 'block';
        })
        .withFailureHandler(function(error) {
          alert('Error: ' + error.message);
        })
        .generatePlainTextReportForRange(startDate, endDate);
    }
    
    function copyReport() {
      var textarea = document.getElementById('reportText');
      textarea.select();
      document.execCommand('copy');
      alert('Report copied to clipboard!');
    }
    
    // Initialize with this week
    setThisWeek();
  </script>
</body>
</html>


[FILE_END: dateRangeReport.html]
################################################################################

================================================================================
FILE_BEGIN: report.html
METADATA: Size=5583 bytes | Last_Modified=2026-02-05 14:37:16.025731
================================================================================
<!DOCTYPE html>
<html>
<head>
<style>
  /* General Styles for Browser Viewing */
  body { font-family: 'Segoe UI', Arial, sans-serif; color: #333; line-height: 1.5; margin: 0; padding: 20px; background-color: #f4f4f4; }
  .container { max-width: 800px; margin: 0 auto; background: #ffffff; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  
  /* Header */
  .header { background-color: #003366; color: #ffffff; padding: 20px; text-align: center; }
  .header h1 { margin: 0; font-size: 24px; }
  .header p { margin: 5px 0 0; font-size: 14px; opacity: 0.9; }

  /* KPI Section */
  .kpi-row { display: flex; justify-content: center; background-color: #eef2f5; padding: 15px 0; border-bottom: 2px solid #ddd; flex-wrap: wrap; }
  .kpi-box { text-align: center; width: 120px; margin: 0 10px; }
  .kpi-label { display: block; font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
  .kpi-value { display: block; font-size: 20px; font-weight: bold; margin-top: 5px; }
  .hot-lead { color: #d35400; } /* Burnt Orange for Hot Leads */

  /* Data Table */
  table { width: 100%; border-collapse: collapse; margin-top: 0; }
  th { background-color: #f8f9fa; color: #444; font-size: 12px; text-transform: uppercase; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; }
  td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: top; }
  tr:last-child td { border-bottom: none; }
  
  /* Outcome Badges */
  .badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap; }
  .b-interested { background-color: #e6fffa; color: #047857; border: 1px solid #047857; }
  .b-disqualified { background-color: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; }
  .b-cold { background-color: #eff6ff; color: #1e40af; border: 1px solid #1e40af; }
  .b-contact { background-color: #fff7ed; color: #c2410c; border: 1px solid #c2410c; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üöÄ K&L Recycling</h1>
    <p>Enterprise Operations Report | 01/14/2026 - 01/14/2026</p>
  </div>

  <div class="kpi-row">
    <div class="kpi-box">
      <span class="kpi-label">Total Visits</span>
      <span class="kpi-value">11</span>
    </div>
    <div class="kpi-box">
      <span class="kpi-label">New Wins</span>
      <span class="kpi-value">0</span>
    </div>
    <div class="kpi-box">
      <span class="kpi-label">üî• Hot Leads</span>
      <span class="kpi-value hot-lead">2</span>
    </div>
  </div>

  <table width="100%" cellpadding="0" cellspacing="0">
    <thead>
      <tr>
        <th width="20%">Company</th>
        <th width="12%">Date</th>
        <th width="15%">Outcome</th>
        <th>Notes</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>Generac</strong></td>
        <td>01/14</td>
        <td><span class="badge b-disqualified">Disqualified</span></td>
        <td>Spoke to GM. Not enough scrap to warrant a roll off. Front office confusion regarding scrap definition.</td>
      </tr>
      <tr>
        <td><strong>Raney Appliance Service</strong></td>
        <td>01/14</td>
        <td><span class="badge b-disqualified">Disqualified</span></td>
        <td>Low volume, but upcoming clean up. Will call when ready.</td>
      </tr>
      <tr>
        <td><strong>Pro Custom Auto Works</strong></td>
        <td>01/14</td>
        <td><span class="badge b-interested">Interested</span></td>
        <td><strong>Target:</strong> Owner needs large cleanup/roll off. Currently uses Huntwell but interested in switching. Will call next week.</td>
      </tr>
      <tr>
        <td><strong>Larry Cathy</strong></td>
        <td>01/14</td>
        <td><span class="badge b-contact">Initial Contact</span></td>
        <td>Owner out of office; office locked. Plan to visit tomorrow morning.</td>
      </tr>
      <tr>
        <td><strong>Goodyear</strong></td>
        <td>01/14</td>
        <td><span class="badge b-disqualified">Disqualified</span></td>
        <td>Insufficient scrap volume.</td>
      </tr>
      <tr>
        <td><strong>C. Davis Heating And Air</strong></td>
        <td>01/14</td>
        <td><span class="badge b-cold">Cold</span></td>
        <td>Currently allows unknown pickup without contact info. Left card for next interaction.</td>
      </tr>
      <tr>
        <td><strong>Northwest Collision Center</strong></td>
        <td>01/14</td>
        <td><span class="badge b-cold">Cold</span></td>
        <td>Employees take scrap (low volume). Left card with receptionist regarding premium pricing.</td>
      </tr>
      <tr>
        <td><strong>Watson Plumbing</strong></td>
        <td>01/14</td>
        <td><span class="badge b-cold">Cold</span></td>
        <td>Follow-up visit. Still unable to locate contact info for current scrap collector.</td>
      </tr>
      <tr>
        <td><strong>Tyler Building Systems</strong></td>
        <td>01/14</td>
        <td><span class="badge b-contact">Contacted</span></td>
        <td>No answer. Left 2 voicemails. Sending text tomorrow morning.</td>
      </tr>
      <tr>
        <td><strong>Faith Co</strong></td>
        <td>01/14</td>
        <td><span class="badge b-interested">Interested</span></td>
        <td>Spoke to receptionist; message left for owner/manager regarding outreach.</td>
      </tr>
    </tbody>
  </table>
</div>

</body>
</html>

[FILE_END: report.html]
################################################################################

================================================================================
FILE_BEGIN: CRM_Styles.html
METADATA: Size=5628 bytes | Last_Modified=2026-02-05 14:37:16.025731
================================================================================
<style>
    :root {
        --bg: #f3f4f6;
        --sidebar: #0f172a;
        --card: #ffffff;
        --accent: #10b981;
        /* K&L Green */
        --text-main: #1f2937;
        --text-dim: #6b7280;
    }

    body {
        margin: 0;
        font-family: 'Segoe UI', system-ui, sans-serif;
        background: var(--bg);
        color: var(--text-main);
    }

    .suite-wrapper {
        display: flex;
        height: 100vh;
    }

    /* Navigation */
    .suite-nav {
        width: 260px;
        background: var(--sidebar);
        color: white;
        display: flex;
        flex-direction: column;
    }

    .brand {
        padding: 30px;
        font-weight: 800;
        font-size: 1.4rem;
        letter-spacing: 1px;
        color: var(--accent);
    }

    .nav-links {
        flex: 1;
        padding: 10px;
    }

    .nav-item {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 5px;
        cursor: pointer;
        transition: 0.2s;
        color: #94a3b8;
    }

    .nav-item:hover {
        background: #1e293b;
        color: white;
    }

    .nav-item.active {
        background: var(--accent);
        color: white;
    }

    .nav-footer {
        padding: 20px;
        font-size: 0.8rem;
        color: #475569;
    }

    /* Main Area */
    .suite-main {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .suite-header {
        background: white;
        padding: 20px 40px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .suite-header h1 {
        font-size: 1.5rem;
        margin: 0;
    }

    /* Dashboard Widgets */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        padding: 30px 40px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .stat-card.accent {
        border-top: 4px solid #ef4444;
    }

    .stat-card.win {
        border-top: 4px solid var(--accent);
    }

    .stat-card h4 {
        margin: 0;
        font-size: 0.8rem;
        color: var(--text-dim);
        text-transform: uppercase;
    }

    .stat-card h2 {
        margin: 10px 0 0 0;
        font-size: 2rem;
    }

    .content-split {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 20px;
        padding: 0 40px 30px;
    }

    .card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .data-list {
        margin-top: 15px;
    }

    .list-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #f3f4f6;
    }

    .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 700;
    }

    .badge.high {
        background: #fee2e2;
        color: #b91c1c;
    }

    .badge.overdue {
        background: #000;
        color: #fff;
    }

    /* Pipeline View */
    .tab-content {
        padding: 30px 40px;
    }

    .pipeline-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
    }

    .pipeline-stage {
        background: white;
        border-radius: 12px;
        padding: 20px;
        min-height: 300px;
    }

    .pipeline-stage h4 {
        margin: 0 0 15px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #e5e7eb;
        font-size: 0.9rem;
    }

    .pipeline-deals {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .pipeline-deal {
        background: #f8fafc;
        padding: 12px;
        border-radius: 8px;
        border-left: 3px solid var(--accent);
    }

    .pipeline-deal strong {
        color: var(--text-main);
    }

    .pipeline-deal small {
        color: var(--text-dim);
        font-size: 0.8rem;
    }

    /* Prospects View */
    .prospects-toolbar {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .prospects-toolbar input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .prospects-toolbar select {
        padding: 12px 15px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9rem;
        background: white;
        cursor: pointer;
    }

    .prospects-table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .prospects-table {
        width: 100%;
        border-collapse: collapse;
    }

    .prospects-table th {
        background: #f8fafc;
        padding: 15px;
        text-align: left;
        font-size: 0.8rem;
        text-transform: uppercase;
        color: var(--text-dim);
        border-bottom: 1px solid #e5e7eb;
    }

    .prospects-table td {
        padding: 15px;
        border-bottom: 1px solid #f3f4f6;
    }

    .prospects-table tr:hover {
        background: #f8fafc;
    }

    /* Badge variations */
    .badge.hot {
        background: #fee2e2;
        color: #b91c1c;
    }

    .badge.warm {
        background: #fef3c7;
        color: #d97706;
    }

    .badge.cold {
        background: #e0f2fe;
        color: #0369a1;
    }

    .badge.won {
        background: #d1fae5;
        color: #059669;
    }
</style>

[FILE_END: CRM_Styles.html]
################################################################################

================================================================================
FILE_BEGIN: CRM_Suite.html
METADATA: Size=13225 bytes | Last_Modified=2026-02-06 09:40:27.692871
================================================================================
<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <?!= HtmlService.createHtmlOutputFromFile('CRM_Styles').getContent(); ?>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
  <div class="suite-wrapper">
    <nav class="suite-nav">
      <div class="brand">K&L RECYCLING</div>
      <div class="nav-links">
        <div class="nav-item active" onclick="switchTab('dashboard', this)">
          <i class="fas fa-th-large"></i> Dashboard
        </div>
        <div class="nav-item" onclick="switchTab('pipeline', this)">
          <i class="fas fa-filter"></i> Pipeline
        </div>
        <div class="nav-item" onclick="switchTab('prospects', this)">
          <i class="fas fa-address-book"></i> Prospects
        </div>
      </div>
      <div class="nav-footer">System v2.5.0</div>
    </nav>

    <main class="suite-main">
      <header class="suite-header">
        <h1 id="tab-title">Executive Dashboard</h1>
        <div class="user-profile">Operations Analyst</div>
      </header>

      <div id="view-dashboard" class="tab-content">
        <div class="stats-grid" id="stat-cards">
        </div>

        <div class="content-split">
          <div class="card">
            <h3>üî• Urgent Follow-ups</h3>
            <div id="urgent-list" class="data-list">Loading...</div>
          </div>
          <div class="card">
            <h3>‚úÖ Recent Wins</h3>
            <div id="wins-list" class="data-list">Loading...</div>
          </div>
        </div>
      </div>

      <div id="view-pipeline" class="tab-content" style="display: none;">
        <div class="pipeline-container" id="pipeline-container">
          <div class="pipeline-stage">
            <h4>üî• Hot</h4>
            <div id="pipeline-hot" class="pipeline-deals">Loading...</div>
          </div>
          <div class="pipeline-stage">
            <h4>‚òÄÔ∏è Warm</h4>
            <div id="pipeline-warm" class="pipeline-deals">Loading...</div>
          </div>
          <div class="pipeline-stage">
            <h4>‚ùÑÔ∏è Cold</h4>
            <div id="pipeline-cold" class="pipeline-deals">Loading...</div>
          </div>
          <div class="pipeline-stage">
            <h4>‚úÖ Won</h4>
            <div id="pipeline-won" class="pipeline-deals">Loading...</div>
          </div>
        </div>
      </div>

      <div id="view-prospects" class="tab-content" style="display: none;">
        <div class="prospects-toolbar">
          <input type="text" id="prospects-search" list="company-suggestions" placeholder="Search prospects..." onkeyup="filterProspects()">
          <datalist id="company-suggestions"></datalist>
          <select id="prospects-filter" onchange="filterProspects()">
            <option value="all">All Statuses</option>
            <option value="hot">Hot</option>
            <option value="warm">Warm</option>
            <option value="cold">Cold</option>
          </select>
        </div>
        <div class="prospects-table-container">
          <table class="prospects-table">
            <thead>
              <tr>
                <th>Company Name</th>
                <th>Contact Status</th>
                <th>Urgency</th>
                <th>Priority Score</th>
                <th>Last Outreach</th>
              </tr>
            </thead>
            <tbody id="prospects-table-body">
              <tr><td colspan="5">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Global data storage
    var crmData = {
      dashboard: null,
      pipeline: null,
      prospects: null
    };

    function callAPI(action, payload = {}) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .crmGateway({ action, payload });
      });
    }

    async function init() {
      console.log('CRM Dashboard initializing...');
      try {
        console.log('Calling GET_DASHBOARD_STATS...');
        const res = await callAPI('GET_DASHBOARD_STATS');
        console.log('API Response:', res);
        if (res.success) {
          console.log('Dashboard data loaded successfully, rendering...');
          crmData.dashboard = res;
          renderDashboard(res);
        } else {
          console.error('Failed to load dashboard stats:', res.error);
          showError('Failed to load dashboard data: ' + (res.error || 'Unknown error'));
        }
      } catch (e) {
        console.error('Error initializing dashboard:', e);
        console.error('Error stack:', e.stack);
        showError('Error loading dashboard: ' + (e.message || 'Unknown error'));
      }
      
      // Load company names for autocomplete
      loadCompanySuggestions();
    }

    function showError(message) {
      document.getElementById('stat-cards').innerHTML = '<div style="color: red; padding: 10px;">' + message + '</div>';
      document.getElementById('urgent-list').innerHTML = '<div style="color: red; padding: 10px;">' + message + '</div>';
      document.getElementById('wins-list').innerHTML = '<div style="color: red; padding: 10px;">' + message + '</div>';
    }

    function renderDashboard(data) {
      // Guard against null/undefined data
      if (!data) {
        console.error('renderDashboard: data is null or undefined');
        showError('No data available');
        return;
      }

      // Render Stat Cards with null checks
      const stats = data.pipeline || { total: 0, hot: 0, warm: 0, won: 0 };
      document.getElementById('stat-cards').innerHTML = `
        <div class="stat-card"><h4>PROSPECTS</h4><h2>${stats.total || 0}</h2></div>
        <div class="stat-card accent"><h4>HOT LEADS</h4><h2>${stats.hot || 0}</h2></div>
        <div class="stat-card"><h4>WARM LEADS</h4><h2>${stats.warm || 0}</h2></div>
        <div class="stat-card win"><h4>TOTAL WINS</h4><h2>${stats.won || 0}</h2></div>
      `;

      // Render Urgent List with null checks
      if (data.prospects && Array.isArray(data.prospects) && data.prospects.length > 0) {
        document.getElementById('urgent-list').innerHTML = data.prospects.map(p => `
          <div class="list-item">
            <span><strong>${p['company name'] || 'Unknown'}</strong></span>
            <span class="badge ${(p.urgencyband || '').toLowerCase()}">${p.urgencyband || 'N/A'}</span>
          </div>
        `).join('');
      } else {
        document.getElementById('urgent-list').innerHTML = '<div style="padding: 10px; color: #666;">No urgent prospects</div>';
      }

      // Render Wins with null checks
      if (data.accounts && Array.isArray(data.accounts) && data.accounts.length > 0) {
        document.getElementById('wins-list').innerHTML = data.accounts.map(a => `
          <div class="list-item">
            <span>${a['company name'] || 'Unknown Company'}</span>
            <small>${a['roll off container size'] || 'N/A'}</small>
          </div>
        `).join('');
      } else {
        document.getElementById('wins-list').innerHTML = '<div style="padding: 10px; color: #666;">No recent wins</div>';
      }
    }

    function renderPipeline(data) {
      // Guard against null/undefined data
      if (!data) {
        console.error('renderPipeline: data is null or undefined');
        return;
      }

      const stages = {
        hot: data.hot || [],
        warm: data.warm || [],
        cold: data.cold || [],
        won: data.won || []
      };

      document.getElementById('pipeline-hot').innerHTML = stages.hot.length > 0 ? 
        stages.hot.map(p => `<div class="pipeline-deal"><strong>${p['company name'] || 'Unknown'}</strong><br><small>${p['urgencyband'] || ''}</small></div>`).join('') : 
        '<div style="color: #999; padding: 10px; text-align: center;">No hot prospects</div>';

      document.getElementById('pipeline-warm').innerHTML = stages.warm.length > 0 ? 
        stages.warm.map(p => `<div class="pipeline-deal"><strong>${p['company name'] || 'Unknown'}</strong><br><small>${p['urgencyband'] || ''}</small></div>`).join('') : 
        '<div style="color: #999; padding: 10px; text-align: center;">No warm prospects</div>';

      document.getElementById('pipeline-cold').innerHTML = stages.cold.length > 0 ? 
        stages.cold.map(p => `<div class="pipeline-deal"><strong>${p['company name'] || 'Unknown'}</strong><br><small>${p['urgencyband'] || ''}</small></div>`).join('') : 
        '<div style="color: #999; padding: 10px; text-align: center;">No cold prospects</div>';

      document.getElementById('pipeline-won').innerHTML = stages.won.length > 0 ? 
        stages.won.map(p => `<div class="pipeline-deal"><strong>${p['company name'] || 'Unknown'}</strong><br><small>${p['timestamp'] || ''}</small></div>`).join('') : 
        '<div style="color: #999; padding: 10px; text-align: center;">No wins yet</div>';
    }

    function renderProspects(data) {
      if (!data || !data.all) {
        console.error('renderProspects: invalid data');
        crmData.prospects = [];
      } else {
        crmData.prospects = data.all;
      }
      updateProspectsTable(crmData.prospects);
    }

    function updateProspectsTable(prospects) {
      const tbody = document.getElementById('prospects-table-body');
      if (!prospects || prospects.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No prospects found</td></tr>';
        return;
      }
      tbody.innerHTML = prospects.map(p => `
        <tr>
          <td><strong>${p['company name'] || 'Unknown'}</strong></td>
          <td><span class="badge ${(p['contact status'] || '').toLowerCase()}">${p['contact status'] || 'N/A'}</span></td>
          <td>${p['urgencyband'] || 'N/A'}</td>
          <td>${p['priority score'] || 'N/A'}</td>
          <td>${p['last outreach date'] || 'N/A'}</td>
        </tr>
      `).join('');
    }

    function filterProspects() {
      const searchTerm = document.getElementById('prospects-search').value.toLowerCase();
      const filterStatus = document.getElementById('prospects-filter').value;

      if (!crmData.prospects) return;

      let filtered = crmData.prospects.filter(p => {
        const matchesSearch = (p['company name'] || '').toLowerCase().includes(searchTerm);
        const status = (p['contact status'] || '').toLowerCase();
        const matchesFilter = filterStatus === 'all' || status === filterStatus;
        return matchesSearch && matchesFilter;
      });

      updateProspectsTable(filtered);
    }

    // Load company names for autocomplete suggestions
    function loadCompanySuggestions() {
      google.script.run
        .withSuccessHandler(populateCompanySuggestions)
        .withFailureHandler(function(error) {
          console.error('Failed to load company suggestions:', error);
        })
        .getCompanyNamesForAutocomplete();
    }

    // Populate the datalist with company names
    function populateCompanySuggestions(names) {
      var datalist = document.getElementById('company-suggestions');
      if (!datalist) return;
      
      datalist.innerHTML = ''; // Clear existing
      
      if (!names || !Array.isArray(names)) {
        console.warn('No company names received for autocomplete');
        return;
      }
      
      names.forEach(function(name) {
        if (name) {
          var option = document.createElement('option');
          option.value = name;
          datalist.appendChild(option);
        }
      });
      
      console.log('Loaded ' + names.length + ' company suggestions');
    }

    async function switchTab(view, el) {
      // Update nav state
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('tab-title').innerText = view.charAt(0).toUpperCase() + view.slice(1);

      // Hide all views
      document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

      // Show selected view
      const viewEl = document.getElementById('view-' + view);
      if (viewEl) {
        viewEl.style.display = 'block';
      }

      // Load data for non-dashboard views
      if (view === 'pipeline' && !crmData.pipeline) {
        try {
          const res = await callAPI('GET_PIPELINE');
          if (res.success) {
            crmData.pipeline = res;
            renderPipeline(res);
          } else {
            console.error('Failed to load pipeline:', res.error);
          }
        } catch (e) {
          console.error('Error loading pipeline:', e);
        }
      } else if (view === 'pipeline' && crmData.pipeline) {
        renderPipeline(crmData.pipeline);
      }

      if (view === 'prospects' && !crmData.prospects) {
        try {
          const res = await callAPI('GET_PROSPECTS');
          if (res.success) {
            renderProspects(res);
          } else {
            console.error('Failed to load prospects:', res.error);
          }
        } catch (e) {
          console.error('Error loading prospects:', e);
        }
      }
    }

    window.onload = init;
  </script>
</body>

</html>


[FILE_END: CRM_Suite.html]
################################################################################

================================================================================
FILE_BEGIN: dashboard.html
METADATA: Size=120087 bytes | Last_Modified=2026-02-06 11:26:25.678967
================================================================================
<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>K&L CRM Dashboard</title>
  <style>
    /* ========================================
       CSS Variables - Design System
       ======================================== */
    :root {
      --primary: #0F2537;
      --primary-light: #1a3a52;
      --primary-dark: #0a1929;
      --success: #27ae60;
      --success-light: #2ecc71;
      --warning: #f39c12;
      --warning-light: #f1c40f;
      --danger: #c0392b;
      --danger-light: #e74c3c;
      --bg: #f2f2f6;
      --bg-dark: #e5e5ea;
      --card-bg: #ffffff;
      --text: #1c1c1e;
      --text-secondary: #8e8e93;
      --text-light: #ffffff;
      --border: #dcdde1;
      --border-light: #e9ecef;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
      --shadow-hover: 0 4px 16px rgba(0, 0, 0, 0.12);
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
      --transition: all 0.2s ease;
      --transition-slow: all 0.3s ease;
      --sidebar-width: 450px;
      --sidebar-min-width: 320px;
      --sidebar-max-width: 600px;
      --header-height: 64px;
    }

    /* CRM Dashboard Panel */
    .crm-summary-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .crm-tile {
      padding: 10px;
      border-radius: var(--radius-sm);
      text-align: center;
      font-size: 12px;
      font-weight: 700;
      box-shadow: var(--shadow);
    }

    .crm-tile.red {
      background: var(--danger);
      color: var(--text-light);
    }

    .crm-tile.yellow {
      background: var(--warning);
      color: var(--text);
    }

    .crm-tile.green {
      background: var(--success);
      color: var(--text-light);
    }

    .crm-tile.orange {
      background: var(--warning-light);
      color: var(--text);
    }

    .crm-tile.blue {
      background: var(--primary-light);
      color: var(--text-light);
    }

    .crm-tile.teal {
      background: #1abc9c;
      color: var(--text-light);
    }

    .crm-tile.gray {
      background: var(--text-secondary);
      color: var(--text-light);
    }

    .crm-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }

    .crm-table th,
    .crm-table td {
      padding: 8px;
      border-bottom: 1px solid var(--border-light);
      font-size: 12px;
    }

    .crm-table th {
      text-transform: uppercase;
      font-size: 10px;
      color: var(--text-secondary);
    }

    /* ========================================
       Reset & Base Styles
       ======================================== */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ========================================
       Sidebar Container (works in both dialog and sidebar contexts)
       ======================================== */
    .sidebar-container {
      position: relative;
      height: 100%;
      width: 100%;
      min-width: var(--sidebar-min-width);
      max-width: var(--sidebar-max-width);
      background: var(--card-bg);
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      z-index: 999999;
      transition: box-shadow var(--transition), transform var(--transition-slow);
      overflow: hidden;
      /* Prevent container overflow */
    }

    /* Dialog context - make it floating */
    body:has(.dialog-context) .sidebar-container {
      position: absolute;
      top: 0;
      left: 0;
      width: var(--sidebar-width);
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
    }

    .sidebar-container.floating {
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
      transform: translateX(-10px);
    }

    .sidebar-container.resizing {
      transition: none;
    }

    /* ========================================
       Resize Handle
       ======================================== */
    .resize-handle {
      position: absolute;
      top: 0;
      right: -8px;
      width: 16px;
      height: 100%;
      cursor: ew-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000000;
      background: linear-gradient(90deg, transparent, rgba(15, 37, 55, 0.1));
      border-radius: 0 8px 8px 0;
    }

    .resize-handle::before {
      content: '';
      height: 60px;
      width: 6px;
      background: var(--border);
      border-radius: 3px;
      transition: var(--transition);
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .resize-handle:hover::before,
    .resize-handle.active::before {
      background: var(--primary);
      box-shadow: 0 0 8px rgba(15, 37, 55, 0.4);
    }

    /* ========================================
       Sidebar Header
       ======================================== */
    .sidebar-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-shrink: 0;
      cursor: move;
      user-select: none;
      position: relative;
    }

    .sidebar-header::before {
      content: '‚ãÆ‚ãÆ';
      position: absolute;
      left: 8px;
      font-size: 10px;
      opacity: 0.6;
      letter-spacing: 2px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-icon {
      font-size: 24px;
      line-height: 1;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
    }

    .brand-title {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.3px;
      line-height: 1.2;
    }

    .brand-subtitle {
      font-size: 11px;
      opacity: 0.85;
      font-weight: 500;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .time-badge {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(8px);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }

    /* ========================================
       Sidebar Content
       ======================================== */
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      scroll-behavior: smooth;
    }

    .sidebar-content::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar-content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .sidebar-content::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* ========================================
       Section Styles
       ======================================== */
    .section {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid var(--border-light);
      transition: var(--transition);
    }

    .section:hover {
      box-shadow: var(--shadow-hover);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .section-title-icon {
      font-size: 14px;
    }

    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, var(--border-light), transparent);
      margin-left: 8px;
    }

    /* ========================================
       Form Elements
       ======================================== */
    .form-group {
      margin-bottom: 8px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 9px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 3px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 6px 8px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-family: inherit;
      background: var(--card-bg);
      color: var(--text);
      transition: var(--transition);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(15, 37, 55, 0.1);
      transform: translateY(-1px);
    }

    .form-input::placeholder,
    .form-textarea::placeholder {
      color: var(--text-secondary);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
      max-height: 200px;
    }

    /* ========================================
       Status Buttons
       ======================================== */
    .status-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    /* ========================================
       Date Grid
       ======================================== */
    .date-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    /* ========================================
       Buttons
       ======================================== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
      opacity: 0;
      transition: var(--transition);
    }

    .btn:hover::before {
      opacity: 1;
    }

    .btn-primary {
      width: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      box-shadow: 0 4px 12px rgba(15, 37, 55, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(15, 37, 55, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-warning {
      width: 100%;
      background: linear-gradient(135deg, var(--warning) 0%, var(--warning-light) 100%);
      color: var(--text);
      box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
    }

    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
    }

    /* ========================================
       Stats Grid
       ======================================== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-dark) 100%);
      padding: 14px 10px;
      border-radius: var(--radius-sm);
      text-align: center;
      border: 1px solid var(--border-light);
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .stat-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--primary);
      line-height: 1.2;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ========================================
       Quick Links
       ======================================== */
    .quick-links {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .quick-link {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 12px 8px;
      background: var(--card-bg);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
      font-family: inherit;
      color: var(--text);
      text-decoration: none;
      cursor: pointer;
      transition: var(--transition);
    }

    .quick-link:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.05) 0%, transparent 100%);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    /* ========================================
       Suggestions / Autocomplete
       ======================================== */
    .suggestions-container {
      position: relative;
    }

    .suggestions {
      position: absolute;
      top: calc(100% - 2px);
      left: 0;
      right: 0;
      background: var(--card-bg);
      border: 2px solid var(--primary);
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      max-height: 180px;
      overflow-y: auto;
      display: none;
      z-index: 1000001;
      box-shadow: var(--shadow-lg);
      border-top: none;
    }

    .suggestions.active {
      display: block;
      animation: slideDown 0.2s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .suggestion-item {
      padding: 12px 14px;
      font-size: 14px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-light);
      transition: var(--transition);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item:hover,
    .suggestion-item.highlighted {
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.08) 0%, transparent 100%);
      color: var(--primary);
    }

    /* ========================================
       Last Touch Card
       ======================================== */
    .last-touch-card {
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-dark) 100%);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      padding: 14px;
      margin-top: 12px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .last-touch-card.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .last-touch-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .last-touch-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 13px;
    }

    .last-touch-item {
      background: var(--card-bg);
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border-light);
    }

    .last-touch-label {
      display: block;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 4px;
    }

    .last-touch-value {
      font-weight: 700;
      color: var(--text);
      word-break: break-word;
    }

    .days-since {
      font-weight: 800;
      color: var(--warning);
    }

    .days-since.low {
      color: var(--success);
    }

    .days-since.high {
      color: var(--danger);
    }

    /* ========================================
       Account Form
       ======================================== */
    .account-form {
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.08) 0%, rgba(46, 204, 113, 0.05) 100%);
      border: 2px solid var(--success);
      border-radius: var(--radius-sm);
      padding: 14px;
      margin-top: 12px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .account-form.active {
      display: block;
    }

    .account-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 700;
      color: var(--success);
      margin-bottom: 12px;
    }

    /* ========================================
       Voice Section
       ======================================== */
    .voice-section {
      margin-top: 12px;
    }

    .voice-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      font-family: inherit;
      transition: var(--transition);
      box-shadow: 0 4px 12px rgba(15, 37, 55, 0.3);
    }

    .voice-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(15, 37, 55, 0.4);
    }

    .voice-btn.recording {
      background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
      animation: pulse 1.2s ease-in-out infinite;
      box-shadow: 0 4px 12px rgba(192, 57, 43, 0.3);
    }

    .voice-btn.recording:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 20px rgba(192, 57, 43, 0.4);
    }

    @keyframes pulse {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.4);
      }

      50% {
        box-shadow: 0 0 0 12px rgba(192, 57, 43, 0);
      }
    }

    .voice-preview {
      background: var(--bg);
      border: 2px dashed var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 8px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      transition: var(--transition);
    }

    .voice-preview.has-content {
      border-style: solid;
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.05) 0%, transparent 100%);
      color: var(--text);
    }

    /* ========================================
       Shortcut Hint
       ======================================== */
    .shortcut-hint {
      font-size: 11px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 12px;
      font-style: italic;
      opacity: 0.8;
    }

    /* ========================================
       Toast Notifications
       ======================================== */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--primary);
      color: var(--text-light);
      padding: 14px 24px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 600;
      display: none;
      z-index: 1000002;
      box-shadow: var(--shadow-lg);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .toast.show {
      display: block;
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.warning {
      background: var(--warning);
      color: var(--text);
    }

    /* ========================================
       Loading Overlay
       ======================================== */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .loading-overlay.active {
      display: flex;
      opacity: 1;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ========================================
       Prospect Status Indicator
       ======================================== */
    .prospect-status-indicator {
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-dark) 100%);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      margin-bottom: 12px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .status-icon {
      font-size: 18px;
      margin-bottom: 6px;
    }

    .status-message {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .prospect-status-indicator.existing {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.08) 0%, transparent 100%);
    }

    .prospect-status-indicator.new {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.08) 0%, transparent 100%);
    }

    .prospect-status-indicator.existing .status-icon {
      color: var(--success);
    }

    .prospect-status-indicator.new .status-icon {
      color: var(--primary);
    }

    /* ========================================
       Workflow Display
       ======================================== */
    .workflow-display {
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-dark) 100%);
      border: 2px solid var(--primary);
      border-radius: var(--radius-sm);
      padding: 14px;
      margin-top: 12px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .workflow-display.urgent {
      border-color: var(--danger);
      background: linear-gradient(135deg, rgba(192, 57, 43, 0.08) 0%, rgba(192, 57, 43, 0.05) 100%);
    }

    .workflow-display.high {
      border-color: var(--warning);
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.08) 0%, rgba(243, 156, 18, 0.05) 100%);
    }

    .workflow-display.medium {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.08) 0%, rgba(15, 37, 55, 0.05) 100%);
    }

    .workflow-display.low {
      border-color: var(--text-secondary);
      background: linear-gradient(135deg, rgba(142, 142, 147, 0.08) 0%, rgba(142, 142, 147, 0.05) 100%);
    }

    .workflow-status {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .workflow-item {
      background: var(--card-bg);
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid var(--border-light);
      text-align: center;
    }

    .workflow-label {
      display: block;
      font-size: 9px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .workflow-value {
      font-size: 12px;
      font-weight: 700;
      color: var(--text);
    }

    .workflow-value.success {
      color: var(--success);
    }

    .workflow-value.warning {
      color: var(--warning);
    }

    .workflow-value.info {
      color: var(--primary);
    }

    .workflow-value.danger {
      color: var(--danger);
    }

    /* ========================================
       Outcome Buttons
       ======================================== */
    .outcome-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 4px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--card-bg);
      cursor: pointer;
      font-size: 11px;
      font-weight: 700;
      font-family: inherit;
      color: var(--text-secondary);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      text-align: center;
      min-height: 48px;
    }

    .outcome-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
      opacity: 0;
      transition: var(--transition);
    }

    .outcome-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .outcome-btn:hover::before {
      opacity: 1;
    }

    .outcome-btn.active {
      border-color: var(--primary);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      box-shadow: 0 4px 12px rgba(15, 37, 55, 0.3);
      transform: translateY(-2px);
    }

    .outcome-btn.active::before {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
      opacity: 1;
    }

    .outcome-btn-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    /* ========================================
       Quick Date Options
       ======================================== */
    .quick-date-options {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .quick-date-btn {
      flex: 1;
      min-width: 70px;
      padding: 8px 6px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 600;
      font-family: inherit;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
    }

    .quick-date-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.05) 0%, transparent 100%);
    }

    /* ========================================
       Report Output
       ======================================== */
    .copy-report-btn {
      padding: 6px 12px;
      background: var(--success);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .copy-report-btn:hover {
      background: var(--success-light);
    }

    .report-textarea {
      width: 100%;
      min-height: 150px;
      max-height: 300px;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
      font-size: 11px;
      line-height: 1.5;
      background: var(--bg);
      color: var(--text);
      resize: vertical;
    }

    .report-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* ========================================
       Control Center - Tabbed Utilities
       ======================================== */
    .control-center-content {
      display: block;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .control-center-content.collapsed {
      max-height: 0;
      overflow: hidden;
    }

    .control-center-tabs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      margin-bottom: 12px;
    }

    .control-tab {
      padding: 8px 4px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 600;
      font-family: inherit;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
    }

    .control-tab:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.05) 0%, transparent 100%);
    }

    .control-tab.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(15, 37, 55, 0.2);
      transform: translateY(-1px);
    }

    .control-tool {
      display: none;
      animation: fadeIn 0.2s ease;
    }

    .control-tool.active {
      display: block;
    }

    /* ========================================
       Responsive Design
       ======================================== */
    @media (max-width: 768px) {
      .sidebar-container {
        width: 100% !important;
        min-width: 100% !important;
        max-width: 100% !important;
        height: 100vh;
        border-radius: 0;
      }

      .resize-handle {
        display: none;
      }

      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
      }

      .stat-card {
        padding: 10px 6px;
      }

      .stat-value {
        font-size: 20px;
      }

      .control-center-tabs {
        grid-template-columns: repeat(2, 1fr);
      }

      .control-tab {
        font-size: 9px;
        padding: 6px 4px;
      }
    }
  </style>
</head>

<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
  </div>

  <!-- Floating Sidebar -->
  <div class="sidebar-container" id="sidebar">
    <!-- Resize Handle -->
    <div class="resize-handle" id="resizeHandle"></div>

    <!-- Header -->
    <div class="sidebar-header">
      <div class="header-left">
        <span class="brand-icon">üó∫Ô∏è</span>
        <div class="brand-text">
          <span class="brand-title">K&L CRM</span>
          <span class="brand-subtitle">Field Operations</span>
        </div>
      </div>
      <div class="header-right">
        <div class="time-badge" id="currentTime">--:--</div>
      </div>
    </div>

    <!-- Content -->
    <div class="sidebar-content">
      <!-- Visit Entry Section -->
      <div class="section">
        <div class="visit-header">
          <div class="visit-title">
            <span>üìù</span>
            <span>Log Visit</span>
          </div>
        </div>

        <!-- Outreach ID -->
        <div class="form-group">
          <label for="outreachId" class="form-label">Outreach ID</label>
          <input type="text" id="outreachId" class="form-input"
            placeholder="Leave empty to auto-generate (e.g., LID-00128)">
        </div>

        <!-- Company Search with Autocomplete -->
        <div class="form-group suggestions-container">
          <label for="companyInput" class="form-label">Company <span class="required">*</span></label>
          <input type="text" id="companyInput" list="companyList" class="form-input" oninput="handleCompanySearchInput(this.value)" placeholder="Search or type new company..." autocomplete="off">
          <datalist id="companyList"></datalist>
          <input type="hidden" id="selectedCompanyId">
        </div>

        <!-- New Company Info Toggle -->
        <div class="form-group">
          <button type="button" class="quick-link" style="width:100%;" onclick="toggleNewCompanyFields()">
            <span id="newCompanyToggleIcon">+</span>
            <span id="newCompanyToggleText">Add New Company Details</span>
          </button>
        </div>

        <!-- New Company Additional Fields -->
        <div id="newCompanyFields" class="new-company-fields" style="display:none;">
          <div class="form-group">
            <label for="newAddress" class="form-label">Address</label>
            <input type="text" id="newAddress" class="form-input" placeholder="Street address">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newCity" class="form-label">City</label>
              <input type="text" id="newCity" class="form-input" placeholder="City" value="Tyler">
            </div>
            <div class="form-group">
              <label for="newState" class="form-label">State</label>
              <input type="text" id="newState" class="form-input" placeholder="State" value="TX">
            </div>
            <div class="form-group">
              <label for="newZip" class="form-label">Zip</label>
              <input type="text" id="newZip" class="form-input" placeholder="Zip Code">
            </div>
          </div>
          <div class="form-group">
            <label for="newIndustry" class="form-label">Industry</label>
            <select id="newIndustry" class="form-select">
              <option value="">Select Industry...</option>
              <option value="Agriculture">Agriculture</option>
              <option value="Appliance">Appliance</option>
              <option value="Automotive">Automotive</option>
              <option value="Business to business">Business to business</option>
              <option value="Construction">Construction</option>
              <option value="Electrical">Electrical</option>
              <option value="Fabrication">Fabrication</option>
              <option value="Fence">Fence</option>
              <option value="Gutter">Gutter</option>
              <option value="HVAC">HVAC</option>
              <option value="Junk Removal">Junk Removal</option>
              <option value="Manufacturing">Manufacturing</option>
              <option value="Metal Fabrication">Metal Fabrication</option>
              <option value="Other">Other</option>
              <option value="Plumbing">Plumbing</option>
              <option value="Retail">Retail</option>
              <option value="Roofing">Roofing</option>
              <option value="Trailer Dealer">Trailer Dealer</option>
              <option value="Warehouses">Warehouses</option>
              <option value="Welding">Welding</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newContact" class="form-label">Contact Name</label>
              <input type="text" id="newContact" class="form-input" placeholder="Contact">
            </div>
            <div class="form-group">
              <label for="newPhone" class="form-label">Phone</label>
              <input type="tel" id="newPhone" class="form-input" placeholder="Phone">
            </div>
          </div>
          <div class="form-group">
            <label for="newEmail" class="form-label">Email</label>
            <input type="email" id="newEmail" class="form-input" placeholder="Email">
          </div>
          <div class="form-group">
            <label for="competitor" class="form-label">Current Competitor</label>
            <select id="competitor" class="form-select">
              <option value="None">None / Unknown</option>
              <option value="AIM">AIM</option>
              <option value="Tyler Iron">Tyler Iron</option>
              <option value="Huntwell">Huntwell</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <!-- Last Touch Card -->
        <div class="last-touch-card" id="lastTouchCard">
          <div class="last-touch-header">
            <span>üìä</span>
            <span>Last Touch</span>
          </div>
          <div class="last-touch-grid">
            <div class="last-touch-item">
              <span class="last-touch-label">Last Contact</span>
              <span class="last-touch-value" id="lastContactDate">--</span>
            </div>
            <div class="last-touch-item">
              <span class="last-touch-label">Days Since</span>
              <span class="last-touch-value days-since" id="daysSince">--</span>
            </div>
            <div class="last-touch-item">
              <span class="last-touch-label">Last Outcome</span>
              <span class="last-touch-value" id="lastOutcome">--</span>
            </div>
            <div class="last-touch-item">
              <span class="last-touch-label">Next Steps</span>
              <span class="last-touch-value" id="nextSteps">--</span>
            </div>
          </div>
        </div>

        <!-- Outcome Selection (UPDATED TO MATCH SETTINGS) -->
        <label class="visit-type-label">Visit Outcome</label>
        <div class="outcome-btn-grid">
          <button type="button" class="outcome-btn" onclick="setOutcome('Account Won', this)">
            <span>üèÜ</span> Account Won
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Interested (Hot)', this)">
            <span>üî•</span> Interested (Hot)
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Interested (Warm)', this)">
            <span>üéØ</span> Interested (Warm)
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Initial Contact', this)">
            <span>üëã</span> Initial Contact
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Follow-Up', this)">
            <span>üîÑ</span> Follow-Up
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('No Answer', this)">
            <span>üìû</span> No Answer
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Not Interested', this)">
            <span>üö´</span> Not Interested
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Disqualified', this)">
            <span>‚ùå</span> Disqualified
          </button>
        </div>

        <!-- Stage & Status Display (Auto-populated based on Outcome) -->
        <div class="workflow-display" id="workflowDisplay" style="display:none;">
          <div class="form-group">
            <label class="visit-type-label">Workflow Status</label>
            <div class="workflow-status">
              <div class="workflow-item">
                <span class="workflow-label">Outcome:</span>
                <span class="workflow-value" id="outcomeValue">--</span>
              </div>
              <div class="workflow-item">
                <span class="workflow-label">Stage:</span>
                <span class="workflow-value" id="stageValue">--</span>
              </div>
              <div class="workflow-item">
                <span class="workflow-label">Status:</span>
                <span class="workflow-value" id="statusValue">--</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Date and Type -->
        <div class="date-grid">
          <div class="form-group">
            <label for="nextDate" class="form-label">Next Action</label>
            <input type="date" id="nextDate" class="form-input">
          </div>
          <div class="form-group">
            <label for="activityType" class="form-label">Type</label>
          <select id="activityType" class="form-select">
            <option value="Visit">Visit</option>
            <option value="Phone">Phone</option>
            <option value="Email">Email</option>
          </select>
          </div>
        </div>

        <!-- Notes -->
        <div class="form-group">
          <label for="notes" class="form-label">Notes</label>
          <textarea id="notes" class="form-textarea" rows="3" placeholder="Site details..."></textarea>
        </div>

        <!-- New Account Form (Only shows for WON) -->
        <div class="account-form" id="accountForm">
          <div class="account-title">
            <span>üöÄ</span>
            <span>New Account Details</span>
          </div>
          <div class="form-group">
            <input type="text" id="newContact" class="form-input" placeholder="Contact Name">
          </div>
          <div class="date-grid">
            <input type="text" id="newPhone" class="form-input" placeholder="Phone">
            <input type="text" id="newAddress" class="form-input" placeholder="Address">
          </div>
        </div>

        <!-- Prospect Status Indicator -->
        <div class="prospect-status-indicator" id="prospectStatusIndicator" style="margin-bottom: 12px; display: none;">
          <div class="status-icon" id="prospectStatusIcon">‚è≥</div>
          <div class="status-message" id="prospectStatusMessage">Checking company status...</div>
        </div>

        <!-- Save Button -->
        <button type="button" class="btn btn-primary" onclick="saveEntry()">
          <span>üíæ</span> Save Entry
        </button>

        <!-- Voice Section -->
        <div class="voice-section">
          <button type="button" class="voice-btn" id="voiceBtn" onclick="toggleVoice()">
            <span id="micIcon">üé§</span>
            <span id="micText">Voice Notes</span>
          </button>
          <div class="voice-preview" id="voicePreview">Tap to record...</div>
        </div>

        <!-- Keyboard Shortcuts -->
        <div class="shortcut-hint">Keyboard: Enter=Save ‚Ä¢ /=Search ‚Ä¢ R=Route</div>
      </div>

      <!-- Stats Section -->
      <div class="section">
        <div class="section-header">
          <div class="section-title">
            <span class="section-title-icon">üìä</span>
            Today's Overview
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statWon">0</div>
            <div class="stat-label">Wins</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statHot">0</div>
            <div class="stat-label">Hot</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statVisits">0</div>
            <div class="stat-label">Visits</div>
          </div>
        </div>
      </div>

      <!-- Summary Tiles -->
      <div id="crm-summary" class="crm-summary-grid"></div>

      <!-- Follow-Up Table -->
      <table id="crm-followups" class="crm-table">
        <thead>
          <tr>
            <th>Company</th>
            <th>Notes</th>
            <th>Countdown</th>
            <th>Urgency</th>
            <th>Priority</th>
            <th>Next Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Control Center - Collapsible Utility Panel -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">
          <span class="section-title-icon">‚öôÔ∏è</span>
          Control Center
        </div>
        <button type="button" class="quick-link" style="padding: 4px 8px; font-size: 10px;"
          onclick="toggleControlCenter()">
          <span id="controlCenterToggleIcon">‚ñº</span>
        </button>
      </div>

      <div id="controlCenterContent" class="control-center-content">
        <!-- Control Center Tabs -->
        <div class="control-center-tabs">
          <button type="button" class="control-tab active" onclick="showTool('route', this)">
            üó∫Ô∏è Route
          </button>
          <button type="button" class="control-tab" onclick="showTool('quick-actions', this)">
            ‚ö° Quick Actions
          </button>
          <button type="button" class="control-tab" onclick="showTool('csv', this)">
            üìÅ CSV Import
          </button>
          <button type="button" class="control-tab" onclick="showTool('report', this)">
            üìä Reports
          </button>
        </div>

        <!-- Route Planning Tool -->
        <div id="tool-route" class="control-tool active">
          <div class="date-grid">
            <div class="form-group">
              <label for="routeStart" class="form-label">Start</label>
              <input type="date" id="routeStart" class="form-input">
            </div>
            <div class="form-group">
              <label for="routeEnd" class="form-label">End</label>
              <input type="date" id="routeEnd" class="form-input">
            </div>
          </div>
          <button type="button" class="btn btn-warning" onclick="generateRoute()">
            <span>üó∫Ô∏è</span> Generate Route
          </button>
        </div>

        <!-- Quick Actions Tool -->
        <div id="tool-quick-actions" class="control-tool">
          <div class="quick-links">
            <button type="button" class="quick-link" onclick="quickAction('pipeline')">
              <span>üìä</span> Pipeline
            </button>
            <button type="button" class="quick-link" onclick="quickAction('accounts')">
              <span>üè¢</span> Accounts
            </button>
            <button type="button" class="quick-link" onclick="quickAction('calendar')">
              <span>üìÖ</span> Calendar
            </button>
            <button type="button" class="quick-link" onclick="quickAction('reports')">
              <span>üìà</span> Reports
            </button>
          </div>
        </div>

        <!-- CSV Import Tool -->
        <div id="tool-csv" class="control-tool">
          <div class="form-group">
            <label for="csvText" class="form-label">Paste CSV Data</label>
            <textarea id="csvText" class="form-textarea" rows="4" placeholder="Paste your CSV data here..."></textarea>
          </div>
          <div class="form-group">
            <label for="importSheet" class="form-label">Target Sheet</label>
            <select id="importSheet" class="form-select">
              <option value="Outreach">Outreach</option>
              <option value="Prospects">Prospects</option>
              <option value="New Accounts">New Accounts</option>
            </select>
          </div>
          <button type="button" class="btn btn-warning" onclick="importCSV()">
            <span>üì•</span> Import CSV
          </button>
        </div>

        <!-- Report Generation Tool -->
        <div id="tool-report" class="control-tool">
          <!-- Quick Date Options -->
          <div class="quick-date-options">
            <button type="button" class="quick-date-btn" onclick="setReportDates('thisWeek')">This Week</button>
            <button type="button" class="quick-date-btn" onclick="setReportDates('thisMonth')">This Month</button>
            <button type="button" class="quick-date-btn" onclick="setReportDates('last7')">Last 7 Days</button>
            <button type="button" class="quick-date-btn" onclick="setReportDates('last30')">Last 30 Days</button>
          </div>

          <div class="date-grid">
            <div class="form-group">
              <label for="reportStart" class="form-label">Start Date</label>
              <input type="date" id="reportStart" class="form-input">
            </div>
            <div class="form-group">
              <label for="reportEnd" class="form-label">End Date</label>
              <input type="date" id="reportEnd" class="form-input">
            </div>
          </div>
          <button type="button" class="btn btn-primary" onclick="generateDateRangeReport()">
            <span>üìä</span> Generate Report
          </button>
        </div>
      </div>
    </div>

    <!-- Report Output Section (hidden until report generated) -->
    <div class="section" id="reportOutputSection" style="display: none;">
      <div class="section-header">
        <div class="section-title">
          <span class="section-title-icon">üìã</span>
          Report Output
        </div>
        <button type="button" class="copy-report-btn" onclick="copyReportToClipboard()">
          üìã Copy
        </button>
      </div>
      <textarea id="reportOutput" class="report-textarea" readonly></textarea>
    </div>
  </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <script>
    // ========================================
    // Non-Blocking UI Logic
    // ========================================

    const state = {
      selectedStatus: '',
      isRecording: false,
      recognition: null,
      searchTimeout: null,
      selectedCompanyData: null
    };

    document.addEventListener('DOMContentLoaded', () => {
      detectDisplayContext();
      initializeDates();
      initializeResize();
      initializeEventListeners();
      updateTime();
      setInterval(updateTime, 60000);

      // Initialize control center tabs
      showTool('route');

      // Staggered loading to prevent server-side queuing bottlenecks
      setTimeout(loadStats, 100);
      setTimeout(loadValidationLists, 500);

      // Load company list for autocomplete
      loadCompanyAutocompleteList();
    });

    function initializeDates() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('nextDate').value = today;
      document.getElementById('routeStart').value = today;
      document.getElementById('routeEnd').value = today;
    }

    function initializeEventListeners() {
      // Close suggestions on outside click
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#companyInput') && !e.target.closest('.suggestions')) {
          document.getElementById('suggestions').classList.remove('active');
        }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', handleKeyboardShortcuts);
    }

    // ========================================
    // Company Autocomplete Logic
    // ========================================
    function loadCompanyAutocompleteList() {
      google.script.run
        .withSuccessHandler(function(companies) {
          const list = document.getElementById('companyList');
          if (companies && companies.length > 0) {
            companies.forEach(c => {
              const option = document.createElement('option');
              option.value = c.name || c.companyName || '';
              option.dataset.id = c.id || c.companyId || '';
              list.appendChild(option);
            });
            console.log('Loaded ' + companies.length + ' companies for autocomplete');
          }
        })
        .withFailureHandler(function(error) {
          console.warn('Failed to load company autocomplete list:', error);
        })
        .getCompanyAutocompleteList();
    }

    function handleCompanySearchInput(value) {
      clearTimeout(state.searchTimeout);

      if (value.length < 2) {
        document.getElementById('selectedCompanyId').value = '';
        document.getElementById('lastTouchCard').classList.remove('active');
        document.getElementById('prospectStatusIndicator').classList.remove('active');
        return;
      }

      // Check if value matches a datalist option
      const options = document.querySelectorAll('#companyList option');
      let matchedCompanyId = '';

      for (let opt of options) {
        if (opt.value === value) {
          matchedCompanyId = opt.dataset.id;
          break;
        }
      }

      if (matchedCompanyId) {
        document.getElementById('selectedCompanyId').value = matchedCompanyId;
        // Fetch and autofill prospect data
        google.script.run
          .withSuccessHandler(fillProspectData)
          .withFailureHandler(function(error) {
            console.warn('Failed to get prospect details:', error);
          })
          .getProspectDetails(matchedCompanyId);

        // Load last touch info
        loadLastTouchInfo(value);
        checkProspectStatus(value);
      } else {
        // New company - clear stored ID
        document.getElementById('selectedCompanyId').value = '';
      }
    }

    function fillProspectData(details) {
      if (details) {
        // Show the new company fields section
        const newCompanyFields = document.getElementById('newCompanyFields');
        const toggleIcon = document.getElementById('newCompanyToggleIcon');
        const toggleText = document.getElementById('newCompanyToggleText');

        if (newCompanyFields.style.display === 'none') {
          newCompanyFields.style.display = 'block';
          toggleIcon.textContent = '-';
          toggleText.textContent = 'Hide New Company Details';
        }

        // Autofill available fields
        if (details.address) {
          const field = document.getElementById('newAddress');
          if (field) field.value = details.address;
        }
        if (details.industry) {
          const field = document.getElementById('newIndustry');
          if (field) field.value = details.industry;
        }
        if (details.contactName) {
          const field = document.getElementById('newContact');
          if (field) field.value = details.contactName;
        }
        if (details.phone) {
          const field = document.getElementById('newPhone');
          if (field) field.value = details.phone;
        }
        if (details.email) {
          const field = document.getElementById('newEmail');
          if (field) field.value = details.email;
        }

        console.log('Autofilled prospect data:', details);
      }
    }

    // ========================================
    // Sidebar Resize & Drag Functionality
    // ========================================
    function initializeResize() {
      const sidebar = document.getElementById('sidebar');
      const handle = document.getElementById('resizeHandle');
      const header = document.querySelector('.sidebar-header');
      let isResizing = false;
      let isDragging = false;
      let startX, startY, startWidth, startLeft, startTop;

      // Resize functionality
      handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startWidth = sidebar.offsetWidth;
        sidebar.classList.add('resizing');
        handle.classList.add('active');
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
      });

      document.addEventListener('mousemove', (e) => {
        if (isResizing) {
          const diff = e.clientX - startX;
          const minWidth = 280;
          const maxWidth = 600;
          const newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth + diff));
          sidebar.style.width = newWidth + 'px';
        } else if (isDragging) {
          const diffX = e.clientX - startX;
          const diffY = e.clientY - startY;
          sidebar.style.left = (startLeft + diffX) + 'px';
          sidebar.style.top = (startTop + diffY) + 'px';
          sidebar.style.right = 'auto';
        }
      });

      document.addEventListener('mouseup', () => {
        if (isResizing || isDragging) {
          isResizing = false;
          isDragging = false;
          sidebar.classList.remove('resizing');
          handle.classList.remove('active');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });

      // Drag functionality (from header)
      header.addEventListener('mousedown', (e) => {
        // Only start drag if not clicking on header buttons
        if (e.target.closest('.header-right')) return;

        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        startLeft = sidebar.offsetLeft;
        startTop = sidebar.offsetTop;
        sidebar.classList.add('floating');
        document.body.style.cursor = 'move';
        document.body.style.userSelect = 'none';
      });

      // Touch support for resize
      handle.addEventListener('touchstart', (e) => {
        isResizing = true;
        startX = e.touches[0].clientX;
        startWidth = sidebar.offsetWidth;
        sidebar.classList.add('resizing');
      });

      document.addEventListener('touchmove', (e) => {
        if (isResizing) {
          e.preventDefault();
          const diff = e.touches[0].clientX - startX;
          const newWidth = Math.max(280, Math.min(600, startWidth + diff));
          sidebar.style.width = newWidth + 'px';
        }
      });

      document.addEventListener('touchend', () => {
        if (isResizing) {
          isResizing = false;
          sidebar.classList.remove('resizing');
        }
      });
    }

    // ========================================
    // Time Display
    // ========================================
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').innerText =
        now.toLocaleDateString('en-US', { weekday: 'short' }) + ' ' +
        now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    // ========================================
    // Keyboard Shortcuts
    // ========================================
    function handleKeyboardShortcuts(e) {
      // Ignore if typing in form fields
      if (e.target.matches('input, textarea, select')) {
        // Allow Enter to submit if in input and Shift not pressed
        if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey) {
          const tagName = e.target.tagName.toLowerCase();
          if (tagName !== 'textarea') {
            e.preventDefault();
            saveEntry();
          }
        }
        return;
      }

      switch (e.key) {
        case 'Enter':
          e.preventDefault();
          saveEntry();
          break;
        case '/':
          e.preventDefault();
          document.getElementById('companyInput').focus();
          break;
        case 'r':
        case 'R':
          generateRoute();
          break;
      }
    }

    // ========================================
    // Workflow-Based Status Selection
    // ========================================

    // Standardized workflow mapping based on user's unified approach
    const workflowMap = {
      'Account Won': {
        stage: 'Won',
        status: 'Active',
        priority: 'urgent',
        days: 1
      },
      'Interested (Hot)': {
        stage: 'Nurture',
        status: 'Interested (Hot)',
        priority: 'high',
        days: 7
      },
      'Interested (Warm)': {
        stage: 'Nurture',
        status: 'Interested (Warm)',
        priority: 'medium',
        days: 14
      },
      'Initial Contact': {
        stage: 'Outreach',
        status: 'Interested (Warm)',
        priority: 'medium',
        days: 30
      },
      'Follow-Up': {
        stage: 'Nurture',
        status: 'Interested (Warm)',
        priority: 'medium',
        days: 14
      },
      'No Answer': {
        stage: 'Outreach',
        status: 'Cold',
        priority: 'high',
        days: 3
      },
      'Not Interested': {
        stage: 'Lost',
        status: 'Disqualified',
        priority: 'low',
        days: 180
      },
      'Disqualified': {
        stage: 'Lost',
        status: 'Disqualified',
        priority: 'low',
        days: 0
      }
    };

    // Set outcome and auto-populate workflow
    function setOutcome(outcome, btn) {
      // Clear previous selections
      document.querySelectorAll('.outcome-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Get workflow details for this outcome
      const workflow = workflowMap[outcome];
      if (workflow) {
        // Update state with full workflow status
        state.selectedOutcome = outcome;
        state.selectedStage = workflow.stage;
        state.selectedStatus = workflow.status;

        // Update display
        document.getElementById('outcomeValue').textContent = outcome;
        document.getElementById('stageValue').textContent = workflow.stage;
        document.getElementById('statusValue').textContent = workflow.status;

        // Show workflow display
        document.getElementById('workflowDisplay').style.display = 'block';

        // Show account form for won accounts
        document.getElementById('accountForm').classList.toggle('active', outcome === 'Account Won');

        // Auto-set next date
        const nextDate = new Date();
        nextDate.setDate(nextDate.getDate() + workflow.days);
        document.getElementById('nextDate').value = nextDate.toISOString().split('T')[0];

        // Visual feedback based on priority
        updateWorkflowStyling(workflow.priority);
      }
    }

    // Update workflow display styling based on priority
    function updateWorkflowStyling(priority) {
      const display = document.getElementById('workflowDisplay');
      display.className = 'workflow-display';

      // Remove previous priority classes
      display.classList.remove('urgent', 'high', 'medium', 'low');

      // Add new priority class
      display.classList.add(priority);

      // Update status value styling
      const statusEl = document.getElementById('statusValue');
      statusEl.className = 'workflow-value';

      const statusColors = {
        'Won': 'success',
        'Interested (Hot)': 'warning',
        'Interested (Warm)': 'info',
        'Disqualified': 'danger',
        'Cold': 'danger',
        'Active': 'success',
        'Lost': 'danger',
        'Nurture': 'info',
        'Outreach': 'warning',
        'Prospect': 'info'
      };

      const status = state.selectedStatus;
      if (statusColors[status]) {
        statusEl.classList.add(statusColors[status]);
      }
    }

    // ========================================
    // Company Search
    // ========================================
    function searchCompany(input) {
      console.log('searchCompany called with input:', input.value);
      clearTimeout(state.searchTimeout);

      if (input.value.length < 2) {
        console.log('Input too short, hiding suggestions');
        document.getElementById('suggestions').classList.remove('active');
        document.getElementById('lastTouchCard').classList.remove('active');
        document.getElementById('prospectStatusIndicator').classList.remove('active');
        return;
      }

      console.log('Setting timeout for search');
      state.searchTimeout = setTimeout(() => {
        console.log('Calling apiSearchProspects with:', input.value);
        google.script.run
          .withSuccessHandler(handleSearchResults)
          .withFailureHandler(error => handleApiError(error, 'Search failed'))
          .apiSearchProspects(input.value);
      }, 300);
    }

    function handleSearchResults(result) {
      console.log('handleSearchResults called with:', result);
      let companies = [];

      if (result && typeof result === 'object') {
        if (Array.isArray(result)) {
          companies = result;
          console.log('Direct array result:', companies.length, 'companies');
        } else if (result.success && result.data) {
          companies = result.data;
          console.log('Object result with data:', companies.length, 'companies');
        } else if (result.success === false) {
          console.log('Search failed with error:', result.error);
          showToast('‚ùå ' + (result.error || 'Search failed'), 'error');
          return;
        } else {
          console.log('Unexpected result format:', result);
        }
      } else {
        console.log('Invalid result:', result);
      }

      console.log('Final companies array:', companies);
      if (companies.length > 0) {
        console.log('Calling showSuggestions with', companies.length, 'companies');
        showSuggestions(companies);
      } else {
        console.log('No companies found, hiding suggestions');
        // No results found - still hide dropdown
        document.getElementById('suggestions').classList.remove('active');
      }
    }

    // ========================================
    // Toast & Loading Helpers
    // ========================================
    function handleApiError(error, defaultMsg) {
      showLoading(false);
      showToast('‚ùå ' + (error.message || defaultMsg), 'error');
    }

    function showSuggestions(results) {
      console.log('showSuggestions called with:', results);
      const dropdown = document.getElementById('suggestions');
      console.log('Dropdown element:', dropdown);

      if (results && results.length > 0) {
        console.log('Generating HTML for', results.length, 'results');
        // Use data attributes instead of inline onclick to handle special characters
        dropdown.innerHTML = results.map((r, index) => {
          const escapedName = escapeHtml(r.companyName || r.company);
          const companyId = r.companyId || '';
          const address = escapeHtml(r.address || '');
          const phone = escapeHtml(r.phone || '');
          const email = escapeHtml(r.email || '');
          const contactName = escapeHtml(r.contactName || '');
          return `<div class="suggestion-item" data-index="${index}" data-name="${escapedName}" data-id="${companyId}" data-address="${address}" data-phone="${phone}" data-email="${email}" data-contact="${contactName}">${escapedName}</div>`;
        }).join('');

        console.log('HTML set, adding click listeners');
        // Add click listeners to suggestion items
        dropdown.querySelectorAll('.suggestion-item').forEach(item => {
          item.onclick = function () {
            console.log('Suggestion clicked:', this.dataset.name);
            const companyData = {
              companyName: this.dataset.name,
              companyId: this.dataset.id,
              address: this.dataset.address,
              phone: this.dataset.phone,
              email: this.dataset.email,
              contactName: this.dataset.contact
            };
            selectCompany(companyData);
          };
        });

        console.log('Adding active class to dropdown');
        dropdown.classList.add('active');
      } else {
        console.log('No results, removing active class');
        dropdown.classList.remove('active');
      }
    }

    function selectCompany(companyData) {
      // Handle both object and string input for backwards compatibility
      if (typeof companyData === 'string') {
        // Legacy: received just company name string
        document.getElementById('companyInput').value = companyData;
        document.getElementById('suggestions').classList.remove('active');
        loadLastTouchInfo(companyData);
        checkProspectStatus(companyData);
        return;
      }

      // New: receive company object with companyId - get comprehensive data for autofill
      const companyId = companyData.companyId;
      const companyName = companyData.companyName || companyData.company || '';

      document.getElementById('companyInput').value = companyName;
      document.getElementById('suggestions').classList.remove('active');

      // Visual feedback
      const input = document.getElementById('companyInput');
      input.style.borderColor = 'var(--success)';
      setTimeout(() => input.style.borderColor = 'var(--border)', 500);

      // Get comprehensive company details for autofill
      if (companyId) {
        showLoading(true);
        google.script.run
          .withSuccessHandler(function (result) {
            showLoading(false);
            if (result && result.success && result.data) {
              // Store comprehensive company data
              state.selectedCompanyData = result.data;
              // Autofill form with comprehensive data
              autofillCompanyData(result.data);
            } else {
              // Fallback to basic data if API call fails
              state.selectedCompanyData = companyData;
              autofillCompanyData(companyData);
            }
          })
          .withFailureHandler(function (error) {
            showLoading(false);
            console.warn('Failed to get comprehensive company details:', error);
            // Fallback to basic data
            state.selectedCompanyData = companyData;
            autofillCompanyData(companyData);
          })
          .getCompanyDetailsForAutofill(companyId);
      } else {
        // No companyId available, use basic data
        state.selectedCompanyData = companyData;
        autofillCompanyData(companyData);
      }

      // Load last touch information
      loadLastTouchInfo(companyName);

      // Check prospect status
      checkProspectStatus(companyName);
    }

    function autofillCompanyData(companyData) {
      console.log('üîç autofillCompanyData called with:', companyData);

      // Only autofill if we have a companyId (meaning it came from prospect sheet)
      if (!companyData.companyId) {
        console.log('‚ùå Skipping autofill - no companyId (company not found in prospect sheet)');
        console.log('Available data:', {
          companyName: companyData.companyName,
          companyId: companyData.companyId,
          hasContact: !!companyData.contactName,
          hasPhone: !!companyData.phone,
          hasAddress: !!companyData.address,
          hasEmail: !!companyData.email
        });
        showToast('‚ö†Ô∏è Company not found in prospects - manual entry required', 'warning');
        return;
      }

      console.log('‚úÖ Autofilling company data for:', companyData.companyName);
      console.log('Data to fill:', {
        contactName: companyData.contactName,
        phone: companyData.phone,
        address: companyData.address,
        email: companyData.email
      });

      // Show the "Add New Company Details" section so user can see the autofilled data
      const newCompanyFields = document.getElementById('newCompanyFields');
      const toggleIcon = document.getElementById('newCompanyToggleIcon');
      const toggleText = document.getElementById('newCompanyToggleText');

      if (newCompanyFields.style.display === 'none') {
        console.log('üìÇ Expanding new company details section');
        newCompanyFields.style.display = 'block';
        toggleIcon.textContent = '-';
        toggleText.textContent = 'Hide New Company Details';
      }

      let filledCount = 0;
      const autofillResults = [];

      // Autofill the expanded new company fields with existing company data
      // Contact Name
      if (companyData.contactName && companyData.contactName.trim()) {
        const contactField = document.getElementById('newContact');
        if (contactField) {
          contactField.value = companyData.contactName.trim();
          autofillResults.push('Contact Name');
          filledCount++;
          console.log('‚úÖ Autofilled contact name:', companyData.contactName);
        } else {
          console.log('‚ùå Contact field not found');
        }
      }

      // Phone
      if (companyData.phone && companyData.phone.trim()) {
        const phoneField = document.getElementById('newPhone');
        if (phoneField) {
          phoneField.value = companyData.phone.trim();
          autofillResults.push('Phone');
          filledCount++;
          console.log('‚úÖ Autofilled phone:', companyData.phone);
        } else {
          console.log('‚ùå Phone field not found');
        }
      }

      // Address
      if (companyData.address && companyData.address.trim()) {
        const addressField = document.getElementById('newAddress');
        if (addressField) {
          addressField.value = companyData.address.trim();
          autofillResults.push('Address');
          filledCount++;
          console.log('‚úÖ Autofilled address:', companyData.address);
        } else {
          console.log('‚ùå Address field not found');
        }
      }

      // Email
      if (companyData.email && companyData.email.trim()) {
        const emailField = document.getElementById('newEmail');
        if (emailField) {
          emailField.value = companyData.email.trim();
          autofillResults.push('Email');
          filledCount++;
          console.log('‚úÖ Autofilled email:', companyData.email);
        } else {
          console.log('‚ùå Email field not found');
        }
      }

      // Industry (if available)
      if (companyData.industry && companyData.industry.trim()) {
        const industryField = document.getElementById('newIndustry');
        if (industryField) {
          industryField.value = companyData.industry.trim();
          autofillResults.push('Industry');
          filledCount++;
          console.log('‚úÖ Autofilled industry:', companyData.industry);
        } else {
          console.log('‚ùå Industry field not found');
        }
      }

      // City (if available)
      if (companyData.city && companyData.city.trim()) {
        const cityField = document.getElementById('newCity');
        if (cityField) {
          cityField.value = companyData.city.trim();
          autofillResults.push('City');
          filledCount++;
          console.log('‚úÖ Autofilled city:', companyData.city);
        } else {
          console.log('‚ùå City field not found');
        }
      }

      // State (if available)
      if (companyData.state && companyData.state.trim()) {
        const stateField = document.getElementById('newState');
        if (stateField) {
          stateField.value = companyData.state.trim();
          autofillResults.push('State');
          filledCount++;
          console.log('‚úÖ Autofilled state:', companyData.state);
        } else {
          console.log('‚ùå State field not found');
        }
      }

      // Zip Code (if available)
      if (companyData.zip && companyData.zip.trim()) {
        const zipField = document.getElementById('newZip');
        if (zipField) {
          zipField.value = companyData.zip.trim();
          autofillResults.push('Zip Code');
          filledCount++;
          console.log('‚úÖ Autofilled zip code:', companyData.zip);
        } else {
          console.log('‚ùå Zip field not found');
        }
      }

      console.log(`üìä Filled ${filledCount} fields:`, autofillResults);

      // Show success feedback with detailed information
      if (filledCount > 0) {
        const fieldList = autofillResults.join(', ');
        showToast(`‚úÖ Company data loaded from prospects (${filledCount} fields: ${fieldList})`, 'success');
      } else {
        showToast('‚ö†Ô∏è Company found but no additional data available', 'warning');
      }

      // Ensure consistent company naming by using the exact name from prospect sheet
      if (companyData.companyName && companyData.companyName.trim()) {
        document.getElementById('companyInput').value = companyData.companyName.trim();
      }

      // Highlight the autofilled fields temporarily
      if (filledCount > 0) {
        autofillResults.forEach(function (fieldName) {
          const fieldId = fieldName.toLowerCase().replace(' ', '');
          const field = document.getElementById('new' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1));
          if (field) {
            const originalBackground = field.style.backgroundColor;
            field.style.backgroundColor = 'rgba(39, 174, 96, 0.1)';
            field.style.borderColor = 'var(--success)';
            field.style.boxShadow = '0 0 0 3px rgba(39, 174, 96, 0.1)';

            // Remove highlight after 2 seconds
            setTimeout(() => {
              field.style.backgroundColor = originalBackground;
              field.style.borderColor = 'var(--border)';
              field.style.boxShadow = 'none';
            }, 2000);
          }
        });
      }
    }

    // ========================================
    // Last Touch Info
    // ========================================
    function loadLastTouchInfo(companyName) {
      google.script.run
        .withSuccessHandler(displayLastTouchInfo)
        .withFailureHandler((error) => handleApiError(error, 'Last touch info failed'))
        .getLastTouchInfo(companyName);
    }

    function displayLastTouchInfo(result) {
      const card = document.getElementById('lastTouchCard');

      if (result && result.success && result.data) {
        const data = result.data;

        document.getElementById('lastContactDate').innerText = data.lastContact || '--';
        document.getElementById('daysSince').innerText = (data.daysSince || 0) + ' days';
        document.getElementById('lastOutcome').innerText = data.lastOutcome || '--';
        document.getElementById('nextSteps').innerText = data.nextSteps || '--';

        // Color coding based on days since
        const daysEl = document.getElementById('daysSince');
        daysEl.className = 'last-touch-value days-since';

        if (data.daysSince <= 7) {
          daysEl.classList.add('low');
        } else if (data.daysSince > 30) {
          daysEl.classList.add('high');
        }

        card.classList.add('active');
      } else {
        card.classList.remove('active');
      }
    }

    // ========================================
    // Prospect Status Checking
    // ========================================
    function checkProspectStatus(companyName) {
      if (!companyName || companyName.length < 2) {
        document.getElementById('prospectStatusIndicator').classList.remove('active');
        return;
      }

      // Show loading state
      const statusIndicator = document.getElementById('prospectStatusIndicator');
      const statusIcon = document.getElementById('prospectStatusIcon');
      const statusMessage = document.getElementById('prospectStatusMessage');

      statusIcon.textContent = '‚è≥';
      statusMessage.textContent = 'Checking company status...';
      statusIndicator.classList.remove('existing', 'new');
      statusIndicator.classList.add('active');

      google.script.run
        .withSuccessHandler(handleProspectStatusResult)
        .withFailureHandler(handleProspectStatusError)
        .checkProspectStatus(companyName);
    }

    function handleProspectStatusResult(result) {
      const statusIndicator = document.getElementById('prospectStatusIndicator');
      const statusIcon = document.getElementById('prospectStatusIcon');
      const statusMessage = document.getElementById('prospectStatusMessage');

      if (result && result.success) {
        if (result.exists) {
          // Company exists in prospects
          statusIndicator.classList.remove('new');
          statusIndicator.classList.add('existing');
          statusIcon.textContent = '‚úÖ';
          statusMessage.textContent = 'Existing prospect - ' + (result.status || 'Active');

          // Store company data for later use
          state.selectedCompanyData = {
            companyName: document.getElementById('companyInput').value,
            companyId: result.companyId,
            status: result.status,
            lastOutcome: result.lastOutcome,
            daysSinceLastContact: result.daysSinceLastContact
          };
        } else {
          // Company does not exist in prospects
          statusIndicator.classList.remove('existing');
          statusIndicator.classList.add('new');
          statusIcon.textContent = 'üÜï';
          statusMessage.textContent = 'New prospect - not in database';

          // Clear any stored company data
          state.selectedCompanyData = null;
        }
      } else {
        // Error case
        statusIndicator.classList.remove('existing', 'new');
        statusIcon.textContent = '‚ùå';
        statusMessage.textContent = 'Error checking status: ' + (result.error || 'Unknown error');
      }
    }

    function handleProspectStatusError(error) {
      const statusIndicator = document.getElementById('prospectStatusIndicator');
      const statusIcon = document.getElementById('prospectStatusIcon');
      const statusMessage = document.getElementById('prospectStatusMessage');

      statusIndicator.classList.remove('existing', 'new');
      statusIcon.textContent = '‚ùå';
      statusMessage.textContent = 'Error checking status: ' + (error.message || 'Unknown error');
      console.error('Prospect status check error:', error);
    }

    // ========================================
    // Save Entry with Duplicate LID Check
    // ========================================
    function loadStats() {
      const today = new Date().toISOString().split('T')[0];

      google.script.run
        .withSuccessHandler(res => {
          if (res && res.success && res.data) {
            const accs = res.data;
            document.getElementById('statVisits').innerText = accs.length || 0;
            document.getElementById('statWon').innerText = accs.filter(a => a.Status === 'WON').length || 0;
            document.getElementById('statHot').innerText = accs.filter(a =>
              (a.Status && a.Status.includes('HOT')) || (a.Status && a.Status.includes('STRONG'))
            ).length || 0;
          }
        })
        .withFailureHandler(error => console.error('Failed to load stats:', error))
        .getOutreachData(today, today);
    }

    // ========================================
    // Voice Recording
    // ========================================
    function toggleVoice() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showToast('‚ùå Voice not supported in this browser', 'error');
        return;
      }

      state.isRecording ? stopVoice() : startVoice();
    }

    function startVoice() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      state.recognition = new SpeechRecognition();
      state.recognition.continuous = true;
      state.recognition.interimResults = true;
      state.recognition.lang = 'en-US';

      state.recognition.onstart = () => {
        state.isRecording = true;
        updateVoiceUI(true);
      };

      state.recognition.onresult = (event) => {
        let transcript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          transcript += event.results[i][0].transcript;
        }

        const preview = document.getElementById('voicePreview');
        preview.textContent = transcript || 'Listening...';
        preview.classList.toggle('has-content', transcript.length > 0);
      };

      state.recognition.onend = () => {
        if (state.isRecording) {
          stopVoice();
        }
      };

      state.recognition.onerror = (event) => {
        console.error('Voice recognition error:', event.error);
        showToast('‚ùå Voice error: ' + event.error, 'error');
        stopVoice();
      };

      try {
        state.recognition.start();
      } catch (e) {
        showToast('‚ùå Failed to start voice recognition', 'error');
      }
    }

    function stopVoice() {
      if (state.recognition) {
        state.recognition.stop();
      }

      state.isRecording = false;
      updateVoiceUI(false);

      const text = document.getElementById('voicePreview').textContent;

      if (text && text !== 'Tap to record...' && text !== 'Listening...') {
        document.getElementById('notes').value = text;
        document.getElementById('voicePreview').classList.add('has-content');
      } else {
        document.getElementById('voicePreview').textContent = 'Tap to record...';
        document.getElementById('voicePreview').classList.remove('has-content');
      }
    }

    function updateVoiceUI(recording) {
      const btn = document.getElementById('voiceBtn');
      const icon = document.getElementById('micIcon');
      const text = document.getElementById('micText');

      btn.classList.toggle('recording', recording);
      icon.textContent = recording ? 'üéôÔ∏è' : 'üé§';
      text.textContent = recording ? 'Stop Recording' : 'Voice Notes';
    }

    /**
     * REFACTORED: Route Generation (Tab-Safe)
     */
    function generateRoute() {
      const today = new Date().toISOString().split('T')[0];
      showLoading(true);
      showToast('üöõ Fetching today\'s stops...', 'info');

      google.script.run
        .withSuccessHandler(res => {
          showLoading(false);
          if (res.success && res.data && res.data.length > 0) {
            const companies = res.data.map(e => e.company || e.Company || '').filter(n => n !== '');

            // Open in NEW TAB via Backend to bypass popup blockers
            google.script.run.generateRouteForCompanies(companies);
            showToast('üó∫Ô∏è Route sent to Maps!', 'success');
          } else {
            showToast('‚ö†Ô∏è No stops logged for today.', 'warning');
          }
        })
        .withFailureHandler(e => handleApiError(e, 'Route failed'))
        .getOutreachData(today, today);
    }

    function handleRouteResult(result) {
      showLoading(false);

      if (result.success && result.data) {
        const url = result.data.url;
        const failures = result.data.failures;

        // Open route in new tab
        if (url) {
          window.open(url, '_blank');
        }

        let message = 'üöõ Route generated!';

        if (failures && failures.length > 0) {
          message += ` (${failures.length} not found)`;
        }

        showToast(message, 'success');
      } else {
        showToast('‚ùå Route generation failed', 'error');
      }
    }

    /**
     * REFACTORED: Quick Action Handler (Non-Blocking)
     */
    function quickAction(action) {
      console.log('Action triggered:', action);

      // Turn off loading spinner immediately for UI fluidity
      if (action === 'reports') {
        showToast('üìä Initializing Report...', 'info');
        // Fire and Forget: Do not wait for success handler to finish before allowing interaction
        google.script.run
          .withFailureHandler(e => showToast('‚ùå Report Error: ' + e.message, 'error'))
          .showProfessionalReport();
        return;
      }

      switch (action) {
        case 'pipeline':
          showToast('üöÄ Opening Pipeline...', 'info');
          google.script.run.openSuiteCRM(); // Routes to the new Suite View
          break;
        case 'accounts':
          // Direct link to sheet to avoid modal blocking
          window.open('https://docs.google.com/spreadsheets/d/1veh2zY5h6sVktA7tdH8k85-TwNEEpdgUYYR16J2a3bdWFeLoTcP2TbJq/edit#gid=0', '_blank');
          break;
        case 'calendar':
          showCalendarView();
          break;
        default:
          showToast('‚ö†Ô∏è Feature in development', 'warning');
      }
    }

    // Show pipeline overview with stats by stage
    function showPipelineView() {
      showLoading(true);
      google.script.run
        .withSuccessHandler(function (data) {
          showLoading(false);
          if (data.success && data.data) {
            displayPipelineModal(data.data);
          } else {
            showToast('‚ùå Failed to load pipeline data', 'error');
          }
        })
        .withFailureHandler(function (error) {
          showLoading(false);
          showToast('‚ùå Pipeline error: ' + (error.message || 'Unknown error'), 'error');
        })
        .getDashboardMetrics();
    }

    // Show accounts management view
    function showAccountsView() {
      showLoading(true);

      // First try to open the New Accounts sheet
      try {
        var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
        var sheet = spreadsheet.getSheetByName('New Accounts');
        if (sheet) {
          sheet.activate();
          showLoading(false);
          showToast('‚úÖ New Accounts sheet opened', 'success');
          return;
        }
      } catch (e) {
        // Sheet not accessible, continue to show modal
      }

      // If sheet not accessible, show a summary modal instead
      google.script.run
        .withSuccessHandler(function (result) {
          showLoading(false);
          if (result.success && result.data) {
            displayAccountsModal(result.data);
          } else {
            showToast('‚ùå Failed to load account data', 'error');
          }
        })
        .withFailureHandler(function (error) {
          showLoading(false);
          showToast('‚ùå Accounts error: ' + (error.message || 'Unknown error'), 'error');
        })
        .getOutreachData(new Date().toISOString().split('T')[0], new Date().toISOString().split('T')[0]);
    }

    // Show calendar view of upcoming follow-ups
    function showCalendarView() {
      showLoading(true);

      // Get today's date and future dates
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(today.getDate() + 1);
      const nextWeek = new Date(today);
      nextWeek.setDate(today.getDate() + 7);

      // Get today's tasks
      google.script.run
        .withSuccessHandler(function (todayResult) {
          // Get tomorrow's tasks
          google.script.run
            .withSuccessHandler(function (tomorrowResult) {
              // Get this week's tasks
              google.script.run
                .withSuccessHandler(function (weekResult) {
                  showLoading(false);
                  displayCalendarModal({
                    today: todayResult.success ? todayResult.data : [],
                    tomorrow: tomorrowResult.success ? tomorrowResult.data : [],
                    thisWeek: weekResult.success ? weekResult.data : []
                  });
                })
                .withFailureHandler(function (error) {
                  showLoading(false);
                  showToast('‚ùå Calendar error: ' + (error.message || 'Unknown error'), 'error');
                })
                .getOutreachData(today.toISOString().split('T')[0], nextWeek.toISOString().split('T')[0]);
            })
            .withFailureHandler(function (error) {
              showLoading(false);
              showToast('‚ùå Calendar error: ' + (error.message || 'Unknown error'), 'error');
            })
            .getOutreachData(tomorrow.toISOString().split('T')[0], tomorrow.toISOString().split('T')[0]);
        })
        .withFailureHandler(function (error) {
          showLoading(false);
          showToast('‚ùå Calendar error: ' + (error.message || 'Unknown error'), 'error');
        })
        .getOutreachData(today.toISOString().split('T')[0], today.toISOString().split('T')[0]);
    }

    // Display pipeline overview modal
    function displayPipelineModal(data) {
      const pipeline = data.pipeline || {};
      const activity = data.activity || [];

      let html = `
        <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #0F2537; margin-bottom: 10px;">üìä Sales Pipeline Overview</h1>
            <p style="color: #666;">Current status of all leads and opportunities</p>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${pipeline.totalActive || 0}</div>
              <div style="font-size: 14px; opacity: 0.9;">Active Opportunities</div>
            </div>
            <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${(pipeline.byStage || {}).Lost || 0}</div>
              <div style="font-size: 14px; opacity: 0.9;">Lost Deals</div>
            </div>
          </div>

          <h3 style="color: #0F2537; margin-bottom: 15px;">üìà Pipeline by Stage</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
      `;

      // Pipeline stages
      const stages = ['Prospect', 'Nurture', 'Active Pursuit', 'Customer', 'Lost'];
      stages.forEach(stage => {
        const count = (pipeline.byStage || {})[stage] || 0;
        const colors = {
          'Prospect': '#3498db',
          'Nurture': '#f39c12',
          'Active Pursuit': '#e74c3c',
          'Customer': '#27ae60',
          'Lost': '#95a5a6'
        };
        html += `
          <div style="background: ${colors[stage]}; color: white; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${count}</div>
            <div style="font-size: 12px;">${stage}</div>
          </div>
        `;
      });

      html += `
          </div>

          <h3 style="color: #0F2537; margin-bottom: 15px;">üî• Recent Activity</h3>
          <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
      `;

      if (activity.length > 0) {
        activity.slice(0, 5).forEach(item => {
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;">
              <div>
                <div style="font-weight: 600; color: #2c3e50;">${item.company || 'Unknown Company'}</div>
                <div style="font-size: 12px; color: #7f8c8d;">${item.outcome || 'No outcome'}</div>
              </div>
              <div style="font-size: 12px; color: #95a5a6;">${item.date || 'No date'}</div>
            </div>
          `;
        });
      } else {
        html += '<p style="color: #666; text-align: center; margin: 20px 0;">No recent activity found</p>';
      }

      html += `
          </div>
        </div>
      `;

      const htmlOutput = HtmlService
        .createHtmlOutput(html)
        .setWidth(800)
        .setHeight(600);

      SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üìä Sales Pipeline');
    }

    // Display calendar modal with upcoming follow-ups
    function displayCalendarModal(data) {
      const today = new Date();
      const nextWeek = new Date(today);
      nextWeek.setDate(today.getDate() + 7);

      let html = `
        <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #0F2537; margin-bottom: 10px;">üìÖ Upcoming Follow-ups</h1>
            <p style="color: #666;">Scheduled activities and reminders</p>
          </div>

          <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h4 style="color: #856404; margin-bottom: 10px;">üìã Today's Tasks</h4>
      `;

      // Display today's tasks
      if (data.today && data.today.length > 0) {
        data.today.slice(0, 3).forEach(task => {
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #ffeaa7;">
              <div>
                <div style="font-weight: 600; color: #856404;">${task.company || task['Company Name'] || 'Unknown Company'}</div>
                <div style="font-size: 12px; color: #856404;">${task.Notes || 'No notes'}</div>
              </div>
              <div style="font-size: 12px; color: #856404; font-weight: 600;">${task.Status || 'Pending'}</div>
            </div>
          `;
        });
      } else {
        html += `<p style="color: #856404; margin: 0;">No tasks scheduled for today</p>`;
      }

      html += `
          </div>

          <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h4 style="color: #0c5460; margin-bottom: 10px;">‚è∞ This Week</h4>
      `;

      // Display this week's tasks
      if (data.thisWeek && data.thisWeek.length > 0) {
        data.thisWeek.slice(0, 5).forEach(task => {
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #bee5eb;">
              <div>
                <div style="font-weight: 600; color: #0c5460;">${task.company || task['Company Name'] || 'Unknown Company'}</div>
                <div style="font-size: 12px; color: #0c5460;">${task.Notes || 'No notes'}</div>
              </div>
              <div style="font-size: 12px; color: #0c5460; font-weight: 600;">${task.Status || 'Pending'}</div>
            </div>
          `;
        });
      } else {
        html += `<p style="color: #0c5460; margin: 0;">No follow-ups scheduled this week</p>`;
      }

      html += `
          </div>

          <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
            <h4 style="color: #495057; margin-bottom: 10px;">üìä Activity Summary</h4>
      `;

      // Calculate summary statistics
      const totalToday = data.today ? data.today.length : 0;
      const totalThisWeek = data.thisWeek ? data.thisWeek.length : 0;
      const totalActivities = totalToday + totalThisWeek;

      if (totalActivities > 0) {
        html += `<p style="color: #495057; margin: 0;">${totalActivities} scheduled activities this week (${totalToday} today, ${totalThisWeek} remaining)</p>`;
      } else {
        html += `<p style="color: #6c757d; margin: 0;">No scheduled activities found</p>`;
      }

      html += `
          </div>
        </div>
      `;

      const htmlOutput = HtmlService
        .createHtmlOutput(html)
        .setWidth(750)
        .setHeight(600);

      SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üìÖ Calendar View');
    }

    // Display accounts summary modal
    function displayAccountsModal(data) {
      // Calculate account statistics
      const totalAccounts = data.length;
      const deployedAccounts = data.filter(a => a.Status && a.Status.toUpperCase().includes('DEPLOYED')).length;
      const pendingAccounts = totalAccounts - deployedAccounts;

      let html = `
        <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #0F2537; margin-bottom: 10px;">üè¢ Account Management</h1>
            <p style="color: #666;">New account deployments and status</p>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${totalAccounts}</div>
              <div style="font-size: 14px; opacity: 0.9;">Total Accounts</div>
            </div>
            <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${deployedAccounts}</div>
              <div style="font-size: 14px; opacity: 0.9;">Deployed</div>
            </div>
            <div style="background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${pendingAccounts}</div>
              <div style="font-size: 14px; opacity: 0.9;">Pending</div>
            </div>
          </div>

          <h3 style="color: #0F2537; margin-bottom: 15px;">üìã Recent Account Activity</h3>
          <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
      `;

      if (data && data.length > 0) {
        // Show last 5 accounts
        data.slice(-5).reverse().forEach(account => {
          const statusColor = account.Status && account.Status.toUpperCase().includes('DEPLOYED') ? '#27ae60' : '#f39c12';
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee;">
              <div>
                <div style="font-weight: 600; color: #2c3e50;">${account.company || account['Company Name'] || 'Unknown Company'}</div>
                <div style="font-size: 12px; color: #7f8c8d;">${account.Notes || 'No notes available'}</div>
              </div>
              <div style="font-size: 12px; color: ${statusColor}; font-weight: 600;">${account.Status || 'Pending'}</div>
            </div>
          `;
        });
      } else {
        html += '<p style="color: #666; text-align: center; margin: 20px 0;">No account data available</p>';
      }

      html += `
          </div>

          <div style="margin-top: 20px; text-align: center;">
            <button onclick="window.open('', '_blank').close();" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
              üìä Open Full Accounts Sheet
            </button>
          </div>
        </div>
      `;

      const htmlOutput = HtmlService
        .createHtmlOutput(html)
        .setWidth(750)
        .setHeight(600);

      SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üè¢ Account Management');
    }

    // ========================================
    // Generate Date Range Report
    // ========================================
    function generateDateRangeReport() {
      const startDate = document.getElementById('reportStart').value;
      const endDate = document.getElementById('reportEnd').value;

      if (!startDate || !endDate) {
        showToast('Please select both start and end dates', 'error');
        return;
      }

      // Show loading immediately
      showLoading(true);

      // Set timeout to prevent infinite freeze
      const timeoutId = setTimeout(() => {
        showLoading(false);
        showToast('Report generation timed out. Try a shorter date range.', 'error');
      }, 30000); // 30 second timeout

      google.script.run
        .withSuccessHandler(function () { showLoading(false); showToast('Report opened', 'success'); })
        .withFailureHandler(function (e) { showLoading(false); handleApiError(e, 'Report generation failed'); })
        .showProfessionalReport(startDate, endDate);
    }

    // ========================================
    // Quick Date Selection
    // ========================================
    function setReportDates(range) {
      const today = new Date();
      let start, end;

      switch (range) {
        case 'thisWeek':
          // Start from Sunday of current week
          start = new Date(today);
          start.setDate(today.getDate() - today.getDay());
          break;
        case 'thisMonth':
          start = new Date(today.getFullYear(), today.getMonth(), 1);
          break;
        case 'last7':
          start = new Date(today);
          start.setDate(today.getDate() - 7);
          break;
        case 'last30':
          start = new Date(today);
          start.setDate(today.getDate() - 30);
          break;
      }

      end = today;

      document.getElementById('reportStart').value = formatDate(start);
      document.getElementById('reportEnd').value = formatDate(end);
    }

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    // ========================================
    // Copy Report to Clipboard
    // ========================================
    function copyReportToClipboard() {
      const textarea = document.getElementById('reportOutput');

      // Try modern API first
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textarea.value)
          .then(() => {
            showToast('üìã Report copied to clipboard!', 'success');
          })
          .catch(err => {
            fallbackCopy(textarea);
          });
      } else {
        fallbackCopy(textarea);
      }
    }

    function fallbackCopy(textarea) {
      textarea.select();
      textarea.setSelectionRange(0, 99999); // For mobile

      try {
        document.execCommand('copy');
        showToast('üìã Report copied to clipboard!', 'success');
      } catch (err) {
        showToast('‚ùå Failed to copy. Please select and copy manually.', 'error');
      }
    }

    // ========================================
    // Utility Functions
    // ========================================
    function showLoading(show) {
      const loading = document.getElementById('loading');
      loading.classList.toggle('active', show);
    }

    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.innerText = message;
      toast.className = 'toast ' + type;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========================================
    // New Company Fields Toggle
    // ========================================
    function toggleNewCompanyFields() {
      const fields = document.getElementById('newCompanyFields');
      const icon = document.getElementById('newCompanyToggleIcon');
      const text = document.getElementById('newCompanyToggleText');

      if (fields.style.display === 'none') {
        fields.style.display = 'block';
        icon.textContent = '-';
        text.textContent = 'Hide New Company Details';
      } else {
        fields.style.display = 'none';
        icon.textContent = '+';
        text.textContent = 'Add New Company Details';
      }
    }

    // ========================================
    // Control Center Toggle
    // ========================================
    function toggleControlCenter() {
      const content = document.getElementById('controlCenterContent');
      const icon = document.getElementById('controlCenterToggleIcon');

      content.classList.toggle('collapsed');
      icon.textContent = content.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
    }

    // ========================================
    // Control Center Tab Switching
    // ========================================
    function showTool(toolId, clickedTab = null) {
      // Hide all tools
      document.querySelectorAll('.control-tool').forEach(tool => {
        tool.classList.remove('active');
      });

      // Remove active class from all tabs
      document.querySelectorAll('.control-tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Show selected tool
      const selectedTool = document.getElementById('tool-' + toolId);
      if (selectedTool) {
        selectedTool.classList.add('active');
      }

      // Add active class to clicked tab (or find it if called programmatically)
      if (clickedTab) {
        clickedTab.classList.add('active');
      } else {
        // Find the tab by its onclick attribute
        const tab = document.querySelector(`[onclick="showTool('${toolId}')"]`);
        if (tab) {
          tab.classList.add('active');
        }
      }
    }

    // ========================================
    // CSV Import
    // ========================================
    function importCSV() {
      const csvText = document.getElementById('csvText').value.trim();
      const targetSheet = document.getElementById('importSheet').value;

      if (!csvText) {
        showToast('‚ö†Ô∏è Please paste CSV data first', 'warning');
        document.getElementById('csvText').focus();
        return;
      }

      showLoading(true);

      google.script.run
        .withSuccessHandler(handleCSVImportSuccess)
        .withFailureHandler(handleCSVImportError)
        .importCSVData(csvText, targetSheet);
    }

    function handleCSVImportSuccess(result) {
      showLoading(false);

      if (result.success) {
        const importedCount = result.data.importedCount || 0;
        const skippedCount = result.data.skippedCount || 0;

        let message = `‚úÖ Successfully imported ${importedCount} rows to ${result.data.sheetName}`;
        if (skippedCount > 0) {
          message += ` (${skippedCount} skipped due to validation)`;
        }

        showToast(message, 'success');

        // Clear the form
        document.getElementById('csvText').value = '';
      } else {
        showToast('‚ùå ' + (result.error || 'Import failed'), 'error');
      }
    }

    function handleCSVImportError(error) {
      showLoading(false);
      showToast('‚ùå CSV import error: ' + (error.message || error), 'error');
    }



    // ========================================
    // Context Detection (Dialog vs Sidebar)
    // ========================================
    function detectDisplayContext() {
      // Check if we're in a narrow container (sidebar) vs wide (dialog)
      const isSidebar = window.innerWidth < 500 || document.body.clientWidth < 500;

      if (isSidebar) {
        // Sidebar context - ensure proper styling
        document.body.classList.remove('dialog-context');
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
          sidebar.style.position = 'relative';
          sidebar.style.width = '100%';
          sidebar.style.left = 'auto';
          sidebar.style.top = 'auto';
        }
      } else {
        // Dialog context - apply floating styles
        document.body.classList.add('dialog-context');
      }
    }

    // ========================================
    // Load Validation Lists
    // ========================================
    function loadValidationLists() {
      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success && result.data) {
            populateValidationLists(result.data);
          } else {
            console.warn('Failed to load validation lists:', result.error);
          }
        })
        .withFailureHandler(function (error) {
          console.warn('Error loading validation lists:', error);
        })
        .getValidationLists();
    }

    function populateValidationLists(validationLists) {
      // Populate activity types
      const activityTypeSelect = document.getElementById('activityType');
      if (validationLists['Activity Types']) {
        // Clear existing options except the first
        while (activityTypeSelect.options.length > 1) {
          activityTypeSelect.remove(1);
        }
        // Add new options
        validationLists['Activity Types'].values.forEach(function (type) {
          const option = document.createElement('option');
          option.value = type;
          option.textContent = type;
          activityTypeSelect.appendChild(option);
        });
      }

      // Populate container sizes for new accounts
      // This would be used when implementing the account form validation

      // Store validation lists for form validation
      state.validationLists = validationLists;

      console.log('Validation lists loaded:', validationLists);
    }

    // ========================================
    // Save Callbacks
    // ========================================
    function handleSaveSuccess(result) {
      showLoading(false);

      if (result && result.success) {
        // Success - show confirmation and reset form
        const company = document.getElementById('companyInput').value.trim();
        showToast('‚úÖ Visit logged for ' + company, 'success');

        // Reset ALL form fields comprehensively
        document.getElementById('companyInput').value = '';
        document.getElementById('notes').value = '';
        document.getElementById('outreachId').value = '';

        // Reset new company fields
        document.getElementById('newAddress').value = '';
        document.getElementById('newPhone').value = '';
        document.getElementById('newContact').value = '';
        document.getElementById('newCity').value = 'Tyler';
        document.getElementById('newState').value = 'TX';
        document.getElementById('newZip').value = '';
        document.getElementById('newEmail').value = '';
        document.getElementById('newCompetitor').value = '';
        document.getElementById('newIndustry').value = '';

        // Reset date fields to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('nextDate').value = today;
        document.getElementById('activityType').value = 'Visit';

        // Reset status selection and UI elements
        state.selectedStatus = '';
        state.selectedOutcome = '';
        state.selectedStage = '';
        document.querySelectorAll('.outcome-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('workflowDisplay').style.display = 'none';

        // Hide informational cards
        document.getElementById('lastTouchCard').classList.remove('active');
        document.getElementById('prospectStatusIndicator').classList.remove('active');
        document.getElementById('accountForm').classList.remove('active');

        // Collapse new company fields section if it was expanded
        const newCompanyFields = document.getElementById('newCompanyFields');
        if (newCompanyFields.style.display !== 'none') {
          newCompanyFields.style.display = 'none';
          document.getElementById('newCompanyToggleIcon').textContent = '+';
          document.getElementById('newCompanyToggleText').textContent = 'Add New Company Details';
        }

        // Clear company data and voice preview
        state.selectedCompanyData = null;
        const voicePreview = document.getElementById('voicePreview');
        voicePreview.textContent = 'Tap to record...';
        voicePreview.classList.remove('has-content');

        // Refresh stats to show updated counts
        loadStats();

        // Focus on company input for quick next entry
        document.getElementById('companyInput').focus();
      } else {
        // Server returned failure
        showToast('‚ùå ' + (result.error || 'Save failed'), 'error');
      }
    }

    function handleSaveError(error) {
      showLoading(false);
      showToast('‚ùå ' + (error.message || error || 'Save failed'), 'error');
      console.error('Save error:', error);
    }

    /**
     * Standard Save Entry (Reliable Pattern)
     */
    function saveEntry() {
      const company = document.getElementById('companyInput').value.trim();
      if (!company || !state.selectedStatus) {
        showToast('‚ö†Ô∏è Company and Status required', 'warning');
        return;
      }

      showLoading(true);
      const formData = {
        company: company,
        outcome: state.selectedOutcome,
        stage: state.selectedStage,
        status: state.selectedStatus,
        notes: document.getElementById('notes').value,
        nextVisitDate: document.getElementById('nextDate').value,
        activityType: document.getElementById('activityType').value
      };

      google.script.run
        .withSuccessHandler(res => {
          showLoading(false);
          if (res.success) {
            showToast('‚úÖ Logged: ' + company, 'success');
            resetForm();
            loadStats();
          } else {
            showToast('‚ùå ' + res.error, 'error');
          }
        })
        .withFailureHandler(e => {
          showLoading(false);
          showToast('‚ùå Server error during save', 'error');
        })
        .addOutreachComplete(formData);
    }

    function resetForm() {
      document.getElementById('companyInput').value = '';
      document.getElementById('notes').value = '';
      document.querySelectorAll('.outcome-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('workflowDisplay').style.display = 'none';
      
      // Reset other form elements to ensure no white text issues
      const formInputs = document.querySelectorAll('.form-input, .form-select, .form-textarea');
      formInputs.forEach(input => {
        input.style.color = '';
        input.style.backgroundColor = '';
      });
    }

    function handleDuplicateCheck(result) {
      const company = document.getElementById('companyInput').value.trim();
      const outreachId = document.getElementById('outreachId').value.trim();

      if (result.success && result.isDuplicate) {
        showLoading(false);
        const message = `‚ö†Ô∏è Duplicate Outreach ID: ${outreachId}\n\n` +
          `Already exists for: ${result.existingCompany || 'Unknown'}\n` +
          `Do you want to save anyway?`;

        if (confirm(message)) {
          proceedWithSave(company, outreachId);
        }
      } else {
        proceedWithSave(company, outreachId);
      }
    }

    function handleDuplicateCheckError(error) {
      console.warn('Duplicate check failed, proceeding anyway:', error);
      const company = document.getElementById('companyInput').value.trim();
      const outreachId = document.getElementById('outreachId').value.trim();

      showLoading(false);
      if (confirm('‚ö†Ô∏è Could not verify Outreach ID uniqueness.\n\nSave anyway?')) {
        proceedWithSave(company, outreachId);
      }
    }

    function proceedWithSave(company, outreachId) {
      const data = {
        company: company,
        companyName: company,
        outcome: state.selectedOutcome, // NEW: Pass the Outcome
        stage: state.selectedStage,     // NEW: Pass the Stage
        status: state.selectedStatus,   // NEW: Pass the Status
        notes: document.getElementById('notes').value,
        nextVisitDate: document.getElementById('nextDate').value,
        activityType: document.getElementById('activityType').value
      };

      if (outreachId) {
        data.outreachId = outreachId;
      }

      if (state.selectedCompanyData && state.selectedCompanyData.companyId) {
        data.companyId = state.selectedCompanyData.companyId;
      }

      // Collect new company details for prospect creation
      const newCompanyFields = document.getElementById('newCompanyFields');
      if (newCompanyFields && newCompanyFields.style.display !== 'none') {
        // Only collect new company data if the section is expanded
        data.newCompanyData = {
          address: document.getElementById('newAddress').value,
          city: document.getElementById('newCity').value,
          state: document.getElementById('newState').value,
          zip: document.getElementById('newZip').value,
          industry: document.getElementById('newIndustry').value,
          contactName: document.getElementById('newContact').value,
          phone: document.getElementById('newPhone').value,
          email: document.getElementById('newEmail').value,
          competitor: document.getElementById('newCompetitor').value
        };
      }

      if (state.selectedOutcome === 'Account Won') {
        data.contact = document.getElementById('newContact').value;
        data.phone = document.getElementById('newPhone').value;
        data.site = document.getElementById('newAddress').value;
      }

      showLoading(true);

      google.script.run
        .withSuccessHandler(handleSaveSuccess)
        .withFailureHandler(handleSaveError)
        .addOutreachComplete(data);
    }
  </script>
</body>

</html>

[FILE_END: dashboard.html]
################################################################################

================================================================================
FILE_BEGIN: dateRangeReport.html
METADATA: Size=5402 bytes | Last_Modified=2026-02-05 14:37:16.025731
================================================================================
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #666;
      margin-bottom: 5px;
      text-transform: uppercase;
    }
    input[type="date"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .btn {
      width: 100%;
      padding: 12px;
      background: #0F2537;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }
    .btn:hover {
      background: #1a3a52;
    }
    .quick-options {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .quick-btn {
      flex: 1;
      padding: 8px;
      background: #e0e0e0;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
    }
    .quick-btn:hover {
      background: #d0d0d0;
    }
    #reportOutput {
      display: none;
      margin-top: 20px;
    }
    #reportText {
      width: 100%;
      height: 300px;
      font-family: monospace;
      font-size: 11px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }
    .copy-btn {
      width: 100%;
      padding: 10px;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="inputForm">
    <h3 style="margin-top: 0; color: #0F2537;">Generate Date Range Report</h3>
    
    <div class="quick-options">
      <button class="quick-btn" onclick="setThisWeek()">This Week</button>
      <button class="quick-btn" onclick="setThisMonth()">This Month</button>
      <button class="quick-btn" onclick="setLast7Days()">Last 7 Days</button>
      <button class="quick-btn" onclick="setLast30Days()">Last 30 Days</button>
    </div>
    
    <div class="form-group">
      <label for="startDate">Start Date</label>
      <input type="date" id="startDate">
    </div>
    
    <div class="form-group">
      <label for="endDate">End Date</label>
      <input type="date" id="endDate">
    </div>
    
    <button class="btn" onclick="generateReport()">Generate Report</button>
  </div>
  
  <div id="reportOutput">
    <button class="copy-btn" onclick="copyReport()">üìã Copy to Clipboard</button>
    <textarea id="reportText" readonly></textarea>
  </div>
  
  <script>
    // Set default dates to this week
    function setThisWeek() {
      var today = new Date();
      var startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - today.getDay());
      
      document.getElementById('startDate').value = formatDate(startOfWeek);
      document.getElementById('endDate').value = formatDate(today);
    }
    
    function setThisMonth() {
      var today = new Date();
      var startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      
      document.getElementById('startDate').value = formatDate(startOfMonth);
      document.getElementById('endDate').value = formatDate(today);
    }
    
    function setLast7Days() {
      var today = new Date();
      var sevenDaysAgo = new Date(today);
      sevenDaysAgo.setDate(today.getDate() - 7);
      
      document.getElementById('startDate').value = formatDate(sevenDaysAgo);
      document.getElementById('endDate').value = formatDate(today);
    }
    
    function setLast30Days() {
      var today = new Date();
      var thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 30);
      
      document.getElementById('startDate').value = formatDate(thirtyDaysAgo);
      document.getElementById('endDate').value = formatDate(today);
    }
    
    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }
    
    function generateReport() {
      var startDate = document.getElementById('startDate').value;
      var endDate = document.getElementById('endDate').value;
      
      if (!startDate || !endDate) {
        alert('Please select both start and end dates.');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(report) {
          document.getElementById('reportText').value = report;
          document.getElementById('inputForm').style.display = 'none';
          document.getElementById('reportOutput').style.display = 'block';
        })
        .withFailureHandler(function(error) {
          alert('Error: ' + error.message);
        })
        .generatePlainTextReportForRange(startDate, endDate);
    }
    
    function copyReport() {
      var textarea = document.getElementById('reportText');
      textarea.select();
      document.execCommand('copy');
      alert('Report copied to clipboard!');
    }
    
    // Initialize with this week
    setThisWeek();
  </script>
</body>
</html>


[FILE_END: dateRangeReport.html]
################################################################################

================================================================================
FILE_BEGIN: report.html
METADATA: Size=5583 bytes | Last_Modified=2026-02-05 14:37:16.025731
================================================================================
<!DOCTYPE html>
<html>
<head>
<style>
  /* General Styles for Browser Viewing */
  body { font-family: 'Segoe UI', Arial, sans-serif; color: #333; line-height: 1.5; margin: 0; padding: 20px; background-color: #f4f4f4; }
  .container { max-width: 800px; margin: 0 auto; background: #ffffff; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  
  /* Header */
  .header { background-color: #003366; color: #ffffff; padding: 20px; text-align: center; }
  .header h1 { margin: 0; font-size: 24px; }
  .header p { margin: 5px 0 0; font-size: 14px; opacity: 0.9; }

  /* KPI Section */
  .kpi-row { display: flex; justify-content: center; background-color: #eef2f5; padding: 15px 0; border-bottom: 2px solid #ddd; flex-wrap: wrap; }
  .kpi-box { text-align: center; width: 120px; margin: 0 10px; }
  .kpi-label { display: block; font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
  .kpi-value { display: block; font-size: 20px; font-weight: bold; margin-top: 5px; }
  .hot-lead { color: #d35400; } /* Burnt Orange for Hot Leads */

  /* Data Table */
  table { width: 100%; border-collapse: collapse; margin-top: 0; }
  th { background-color: #f8f9fa; color: #444; font-size: 12px; text-transform: uppercase; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; }
  td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: top; }
  tr:last-child td { border-bottom: none; }
  
  /* Outcome Badges */
  .badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap; }
  .b-interested { background-color: #e6fffa; color: #047857; border: 1px solid #047857; }
  .b-disqualified { background-color: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; }
  .b-cold { background-color: #eff6ff; color: #1e40af; border: 1px solid #1e40af; }
  .b-contact { background-color: #fff7ed; color: #c2410c; border: 1px solid #c2410c; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üöÄ K&L Recycling</h1>
    <p>Enterprise Operations Report | 01/14/2026 - 01/14/2026</p>
  </div>

  <div class="kpi-row">
    <div class="kpi-box">
      <span class="kpi-label">Total Visits</span>
      <span class="kpi-value">11</span>
    </div>
    <div class="kpi-box">
      <span class="kpi-label">New Wins</span>
      <span class="kpi-value">0</span>
    </div>
    <div class="kpi-box">
      <span class="kpi-label">üî• Hot Leads</span>
      <span class="kpi-value hot-lead">2</span>
    </div>
  </div>

  <table width="100%" cellpadding="0" cellspacing="0">
    <thead>
      <tr>
        <th width="20%">Company</th>
        <th width="12%">Date</th>
        <th width="15%">Outcome</th>
        <th>Notes</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>Generac</strong></td>
        <td>01/14</td>
        <td><span class="badge b-disqualified">Disqualified</span></td>
        <td>Spoke to GM. Not enough scrap to warrant a roll off. Front office confusion regarding scrap definition.</td>
      </tr>
      <tr>
        <td><strong>Raney Appliance Service</strong></td>
        <td>01/14</td>
        <td><span class="badge b-disqualified">Disqualified</span></td>
        <td>Low volume, but upcoming clean up. Will call when ready.</td>
      </tr>
      <tr>
        <td><strong>Pro Custom Auto Works</strong></td>
        <td>01/14</td>
        <td><span class="badge b-interested">Interested</span></td>
        <td><strong>Target:</strong> Owner needs large cleanup/roll off. Currently uses Huntwell but interested in switching. Will call next week.</td>
      </tr>
      <tr>
        <td><strong>Larry Cathy</strong></td>
        <td>01/14</td>
        <td><span class="badge b-contact">Initial Contact</span></td>
        <td>Owner out of office; office locked. Plan to visit tomorrow morning.</td>
      </tr>
      <tr>
        <td><strong>Goodyear</strong></td>
        <td>01/14</td>
        <td><span class="badge b-disqualified">Disqualified</span></td>
        <td>Insufficient scrap volume.</td>
      </tr>
      <tr>
        <td><strong>C. Davis Heating And Air</strong></td>
        <td>01/14</td>
        <td><span class="badge b-cold">Cold</span></td>
        <td>Currently allows unknown pickup without contact info. Left card for next interaction.</td>
      </tr>
      <tr>
        <td><strong>Northwest Collision Center</strong></td>
        <td>01/14</td>
        <td><span class="badge b-cold">Cold</span></td>
        <td>Employees take scrap (low volume). Left card with receptionist regarding premium pricing.</td>
      </tr>
      <tr>
        <td><strong>Watson Plumbing</strong></td>
        <td>01/14</td>
        <td><span class="badge b-cold">Cold</span></td>
        <td>Follow-up visit. Still unable to locate contact info for current scrap collector.</td>
      </tr>
      <tr>
        <td><strong>Tyler Building Systems</strong></td>
        <td>01/14</td>
        <td><span class="badge b-contact">Contacted</span></td>
        <td>No answer. Left 2 voicemails. Sending text tomorrow morning.</td>
      </tr>
      <tr>
        <td><strong>Faith Co</strong></td>
        <td>01/14</td>
        <td><span class="badge b-interested">Interested</span></td>
        <td>Spoke to receptionist; message left for owner/manager regarding outreach.</td>
      </tr>
    </tbody>
  </table>
</div>

</body>
</html>

[FILE_END: report.html]
################################################################################

================================================================================
FILE_BEGIN: CRM_BLUEPRINT_REPORT.html
METADATA: Size=46704 bytes | Last_Modified=2026-02-07 00:34:33.945554
================================================================================
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K&L CRM - Blueprint & Health Report</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .health-score {
            display: inline-block;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(#dc3545 0.0deg, #e0e0e0 0deg);
            position: relative;
            margin: 20px auto;
        }
        .health-score::before {
            content: '0';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            font-weight: bold;
            color: #333;
        }
        .content { padding: 40px; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-number { font-size: 2.5em; font-weight: bold; }
        .stat-label { opacity: 0.9; margin-top: 5px; }
        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .section h2 {
            color: #1e3c72;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .issue-card {
            background: white;
            border-left: 5px solid #dc3545;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .issue-card.critical { border-left-color: #dc3545; }
        .issue-card.high { border-left-color: #fd7e14; }
        .issue-card.medium { border-left-color: #ffc107; }
        .issue-card.low { border-left-color: #17a2b8; }
        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .issue-severity {
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }
        .issue-location {
            color: #666;
            font-family: monospace;
            margin-bottom: 10px;
        }
        .issue-message { color: #333; margin-bottom: 10px; }
        .issue-recommendation {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            color: #1565c0;
            font-size: 0.9em;
        }
        .file-tree {
            background: white;
            border-radius: 10px;
            padding: 20px;
        }
        .file-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-item:hover { background: #f5f5f5; }
        .file-name { font-family: monospace; color: #333; }
        .file-stats { color: #666; font-size: 0.9em; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @media print {
            body { background: white; }
            .container { box-shadow: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ K&L Recycling CRM</h1>
            <p>Comprehensive Blueprint & Health Analysis Report</p>
            <p>Generated: 2026-02-07 00:34:33</p>
            <div class="health-score"></div>
            <p>Overall Health Score</p>
        </div>
        
        <div class="content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">53</div>
                    <div class="stat-label">Files Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">428</div>
                    <div class="stat-label">Functions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">25,870</div>
                    <div class="stat-label">Lines of Code</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">376</div>
                    <div class="stat-label">Issues Found</div>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('issues')">üö® Issues</div>
                <div class="tab" onclick="showTab('files')">üìÅ Files</div>
                <div class="tab" onclick="showTab('architecture')">üèóÔ∏è Architecture</div>
            </div>
            
            <div id="issues" class="tab-content active">
                <div class="section">
                    <h2>üö® Issues by Severity</h2>
<h3 style="color: #fd7e14; margin: 20px 0 15px;">HIGH (39)</h3>
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:144</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:145</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:146</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:159</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:168</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:175</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:180</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:187</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:205</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:209</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    <p style="text-align: center; color: #666; margin-top: 15px;">... and 29 more HIGH issues</p><h3 style="color: #ffc107; margin: 20px 0 15px;">MEDIUM (204)</h3>
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:30</div>
                        <div class="issue-message">Potential schema typo: 'mailing location' is similar to 'mailingLocation'</div>
                        <div class="issue-recommendation">üí° Verify if 'mailing location' should be 'mailingLocation'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:32</div>
                        <div class="issue-message">Potential schema typo: 'handling of metal' is similar to 'Handling of Metal'</div>
                        <div class="issue-recommendation">üí° Verify if 'handling of metal' should be 'Handling of Metal'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:61</div>
                        <div class="issue-message">Potential schema typo: 'Accounts' is similar to 'Account'</div>
                        <div class="issue-recommendation">üí° Verify if 'Accounts' should be 'Account'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:65</div>
                        <div class="issue-message">Potential schema typo: 'Company name' is similar to 'Company Name'</div>
                        <div class="issue-recommendation">üí° Verify if 'Company name' should be 'Company Name'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:96</div>
                        <div class="issue-message">Potential schema typo: 'Company name' is similar to 'Company Name'</div>
                        <div class="issue-recommendation">üí° Verify if 'Company name' should be 'Company Name'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:106</div>
                        <div class="issue-message">Potential schema typo: 'Company name' is similar to 'Company Name'</div>
                        <div class="issue-recommendation">üí° Verify if 'Company name' should be 'Company Name'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:188</div>
                        <div class="issue-message">Potential schema typo: 'Accounts' is similar to 'Account'</div>
                        <div class="issue-recommendation">üí° Verify if 'Accounts' should be 'Account'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:192</div>
                        <div class="issue-message">Potential schema typo: 'Company name' is similar to 'Company Name'</div>
                        <div class="issue-recommendation">üí° Verify if 'Company name' should be 'Company Name'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:33</div>
                        <div class="issue-message">Potential schema typo: 'contact status' is similar to 'contactStatus'</div>
                        <div class="issue-recommendation">üí° Verify if 'contact status' should be 'contactStatus'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:34</div>
                        <div class="issue-message">Potential schema typo: 'close probability' is similar to 'closeProbability'</div>
                        <div class="issue-recommendation">üí° Verify if 'close probability' should be 'closeProbability'</div>
                    </div>
                    <p style="text-align: center; color: #666; margin-top: 15px;">... and 194 more MEDIUM issues</p><h3 style="color: #17a2b8; margin: 20px 0 15px;">LOW (130)</h3>
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:19</div>
                        <div class="issue-message">Function 'generateProspect' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:49</div>
                        <div class="issue-message">Function 'generateOutreach' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:78</div>
                        <div class="issue-message">Function 'generateAccount' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:602</div>
                        <div class="issue-message">Function 'standardizeDateHandling' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ AutoFillService.js:7</div>
                        <div class="issue-message">Function 'runMasterAutofill' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ AutoFillService.js:20</div>
                        <div class="issue-message">Function 'autofillProspects' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ AutoFillService.js:54</div>
                        <div class="issue-message">Function 'autofillOutreach' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ BusinessValidation.js:134</div>
                        <div class="issue-message">Function 'validateProspect' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ BusinessValidation.js:294</div>
                        <div class="issue-message">Function 'validateOutreach' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ BusinessValidation.js:422</div>
                        <div class="issue-message">Function 'validateNewAccount' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    <p style="text-align: center; color: #666; margin-top: 15px;">... and 120 more LOW issues</p><h3 style="color: #6c757d; margin: 20px 0 15px;">INFO (3)</h3>
                    <div class="issue-card info">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #6c757d;">INFO</span>
                            <span>‚ö° Performance</span>
                        </div>
                        <div class="issue-location">üìÑ ErrorHandling.js:180</div>
                        <div class="issue-message">SpreadsheetApp.flush() can impact performance</div>
                        <div class="issue-recommendation">üí° Consider using batch operations or caching</div>
                    </div>
                    
                    <div class="issue-card info">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #6c757d;">INFO</span>
                            <span>‚ö° Performance</span>
                        </div>
                        <div class="issue-location">üìÑ PerformanceUtils.js:92</div>
                        <div class="issue-message">SpreadsheetApp.flush() can impact performance</div>
                        <div class="issue-recommendation">üí° Consider using batch operations or caching</div>
                    </div>
                    
                    <div class="issue-card info">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #6c757d;">INFO</span>
                            <span>‚ö° Performance</span>
                        </div>
                        <div class="issue-location">üìÑ PerformanceUtils.js:779</div>
                        <div class="issue-message">SpreadsheetApp.flush() can impact performance</div>
                        <div class="issue-recommendation">üí° Consider using batch operations or caching</div>
                    </div>
                    
                </div>
            </div>
            
            <div id="files" class="tab-content">
                <div class="section">
                    <h2>üìÅ File Analysis</h2>
                    <div class="file-tree">
<h3 style="margin: 20px 0 10px; color: #1e3c72;">üì¶ Core Services</h3>
                        <div class="file-item">
                            <span class="file-name">CRM_API.js</span>
                            <span class="file-stats">8 lines | 0 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">Config.js</span>
                            <span class="file-stats">150 lines | 2 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">MenuFunctions.js</span>
                            <span class="file-stats">41 lines | 2 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">Settings.js</span>
                            <span class="file-stats">177 lines | 3 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">üé® UI Components</h3>
                        <div class="file-item">
                            <span class="file-name">CRM_BLUEPRINT_REPORT.html</span>
                            <span class="file-stats">852 lines | 1 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">CRM_Styles.html</span>
                            <span class="file-stats">927 lines | 0 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">CRM_Suite.html</span>
                            <span class="file-stats">349 lines | 11 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">DashboardBackend.js</span>
                            <span class="file-stats">82 lines | 2 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ReportFunctions.js</span>
                            <span class="file-stats">1409 lines | 24 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">dashboard.html</span>
                            <span class="file-stats">3619 lines | 59 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">dateRangeReport.html</span>
                            <span class="file-stats">193 lines | 7 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">report.html</span>
                            <span class="file-stats">219 lines | 1 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">üîÑ Sync & Workflow</h3>
                        <div class="file-item">
                            <span class="file-name">OutreachSyncFunctions.js</span>
                            <span class="file-stats">228 lines | 4 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">Sync.js</span>
                            <span class="file-stats">264 lines | 9 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">WorkflowAutomationService.js</span>
                            <span class="file-stats">293 lines | 7 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">‚úÖ Validation</h3>
                        <div class="file-item">
                            <span class="file-name">BusinessValidation.js</span>
                            <span class="file-stats">735 lines | 12 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ComprehensiveValidationSystem.js</span>
                            <span class="file-stats">1660 lines | 29 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">DataValidation.js</span>
                            <span class="file-stats">1834 lines | 32 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">SettingsValidation.js</span>
                            <span class="file-stats">943 lines | 17 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ValidationUtils.js</span>
                            <span class="file-stats">189 lines | 11 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">üß™ Testing</h3>
                        <div class="file-item">
                            <span class="file-name">simple_test.js</span>
                            <span class="file-stats">8 lines | 1 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_autofill_implementation.js</span>
                            <span class="file-stats">79 lines | 2 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_comprehensive_validation.js</span>
                            <span class="file-stats">526 lines | 9 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_fixes.js</span>
                            <span class="file-stats">288 lines | 8 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_integration.js</span>
                            <span class="file-stats">344 lines | 7 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_normalization.js</span>
                            <span class="file-stats">291 lines | 10 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_robust.js</span>
                            <span class="file-stats">658 lines | 25 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_rowindex_fix.js</span>
                            <span class="file-stats">238 lines | 3 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_runner.js</span>
                            <span class="file-stats">757 lines | 22 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_runtime_fixes.js</span>
                            <span class="file-stats">369 lines | 5 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_settings_validation.js</span>
                            <span class="file-stats">221 lines | 8 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_unit.js</span>
                            <span class="file-stats">431 lines | 8 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">üîß Utilities</h3>
                        <div class="file-item">
                            <span class="file-name">DataHelpers.js</span>
                            <span class="file-stats">598 lines | 5 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">FuzzyMatchingUtils.js</span>
                            <span class="file-stats">118 lines | 3 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">PerformanceUtils.js</span>
                            <span class="file-stats">789 lines | 26 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">SharedUtils.js</span>
                            <span class="file-stats">559 lines | 16 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">StringUtils.js</span>
                            <span class="file-stats">139 lines | 15 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">üìÑ Other</h3>
                        <div class="file-item">
                            <span class="file-name">AccountFunction.js</span>
                            <span class="file-stats">278 lines | 3 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">AlertingService.js</span>
                            <span class="file-stats">158 lines | 5 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">AutoFillService.js</span>
                            <span class="file-stats">79 lines | 3 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">CSVImport.js</span>
                            <span class="file-stats">278 lines | 5 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ColumnMapper.js</span>
                            <span class="file-stats">126 lines | 4 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ErrorHandling.js</span>
                            <span class="file-stats">279 lines | 10 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">Normalization.js</span>
                            <span class="file-stats">455 lines | 7 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">OutreachFunctions.js</span>
                            <span class="file-stats">1050 lines | 13 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">PipelineService.js</span>
                            <span class="file-stats">131 lines | 6 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ProspectFunctions.js</span>
                            <span class="file-stats">701 lines | 14 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ProspectScoringService.js</span>
                            <span class="file-stats">322 lines | 8 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">RouteFunction.js</span>
                            <span class="file-stats">161 lines | 3 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">SetupFunctions.js</span>
                            <span class="file-stats">24 lines | 1 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">SystemAlignment.gs</span>
                            <span class="file-stats">289 lines | 7 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">WebApp.gs</span>
                            <span class="file-stats">105 lines | 4 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">apply-fixes.js</span>
                            <span class="file-stats">849 lines | 18 functions</span>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <div id="architecture" class="tab-content">
                <div class="section">
                    <h2>üèóÔ∏è System Architecture</h2>
                    <h3 style="margin: 20px 0 10px;">üìä Schema Objects</h3>

                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">Prospects</h4>
                        <p style="color: #666;">36 columns defined</p>
                    </div>
            
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">Outreach</h4>
                        <p style="color: #666;">36 columns defined</p>
                    </div>
            
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">Accounts</h4>
                        <p style="color: #666;">26 columns defined</p>
                    </div>
            
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">Contacts</h4>
                        <p style="color: #666;">16 columns defined</p>
                    </div>
            
                    <h3 style="margin: 30px 0 10px;">üîó External Dependencies</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
<div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">CacheService</div><div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">MailApp</div><div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">ScriptApp</div><div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">SpreadsheetApp</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function showTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }
    </script>
</body>
</html>


[FILE_END: CRM_BLUEPRINT_REPORT.html]
################################################################################

================================================================================
FILE_BEGIN: CRM_Styles.html
METADATA: Size=24214 bytes | Last_Modified=2026-02-06 14:54:14.915298
================================================================================
<style>
    /* ===== CSS Variables & Theme ===== */
    :root {
        /* Primary Palette - K&L Green Inspired */
        --primary: #10b981;
        --primary-dark: #059669;
        --primary-light: #34d399;
        --primary-bg: #ecfdf5;
        
        /* Accent Colors */
        --accent-hot: #ef4444;
        --accent-warm: #f59e0b;
        --accent-cold: #3b82f6;
        --accent-won: #10b981;
        
        /* Neutral Palette */
        --bg-main: #0f172a;
        --bg-secondary: #1e293b;
        --bg-card: #ffffff;
        --bg-hover: #f1f5f9;
        
        /* Text Colors */
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --text-inverse: #ffffff;
        
        /* Semantic Colors */
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --info: #3b82f6;
        
        /* Shadows */
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --shadow-glow: 0 0 20px rgba(16, 185, 129, 0.3);
        
        /* Spacing */
        --spacing-xs: 0.25rem;
        --spacing-sm: 0.5rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --spacing-xl: 2rem;
        
        /* Border Radius */
        --radius-sm: 0.375rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        --radius-full: 9999px;
        
        /* Transitions */
        --transition-fast: 150ms ease;
        --transition-normal: 250ms ease;
        --transition-slow: 350ms ease;
        
        /* Sidebar Width */
        --sidebar-width: 280px;
    }

    /* ===== Base Reset ===== */
    *, *::before, *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    html {
        font-size: 16px;
        scroll-behavior: smooth;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        background: var(--bg-main);
        color: var(--text-primary);
        line-height: 1.6;
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* ===== Scrollbar Styling ===== */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: var(--radius-full);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: var(--radius-full);
        transition: var(--transition-fast);
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-light);
    }

    /* ===== Layout ===== */
    .suite-wrapper {
        display: flex;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
    }

    /* ===== Sidebar Navigation ===== */
    .suite-nav {
        width: var(--sidebar-width);
        background: linear-gradient(180deg, var(--bg-secondary) 0%, #0f172a 100%);
        color: var(--text-inverse);
        display: flex;
        flex-direction: column;
        position: relative;
        z-index: 100;
        box-shadow: var(--shadow-xl);
    }

    .suite-nav::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.5), transparent);
    }

    .brand {
        padding: var(--spacing-xl) var(--spacing-lg);
        font-weight: 800;
        font-size: 1.25rem;
        letter-spacing: 2px;
        color: var(--primary);
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        position: relative;
    }

    .brand::before {
        content: '';
    }

    .brand::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: var(--spacing-lg);
        right: var(--spacing-lg);
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
    }

    .nav-links {
        flex: 1;
        padding: var(--spacing-md);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        overflow-y: auto;
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-md) var(--spacing-lg);
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: all var(--transition-normal);
        color: var(--text-muted);
        font-weight: 500;
        position: relative;
        overflow: hidden;
    }

    .nav-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 0;
        background: var(--primary);
        border-radius: var(--radius-full);
        transition: height var(--transition-normal);
    }

    .nav-item:hover {
        background: rgba(16, 185, 129, 0.1);
        color: var(--text-inverse);
        transform: translateX(4px);
    }

    .nav-item:hover::before {
        height: 24px;
    }

    .nav-item.active {
        background: linear-gradient(90deg, rgba(16, 185, 129, 0.2), transparent);
        color: var(--primary);
        font-weight: 600;
    }

    .nav-item.active::before {
        height: 32px;
        box-shadow: var(--shadow-glow);
    }

    .nav-item i {
        width: 24px;
        text-align: center;
        font-size: 1.1rem;
    }

    .nav-footer {
        padding: var(--spacing-lg);
        text-align: center;
        font-size: 0.75rem;
        color: var(--text-muted);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
    }

    .nav-footer::before {
        content: '';
        position: absolute;
        top: -1px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 2px;
        background: var(--primary);
        border-radius: var(--radius-full);
    }

    /* ===== Main Content Area ===== */
    .suite-main {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }

    .suite-header {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: var(--spacing-lg) var(--spacing-xl);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 50;
    }

    .suite-header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        position: relative;
        padding-left: var(--spacing-md);
    }

    .suite-header h1::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 24px;
        background: var(--primary);
        border-radius: var(--radius-full);
    }

    .user-profile {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-sm) var(--spacing-lg);
        background: var(--bg-card);
        border-radius: var(--radius-full);
        box-shadow: var(--shadow-sm);
        font-weight: 500;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .user-profile::before {
        content: '';
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.875rem;
    }

    /* ===== Tab Content ===== */
    .tab-content {
        padding: var(--spacing-xl);
        flex: 1;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ===== Stats Grid ===== */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .stat-card {
        background: var(--bg-card);
        padding: var(--spacing-xl);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        transition: all var(--transition-normal);
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary);
        opacity: 0;
        transition: opacity var(--transition-normal);
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
    }

    .stat-card:hover::before {
        opacity: 1;
    }

    .stat-card.accent {
        border-top: none;
    }

    .stat-card.accent::before {
        background: linear-gradient(90deg, var(--accent-hot), #fca5a5);
        opacity: 1;
    }

    .stat-card.win::before {
        background: linear-gradient(90deg, var(--accent-won), #6ee7b7);
        opacity: 1;
    }

    .stat-card h4 {
        margin: 0;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
        margin-bottom: var(--spacing-sm);
    }

    .stat-card h2 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, var(--text-primary), var(--primary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-card .trend {
        position: absolute;
        bottom: var(--spacing-lg);
        right: var(--spacing-lg);
        font-size: 0.75rem;
        color: var(--success);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .stat-card .trend.down {
        color: var(--error);
    }

    /* ===== Content Split ===== */
    .content-split {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: var(--spacing-xl);
    }

    .card {
        background: var(--bg-card);
        padding: var(--spacing-xl);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .card h3 {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: var(--spacing-lg);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding-bottom: var(--spacing-md);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .card h3 i {
        color: var(--primary);
    }

    .data-list {
        margin-top: var(--spacing-md);
        max-height: 400px;
        overflow-y: auto;
    }

    .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
        cursor: pointer;
    }

    .list-item:hover {
        background: var(--bg-hover);
        transform: translateX(4px);
    }

    .list-item span:first-child {
        font-weight: 500;
        color: var(--text-primary);
    }

    .list-item small {
        color: var(--text-muted);
        font-size: 0.75rem;
    }

    /* ===== Badge System ===== */
    .badge {
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-full);
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .badge.overdue {
        background: linear-gradient(135deg, #000000, #333333);
        color: #ffffff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .badge.high, .badge.hot {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #b91c1c;
    }

    .badge.medium, .badge.warm {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #d97706;
    }

    .badge.low, .badge.cold {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1d4ed8;
    }

    .badge.won, .badge.active {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        color: #059669;
    }

    /* ===== Pipeline View ===== */
    .pipeline-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--spacing-lg);
        height: calc(100vh - 200px);
    }

    .pipeline-stage {
        background: var(--bg-card);
        border-radius: var(--radius-xl);
        padding: var(--spacing-lg);
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-sm);
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: all var(--transition-normal);
    }

    .pipeline-stage:hover {
        box-shadow: var(--shadow-md);
    }

    .pipeline-stage h4 {
        margin: 0 0 var(--spacing-lg) 0;
        padding-bottom: var(--spacing-md);
        border-bottom: 2px solid;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .pipeline-stage h4::before {
        content: '';
        width: 8px;
        height: 8px;
        border-radius: var(--radius-full);
    }

    #pipeline-hot h4 { border-color: var(--accent-hot); color: var(--accent-hot); }
    #pipeline-hot h4::before { background: var(--accent-hot); box-shadow: 0 0 10px var(--accent-hot); }
    
    #pipeline-warm h4 { border-color: var(--accent-warm); color: var(--accent-warm); }
    #pipeline-warm h4::before { background: var(--accent-warm); box-shadow: 0 0 10px var(--accent-warm); }
    
    #pipeline-cold h4 { border-color: var(--accent-cold); color: var(--accent-cold); }
    #pipeline-cold h4::before { background: var(--accent-cold); box-shadow: 0 0 10px var(--accent-cold); }
    
    #pipeline-won h4 { border-color: var(--accent-won); color: var(--accent-won); }
    #pipeline-won h4::before { background: var(--accent-won); box-shadow: 0 0 10px var(--accent-won); }

    .pipeline-deals {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        overflow-y: auto;
        padding-right: var(--spacing-xs);
    }

    .pipeline-deal {
        background: linear-gradient(135deg, #f8fafc, #ffffff);
        padding: var(--spacing-md);
        border-radius: var(--radius-lg);
        border-left: 4px solid;
        transition: all var(--transition-fast);
        cursor: pointer;
        position: relative;
    }

    .pipeline-deal:hover {
        transform: translateX(4px);
        box-shadow: var(--shadow-sm);
    }

    #pipeline-hot .pipeline-deal { border-left-color: var(--accent-hot); }
    #pipeline-warm .pipeline-deal { border-left-color: var(--accent-warm); }
    #pipeline-cold .pipeline-deal { border-left-color: var(--accent-cold); }
    #pipeline-won .pipeline-deal { border-left-color: var(--accent-won); }

    .pipeline-deal strong {
        display: block;
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
    }

    .pipeline-deal small {
        color: var(--text-muted);
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .pipeline-deal .actions {
        position: absolute;
        top: var(--spacing-sm);
        right: var(--spacing-sm);
        opacity: 0;
        transition: opacity var(--transition-fast);
    }

    .pipeline-deal:hover .actions {
        opacity: 1;
    }

    .pipeline-deal .actions i {
        padding: var(--spacing-xs);
        border-radius: var(--radius-sm);
        background: var(--bg-hover);
        cursor: pointer;
        transition: var(--transition-fast);
    }

    .pipeline-deal .actions i:hover {
        background: var(--primary);
        color: white;
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .empty-state i {
        font-size: 2rem;
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
    }

    /* ===== Prospects View ===== */
    .prospects-toolbar {
        display: flex;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-xl);
        background: var(--bg-card);
        padding: var(--spacing-lg);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-sm);
    }

    .prospects-toolbar input {
        flex: 1;
        padding: var(--spacing-md) var(--spacing-lg);
        border: 2px solid transparent;
        border-radius: var(--radius-lg);
        font-size: 0.9rem;
        background: var(--bg-hover);
        transition: all var(--transition-fast);
    }

    .prospects-toolbar input:focus {
        outline: none;
        border-color: var(--primary);
        background: var(--bg-card);
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }

    .prospects-toolbar select {
        padding: var(--spacing-md) var(--spacing-lg);
        border: 2px solid transparent;
        border-radius: var(--radius-lg);
        font-size: 0.9rem;
        background: var(--bg-hover);
        cursor: pointer;
        transition: all var(--transition-fast);
        min-width: 150px;
    }

    .prospects-toolbar select:focus {
        outline: none;
        border-color: var(--primary);
        background: var(--bg-card);
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }

    .prospects-table-container {
        background: var(--bg-card);
        border-radius: var(--radius-xl);
        overflow: hidden;
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .prospects-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .prospects-table thead {
        background: linear-gradient(135deg, var(--bg-secondary), #0f172a);
    }

    .prospects-table th {
        background: transparent;
        padding: var(--spacing-lg);
        text-align: left;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .prospects-table td {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--bg-hover);
        vertical-align: middle;
    }

    .prospects-table tbody tr {
        transition: all var(--transition-fast);
        cursor: pointer;
    }

    .prospects-table tbody tr:hover {
        background: var(--bg-hover);
    }

    .prospects-table tbody tr td:first-child {
        border-radius: var(--radius-lg) 0 0 var(--radius-lg);
    }

    .prospects-table tbody tr td:last-child {
        border-radius: 0 var(--radius-lg) var(--radius-lg) 0;
    }

    .company-cell {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .company-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 0.875rem;
        box-shadow: var(--shadow-sm);
    }

    .company-info strong {
        display: block;
        color: var(--text-primary);
        font-weight: 600;
    }

    .company-info small {
        color: var(--text-muted);
        font-size: 0.75rem;
    }

    .score-cell {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .score-bar {
        width: 60px;
        height: 6px;
        background: var(--bg-hover);
        border-radius: var(--radius-full);
        overflow: hidden;
    }

    .score-bar-fill {
        height: 100%;
        border-radius: var(--radius-full);
        transition: width var(--transition-normal);
    }

    .score-bar-fill.high { background: linear-gradient(90deg, var(--accent-hot), #fca5a5); }
    .score-bar-fill.medium { background: linear-gradient(90deg, var(--accent-warm), #fcd34d); }
    .score-bar-fill.low { background: linear-gradient(90deg, var(--accent-cold), #93c5fd); }

    /* ===== Loading States ===== */
    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-xl);
        color: var(--text-muted);
    }

    .loading::after {
        content: '';
        width: 24px;
        height: 24px;
        border: 3px solid var(--bg-hover);
        border-top-color: var(--primary);
        border-radius: var(--radius-full);
        animation: spin 1s linear infinite;
        margin-left: var(--spacing-md);
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .skeleton {
        background: linear-gradient(90deg, var(--bg-hover) 25%, #e2e8f0 50%, var(--bg-hover) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: var(--radius-md);
    }

    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* ===== Toast Notifications ===== */
    .toast-container {
        position: fixed;
        bottom: var(--spacing-xl);
        right: var(--spacing-xl);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
    }

    .toast {
        padding: var(--spacing-md) var(--spacing-lg);
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        animation: slideIn 0.3s ease;
        min-width: 300px;
    }

    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--error); }
    .toast.warning { border-left: 4px solid var(--warning); }
    .toast.info { border-left: 4px solid var(--info); }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* ===== Responsive Design ===== */
    @media (max-width: 1400px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .pipeline-container {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 1024px) {
        .suite-nav {
            width: 80px;
        }
        
        .brand span,
        .nav-item span {
            display: none;
        }
        
        .nav-item {
            justify-content: center;
            padding: var(--spacing-md);
        }
        
        .content-split {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .pipeline-container {
            grid-template-columns: 1fr;
            height: auto;
        }
        
        .prospects-toolbar {
            flex-direction: column;
        }
    }
</style>

[FILE_END: CRM_Styles.html]
################################################################################

================================================================================
FILE_BEGIN: CRM_Suite.html
METADATA: Size=13225 bytes | Last_Modified=2026-02-06 09:40:27.692871
================================================================================
<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <?!= HtmlService.createHtmlOutputFromFile('CRM_Styles').getContent(); ?>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
  <div class="suite-wrapper">
    <nav class="suite-nav">
      <div class="brand">K&L RECYCLING</div>
      <div class="nav-links">
        <div class="nav-item active" onclick="switchTab('dashboard', this)">
          <i class="fas fa-th-large"></i> Dashboard
        </div>
        <div class="nav-item" onclick="switchTab('pipeline', this)">
          <i class="fas fa-filter"></i> Pipeline
        </div>
        <div class="nav-item" onclick="switchTab('prospects', this)">
          <i class="fas fa-address-book"></i> Prospects
        </div>
      </div>
      <div class="nav-footer">System v2.5.0</div>
    </nav>

    <main class="suite-main">
      <header class="suite-header">
        <h1 id="tab-title">Executive Dashboard</h1>
        <div class="user-profile">Operations Analyst</div>
      </header>

      <div id="view-dashboard" class="tab-content">
        <div class="stats-grid" id="stat-cards">
        </div>

        <div class="content-split">
          <div class="card">
            <h3>üî• Urgent Follow-ups</h3>
            <div id="urgent-list" class="data-list">Loading...</div>
          </div>
          <div class="card">
            <h3>‚úÖ Recent Wins</h3>
            <div id="wins-list" class="data-list">Loading...</div>
          </div>
        </div>
      </div>

      <div id="view-pipeline" class="tab-content" style="display: none;">
        <div class="pipeline-container" id="pipeline-container">
          <div class="pipeline-stage">
            <h4>üî• Hot</h4>
            <div id="pipeline-hot" class="pipeline-deals">Loading...</div>
          </div>
          <div class="pipeline-stage">
            <h4>‚òÄÔ∏è Warm</h4>
            <div id="pipeline-warm" class="pipeline-deals">Loading...</div>
          </div>
          <div class="pipeline-stage">
            <h4>‚ùÑÔ∏è Cold</h4>
            <div id="pipeline-cold" class="pipeline-deals">Loading...</div>
          </div>
          <div class="pipeline-stage">
            <h4>‚úÖ Won</h4>
            <div id="pipeline-won" class="pipeline-deals">Loading...</div>
          </div>
        </div>
      </div>

      <div id="view-prospects" class="tab-content" style="display: none;">
        <div class="prospects-toolbar">
          <input type="text" id="prospects-search" list="company-suggestions" placeholder="Search prospects..." onkeyup="filterProspects()">
          <datalist id="company-suggestions"></datalist>
          <select id="prospects-filter" onchange="filterProspects()">
            <option value="all">All Statuses</option>
            <option value="hot">Hot</option>
            <option value="warm">Warm</option>
            <option value="cold">Cold</option>
          </select>
        </div>
        <div class="prospects-table-container">
          <table class="prospects-table">
            <thead>
              <tr>
                <th>Company Name</th>
                <th>Contact Status</th>
                <th>Urgency</th>
                <th>Priority Score</th>
                <th>Last Outreach</th>
              </tr>
            </thead>
            <tbody id="prospects-table-body">
              <tr><td colspan="5">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Global data storage
    var crmData = {
      dashboard: null,
      pipeline: null,
      prospects: null
    };

    function callAPI(action, payload = {}) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .crmGateway({ action, payload });
      });
    }

    async function init() {
      console.log('CRM Dashboard initializing...');
      try {
        console.log('Calling GET_DASHBOARD_STATS...');
        const res = await callAPI('GET_DASHBOARD_STATS');
        console.log('API Response:', res);
        if (res.success) {
          console.log('Dashboard data loaded successfully, rendering...');
          crmData.dashboard = res;
          renderDashboard(res);
        } else {
          console.error('Failed to load dashboard stats:', res.error);
          showError('Failed to load dashboard data: ' + (res.error || 'Unknown error'));
        }
      } catch (e) {
        console.error('Error initializing dashboard:', e);
        console.error('Error stack:', e.stack);
        showError('Error loading dashboard: ' + (e.message || 'Unknown error'));
      }
      
      // Load company names for autocomplete
      loadCompanySuggestions();
    }

    function showError(message) {
      document.getElementById('stat-cards').innerHTML = '<div style="color: red; padding: 10px;">' + message + '</div>';
      document.getElementById('urgent-list').innerHTML = '<div style="color: red; padding: 10px;">' + message + '</div>';
      document.getElementById('wins-list').innerHTML = '<div style="color: red; padding: 10px;">' + message + '</div>';
    }

    function renderDashboard(data) {
      // Guard against null/undefined data
      if (!data) {
        console.error('renderDashboard: data is null or undefined');
        showError('No data available');
        return;
      }

      // Render Stat Cards with null checks
      const stats = data.pipeline || { total: 0, hot: 0, warm: 0, won: 0 };
      document.getElementById('stat-cards').innerHTML = `
        <div class="stat-card"><h4>PROSPECTS</h4><h2>${stats.total || 0}</h2></div>
        <div class="stat-card accent"><h4>HOT LEADS</h4><h2>${stats.hot || 0}</h2></div>
        <div class="stat-card"><h4>WARM LEADS</h4><h2>${stats.warm || 0}</h2></div>
        <div class="stat-card win"><h4>TOTAL WINS</h4><h2>${stats.won || 0}</h2></div>
      `;

      // Render Urgent List with null checks
      if (data.prospects && Array.isArray(data.prospects) && data.prospects.length > 0) {
        document.getElementById('urgent-list').innerHTML = data.prospects.map(p => `
          <div class="list-item">
            <span><strong>${p['company name'] || 'Unknown'}</strong></span>
            <span class="badge ${(p.urgencyband || '').toLowerCase()}">${p.urgencyband || 'N/A'}</span>
          </div>
        `).join('');
      } else {
        document.getElementById('urgent-list').innerHTML = '<div style="padding: 10px; color: #666;">No urgent prospects</div>';
      }

      // Render Wins with null checks
      if (data.accounts && Array.isArray(data.accounts) && data.accounts.length > 0) {
        document.getElementById('wins-list').innerHTML = data.accounts.map(a => `
          <div class="list-item">
            <span>${a['company name'] || 'Unknown Company'}</span>
            <small>${a['roll off container size'] || 'N/A'}</small>
          </div>
        `).join('');
      } else {
        document.getElementById('wins-list').innerHTML = '<div style="padding: 10px; color: #666;">No recent wins</div>';
      }
    }

    function renderPipeline(data) {
      // Guard against null/undefined data
      if (!data) {
        console.error('renderPipeline: data is null or undefined');
        return;
      }

      const stages = {
        hot: data.hot || [],
        warm: data.warm || [],
        cold: data.cold || [],
        won: data.won || []
      };

      document.getElementById('pipeline-hot').innerHTML = stages.hot.length > 0 ? 
        stages.hot.map(p => `<div class="pipeline-deal"><strong>${p['company name'] || 'Unknown'}</strong><br><small>${p['urgencyband'] || ''}</small></div>`).join('') : 
        '<div style="color: #999; padding: 10px; text-align: center;">No hot prospects</div>';

      document.getElementById('pipeline-warm').innerHTML = stages.warm.length > 0 ? 
        stages.warm.map(p => `<div class="pipeline-deal"><strong>${p['company name'] || 'Unknown'}</strong><br><small>${p['urgencyband'] || ''}</small></div>`).join('') : 
        '<div style="color: #999; padding: 10px; text-align: center;">No warm prospects</div>';

      document.getElementById('pipeline-cold').innerHTML = stages.cold.length > 0 ? 
        stages.cold.map(p => `<div class="pipeline-deal"><strong>${p['company name'] || 'Unknown'}</strong><br><small>${p['urgencyband'] || ''}</small></div>`).join('') : 
        '<div style="color: #999; padding: 10px; text-align: center;">No cold prospects</div>';

      document.getElementById('pipeline-won').innerHTML = stages.won.length > 0 ? 
        stages.won.map(p => `<div class="pipeline-deal"><strong>${p['company name'] || 'Unknown'}</strong><br><small>${p['timestamp'] || ''}</small></div>`).join('') : 
        '<div style="color: #999; padding: 10px; text-align: center;">No wins yet</div>';
    }

    function renderProspects(data) {
      if (!data || !data.all) {
        console.error('renderProspects: invalid data');
        crmData.prospects = [];
      } else {
        crmData.prospects = data.all;
      }
      updateProspectsTable(crmData.prospects);
    }

    function updateProspectsTable(prospects) {
      const tbody = document.getElementById('prospects-table-body');
      if (!prospects || prospects.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No prospects found</td></tr>';
        return;
      }
      tbody.innerHTML = prospects.map(p => `
        <tr>
          <td><strong>${p['company name'] || 'Unknown'}</strong></td>
          <td><span class="badge ${(p['contact status'] || '').toLowerCase()}">${p['contact status'] || 'N/A'}</span></td>
          <td>${p['urgencyband'] || 'N/A'}</td>
          <td>${p['priority score'] || 'N/A'}</td>
          <td>${p['last outreach date'] || 'N/A'}</td>
        </tr>
      `).join('');
    }

    function filterProspects() {
      const searchTerm = document.getElementById('prospects-search').value.toLowerCase();
      const filterStatus = document.getElementById('prospects-filter').value;

      if (!crmData.prospects) return;

      let filtered = crmData.prospects.filter(p => {
        const matchesSearch = (p['company name'] || '').toLowerCase().includes(searchTerm);
        const status = (p['contact status'] || '').toLowerCase();
        const matchesFilter = filterStatus === 'all' || status === filterStatus;
        return matchesSearch && matchesFilter;
      });

      updateProspectsTable(filtered);
    }

    // Load company names for autocomplete suggestions
    function loadCompanySuggestions() {
      google.script.run
        .withSuccessHandler(populateCompanySuggestions)
        .withFailureHandler(function(error) {
          console.error('Failed to load company suggestions:', error);
        })
        .getCompanyNamesForAutocomplete();
    }

    // Populate the datalist with company names
    function populateCompanySuggestions(names) {
      var datalist = document.getElementById('company-suggestions');
      if (!datalist) return;
      
      datalist.innerHTML = ''; // Clear existing
      
      if (!names || !Array.isArray(names)) {
        console.warn('No company names received for autocomplete');
        return;
      }
      
      names.forEach(function(name) {
        if (name) {
          var option = document.createElement('option');
          option.value = name;
          datalist.appendChild(option);
        }
      });
      
      console.log('Loaded ' + names.length + ' company suggestions');
    }

    async function switchTab(view, el) {
      // Update nav state
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('tab-title').innerText = view.charAt(0).toUpperCase() + view.slice(1);

      // Hide all views
      document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

      // Show selected view
      const viewEl = document.getElementById('view-' + view);
      if (viewEl) {
        viewEl.style.display = 'block';
      }

      // Load data for non-dashboard views
      if (view === 'pipeline' && !crmData.pipeline) {
        try {
          const res = await callAPI('GET_PIPELINE');
          if (res.success) {
            crmData.pipeline = res;
            renderPipeline(res);
          } else {
            console.error('Failed to load pipeline:', res.error);
          }
        } catch (e) {
          console.error('Error loading pipeline:', e);
        }
      } else if (view === 'pipeline' && crmData.pipeline) {
        renderPipeline(crmData.pipeline);
      }

      if (view === 'prospects' && !crmData.prospects) {
        try {
          const res = await callAPI('GET_PROSPECTS');
          if (res.success) {
            renderProspects(res);
          } else {
            console.error('Failed to load prospects:', res.error);
          }
        } catch (e) {
          console.error('Error loading prospects:', e);
        }
      }
    }

    window.onload = init;
  </script>
</body>

</html>


[FILE_END: CRM_Suite.html]
################################################################################

================================================================================
FILE_BEGIN: dashboard.html
METADATA: Size=120560 bytes | Last_Modified=2026-02-06 14:23:29.072762
================================================================================
<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>K&L CRM Dashboard</title>
  <style>
    /* ========================================
       CSS Variables - Design System
       ======================================== */
    :root {
      --primary: #0F2537;
      --primary-light: #1a3a52;
      --primary-dark: #0a1929;
      --success: #27ae60;
      --success-light: #2ecc71;
      --warning: #f39c12;
      --warning-light: #f1c40f;
      --danger: #c0392b;
      --danger-light: #e74c3c;
      --bg: #f2f2f6;
      --bg-dark: #e5e5ea;
      --card-bg: #ffffff;
      --text: #1c1c1e;
      --text-secondary: #8e8e93;
      --text-light: #ffffff;
      --border: #dcdde1;
      --border-light: #e9ecef;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
      --shadow-hover: 0 4px 16px rgba(0, 0, 0, 0.12);
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
      --transition: all 0.2s ease;
      --transition-slow: all 0.3s ease;
      --sidebar-width: 450px;
      --sidebar-min-width: 320px;
      --sidebar-max-width: 600px;
      --header-height: 64px;
    }

    /* CRM Dashboard Panel */
    .crm-summary-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .crm-tile {
      padding: 10px;
      border-radius: var(--radius-sm);
      text-align: center;
      font-size: 12px;
      font-weight: 700;
      box-shadow: var(--shadow);
    }

    .crm-tile.red {
      background: var(--danger);
      color: var(--text-light);
    }

    .crm-tile.yellow {
      background: var(--warning);
      color: var(--text);
    }

    .crm-tile.green {
      background: var(--success);
      color: var(--text-light);
    }

    .crm-tile.orange {
      background: var(--warning-light);
      color: var(--text);
    }

    .crm-tile.blue {
      background: var(--primary-light);
      color: var(--text-light);
    }

    .crm-tile.teal {
      background: #1abc9c;
      color: var(--text-light);
    }

    .crm-tile.gray {
      background: var(--text-secondary);
      color: var(--text-light);
    }

    .crm-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }

    .crm-table th,
    .crm-table td {
      padding: 8px;
      border-bottom: 1px solid var(--border-light);
      font-size: 12px;
    }

    .crm-table th {
      text-transform: uppercase;
      font-size: 10px;
      color: var(--text-secondary);
    }

    /* ========================================
       Reset & Base Styles
       ======================================== */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ========================================
       Sidebar Container (works in both dialog and sidebar contexts)
       ======================================== */
    .sidebar-container {
      position: relative;
      height: 100%;
      width: 100%;
      min-width: var(--sidebar-min-width);
      max-width: var(--sidebar-max-width);
      background: var(--card-bg);
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      z-index: 999999;
      transition: box-shadow var(--transition), transform var(--transition-slow);
      overflow: hidden;
      /* Prevent container overflow */
    }

    /* Dialog context - make it floating */
    body:has(.dialog-context) .sidebar-container {
      position: absolute;
      top: 0;
      left: 0;
      width: var(--sidebar-width);
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
    }

    .sidebar-container.floating {
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
      transform: translateX(-10px);
    }

    .sidebar-container.resizing {
      transition: none;
    }

    /* ========================================
       Resize Handle
       ======================================== */
    .resize-handle {
      position: absolute;
      top: 0;
      right: -8px;
      width: 16px;
      height: 100%;
      cursor: ew-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000000;
      background: linear-gradient(90deg, transparent, rgba(15, 37, 55, 0.1));
      border-radius: 0 8px 8px 0;
    }

    .resize-handle::before {
      content: '';
      height: 60px;
      width: 6px;
      background: var(--border);
      border-radius: 3px;
      transition: var(--transition);
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .resize-handle:hover::before,
    .resize-handle.active::before {
      background: var(--primary);
      box-shadow: 0 0 8px rgba(15, 37, 55, 0.4);
    }

    /* ========================================
       Sidebar Header
       ======================================== */
    .sidebar-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-shrink: 0;
      cursor: move;
      user-select: none;
      position: relative;
    }

    .sidebar-header::before {
      content: '‚ãÆ‚ãÆ';
      position: absolute;
      left: 8px;
      font-size: 10px;
      opacity: 0.6;
      letter-spacing: 2px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-icon {
      font-size: 24px;
      line-height: 1;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
    }

    .brand-title {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.3px;
      line-height: 1.2;
    }

    .brand-subtitle {
      font-size: 11px;
      opacity: 0.85;
      font-weight: 500;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .time-badge {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(8px);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }

    /* ========================================
       Sidebar Content
       ======================================== */
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      scroll-behavior: smooth;
    }

    .sidebar-content::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar-content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .sidebar-content::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* ========================================
       Section Styles
       ======================================== */
    .section {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid var(--border-light);
      transition: var(--transition);
    }

    .section:hover {
      box-shadow: var(--shadow-hover);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .section-title-icon {
      font-size: 14px;
    }

    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, var(--border-light), transparent);
      margin-left: 8px;
    }

    /* ========================================
       Form Elements
       ======================================== */
    .form-group {
      margin-bottom: 8px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 9px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 3px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 6px 8px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-family: inherit;
      background: var(--card-bg);
      color: var(--text);
      transition: var(--transition);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(15, 37, 55, 0.1);
      transform: translateY(-1px);
    }

    .form-input::placeholder,
    .form-textarea::placeholder {
      color: var(--text-secondary);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
      max-height: 200px;
    }

    /* ========================================
       Status Buttons
       ======================================== */
    .status-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    /* ========================================
       Date Grid
       ======================================== */
    .date-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    /* ========================================
       Buttons
       ======================================== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
      opacity: 0;
      transition: var(--transition);
    }

    .btn:hover::before {
      opacity: 1;
    }

    .btn-primary {
      width: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      box-shadow: 0 4px 12px rgba(15, 37, 55, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(15, 37, 55, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-warning {
      width: 100%;
      background: linear-gradient(135deg, var(--warning) 0%, var(--warning-light) 100%);
      color: var(--text);
      box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
    }

    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
    }

    /* ========================================
       Stats Grid
       ======================================== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-dark) 100%);
      padding: 14px 10px;
      border-radius: var(--radius-sm);
      text-align: center;
      border: 1px solid var(--border-light);
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .stat-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--primary);
      line-height: 1.2;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ========================================
       Quick Links
       ======================================== */
    .quick-links {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .quick-link {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 12px 8px;
      background: var(--card-bg);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
      font-family: inherit;
      color: var(--text);
      text-decoration: none;
      cursor: pointer;
      transition: var(--transition);
    }

    .quick-link:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.05) 0%, transparent 100%);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    /* ========================================
       Suggestions / Autocomplete
       ======================================== */
    .suggestions-container {
      position: relative;
    }

    .suggestions {
      position: absolute;
      top: calc(100% - 2px);
      left: 0;
      right: 0;
      background: var(--card-bg);
      border: 2px solid var(--primary);
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      max-height: 180px;
      overflow-y: auto;
      display: none;
      z-index: 1000001;
      box-shadow: var(--shadow-lg);
      border-top: none;
    }

    .suggestions.active {
      display: block;
      animation: slideDown 0.2s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .suggestion-item {
      padding: 12px 14px;
      font-size: 14px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-light);
      transition: var(--transition);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item:hover,
    .suggestion-item.highlighted {
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.08) 0%, transparent 100%);
      color: var(--primary);
    }

    /* ========================================
       Last Touch Card
       ======================================== */
    .last-touch-card {
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-dark) 100%);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      padding: 14px;
      margin-top: 12px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .last-touch-card.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .last-touch-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .last-touch-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 13px;
    }

    .last-touch-item {
      background: var(--card-bg);
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border-light);
    }

    .last-touch-label {
      display: block;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 4px;
    }

    .last-touch-value {
      font-weight: 700;
      color: var(--text);
      word-break: break-word;
    }

    .days-since {
      font-weight: 800;
      color: var(--warning);
    }

    .days-since.low {
      color: var(--success);
    }

    .days-since.high {
      color: var(--danger);
    }

    /* ========================================
       Account Form
       ======================================== */
    .account-form {
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.08) 0%, rgba(46, 204, 113, 0.05) 100%);
      border: 2px solid var(--success);
      border-radius: var(--radius-sm);
      padding: 14px;
      margin-top: 12px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .account-form.active {
      display: block;
    }

    .account-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 700;
      color: var(--success);
      margin-bottom: 12px;
    }

    /* ========================================
       Voice Section
       ======================================== */
    .voice-section {
      margin-top: 12px;
    }

    .voice-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      font-family: inherit;
      transition: var(--transition);
      box-shadow: 0 4px 12px rgba(15, 37, 55, 0.3);
    }

    .voice-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(15, 37, 55, 0.4);
    }

    .voice-btn.recording {
      background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
      animation: pulse 1.2s ease-in-out infinite;
      box-shadow: 0 4px 12px rgba(192, 57, 43, 0.3);
    }

    .voice-btn.recording:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 20px rgba(192, 57, 43, 0.4);
    }

    @keyframes pulse {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.4);
      }

      50% {
        box-shadow: 0 0 0 12px rgba(192, 57, 43, 0);
      }
    }

    .voice-preview {
      background: var(--bg);
      border: 2px dashed var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 8px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      transition: var(--transition);
    }

    .voice-preview.has-content {
      border-style: solid;
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.05) 0%, transparent 100%);
      color: var(--text);
    }

    /* ========================================
       Shortcut Hint
       ======================================== */
    .shortcut-hint {
      font-size: 11px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 12px;
      font-style: italic;
      opacity: 0.8;
    }

    /* ========================================
       Toast Notifications
       ======================================== */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--primary);
      color: var(--text-light);
      padding: 14px 24px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 600;
      display: none;
      z-index: 1000002;
      box-shadow: var(--shadow-lg);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .toast.show {
      display: block;
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.warning {
      background: var(--warning);
      color: var(--text);
    }

    /* ========================================
       Loading Overlay
       ======================================== */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .loading-overlay.active {
      display: flex;
      opacity: 1;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ========================================
       Prospect Status Indicator
       ======================================== */
    .prospect-status-indicator {
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-dark) 100%);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      margin-bottom: 12px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .status-icon {
      font-size: 18px;
      margin-bottom: 6px;
    }

    .status-message {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .prospect-status-indicator.existing {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.08) 0%, transparent 100%);
    }

    .prospect-status-indicator.new {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.08) 0%, transparent 100%);
    }

    .prospect-status-indicator.existing .status-icon {
      color: var(--success);
    }

    .prospect-status-indicator.new .status-icon {
      color: var(--primary);
    }

    /* ========================================
       Workflow Display
       ======================================== */
    .workflow-display {
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-dark) 100%);
      border: 2px solid var(--primary);
      border-radius: var(--radius-sm);
      padding: 14px;
      margin-top: 12px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .workflow-display.urgent {
      border-color: var(--danger);
      background: linear-gradient(135deg, rgba(192, 57, 43, 0.08) 0%, rgba(192, 57, 43, 0.05) 100%);
    }

    .workflow-display.high {
      border-color: var(--warning);
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.08) 0%, rgba(243, 156, 18, 0.05) 100%);
    }

    .workflow-display.medium {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.08) 0%, rgba(15, 37, 55, 0.05) 100%);
    }

    .workflow-display.low {
      border-color: var(--text-secondary);
      background: linear-gradient(135deg, rgba(142, 142, 147, 0.08) 0%, rgba(142, 142, 147, 0.05) 100%);
    }

    .workflow-status {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .workflow-item {
      background: var(--card-bg);
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid var(--border-light);
      text-align: center;
    }

    .workflow-label {
      display: block;
      font-size: 9px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .workflow-value {
      font-size: 12px;
      font-weight: 700;
      color: var(--text);
    }

    .workflow-value.success {
      color: var(--success);
    }

    .workflow-value.warning {
      color: var(--warning);
    }

    .workflow-value.info {
      color: var(--primary);
    }

    .workflow-value.danger {
      color: var(--danger);
    }

    /* ========================================
       Outcome Buttons
       ======================================== */
    .outcome-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 4px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--card-bg);
      cursor: pointer;
      font-size: 11px;
      font-weight: 700;
      font-family: inherit;
      color: var(--text-secondary);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      text-align: center;
      min-height: 48px;
    }

    .outcome-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
      opacity: 0;
      transition: var(--transition);
    }

    .outcome-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .outcome-btn:hover::before {
      opacity: 1;
    }

    .outcome-btn.active {
      border-color: var(--primary);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      box-shadow: 0 4px 12px rgba(15, 37, 55, 0.3);
      transform: translateY(-2px);
    }

    .outcome-btn.active::before {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
      opacity: 1;
    }

    .outcome-btn-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    /* ========================================
       Quick Date Options
       ======================================== */
    .quick-date-options {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .quick-date-btn {
      flex: 1;
      min-width: 70px;
      padding: 8px 6px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 600;
      font-family: inherit;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
    }

    .quick-date-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.05) 0%, transparent 100%);
    }

    /* ========================================
       Report Output
       ======================================== */
    .copy-report-btn {
      padding: 6px 12px;
      background: var(--success);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .copy-report-btn:hover {
      background: var(--success-light);
    }

    .report-textarea {
      width: 100%;
      min-height: 150px;
      max-height: 300px;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
      font-size: 11px;
      line-height: 1.5;
      background: var(--bg);
      color: var(--text);
      resize: vertical;
    }

    .report-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* ========================================
       Control Center - Tabbed Utilities
       ======================================== */
    .control-center-content {
      display: block;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .control-center-content.collapsed {
      max-height: 0;
      overflow: hidden;
    }

    .control-center-tabs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      margin-bottom: 12px;
    }

    .control-tab {
      padding: 8px 4px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 600;
      font-family: inherit;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
    }

    .control-tab:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.05) 0%, transparent 100%);
    }

    .control-tab.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(15, 37, 55, 0.2);
      transform: translateY(-1px);
    }

    .control-tool {
      display: none;
      animation: fadeIn 0.2s ease;
    }

    .control-tool.active {
      display: block;
    }

    /* ========================================
       Responsive Design
       ======================================== */
    @media (max-width: 768px) {
      .sidebar-container {
        width: 100% !important;
        min-width: 100% !important;
        max-width: 100% !important;
        height: 100vh;
        border-radius: 0;
      }

      .resize-handle {
        display: none;
      }

      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
      }

      .stat-card {
        padding: 10px 6px;
      }

      .stat-value {
        font-size: 20px;
      }

      .control-center-tabs {
        grid-template-columns: repeat(2, 1fr);
      }

      .control-tab {
        font-size: 9px;
        padding: 6px 4px;
      }
    }
  </style>
</head>

<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
  </div>

  <!-- Floating Sidebar -->
  <div class="sidebar-container" id="sidebar">
    <!-- Resize Handle -->
    <div class="resize-handle" id="resizeHandle"></div>

    <!-- Header -->
    <div class="sidebar-header">
      <div class="header-left">
        <span class="brand-icon">üó∫Ô∏è</span>
        <div class="brand-text">
          <span class="brand-title">K&L CRM</span>
          <span class="brand-subtitle">Field Operations</span>
        </div>
      </div>
      <div class="header-right">
        <div class="time-badge" id="currentTime">--:--</div>
      </div>
    </div>

    <!-- Content -->
    <div class="sidebar-content">
      <!-- Visit Entry Section -->
      <div class="section">
        <div class="visit-header">
          <div class="visit-title">
            <span>üìù</span>
            <span>Log Visit</span>
          </div>
        </div>

        <!-- Outreach ID -->
        <div class="form-group">
          <label for="outreachId" class="form-label">Outreach ID</label>
          <input type="text" id="outreachId" class="form-input"
            placeholder="Leave empty to auto-generate (e.g., LID-00128)">
        </div>

        <!-- Company Search with Autocomplete -->
        <div class="form-group suggestions-container">
          <label for="companyInput" class="form-label">Company <span class="required">*</span></label>
          <input type="text" id="companyInput" list="companyList" class="form-input" oninput="handleCompanySearchInput(this.value)" placeholder="Search or type new company..." autocomplete="off">
          <datalist id="companyList"></datalist>
          <input type="hidden" id="selectedCompanyId">
        </div>

        <!-- New Company Info Toggle -->
        <div class="form-group">
          <button type="button" class="quick-link" style="width:100%;" onclick="toggleNewCompanyFields()">
            <span id="newCompanyToggleIcon">+</span>
            <span id="newCompanyToggleText">Add New Company Details</span>
          </button>
        </div>

        <!-- New Company Additional Fields -->
        <div id="newCompanyFields" class="new-company-fields" style="display:none;">
          <div class="form-group">
            <label for="newAddress" class="form-label">Address</label>
            <input type="text" id="newAddress" class="form-input" placeholder="Street address">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newCity" class="form-label">City</label>
              <input type="text" id="newCity" class="form-input" placeholder="City" value="Tyler">
            </div>
            <div class="form-group">
              <label for="newState" class="form-label">State</label>
              <input type="text" id="newState" class="form-input" placeholder="State" value="TX">
            </div>
            <div class="form-group">
              <label for="newZip" class="form-label">Zip</label>
              <input type="text" id="newZip" class="form-input" placeholder="Zip Code">
            </div>
          </div>
          <div class="form-group">
            <label for="newIndustry" class="form-label">Industry</label>
            <select id="newIndustry" class="form-select">
              <option value="">Select Industry...</option>
              <option value="Agriculture">Agriculture</option>
              <option value="Appliance">Appliance</option>
              <option value="Automotive">Automotive</option>
              <option value="Business to business">Business to business</option>
              <option value="Construction">Construction</option>
              <option value="Electrical">Electrical</option>
              <option value="Fabrication">Fabrication</option>
              <option value="Fence">Fence</option>
              <option value="Gutter">Gutter</option>
              <option value="HVAC">HVAC</option>
              <option value="Junk Removal">Junk Removal</option>
              <option value="Manufacturing">Manufacturing</option>
              <option value="Metal Fabrication">Metal Fabrication</option>
              <option value="Other">Other</option>
              <option value="Plumbing">Plumbing</option>
              <option value="Retail">Retail</option>
              <option value="Roofing">Roofing</option>
              <option value="Trailer Dealer">Trailer Dealer</option>
              <option value="Warehouses">Warehouses</option>
              <option value="Welding">Welding</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newContact" class="form-label">Contact Name</label>
              <input type="text" id="newContact" class="form-input" placeholder="Contact">
            </div>
            <div class="form-group">
              <label for="newPhone" class="form-label">Phone</label>
              <input type="tel" id="newPhone" class="form-input" placeholder="Phone">
            </div>
          </div>
          <div class="form-group">
            <label for="newEmail" class="form-label">Email</label>
            <input type="email" id="newEmail" class="form-input" placeholder="Email">
          </div>
          <div class="form-group">
            <label for="competitor" class="form-label">Current Competitor</label>
            <select id="competitor" class="form-select">
              <option value="None">None / Unknown</option>
              <option value="AIM">AIM</option>
              <option value="Tyler Iron">Tyler Iron</option>
              <option value="Huntwell">Huntwell</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <!-- Last Touch Card -->
        <div class="last-touch-card" id="lastTouchCard">
          <div class="last-touch-header">
            <span>üìä</span>
            <span>Last Touch</span>
          </div>
          <div class="last-touch-grid">
            <div class="last-touch-item">
              <span class="last-touch-label">Last Contact</span>
              <span class="last-touch-value" id="lastContactDate">--</span>
            </div>
            <div class="last-touch-item">
              <span class="last-touch-label">Days Since</span>
              <span class="last-touch-value days-since" id="daysSince">--</span>
            </div>
            <div class="last-touch-item">
              <span class="last-touch-label">Last Outcome</span>
              <span class="last-touch-value" id="lastOutcome">--</span>
            </div>
            <div class="last-touch-item">
              <span class="last-touch-label">Next Steps</span>
              <span class="last-touch-value" id="nextSteps">--</span>
            </div>
          </div>
        </div>

        <!-- Outcome Selection (UPDATED TO MATCH SETTINGS) -->
        <label class="visit-type-label">Visit Outcome</label>
        <div class="outcome-btn-grid">
          <button type="button" class="outcome-btn" onclick="setOutcome('Account Won', this)">
            <span>üèÜ</span> Account Won
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Interested (Hot)', this)">
            <span>üî•</span> Interested (Hot)
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Interested (Warm)', this)">
            <span>üéØ</span> Interested (Warm)
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Initial Contact', this)">
            <span>üëã</span> Initial Contact
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Follow-Up', this)">
            <span>üîÑ</span> Follow-Up
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('No Answer', this)">
            <span>üìû</span> No Answer
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Not Interested', this)">
            <span>üö´</span> Not Interested
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Disqualified', this)">
            <span>‚ùå</span> Disqualified
          </button>
        </div>

        <!-- Stage & Status Display (Auto-populated based on Outcome) -->
        <div class="workflow-display" id="workflowDisplay" style="display:none;">
          <div class="form-group">
            <label class="visit-type-label">Workflow Status</label>
            <div class="workflow-status">
              <div class="workflow-item">
                <span class="workflow-label">Outcome:</span>
                <span class="workflow-value" id="outcomeValue">--</span>
              </div>
              <div class="workflow-item">
                <span class="workflow-label">Stage:</span>
                <span class="workflow-value" id="stageValue">--</span>
              </div>
              <div class="workflow-item">
                <span class="workflow-label">Status:</span>
                <span class="workflow-value" id="statusValue">--</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Date and Type -->
        <div class="date-grid">
          <div class="form-group">
            <label for="nextDate" class="form-label">Next Action</label>
            <input type="date" id="nextDate" class="form-input">
          </div>
          <div class="form-group">
            <label for="activityType" class="form-label">Type</label>
          <select id="activityType" class="form-select">
            <option value="Visit">Visit</option>
            <option value="Phone">Phone</option>
            <option value="Email">Email</option>
          </select>
          </div>
        </div>

        <!-- Notes -->
        <div class="form-group">
          <label for="notes" class="form-label">Notes</label>
          <textarea id="notes" class="form-textarea" rows="3" placeholder="Site details..."></textarea>
        </div>

        <!-- New Account Form (Only shows for WON) -->
        <div class="account-form" id="accountForm">
          <div class="account-title">
            <span>üöÄ</span>
            <span>New Account Details</span>
          </div>
          <div class="form-group">
            <input type="text" id="newContact" class="form-input" placeholder="Contact Name">
          </div>
          <div class="date-grid">
            <input type="text" id="newPhone" class="form-input" placeholder="Phone">
            <input type="text" id="newAddress" class="form-input" placeholder="Address">
          </div>
        </div>

        <!-- Prospect Status Indicator -->
        <div class="prospect-status-indicator" id="prospectStatusIndicator" style="margin-bottom: 12px; display: none;">
          <div class="status-icon" id="prospectStatusIcon">‚è≥</div>
          <div class="status-message" id="prospectStatusMessage">Checking company status...</div>
        </div>

        <!-- Save Button -->
        <button type="button" class="btn btn-primary" onclick="saveEntry()">
          <span>üíæ</span> Save Entry
        </button>

        <!-- Voice Section -->
        <div class="voice-section">
          <button type="button" class="voice-btn" id="voiceBtn" onclick="toggleVoice()">
            <span id="micIcon">üé§</span>
            <span id="micText">Voice Notes</span>
          </button>
          <div class="voice-preview" id="voicePreview">Tap to record...</div>
        </div>

        <!-- Keyboard Shortcuts -->
        <div class="shortcut-hint">Keyboard: Enter=Save ‚Ä¢ /=Search ‚Ä¢ R=Route</div>
      </div>

      <!-- Stats Section -->
      <div class="section">
        <div class="section-header">
          <div class="section-title">
            <span class="section-title-icon">üìä</span>
            Today's Overview
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statWon">0</div>
            <div class="stat-label">Wins</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statHot">0</div>
            <div class="stat-label">Hot</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statVisits">0</div>
            <div class="stat-label">Visits</div>
          </div>
        </div>
      </div>

      <!-- Summary Tiles -->
      <div id="crm-summary" class="crm-summary-grid"></div>

    <!-- Control Center - Collapsible Utility Panel -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">
          <span class="section-title-icon">‚öôÔ∏è</span>
          Control Center
        </div>
        <button type="button" class="quick-link" style="padding: 4px 8px; font-size: 10px;"
          onclick="toggleControlCenter()">
          <span id="controlCenterToggleIcon">‚ñº</span>
        </button>
      </div>

      <div id="controlCenterContent" class="control-center-content">
        <!-- Control Center Tabs -->
        <div class="control-center-tabs">
          <button type="button" class="control-tab active" onclick="showTool('route', this)">
            üó∫Ô∏è Route
          </button>
          <button type="button" class="control-tab" onclick="showTool('quick-actions', this)">
            ‚ö° Quick Actions
          </button>
          <button type="button" class="control-tab" onclick="showTool('csv', this)">
            üìÅ CSV Import
          </button>
          <button type="button" class="control-tab" onclick="showTool('report', this)">
            üìä Reports
          </button>
        </div>

        <!-- Route Planning Tool -->
        <div id="tool-route" class="control-tool active">
          <div class="date-grid">
            <div class="form-group">
              <label for="routeStart" class="form-label">Start</label>
              <input type="date" id="routeStart" class="form-input">
            </div>
            <div class="form-group">
              <label for="routeEnd" class="form-label">End</label>
              <input type="date" id="routeEnd" class="form-input">
            </div>
          </div>
          <button type="button" class="btn btn-warning" onclick="generateRoute()">
            <span>üó∫Ô∏è</span> Generate Route
          </button>
        </div>

        <!-- Quick Actions Tool -->
        <div id="tool-quick-actions" class="control-tool">
          <div class="quick-links">
            <button type="button" class="quick-link" onclick="quickAction('pipeline')">
              <span>üìä</span> Pipeline
            </button>
            <button type="button" class="quick-link" onclick="quickAction('accounts')">
              <span>üè¢</span> Accounts
            </button>
            <button type="button" class="quick-link" onclick="quickAction('calendar')">
              <span>üìÖ</span> Calendar
            </button>
            <button type="button" class="quick-link" onclick="quickAction('reports')">
              <span>üìà</span> Reports
            </button>
          </div>
        </div>

        <!-- CSV Import Tool -->
        <div id="tool-csv" class="control-tool">
          <div class="form-group">
            <label for="csvText" class="form-label">Paste CSV Data</label>
            <textarea id="csvText" class="form-textarea" rows="4" placeholder="Paste your CSV data here..."></textarea>
          </div>
          <div class="form-group">
            <label for="importSheet" class="form-label">Target Sheet</label>
            <select id="importSheet" class="form-select">
              <option value="Outreach">Outreach</option>
              <option value="Prospects">Prospects</option>
              <option value="New Accounts">New Accounts</option>
            </select>
          </div>
          <button type="button" class="btn btn-warning" onclick="importCSV()">
            <span>üì•</span> Import CSV
          </button>
        </div>

        <!-- Report Generation Tool -->
        <div id="tool-report" class="control-tool">
          <!-- Quick Date Options -->
          <div class="quick-date-options">
            <button type="button" class="quick-date-btn" onclick="setReportDates('thisWeek')">This Week</button>
            <button type="button" class="quick-date-btn" onclick="setReportDates('thisMonth')">This Month</button>
            <button type="button" class="quick-date-btn" onclick="setReportDates('last7')">Last 7 Days</button>
            <button type="button" class="quick-date-btn" onclick="setReportDates('last30')">Last 30 Days</button>
          </div>

          <div class="date-grid">
            <div class="form-group">
              <label for="reportStart" class="form-label">Start Date</label>
              <input type="date" id="reportStart" class="form-input">
            </div>
            <div class="form-group">
              <label for="reportEnd" class="form-label">End Date</label>
              <input type="date" id="reportEnd" class="form-input">
            </div>
          </div>
          <button type="button" class="btn btn-primary" onclick="generateDateRangeReport()">
            <span>üìä</span> Generate Report
          </button>
        </div>
      </div>
    </div>

    <!-- Report Output Section (hidden until report generated) -->
    <div class="section" id="reportOutputSection" style="display: none;">
      <div class="section-header">
        <div class="section-title">
          <span class="section-title-icon">üìã</span>
          Report Output
        </div>
        <button type="button" class="copy-report-btn" onclick="copyReportToClipboard()">
          üìã Copy
        </button>
      </div>
      <textarea id="reportOutput" class="report-textarea" readonly></textarea>
    </div>
  </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <script>
    // ========================================
    // Non-Blocking UI Logic
    // ========================================

    const state = {
      selectedStatus: '',
      isRecording: false,
      recognition: null,
      searchTimeout: null,
      selectedCompanyData: null
    };

    document.addEventListener('DOMContentLoaded', () => {
      detectDisplayContext();
      initializeDates();
      initializeResize();
      initializeEventListeners();
      updateTime();
      setInterval(updateTime, 60000);

      // Initialize control center tabs
      showTool('route');

      // Staggered loading to prevent server-side queuing bottlenecks
      setTimeout(loadStats, 100);
      setTimeout(loadValidationLists, 500);

      // Load company list for autocomplete
      loadCompanyAutocompleteList();
    });

    function initializeDates() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('nextDate').value = today;
      document.getElementById('routeStart').value = today;
      document.getElementById('routeEnd').value = today;
    }

    function initializeEventListeners() {
      // Close suggestions on outside click
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#companyInput') && !e.target.closest('.suggestions')) {
          document.getElementById('suggestions').classList.remove('active');
        }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', handleKeyboardShortcuts);
    }

    // ========================================
    // Company Autocomplete Logic
    // ========================================
    function loadCompanyAutocompleteList() {
      google.script.run
        .withSuccessHandler(function(companies) {
          const list = document.getElementById('companyList');
          if (companies && companies.length > 0) {
            companies.forEach(c => {
              const option = document.createElement('option');
              option.value = c.name || c.companyName || '';
              option.dataset.id = c.id || c.companyId || '';
              list.appendChild(option);
            });
            console.log('Loaded ' + companies.length + ' companies for autocomplete');
          }
        })
        .withFailureHandler(function(error) {
          console.warn('Failed to load company autocomplete list:', error);
        })
        .getCompanyAutocompleteList();
    }

    function handleCompanySearchInput(value) {
      clearTimeout(state.searchTimeout);

      if (value.length < 2) {
        document.getElementById('selectedCompanyId').value = '';
        document.getElementById('lastTouchCard').classList.remove('active');
        document.getElementById('prospectStatusIndicator').classList.remove('active');
        return;
      }

      // Check if value matches a datalist option
      const options = document.querySelectorAll('#companyList option');
      let matchedCompanyId = '';

      for (let opt of options) {
        if (opt.value === value) {
          matchedCompanyId = opt.dataset.id;
          break;
        }
      }

      if (matchedCompanyId) {
        document.getElementById('selectedCompanyId').value = matchedCompanyId;
        // Fetch and autofill prospect data
        google.script.run
          .withSuccessHandler(fillProspectData)
          .withFailureHandler(function(error) {
            console.warn('Failed to get prospect details:', error);
          })
          .getProspectDetails(matchedCompanyId);

        // Load last touch info
        loadLastTouchInfo(value);
        checkProspectStatus(value);
      } else {
        // New company - clear stored ID
        document.getElementById('selectedCompanyId').value = '';
      }
    }

    function fillProspectData(details) {
      if (details) {
        // Show the new company fields section
        const newCompanyFields = document.getElementById('newCompanyFields');
        const toggleIcon = document.getElementById('newCompanyToggleIcon');
        const toggleText = document.getElementById('newCompanyToggleText');

        if (newCompanyFields.style.display === 'none') {
          newCompanyFields.style.display = 'block';
          toggleIcon.textContent = '-';
          toggleText.textContent = 'Hide New Company Details';
        }

        // Autofill available fields
        if (details.address) {
          const field = document.getElementById('newAddress');
          if (field) field.value = details.address;
        }
        if (details.industry) {
          const field = document.getElementById('newIndustry');
          if (field) field.value = details.industry;
        }
        if (details.contactName) {
          const field = document.getElementById('newContact');
          if (field) field.value = details.contactName;
        }
        if (details.phone) {
          const field = document.getElementById('newPhone');
          if (field) field.value = details.phone;
        }
        if (details.email) {
          const field = document.getElementById('newEmail');
          if (field) field.value = details.email;
        }

        console.log('Autofilled prospect data:', details);
      }
    }

    // ========================================
    // Sidebar Resize & Drag Functionality
    // ========================================
    function initializeResize() {
      const sidebar = document.getElementById('sidebar');
      const handle = document.getElementById('resizeHandle');
      const header = document.querySelector('.sidebar-header');
      let isResizing = false;
      let isDragging = false;
      let startX, startY, startWidth, startLeft, startTop;

      // Resize functionality
      handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startWidth = sidebar.offsetWidth;
        sidebar.classList.add('resizing');
        handle.classList.add('active');
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
      });

      document.addEventListener('mousemove', (e) => {
        if (isResizing) {
          const diff = e.clientX - startX;
          const minWidth = 280;
          const maxWidth = 600;
          const newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth + diff));
          sidebar.style.width = newWidth + 'px';
        } else if (isDragging) {
          const diffX = e.clientX - startX;
          const diffY = e.clientY - startY;
          sidebar.style.left = (startLeft + diffX) + 'px';
          sidebar.style.top = (startTop + diffY) + 'px';
          sidebar.style.right = 'auto';
        }
      });

      document.addEventListener('mouseup', () => {
        if (isResizing || isDragging) {
          isResizing = false;
          isDragging = false;
          sidebar.classList.remove('resizing');
          handle.classList.remove('active');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });

      // Drag functionality (from header)
      header.addEventListener('mousedown', (e) => {
        // Only start drag if not clicking on header buttons
        if (e.target.closest('.header-right')) return;

        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        startLeft = sidebar.offsetLeft;
        startTop = sidebar.offsetTop;
        sidebar.classList.add('floating');
        document.body.style.cursor = 'move';
        document.body.style.userSelect = 'none';
      });

      // Touch support for resize
      handle.addEventListener('touchstart', (e) => {
        isResizing = true;
        startX = e.touches[0].clientX;
        startWidth = sidebar.offsetWidth;
        sidebar.classList.add('resizing');
      });

      document.addEventListener('touchmove', (e) => {
        if (isResizing) {
          e.preventDefault();
          const diff = e.touches[0].clientX - startX;
          const newWidth = Math.max(280, Math.min(600, startWidth + diff));
          sidebar.style.width = newWidth + 'px';
        }
      });

      document.addEventListener('touchend', () => {
        if (isResizing) {
          isResizing = false;
          sidebar.classList.remove('resizing');
        }
      });
    }

    // ========================================
    // Time Display
    // ========================================
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').innerText =
        now.toLocaleDateString('en-US', { weekday: 'short' }) + ' ' +
        now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    // ========================================
    // Keyboard Shortcuts
    // ========================================
    function handleKeyboardShortcuts(e) {
      // Ignore if typing in form fields
      if (e.target.matches('input, textarea, select')) {
        // Allow Enter to submit if in input and Shift not pressed
        if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey) {
          const tagName = e.target.tagName.toLowerCase();
          if (tagName !== 'textarea') {
            e.preventDefault();
            saveEntry();
          }
        }
        return;
      }

      switch (e.key) {
        case 'Enter':
          e.preventDefault();
          saveEntry();
          break;
        case '/':
          e.preventDefault();
          document.getElementById('companyInput').focus();
          break;
        case 'r':
        case 'R':
          generateRoute();
          break;
      }
    }

    // ========================================
    // Workflow-Based Status Selection
    // ========================================

    // Standardized workflow mapping based on user's unified approach
    const workflowMap = {
      'Account Won': {
        stage: 'Won',
        status: 'Active',
        priority: 'urgent',
        days: 1
      },
      'Interested (Hot)': {
        stage: 'Nurture',
        status: 'Interested (Hot)',
        priority: 'high',
        days: 7
      },
      'Interested (Warm)': {
        stage: 'Nurture',
        status: 'Interested (Warm)',
        priority: 'medium',
        days: 14
      },
      'Initial Contact': {
        stage: 'Outreach',
        status: 'Interested (Warm)',
        priority: 'medium',
        days: 30
      },
      'Follow-Up': {
        stage: 'Nurture',
        status: 'Interested (Warm)',
        priority: 'medium',
        days: 14
      },
      'No Answer': {
        stage: 'Outreach',
        status: 'Cold',
        priority: 'high',
        days: 3
      },
      'Not Interested': {
        stage: 'Lost',
        status: 'Disqualified',
        priority: 'low',
        days: 180
      },
      'Disqualified': {
        stage: 'Lost',
        status: 'Disqualified',
        priority: 'low',
        days: 0
      }
    };

    // Set outcome and auto-populate workflow
    function setOutcome(outcome, btn) {
      // Clear previous selections
      document.querySelectorAll('.outcome-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Get workflow details for this outcome
      const workflow = workflowMap[outcome];
      if (workflow) {
        // Update state with full workflow status
        state.selectedOutcome = outcome;
        state.selectedStage = workflow.stage;
        state.selectedStatus = workflow.status;

        // Update display
        document.getElementById('outcomeValue').textContent = outcome;
        document.getElementById('stageValue').textContent = workflow.stage;
        document.getElementById('statusValue').textContent = workflow.status;

        // Show workflow display
        document.getElementById('workflowDisplay').style.display = 'block';

        // Show account form for won accounts
        document.getElementById('accountForm').classList.toggle('active', outcome === 'Account Won');

        // Auto-set next date
        const nextDate = new Date();
        nextDate.setDate(nextDate.getDate() + workflow.days);
        document.getElementById('nextDate').value = nextDate.toISOString().split('T')[0];

        // Visual feedback based on priority
        updateWorkflowStyling(workflow.priority);
      }
    }

    // Update workflow display styling based on priority
    function updateWorkflowStyling(priority) {
      const display = document.getElementById('workflowDisplay');
      display.className = 'workflow-display';

      // Remove previous priority classes
      display.classList.remove('urgent', 'high', 'medium', 'low');

      // Add new priority class
      display.classList.add(priority);

      // Update status value styling
      const statusEl = document.getElementById('statusValue');
      statusEl.className = 'workflow-value';

      const statusColors = {
        'Won': 'success',
        'Interested (Hot)': 'warning',
        'Interested (Warm)': 'info',
        'Disqualified': 'danger',
        'Cold': 'danger',
        'Active': 'success',
        'Lost': 'danger',
        'Nurture': 'info',
        'Outreach': 'warning',
        'Prospect': 'info'
      };

      const status = state.selectedStatus;
      if (statusColors[status]) {
        statusEl.classList.add(statusColors[status]);
      }
    }

    // ========================================
    // Company Search
    // ========================================
    function searchCompany(input) {
      console.log('searchCompany called with input:', input.value);
      clearTimeout(state.searchTimeout);

      if (input.value.length < 2) {
        console.log('Input too short, hiding suggestions');
        document.getElementById('suggestions').classList.remove('active');
        document.getElementById('lastTouchCard').classList.remove('active');
        document.getElementById('prospectStatusIndicator').classList.remove('active');
        return;
      }

      console.log('Setting timeout for search');
      state.searchTimeout = setTimeout(() => {
        console.log('Calling apiSearchProspects with:', input.value);
        google.script.run
          .withSuccessHandler(handleSearchResults)
          .withFailureHandler(error => handleApiError(error, 'Search failed'))
          .apiSearchProspects(input.value);
      }, 300);
    }

    function handleSearchResults(result) {
      console.log('handleSearchResults called with:', result);
      let companies = [];

      if (result && typeof result === 'object') {
        if (Array.isArray(result)) {
          companies = result;
          console.log('Direct array result:', companies.length, 'companies');
        } else if (result.success && result.data) {
          companies = result.data;
          console.log('Object result with data:', companies.length, 'companies');
        } else if (result.success === false) {
          console.log('Search failed with error:', result.error);
          showToast('‚ùå ' + (result.error || 'Search failed'), 'error');
          return;
        } else {
          console.log('Unexpected result format:', result);
        }
      } else {
        console.log('Invalid result:', result);
      }

      console.log('Final companies array:', companies);
      if (companies.length > 0) {
        console.log('Calling showSuggestions with', companies.length, 'companies');
        showSuggestions(companies);
      } else {
        console.log('No companies found, hiding suggestions');
        // No results found - still hide dropdown
        document.getElementById('suggestions').classList.remove('active');
      }
    }

    // ========================================
    // Toast & Loading Helpers
    // ========================================
    function handleApiError(error, defaultMsg) {
      showLoading(false);
      showToast('‚ùå ' + (error.message || defaultMsg), 'error');
    }

    function showSuggestions(results) {
      console.log('showSuggestions called with:', results);
      const dropdown = document.getElementById('suggestions');
      console.log('Dropdown element:', dropdown);

      if (results && results.length > 0) {
        console.log('Generating HTML for', results.length, 'results');
        // Use data attributes instead of inline onclick to handle special characters
        dropdown.innerHTML = results.map((r, index) => {
          const escapedName = escapeHtml(r.companyName || r.company);
          const companyId = r.companyId || '';
          const address = escapeHtml(r.address || '');
          const phone = escapeHtml(r.phone || '');
          const email = escapeHtml(r.email || '');
          const contactName = escapeHtml(r.contactName || '');
          return `<div class="suggestion-item" data-index="${index}" data-name="${escapedName}" data-id="${companyId}" data-address="${address}" data-phone="${phone}" data-email="${email}" data-contact="${contactName}">${escapedName}</div>`;
        }).join('');

        console.log('HTML set, adding click listeners');
        // Add click listeners to suggestion items
        dropdown.querySelectorAll('.suggestion-item').forEach(item => {
          item.onclick = function () {
            console.log('Suggestion clicked:', this.dataset.name);
            const companyData = {
              companyName: this.dataset.name,
              companyId: this.dataset.id,
              address: this.dataset.address,
              phone: this.dataset.phone,
              email: this.dataset.email,
              contactName: this.dataset.contact
            };
            selectCompany(companyData);
          };
        });

        console.log('Adding active class to dropdown');
        dropdown.classList.add('active');
      } else {
        console.log('No results, removing active class');
        dropdown.classList.remove('active');
      }
    }

    function selectCompany(companyData) {
      // Handle both object and string input for backwards compatibility
      if (typeof companyData === 'string') {
        // Legacy: received just company name string
        document.getElementById('companyInput').value = companyData;
        document.getElementById('suggestions').classList.remove('active');
        loadLastTouchInfo(companyData);
        checkProspectStatus(companyData);
        return;
      }

      // New: receive company object with companyId - get comprehensive data for autofill
      const companyId = companyData.companyId;
      const companyName = companyData.companyName || companyData.company || '';

      document.getElementById('companyInput').value = companyName;
      document.getElementById('suggestions').classList.remove('active');

      // Visual feedback
      const input = document.getElementById('companyInput');
      input.style.borderColor = 'var(--success)';
      setTimeout(() => input.style.borderColor = 'var(--border)', 500);

      // Get comprehensive company details for autofill
      if (companyId) {
        showLoading(true);
        google.script.run
          .withSuccessHandler(function (result) {
            showLoading(false);
            if (result && result.success && result.data) {
              // Store comprehensive company data
              state.selectedCompanyData = result.data;
              // Autofill form with comprehensive data
              autofillCompanyData(result.data);
            } else {
              // Fallback to basic data if API call fails
              state.selectedCompanyData = companyData;
              autofillCompanyData(companyData);
            }
          })
          .withFailureHandler(function (error) {
            showLoading(false);
            console.warn('Failed to get comprehensive company details:', error);
            // Fallback to basic data
            state.selectedCompanyData = companyData;
            autofillCompanyData(companyData);
          })
          .getCompanyDetailsForAutofill(companyId);
      } else {
        // No companyId available, use basic data
        state.selectedCompanyData = companyData;
        autofillCompanyData(companyData);
      }

      // Load last touch information
      loadLastTouchInfo(companyName);

      // Check prospect status
      checkProspectStatus(companyName);
    }

    function autofillCompanyData(companyData) {
      console.log('üîç autofillCompanyData called with:', companyData);

      // Only autofill if we have a companyId (meaning it came from prospect sheet)
      if (!companyData.companyId) {
        console.log('‚ùå Skipping autofill - no companyId (company not found in prospect sheet)');
        console.log('Available data:', {
          companyName: companyData.companyName,
          companyId: companyData.companyId,
          hasContact: !!companyData.contactName,
          hasPhone: !!companyData.phone,
          hasAddress: !!companyData.address,
          hasEmail: !!companyData.email
        });
        showToast('‚ö†Ô∏è Company not found in prospects - manual entry required', 'warning');
        return;
      }

      console.log('‚úÖ Autofilling company data for:', companyData.companyName);
      console.log('Data to fill:', {
        contactName: companyData.contactName,
        phone: companyData.phone,
        address: companyData.address,
        email: companyData.email
      });

      // Show the "Add New Company Details" section so user can see the autofilled data
      const newCompanyFields = document.getElementById('newCompanyFields');
      const toggleIcon = document.getElementById('newCompanyToggleIcon');
      const toggleText = document.getElementById('newCompanyToggleText');

      if (newCompanyFields.style.display === 'none') {
        console.log('üìÇ Expanding new company details section');
        newCompanyFields.style.display = 'block';
        toggleIcon.textContent = '-';
        toggleText.textContent = 'Hide New Company Details';
      }

      let filledCount = 0;
      const autofillResults = [];

      // Autofill the expanded new company fields with existing company data
      // Contact Name
      if (companyData.contactName && companyData.contactName.trim()) {
        const contactField = document.getElementById('newContact');
        if (contactField) {
          contactField.value = companyData.contactName.trim();
          autofillResults.push('Contact Name');
          filledCount++;
          console.log('‚úÖ Autofilled contact name:', companyData.contactName);
        } else {
          console.log('‚ùå Contact field not found');
        }
      }

      // Phone
      if (companyData.phone && companyData.phone.trim()) {
        const phoneField = document.getElementById('newPhone');
        if (phoneField) {
          phoneField.value = companyData.phone.trim();
          autofillResults.push('Phone');
          filledCount++;
          console.log('‚úÖ Autofilled phone:', companyData.phone);
        } else {
          console.log('‚ùå Phone field not found');
        }
      }

      // Address
      if (companyData.address && companyData.address.trim()) {
        const addressField = document.getElementById('newAddress');
        if (addressField) {
          addressField.value = companyData.address.trim();
          autofillResults.push('Address');
          filledCount++;
          console.log('‚úÖ Autofilled address:', companyData.address);
        } else {
          console.log('‚ùå Address field not found');
        }
      }

      // Email
      if (companyData.email && companyData.email.trim()) {
        const emailField = document.getElementById('newEmail');
        if (emailField) {
          emailField.value = companyData.email.trim();
          autofillResults.push('Email');
          filledCount++;
          console.log('‚úÖ Autofilled email:', companyData.email);
        } else {
          console.log('‚ùå Email field not found');
        }
      }

      // Industry (if available)
      if (companyData.industry && companyData.industry.trim()) {
        const industryField = document.getElementById('newIndustry');
        if (industryField) {
          industryField.value = companyData.industry.trim();
          autofillResults.push('Industry');
          filledCount++;
          console.log('‚úÖ Autofilled industry:', companyData.industry);
        } else {
          console.log('‚ùå Industry field not found');
        }
      }

      // City (if available)
      if (companyData.city && companyData.city.trim()) {
        const cityField = document.getElementById('newCity');
        if (cityField) {
          cityField.value = companyData.city.trim();
          autofillResults.push('City');
          filledCount++;
          console.log('‚úÖ Autofilled city:', companyData.city);
        } else {
          console.log('‚ùå City field not found');
        }
      }

      // State (if available)
      if (companyData.state && companyData.state.trim()) {
        const stateField = document.getElementById('newState');
        if (stateField) {
          stateField.value = companyData.state.trim();
          autofillResults.push('State');
          filledCount++;
          console.log('‚úÖ Autofilled state:', companyData.state);
        } else {
          console.log('‚ùå State field not found');
        }
      }

      // Zip Code (if available)
      if (companyData.zip && companyData.zip.trim()) {
        const zipField = document.getElementById('newZip');
        if (zipField) {
          zipField.value = companyData.zip.trim();
          autofillResults.push('Zip Code');
          filledCount++;
          console.log('‚úÖ Autofilled zip code:', companyData.zip);
        } else {
          console.log('‚ùå Zip field not found');
        }
      }

      console.log(`üìä Filled ${filledCount} fields:`, autofillResults);

      // Show success feedback with detailed information
      if (filledCount > 0) {
        const fieldList = autofillResults.join(', ');
        showToast(`‚úÖ Company data loaded from prospects (${filledCount} fields: ${fieldList})`, 'success');
      } else {
        showToast('‚ö†Ô∏è Company found but no additional data available', 'warning');
      }

      // Ensure consistent company naming by using the exact name from prospect sheet
      if (companyData.companyName && companyData.companyName.trim()) {
        document.getElementById('companyInput').value = companyData.companyName.trim();
      }

      // Highlight the autofilled fields temporarily
      if (filledCount > 0) {
        autofillResults.forEach(function (fieldName) {
          const fieldId = fieldName.toLowerCase().replace(' ', '');
          const field = document.getElementById('new' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1));
          if (field) {
            const originalBackground = field.style.backgroundColor;
            field.style.backgroundColor = 'rgba(39, 174, 96, 0.1)';
            field.style.borderColor = 'var(--success)';
            field.style.boxShadow = '0 0 0 3px rgba(39, 174, 96, 0.1)';

            // Remove highlight after 2 seconds
            setTimeout(() => {
              field.style.backgroundColor = originalBackground;
              field.style.borderColor = 'var(--border)';
              field.style.boxShadow = 'none';
            }, 2000);
          }
        });
      }
    }

    // ========================================
    // Last Touch Info
    // ========================================
    function loadLastTouchInfo(companyName) {
      google.script.run
        .withSuccessHandler(displayLastTouchInfo)
        .withFailureHandler((error) => handleApiError(error, 'Last touch info failed'))
        .getLastTouchInfo(companyName);
    }

    function displayLastTouchInfo(result) {
      const card = document.getElementById('lastTouchCard');

      if (result && result.success && result.data) {
        const data = result.data;

        document.getElementById('lastContactDate').innerText = data.lastContact || '--';
        document.getElementById('daysSince').innerText = (data.daysSince || 0) + ' days';
        document.getElementById('lastOutcome').innerText = data.lastOutcome || '--';
        document.getElementById('nextSteps').innerText = data.nextSteps || '--';

        // Color coding based on days since
        const daysEl = document.getElementById('daysSince');
        daysEl.className = 'last-touch-value days-since';

        if (data.daysSince <= 7) {
          daysEl.classList.add('low');
        } else if (data.daysSince > 30) {
          daysEl.classList.add('high');
        }

        card.classList.add('active');
      } else {
        card.classList.remove('active');
      }
    }

    // ========================================
    // Prospect Status Checking
    // ========================================
    function checkProspectStatus(companyName) {
      if (!companyName || companyName.length < 2) {
        document.getElementById('prospectStatusIndicator').classList.remove('active');
        return;
      }

      // Show loading state
      const statusIndicator = document.getElementById('prospectStatusIndicator');
      const statusIcon = document.getElementById('prospectStatusIcon');
      const statusMessage = document.getElementById('prospectStatusMessage');

      statusIcon.textContent = '‚è≥';
      statusMessage.textContent = 'Checking company status...';
      statusIndicator.classList.remove('existing', 'new');
      statusIndicator.classList.add('active');

      google.script.run
        .withSuccessHandler(handleProspectStatusResult)
        .withFailureHandler(handleProspectStatusError)
        .checkProspectStatus(companyName);
    }

    function handleProspectStatusResult(result) {
      const statusIndicator = document.getElementById('prospectStatusIndicator');
      const statusIcon = document.getElementById('prospectStatusIcon');
      const statusMessage = document.getElementById('prospectStatusMessage');

      if (result && result.success) {
        if (result.exists) {
          // Company exists in prospects
          statusIndicator.classList.remove('new');
          statusIndicator.classList.add('existing');
          statusIcon.textContent = '‚úÖ';
          statusMessage.textContent = 'Existing prospect - ' + (result.status || 'Active');

          // Store company data for later use
          state.selectedCompanyData = {
            companyName: document.getElementById('companyInput').value,
            companyId: result.companyId,
            status: result.status,
            lastOutcome: result.lastOutcome,
            daysSinceLastContact: result.daysSinceLastContact
          };
        } else {
          // Company does not exist in prospects
          statusIndicator.classList.remove('existing');
          statusIndicator.classList.add('new');
          statusIcon.textContent = 'üÜï';
          statusMessage.textContent = 'New prospect - not in database';

          // Clear any stored company data
          state.selectedCompanyData = null;
        }
      } else {
        // Error case
        statusIndicator.classList.remove('existing', 'new');
        statusIcon.textContent = '‚ùå';
        statusMessage.textContent = 'Error checking status: ' + (result.error || 'Unknown error');
      }
    }

    function handleProspectStatusError(error) {
      const statusIndicator = document.getElementById('prospectStatusIndicator');
      const statusIcon = document.getElementById('prospectStatusIcon');
      const statusMessage = document.getElementById('prospectStatusMessage');

      statusIndicator.classList.remove('existing', 'new');
      statusIcon.textContent = '‚ùå';
      statusMessage.textContent = 'Error checking status: ' + (error.message || 'Unknown error');
      console.error('Prospect status check error:', error);
    }

    // ========================================
    // Save Entry with Duplicate LID Check
    // ========================================
    function loadStats() {
      const today = new Date().toISOString().split('T')[0];

      google.script.run
        .withSuccessHandler(res => {
          if (res && res.success && res.data) {
            const accs = res.data;
            document.getElementById('statVisits').innerText = accs.length || 0;
            document.getElementById('statWon').innerText = accs.filter(a => a.Status === 'WON').length || 0;
            document.getElementById('statHot').innerText = accs.filter(a =>
              (a.Status && a.Status.includes('HOT')) || (a.Status && a.Status.includes('STRONG'))
            ).length || 0;
          }
        })
        .withFailureHandler(error => console.error('Failed to load stats:', error))
        .getOutreachData(today, today);
    }

    // ========================================
    // Voice Recording
    // ========================================
    function toggleVoice() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showToast('‚ùå Voice not supported in this browser', 'error');
        return;
      }

      state.isRecording ? stopVoice() : startVoice();
    }

    function startVoice() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      state.recognition = new SpeechRecognition();
      state.recognition.continuous = true;
      state.recognition.interimResults = true;
      state.recognition.lang = 'en-US';

      state.recognition.onstart = () => {
        state.isRecording = true;
        updateVoiceUI(true);
      };

      state.recognition.onresult = (event) => {
        let transcript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          transcript += event.results[i][0].transcript;
        }

        const preview = document.getElementById('voicePreview');
        preview.textContent = transcript || 'Listening...';
        preview.classList.toggle('has-content', transcript.length > 0);
      };

      state.recognition.onend = () => {
        if (state.isRecording) {
          stopVoice();
        }
      };

      state.recognition.onerror = (event) => {
        console.error('Voice recognition error:', event.error);
        showToast('‚ùå Voice error: ' + event.error, 'error');
        stopVoice();
      };

      try {
        state.recognition.start();
      } catch (e) {
        showToast('‚ùå Failed to start voice recognition', 'error');
      }
    }

    function stopVoice() {
      if (state.recognition) {
        state.recognition.stop();
      }

      state.isRecording = false;
      updateVoiceUI(false);

      const text = document.getElementById('voicePreview').textContent;

      if (text && text !== 'Tap to record...' && text !== 'Listening...') {
        document.getElementById('notes').value = text;
        document.getElementById('voicePreview').classList.add('has-content');
      } else {
        document.getElementById('voicePreview').textContent = 'Tap to record...';
        document.getElementById('voicePreview').classList.remove('has-content');
      }
    }

    function updateVoiceUI(recording) {
      const btn = document.getElementById('voiceBtn');
      const icon = document.getElementById('micIcon');
      const text = document.getElementById('micText');

      btn.classList.toggle('recording', recording);
      icon.textContent = recording ? 'üéôÔ∏è' : 'üé§';
      text.textContent = recording ? 'Stop Recording' : 'Voice Notes';
    }

    /**
     * REFACTORED: Route Generation (Tab-Safe)
     */
    function generateRoute() {
      const today = new Date().toISOString().split('T')[0];
      showLoading(true);
      showToast('üöõ Fetching today\'s stops...', 'info');

      google.script.run
        .withSuccessHandler(res => {
          showLoading(false);
          if (res.success && res.data && res.data.length > 0) {
            const companies = res.data.map(e => e.company || e.Company || '').filter(n => n !== '');

            // Open in NEW TAB via Backend to bypass popup blockers
            google.script.run.generateRouteForCompanies(companies);
            showToast('üó∫Ô∏è Route sent to Maps!', 'success');
          } else {
            showToast('‚ö†Ô∏è No stops logged for today.', 'warning');
          }
        })
        .withFailureHandler(e => handleApiError(e, 'Route failed'))
        .getOutreachData(today, today);
    }

    function handleRouteResult(result) {
      showLoading(false);

      if (result.success && result.data) {
        const url = result.data.url;
        const failures = result.data.failures;

        // Open route in new tab
        if (url) {
          window.open(url, '_blank');
        }

        let message = 'üöõ Route generated!';

        if (failures && failures.length > 0) {
          message += ` (${failures.length} not found)`;
        }

        showToast(message, 'success');
      } else {
        showToast('‚ùå Route generation failed', 'error');
      }
    }

    /**
     * REFACTORED: Quick Action Handler (Non-Blocking)
     */
    function quickAction(action) {
      console.log('Action triggered:', action);

      // Turn off loading spinner immediately for UI fluidity
      if (action === 'reports') {
        showToast('üìä Initializing Report...', 'info');
        // Fire and Forget: Do not wait for success handler to finish before allowing interaction
        google.script.run
          .withFailureHandler(e => showToast('‚ùå Report Error: ' + e.message, 'error'))
          .showProfessionalReport();
        return;
      }

      switch (action) {
        case 'pipeline':
          showToast('üöÄ Opening Pipeline...', 'info');
          google.script.run.openSuiteCRM(); // Routes to the new Suite View
          break;
        case 'accounts':
          // Direct link to sheet to avoid modal blocking
          window.open('https://docs.google.com/spreadsheets/d/1veh2zY5h6sVktA7tdH8k85-TwNEEpdgUYYR16J2a3bdWFeLoTcP2TbJq/edit#gid=0', '_blank');
          break;
        case 'calendar':
          showCalendarView();
          break;
        default:
          showToast('‚ö†Ô∏è Feature in development', 'warning');
      }
    }

    // Show pipeline overview with stats by stage
    function showPipelineView() {
      showLoading(true);
      google.script.run
        .withSuccessHandler(function (data) {
          showLoading(false);
          if (data.success && data.data) {
            displayPipelineModal(data.data);
          } else {
            showToast('‚ùå Failed to load pipeline data', 'error');
          }
        })
        .withFailureHandler(function (error) {
          showLoading(false);
          showToast('‚ùå Pipeline error: ' + (error.message || 'Unknown error'), 'error');
        })
        .getDashboardMetrics();
    }

    // Show accounts management view
    function showAccountsView() {
      showLoading(true);

      // First try to open the New Accounts sheet
      try {
        var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
        var sheet = spreadsheet.getSheetByName('New Accounts');
        if (sheet) {
          sheet.activate();
          showLoading(false);
          showToast('‚úÖ New Accounts sheet opened', 'success');
          return;
        }
      } catch (e) {
        // Sheet not accessible, continue to show modal
      }

      // If sheet not accessible, show a summary modal instead
      google.script.run
        .withSuccessHandler(function (result) {
          showLoading(false);
          if (result.success && result.data) {
            displayAccountsModal(result.data);
          } else {
            showToast('‚ùå Failed to load account data', 'error');
          }
        })
        .withFailureHandler(function (error) {
          showLoading(false);
          showToast('‚ùå Accounts error: ' + (error.message || 'Unknown error'), 'error');
        })
        .getOutreachData(new Date().toISOString().split('T')[0], new Date().toISOString().split('T')[0]);
    }

    // Show calendar view of upcoming follow-ups
    function showCalendarView() {
      showLoading(true);

      // Get today's date and future dates
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(today.getDate() + 1);
      const nextWeek = new Date(today);
      nextWeek.setDate(today.getDate() + 7);

      // Get today's tasks
      google.script.run
        .withSuccessHandler(function (todayResult) {
          // Get tomorrow's tasks
          google.script.run
            .withSuccessHandler(function (tomorrowResult) {
              // Get this week's tasks
              google.script.run
                .withSuccessHandler(function (weekResult) {
                  showLoading(false);
                  displayCalendarModal({
                    today: todayResult.success ? todayResult.data : [],
                    tomorrow: tomorrowResult.success ? tomorrowResult.data : [],
                    thisWeek: weekResult.success ? weekResult.data : []
                  });
                })
                .withFailureHandler(function (error) {
                  showLoading(false);
                  showToast('‚ùå Calendar error: ' + (error.message || 'Unknown error'), 'error');
                })
                .getOutreachData(today.toISOString().split('T')[0], nextWeek.toISOString().split('T')[0]);
            })
            .withFailureHandler(function (error) {
              showLoading(false);
              showToast('‚ùå Calendar error: ' + (error.message || 'Unknown error'), 'error');
            })
            .getOutreachData(tomorrow.toISOString().split('T')[0], tomorrow.toISOString().split('T')[0]);
        })
        .withFailureHandler(function (error) {
          showLoading(false);
          showToast('‚ùå Calendar error: ' + (error.message || 'Unknown error'), 'error');
        })
        .getOutreachData(today.toISOString().split('T')[0], today.toISOString().split('T')[0]);
    }

    // Display pipeline overview modal
    function displayPipelineModal(data) {
      const pipeline = data.pipeline || {};
      const activity = data.activity || [];

      let html = `
        <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #0F2537; margin-bottom: 10px;">üìä Sales Pipeline Overview</h1>
            <p style="color: #666;">Current status of all leads and opportunities</p>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${pipeline.totalActive || 0}</div>
              <div style="font-size: 14px; opacity: 0.9;">Active Opportunities</div>
            </div>
            <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${(pipeline.byStage || {}).Lost || 0}</div>
              <div style="font-size: 14px; opacity: 0.9;">Lost Deals</div>
            </div>
          </div>

          <h3 style="color: #0F2537; margin-bottom: 15px;">üìà Pipeline by Stage</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
      `;

      // Pipeline stages
      const stages = ['Prospect', 'Nurture', 'Active Pursuit', 'Customer', 'Lost'];
      stages.forEach(stage => {
        const count = (pipeline.byStage || {})[stage] || 0;
        const colors = {
          'Prospect': '#3498db',
          'Nurture': '#f39c12',
          'Active Pursuit': '#e74c3c',
          'Customer': '#27ae60',
          'Lost': '#95a5a6'
        };
        html += `
          <div style="background: ${colors[stage]}; color: white; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${count}</div>
            <div style="font-size: 12px;">${stage}</div>
          </div>
        `;
      });

      html += `
          </div>

          <h3 style="color: #0F2537; margin-bottom: 15px;">üî• Recent Activity</h3>
          <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
      `;

      if (activity.length > 0) {
        activity.slice(0, 5).forEach(item => {
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;">
              <div>
                <div style="font-weight: 600; color: #2c3e50;">${item.company || 'Unknown Company'}</div>
                <div style="font-size: 12px; color: #7f8c8d;">${item.outcome || 'No outcome'}</div>
              </div>
              <div style="font-size: 12px; color: #95a5a6;">${item.date || 'No date'}</div>
            </div>
          `;
        });
      } else {
        html += '<p style="color: #666; text-align: center; margin: 20px 0;">No recent activity found</p>';
      }

      html += `
          </div>
        </div>
      `;

      const htmlOutput = HtmlService
        .createHtmlOutput(html)
        .setWidth(800)
        .setHeight(600);

      SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üìä Sales Pipeline');
    }

    // Display calendar modal with upcoming follow-ups
    function displayCalendarModal(data) {
      const today = new Date();
      const nextWeek = new Date(today);
      nextWeek.setDate(today.getDate() + 7);

      let html = `
        <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #0F2537; margin-bottom: 10px;">üìÖ Upcoming Follow-ups</h1>
            <p style="color: #666;">Scheduled activities and reminders</p>
          </div>

          <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h4 style="color: #856404; margin-bottom: 10px;">üìã Today's Tasks</h4>
      `;

      // Display today's tasks
      if (data.today && data.today.length > 0) {
        data.today.slice(0, 3).forEach(task => {
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #ffeaa7;">
              <div>
                <div style="font-weight: 600; color: #856404;">${task.company || task['Company Name'] || 'Unknown Company'}</div>
                <div style="font-size: 12px; color: #856404;">${task.Notes || 'No notes'}</div>
              </div>
              <div style="font-size: 12px; color: #856404; font-weight: 600;">${task.Status || 'Pending'}</div>
            </div>
          `;
        });
      } else {
        html += `<p style="color: #856404; margin: 0;">No tasks scheduled for today</p>`;
      }

      html += `
          </div>

          <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <h4 style="color: #0c5460; margin-bottom: 10px;">‚è∞ This Week</h4>
      `;

      // Display this week's tasks
      if (data.thisWeek && data.thisWeek.length > 0) {
        data.thisWeek.slice(0, 5).forEach(task => {
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #bee5eb;">
              <div>
                <div style="font-weight: 600; color: #0c5460;">${task.company || task['Company Name'] || 'Unknown Company'}</div>
                <div style="font-size: 12px; color: #0c5460;">${task.Notes || 'No notes'}</div>
              </div>
              <div style="font-size: 12px; color: #0c5460; font-weight: 600;">${task.Status || 'Pending'}</div>
            </div>
          `;
        });
      } else {
        html += `<p style="color: #0c5460; margin: 0;">No follow-ups scheduled this week</p>`;
      }

      html += `
          </div>

          <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
            <h4 style="color: #495057; margin-bottom: 10px;">üìä Activity Summary</h4>
      `;

      // Calculate summary statistics
      const totalToday = data.today ? data.today.length : 0;
      const totalThisWeek = data.thisWeek ? data.thisWeek.length : 0;
      const totalActivities = totalToday + totalThisWeek;

      if (totalActivities > 0) {
        html += `<p style="color: #495057; margin: 0;">${totalActivities} scheduled activities this week (${totalToday} today, ${totalThisWeek} remaining)</p>`;
      } else {
        html += `<p style="color: #6c757d; margin: 0;">No scheduled activities found</p>`;
      }

      html += `
          </div>
        </div>
      `;

      const htmlOutput = HtmlService
        .createHtmlOutput(html)
        .setWidth(750)
        .setHeight(600);

      SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üìÖ Calendar View');
    }

    // Display accounts summary modal
    function displayAccountsModal(data) {
      // Calculate account statistics
      const totalAccounts = data.length;
      const deployedAccounts = data.filter(a => a.Status && a.Status.toUpperCase().includes('DEPLOYED')).length;
      const pendingAccounts = totalAccounts - deployedAccounts;

      let html = `
        <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #0F2537; margin-bottom: 10px;">üè¢ Account Management</h1>
            <p style="color: #666;">New account deployments and status</p>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${totalAccounts}</div>
              <div style="font-size: 14px; opacity: 0.9;">Total Accounts</div>
            </div>
            <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${deployedAccounts}</div>
              <div style="font-size: 14px; opacity: 0.9;">Deployed</div>
            </div>
            <div style="background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${pendingAccounts}</div>
              <div style="font-size: 14px; opacity: 0.9;">Pending</div>
            </div>
          </div>

          <h3 style="color: #0F2537; margin-bottom: 15px;">üìã Recent Account Activity</h3>
          <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
      `;

      if (data && data.length > 0) {
        // Show last 5 accounts
        data.slice(-5).reverse().forEach(account => {
          const statusColor = account.Status && account.Status.toUpperCase().includes('DEPLOYED') ? '#27ae60' : '#f39c12';
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee;">
              <div>
                <div style="font-weight: 600; color: #2c3e50;">${account.company || account['Company Name'] || 'Unknown Company'}</div>
                <div style="font-size: 12px; color: #7f8c8d;">${account.Notes || 'No notes available'}</div>
              </div>
              <div style="font-size: 12px; color: ${statusColor}; font-weight: 600;">${account.Status || 'Pending'}</div>
            </div>
          `;
        });
      } else {
        html += '<p style="color: #666; text-align: center; margin: 20px 0;">No account data available</p>';
      }

      html += `
          </div>

          <div style="margin-top: 20px; text-align: center;">
            <button onclick="window.open('', '_blank').close();" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
              üìä Open Full Accounts Sheet
            </button>
          </div>
        </div>
      `;

      const htmlOutput = HtmlService
        .createHtmlOutput(html)
        .setWidth(750)
        .setHeight(600);

      SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üè¢ Account Management');
    }

    // ========================================
    // Generate Date Range Report
    // ========================================
    function generateDateRangeReport() {
      const startDate = document.getElementById('reportStart').value;
      const endDate = document.getElementById('reportEnd').value;

      if (!startDate || !endDate) {
        showToast('Please select both start and end dates', 'error');
        return;
      }

      // Show loading immediately
      showLoading(true);

      // Set timeout to prevent infinite freeze
      const timeoutId = setTimeout(() => {
        showLoading(false);
        showToast('Report generation timed out. Try a shorter date range.', 'error');
      }, 30000); // 30 second timeout

      google.script.run
        .withSuccessHandler(function () { showLoading(false); showToast('Report opened', 'success'); })
        .withFailureHandler(function (e) { showLoading(false); handleApiError(e, 'Report generation failed'); })
        .showProfessionalReport(startDate, endDate);
    }

    // ========================================
    // Quick Date Selection
    // ========================================
    function setReportDates(range) {
      const today = new Date();
      let start, end;

      switch (range) {
        case 'thisWeek':
          // Start from Sunday of current week
          start = new Date(today);
          start.setDate(today.getDate() - today.getDay());
          break;
        case 'thisMonth':
          start = new Date(today.getFullYear(), today.getMonth(), 1);
          break;
        case 'last7':
          start = new Date(today);
          start.setDate(today.getDate() - 7);
          break;
        case 'last30':
          start = new Date(today);
          start.setDate(today.getDate() - 30);
          break;
      }

      end = today;

      document.getElementById('reportStart').value = formatDate(start);
      document.getElementById('reportEnd').value = formatDate(end);
    }

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    // ========================================
    // Copy Report to Clipboard
    // ========================================
    function copyReportToClipboard() {
      const textarea = document.getElementById('reportOutput');

      // Try modern API first
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textarea.value)
          .then(() => {
            showToast('üìã Report copied to clipboard!', 'success');
          })
          .catch(err => {
            fallbackCopy(textarea);
          });
      } else {
        fallbackCopy(textarea);
      }
    }

    function fallbackCopy(textarea) {
      textarea.select();
      textarea.setSelectionRange(0, 99999); // For mobile

      try {
        document.execCommand('copy');
        showToast('üìã Report copied to clipboard!', 'success');
      } catch (err) {
        showToast('‚ùå Failed to copy. Please select and copy manually.', 'error');
      }
    }

    // ========================================
    // Utility Functions
    // ========================================
    function showLoading(show) {
      const loading = document.getElementById('loading');
      loading.classList.toggle('active', show);
    }

    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.innerText = message;
      toast.className = 'toast ' + type;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========================================
    // New Company Fields Toggle
    // ========================================
    function toggleNewCompanyFields() {
      const fields = document.getElementById('newCompanyFields');
      const icon = document.getElementById('newCompanyToggleIcon');
      const text = document.getElementById('newCompanyToggleText');

      if (fields.style.display === 'none') {
        fields.style.display = 'block';
        icon.textContent = '-';
        text.textContent = 'Hide New Company Details';
      } else {
        fields.style.display = 'none';
        icon.textContent = '+';
        text.textContent = 'Add New Company Details';
      }
    }

    // ========================================
    // Control Center Toggle
    // ========================================
    function toggleControlCenter() {
      const content = document.getElementById('controlCenterContent');
      const icon = document.getElementById('controlCenterToggleIcon');

      content.classList.toggle('collapsed');
      icon.textContent = content.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
    }

    // ========================================
    // Control Center Tab Switching
    // ========================================
    function showTool(toolId, clickedTab = null) {
      // Hide all tools
      document.querySelectorAll('.control-tool').forEach(tool => {
        tool.classList.remove('active');
      });

      // Remove active class from all tabs
      document.querySelectorAll('.control-tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Show selected tool
      const selectedTool = document.getElementById('tool-' + toolId);
      if (selectedTool) {
        selectedTool.classList.add('active');
      }

      // Add active class to clicked tab (or find it if called programmatically)
      if (clickedTab) {
        clickedTab.classList.add('active');
      } else {
        // Find the tab by its onclick attribute
        const tab = document.querySelector(`[onclick="showTool('${toolId}')"]`);
        if (tab) {
          tab.classList.add('active');
        }
      }
    }

    // ========================================
    // CSV Import
    // ========================================
    function importCSV() {
      const csvText = document.getElementById('csvText').value.trim();
      const targetSheet = document.getElementById('importSheet').value;

      if (!csvText) {
        showToast('‚ö†Ô∏è Please paste CSV data first', 'warning');
        document.getElementById('csvText').focus();
        return;
      }

      showLoading(true);

      google.script.run
        .withSuccessHandler(handleCSVImportSuccess)
        .withFailureHandler(handleCSVImportError)
        .importCSVData(csvText, targetSheet);
    }

    function handleCSVImportSuccess(result) {
      showLoading(false);

      if (result.success) {
        const importedCount = result.data.importedCount || 0;
        const skippedCount = result.data.skippedCount || 0;

        let message = `‚úÖ Successfully imported ${importedCount} rows to ${result.data.sheetName}`;
        if (skippedCount > 0) {
          message += ` (${skippedCount} skipped due to validation)`;
        }

        showToast(message, 'success');

        // Clear the form
        document.getElementById('csvText').value = '';
      } else {
        showToast('‚ùå ' + (result.error || 'Import failed'), 'error');
      }
    }

    function handleCSVImportError(error) {
      showLoading(false);
      showToast('‚ùå CSV import error: ' + (error.message || error), 'error');
    }



    // ========================================
    // Context Detection (Dialog vs Sidebar)
    // ========================================
    function detectDisplayContext() {
      // Check if we're in a narrow container (sidebar) vs wide (dialog)
      const isSidebar = window.innerWidth < 500 || document.body.clientWidth < 500;

      if (isSidebar) {
        // Sidebar context - ensure proper styling
        document.body.classList.remove('dialog-context');
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
          sidebar.style.position = 'relative';
          sidebar.style.width = '100%';
          sidebar.style.left = 'auto';
          sidebar.style.top = 'auto';
        }
      } else {
        // Dialog context - apply floating styles
        document.body.classList.add('dialog-context');
      }
    }

    // ========================================
    // Load Validation Lists
    // ========================================
    function loadValidationLists() {
      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success && result.data) {
            populateValidationLists(result.data);
          } else {
            console.warn('Failed to load validation lists:', result.error);
          }
        })
        .withFailureHandler(function (error) {
          console.warn('Error loading validation lists:', error);
        })
        .getValidationLists();
    }

    function populateValidationLists(validationLists) {
      // Populate activity types
      const activityTypeSelect = document.getElementById('activityType');
      if (validationLists['Activity Types']) {
        // Clear existing options except the first
        while (activityTypeSelect.options.length > 1) {
          activityTypeSelect.remove(1);
        }
        // Add new options
        validationLists['Activity Types'].values.forEach(function (type) {
          const option = document.createElement('option');
          option.value = type;
          option.textContent = type;
          activityTypeSelect.appendChild(option);
        });
      }

      // Populate competitor dropdown from Settings (dynamic - no hardcoding)
      const competitorSelect = document.getElementById('competitor');
      if (validationLists['Competitors'] && validationLists['Competitors'].values) {
        // Clear existing options except the first ("None / Unknown")
        while (competitorSelect.options.length > 1) {
          competitorSelect.remove(1);
        }
        // Add new options from Settings
        validationLists['Competitors'].values.forEach(function (competitor) {
          const option = document.createElement('option');
          option.value = competitor;
          option.textContent = competitor;
          competitorSelect.appendChild(option);
        });
        console.log('‚úÖ Populated ' + validationLists['Competitors'].values.length + ' competitors from Settings');
      }

      // Populate container sizes for new accounts
      // This would be used when implementing the account form validation

      // Store validation lists for form validation
      state.validationLists = validationLists;

      console.log('Validation lists loaded:', validationLists);
    }

    // ========================================
    // Save Callbacks
    // ========================================
    function handleSaveSuccess(result) {
      showLoading(false);

      if (result && result.success) {
        // Success - show confirmation and reset form
        const company = document.getElementById('companyInput').value.trim();
        showToast('‚úÖ Visit logged for ' + company, 'success');

        // Reset ALL form fields comprehensively
        document.getElementById('companyInput').value = '';
        document.getElementById('notes').value = '';
        document.getElementById('outreachId').value = '';

        // Reset new company fields
        document.getElementById('newAddress').value = '';
        document.getElementById('newPhone').value = '';
        document.getElementById('newContact').value = '';
        document.getElementById('newCity').value = 'Tyler';
        document.getElementById('newState').value = 'TX';
        document.getElementById('newZip').value = '';
        document.getElementById('newEmail').value = '';
        document.getElementById('newCompetitor').value = '';
        document.getElementById('newIndustry').value = '';

        // Reset date fields to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('nextDate').value = today;
        document.getElementById('activityType').value = 'Visit';

        // Reset status selection and UI elements
        state.selectedStatus = '';
        state.selectedOutcome = '';
        state.selectedStage = '';
        document.querySelectorAll('.outcome-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('workflowDisplay').style.display = 'none';

        // Hide informational cards
        document.getElementById('lastTouchCard').classList.remove('active');
        document.getElementById('prospectStatusIndicator').classList.remove('active');
        document.getElementById('accountForm').classList.remove('active');

        // Collapse new company fields section if it was expanded
        const newCompanyFields = document.getElementById('newCompanyFields');
        if (newCompanyFields.style.display !== 'none') {
          newCompanyFields.style.display = 'none';
          document.getElementById('newCompanyToggleIcon').textContent = '+';
          document.getElementById('newCompanyToggleText').textContent = 'Add New Company Details';
        }

        // Clear company data and voice preview
        state.selectedCompanyData = null;
        const voicePreview = document.getElementById('voicePreview');
        voicePreview.textContent = 'Tap to record...';
        voicePreview.classList.remove('has-content');

        // Refresh stats to show updated counts
        loadStats();

        // Focus on company input for quick next entry
        document.getElementById('companyInput').focus();
      } else {
        // Server returned failure
        showToast('‚ùå ' + (result.error || 'Save failed'), 'error');
      }
    }

    function handleSaveError(error) {
      showLoading(false);
      showToast('‚ùå ' + (error.message || error || 'Save failed'), 'error');
      console.error('Save error:', error);
    }

    /**
     * Standard Save Entry (Reliable Pattern)
     */
    function saveEntry() {
      const company = document.getElementById('companyInput').value.trim();
      if (!company || !state.selectedStatus) {
        showToast('‚ö†Ô∏è Company and Status required', 'warning');
        return;
      }

      showLoading(true);
      const formData = {
        company: company,
        outcome: state.selectedOutcome,
        stage: state.selectedStage,
        status: state.selectedStatus,
        notes: document.getElementById('notes').value,
        nextVisitDate: document.getElementById('nextDate').value,
        activityType: document.getElementById('activityType').value
      };

      google.script.run
        .withSuccessHandler(res => {
          showLoading(false);
          if (res.success) {
            showToast('‚úÖ Logged: ' + company, 'success');
            resetForm();
            loadStats();
          } else {
            showToast('‚ùå ' + res.error, 'error');
          }
        })
        .withFailureHandler(e => {
          showLoading(false);
          showToast('‚ùå Server error during save', 'error');
        })
        .addOutreachComplete(formData);
    }

    function resetForm() {
      document.getElementById('companyInput').value = '';
      document.getElementById('notes').value = '';
      document.querySelectorAll('.outcome-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('workflowDisplay').style.display = 'none';
      
      // Reset other form elements to ensure no white text issues
      const formInputs = document.querySelectorAll('.form-input, .form-select, .form-textarea');
      formInputs.forEach(input => {
        input.style.color = '';
        input.style.backgroundColor = '';
      });
    }

    function handleDuplicateCheck(result) {
      const company = document.getElementById('companyInput').value.trim();
      const outreachId = document.getElementById('outreachId').value.trim();

      if (result.success && result.isDuplicate) {
        showLoading(false);
        const message = `‚ö†Ô∏è Duplicate Outreach ID: ${outreachId}\n\n` +
          `Already exists for: ${result.existingCompany || 'Unknown'}\n` +
          `Do you want to save anyway?`;

        if (confirm(message)) {
          proceedWithSave(company, outreachId);
        }
      } else {
        proceedWithSave(company, outreachId);
      }
    }

    function handleDuplicateCheckError(error) {
      console.warn('Duplicate check failed, proceeding anyway:', error);
      const company = document.getElementById('companyInput').value.trim();
      const outreachId = document.getElementById('outreachId').value.trim();

      showLoading(false);
      if (confirm('‚ö†Ô∏è Could not verify Outreach ID uniqueness.\n\nSave anyway?')) {
        proceedWithSave(company, outreachId);
      }
    }

    function proceedWithSave(company, outreachId) {
      const data = {
        company: company,
        companyName: company,
        outcome: state.selectedOutcome, // NEW: Pass the Outcome
        stage: state.selectedStage,     // NEW: Pass the Stage
        status: state.selectedStatus,   // NEW: Pass the Status
        notes: document.getElementById('notes').value,
        nextVisitDate: document.getElementById('nextDate').value,
        activityType: document.getElementById('activityType').value
      };

      if (outreachId) {
        data.outreachId = outreachId;
      }

      if (state.selectedCompanyData && state.selectedCompanyData.companyId) {
        data.companyId = state.selectedCompanyData.companyId;
      }

      // Collect new company details for prospect creation
      const newCompanyFields = document.getElementById('newCompanyFields');
      if (newCompanyFields && newCompanyFields.style.display !== 'none') {
        // Only collect new company data if the section is expanded
        data.newCompanyData = {
          address: document.getElementById('newAddress').value,
          city: document.getElementById('newCity').value,
          state: document.getElementById('newState').value,
          zip: document.getElementById('newZip').value,
          industry: document.getElementById('newIndustry').value,
          contactName: document.getElementById('newContact').value,
          phone: document.getElementById('newPhone').value,
          email: document.getElementById('newEmail').value,
          competitor: document.getElementById('newCompetitor').value
        };
      }

      if (state.selectedOutcome === 'Account Won') {
        data.contact = document.getElementById('newContact').value;
        data.phone = document.getElementById('newPhone').value;
        data.site = document.getElementById('newAddress').value;
      }

      showLoading(true);

      google.script.run
        .withSuccessHandler(handleSaveSuccess)
        .withFailureHandler(handleSaveError)
        .addOutreachComplete(data);
    }
  </script>
</body>

</html>

[FILE_END: dashboard.html]
################################################################################

================================================================================
FILE_BEGIN: dateRangeReport.html
METADATA: Size=5402 bytes | Last_Modified=2026-02-05 14:37:16.025731
================================================================================
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #666;
      margin-bottom: 5px;
      text-transform: uppercase;
    }
    input[type="date"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .btn {
      width: 100%;
      padding: 12px;
      background: #0F2537;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }
    .btn:hover {
      background: #1a3a52;
    }
    .quick-options {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .quick-btn {
      flex: 1;
      padding: 8px;
      background: #e0e0e0;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
    }
    .quick-btn:hover {
      background: #d0d0d0;
    }
    #reportOutput {
      display: none;
      margin-top: 20px;
    }
    #reportText {
      width: 100%;
      height: 300px;
      font-family: monospace;
      font-size: 11px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }
    .copy-btn {
      width: 100%;
      padding: 10px;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="inputForm">
    <h3 style="margin-top: 0; color: #0F2537;">Generate Date Range Report</h3>
    
    <div class="quick-options">
      <button class="quick-btn" onclick="setThisWeek()">This Week</button>
      <button class="quick-btn" onclick="setThisMonth()">This Month</button>
      <button class="quick-btn" onclick="setLast7Days()">Last 7 Days</button>
      <button class="quick-btn" onclick="setLast30Days()">Last 30 Days</button>
    </div>
    
    <div class="form-group">
      <label for="startDate">Start Date</label>
      <input type="date" id="startDate">
    </div>
    
    <div class="form-group">
      <label for="endDate">End Date</label>
      <input type="date" id="endDate">
    </div>
    
    <button class="btn" onclick="generateReport()">Generate Report</button>
  </div>
  
  <div id="reportOutput">
    <button class="copy-btn" onclick="copyReport()">üìã Copy to Clipboard</button>
    <textarea id="reportText" readonly></textarea>
  </div>
  
  <script>
    // Set default dates to this week
    function setThisWeek() {
      var today = new Date();
      var startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - today.getDay());
      
      document.getElementById('startDate').value = formatDate(startOfWeek);
      document.getElementById('endDate').value = formatDate(today);
    }
    
    function setThisMonth() {
      var today = new Date();
      var startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      
      document.getElementById('startDate').value = formatDate(startOfMonth);
      document.getElementById('endDate').value = formatDate(today);
    }
    
    function setLast7Days() {
      var today = new Date();
      var sevenDaysAgo = new Date(today);
      sevenDaysAgo.setDate(today.getDate() - 7);
      
      document.getElementById('startDate').value = formatDate(sevenDaysAgo);
      document.getElementById('endDate').value = formatDate(today);
    }
    
    function setLast30Days() {
      var today = new Date();
      var thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 30);
      
      document.getElementById('startDate').value = formatDate(thirtyDaysAgo);
      document.getElementById('endDate').value = formatDate(today);
    }
    
    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }
    
    function generateReport() {
      var startDate = document.getElementById('startDate').value;
      var endDate = document.getElementById('endDate').value;
      
      if (!startDate || !endDate) {
        alert('Please select both start and end dates.');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(report) {
          document.getElementById('reportText').value = report;
          document.getElementById('inputForm').style.display = 'none';
          document.getElementById('reportOutput').style.display = 'block';
        })
        .withFailureHandler(function(error) {
          alert('Error: ' + error.message);
        })
        .generatePlainTextReportForRange(startDate, endDate);
    }
    
    function copyReport() {
      var textarea = document.getElementById('reportText');
      textarea.select();
      document.execCommand('copy');
      alert('Report copied to clipboard!');
    }
    
    // Initialize with this week
    setThisWeek();
  </script>
</body>
</html>


[FILE_END: dateRangeReport.html]
################################################################################

================================================================================
FILE_BEGIN: report.html
METADATA: Size=15016 bytes | Last_Modified=2026-02-06 15:23:22.659470
================================================================================
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K&L Daily Operations Report</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 15px; color: #333; }
        .app-header { background: #1a472a; color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .app-title { font-size: 24px; font-weight: bold; }
        .app-meta { font-size: 14px; opacity: 0.9; margin-top: 5px; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .kpi-box { background: white; padding: 15px; border-radius: 10px; text-align: center; border-bottom: 4px solid #ddd; }
        .kpi-val { font-size: 22px; font-weight: bold; display: block; }
        .kpi-label { font-size: 12px; text-transform: uppercase; color: #666; }
        
        .visit-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 8px solid #ccc; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .company-name { font-weight: bold; font-size: 18px; color: #1a472a; }
        
        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .visit-card.won { border-left-color: #27ae60; } .status-won { background: #eafaf1; color: #27ae60; }
        .visit-card.hot { border-left-color: #e67e22; } .status-hot { background: #fdf5e6; color: #e67e22; }
        .visit-card.warm { border-left-color: #3498db; } .status-warm { background: #ebf5fb; color: #3498db; }
        .visit-card.cold { border-left-color: #95a5a6; } .status-cold { background: #f2f4f4; color: #95a5a6; }
        
        .section-label { font-size: 11px; text-transform: uppercase; color: #999; margin-top: 10px; font-weight: bold; }
        .notes-text { font-size: 14px; line-height: 1.4; margin-top: 4px; color: #444; }
        .action-box { background: #f9f9f9; padding: 8px; border-radius: 6px; margin-top: 5px; border: 1px dashed #ddd; }
        .action-text { font-size: 13px; color: #2c3e50; font-style: italic; }

        .export-section { margin-top: 30px; text-align: center; padding-bottom: 50px; }
        .export-btn { background: #1a472a; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .csv-data { display: none; text-align: left; background: #222; color: #0f0; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 11px; overflow-x: auto; margin-top: 15px; white-space: pre; }
    </style>
    <script>
        function toggleCSV() {
            var x = document.getElementById("csvData");
            x.style.display = (x.style.display === "none" || x.style.display === "") ? "block" : "none";
        }
    </script>
</head>
<body>

<div class="app-header">
    <div class="app-title">‚ôªÔ∏è K&L Daily Report</div>
    <div class="app-meta">üìÖ 2026-02-06 ‚Ä¢ üë§ Kyle Buzbee</div>
</div>

<div class="kpi-grid">
    <div class="kpi-box" style="border-bottom-color: #3498db;"><span class="kpi-val">11</span><span class="kpi-label">Total Visits</span></div>
    <div class="kpi-box" style="border-bottom-color: #27ae60;"><span class="kpi-val">1</span><span class="kpi-label">Wins</span></div>
    <div class="kpi-box" style="border-bottom-color: #e67e22;"><span class="kpi-val">0</span><span class="kpi-label">Hot Leads</span></div>
    <div class="kpi-box" style="border-bottom-color: #95a5a6;"><span class="kpi-val">2</span><span class="kpi-label">Cold/DQ</span></div>
</div>

<div class="visit-card cold">
    <div class="card-header">
        <div class="company-name">Calibur Collision</div>
        <span class="status-pill status-cold">‚ùÑÔ∏è Not Interested</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Was not able to speak to anyone who could do anything, but I did get his card and so I will send them an email today.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">Try again</div></div>
    </div>
</div>

<div class="visit-card warm">
    <div class="card-header">
        <div class="company-name">Joe Hudson</div>
        <span class="status-pill status-warm">‚è≥ Follow-Up</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">They are being bought out by Gerber and are going to let me know once everything is finalized if they want to continue doing what they have been doing or switch to something new</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">Check periodic</div></div>
    </div>
</div>

<div class="visit-card warm">
    <div class="card-header">
        <div class="company-name">Cox Construction</div>
        <span class="status-pill status-warm">‚è≥ Follow-Up</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Spoke to Joey and because Waskom is about 70 miles from Madfos, Corey told me to charge a $125 dump fee. He said that it was fine and so we will get it delivered as soon as one is available.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">See Notes</div></div>
    </div>
</div>

<div class="visit-card warm">
    <div class="card-header">
        <div class="company-name">TDI Air Condition</div>
        <span class="status-pill status-warm">‚è≥ Follow-Up</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Talked to the receptionist and was not able to talk to a manager or anything because they were all on service calls, but I did get his card so I will send him an email first thing in the morning.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">Try again</div></div>
    </div>
</div>

<div class="visit-card cold">
    <div class="card-header">
        <div class="company-name">Barbin Fence Inc</div>
        <span class="status-pill status-cold">üö´ Disqualified</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Only has enough scrap to fill a trailer and take it to the scrap yard about twice a year so I have disqualified them as a prospect.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">See Notes</div></div>
    </div>
</div>

<div class="visit-card cold">
    <div class="card-header">
        <div class="company-name">Champion Fence</div>
        <span class="status-pill status-cold">üö´ Disqualified</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Reached out via email letting them know that I am interested in buying their metal. They are currently with Athens Iron and Metal so we will see.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">Try again</div></div>
    </div>
</div>

<div class="visit-card won">
    <div class="card-header">
        <div class="company-name">Glenwood Blind & Awning</div>
        <span class="status-pill status-won">üèÜ Account Won</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Visited him this morning and won the account and he is wanting a 30 yard container, but might switch to a 20 yard container if needed. Pricing is as follows: "AL 5052: $1.50 (Clean) / $1.40 (Painted) AL 6063: $1.10 (Clean) / $1.00 (Painted) Siding: $0.68 | Break: $0.10"</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">Onboard Account</div></div>
    </div>
</div>

<div class="visit-card warm">
    <div class="card-header">
        <div class="company-name">Dealer's Collision</div>
        <span class="status-pill status-warm">‚è≥ Follow-Up</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Sent Dealer's Collision an email touching base about my interest in getting them a roll-off container.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">General follow</div></div>
    </div>
</div>

<div class="visit-card warm">
    <div class="card-header">
        <div class="company-name">One-Ten Welding</div>
        <span class="status-pill status-warm">‚è≥ Follow-Up</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Sent One-Ten Welding an email to see if he had a chance to look at the agreement I gave him.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">General follow</div></div>
    </div>
</div>

<div class="visit-card warm">
    <div class="card-header">
        <div class="company-name">Rub-A-Dub Plumbing</div>
        <span class="status-pill status-warm">‚è≥ Follow-Up</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Sent Ashley an email letting her know that we can drop off a container at one of their project sites since the last time I talked to her she said that they had several big jobs coming up.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">General follow</div></div>
    </div>
</div>

<div class="visit-card warm">
    <div class="card-header">
        <div class="company-name">Holliday Sheet Metal</div>
        <span class="status-pill status-warm">‚è≥ Follow-Up</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Sent him an email even though he rushed m out the last time I was there and did not respond to my previous email. I am hoping to get a response because they do produce a fair amount of scrap metal.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">General follow</div></div>
    </div>
</div>

<div class="export-section">
    <div class="section-label">Export CRM Data</div>
    <button class="export-btn" onclick="toggleCSV()">üì• Show CSV Export</button>
    <pre class="csv-data" id="csvData">outreachID,companyID,company,visitDate,notes,outcome,stage,status,nextVisitDate,daysSinceLastVisit,nextVisitCountdown,outcomeCategory,followUpAction,owner,prospectsMatch,contactType,emailSent,competitor
LID-001,CID-CAL001,Calibur Collision,2026-02-06,"Was not able to speak to anyone who could do anything, but I did get his card and so I will send them an email today.",Not Interested,Lost,Disqualified,2026-08-05,,,Negative,Try again,Kyle Buzbee,,Visit,FALSE,None
LID-002,CID-JOE001,Joe Hudson,2026-02-06,"They are being bought out by Gerber and are going to let me know once everything is finalized if they want to continue doing what they have been doing or switch to something new",Follow-Up,Nurture,Interested (Warm),2026-02-20,,,Neutral,Check periodic,Kyle Buzbee,,Visit,FALSE,None
LID-003,CID-COX001,Cox Construction,2026-02-06,"Spoke to Joey and because Waskom is about 70 miles from Madfos, Corey told me to charge a $125 dump fee. He said that it was fine and so we will get it delivered as soon as one is available.",Follow-Up,Nurture,Interested (Warm),2026-02-20,,,Neutral,See Notes,Kyle Buzbee,,Visit,FALSE,None
LID-004,CID-TDI001,TDI Air Condition,2026-02-06,"Talked to the receptionist and was not able to talk to a manager or anything because they were all on service calls, but I did get his card so I will send him an email first thing in the morning.",Follow-Up,Nurture,Interested (Warm),2026-02-20,,,Neutral,Try again,Kyle Buzbee,,Visit,FALSE,None
LID-005,CID-BAR001,Barbin Fence Inc,2026-02-06,"Only has enough scrap to fill a trailer and take it to the scrap yard about twice a year so I have disqualified them as a prospect.",Disqualified,Lost,Disqualified,2026-02-06,,,Negative,See Notes,Kyle Buzbee,,Visit,FALSE,None
LID-006,CID-CHA001,Champion Fence,2026-02-06,"Reached out via email letting them know that I am interested in buying their metal. They are currently with Athens Iron and Metal so we will see.",Disqualified,Lost,Disqualified,2026-02-06,,,Negative,Try again,Kyle Buzbee,,Visit,FALSE,AIM
LID-007,CID-GLE001,Glenwood Blind & Awning,2026-02-06,"Visited him this morning and won the account and he is wanting a 30 yard container, but might switch to a 20 yard container if needed. Pricing is as follows: ""AL 5052: $1.50 (Clean) / $1.40 (Painted) AL 6063: $1.10 (Clean) / $1.00 (Painted) Siding: $0.68 | Break: $0.10""",Account Won,Won,Active,2026-02-07,,,Positive,Onboard Account,Kyle Buzbee,,Visit,FALSE,None
LID-008,CID-DEA001,Dealer's Collision,2026-02-06,"Sent Dealer's Collision an email touching base about my interest in getting them a roll-off container.",Follow-Up,Nurture,Interested (Warm),2026-02-20,,,Neutral,General follow,Kyle Buzbee,,Visit,FALSE,None
LID-009,CID-ONE001,One-Ten Welding,2026-02-06,"Sent One-Ten Welding an email to see if he had a chance to look at the agreement I gave him.",Follow-Up,Nurture,Interested (Warm),2026-02-20,,,Neutral,General follow,Kyle Buzbee,,Visit,FALSE,None
LID-010,CID-RUB001,Rub-A-Dub Plumbing,2026-02-06,"Sent Ashley an email letting her know that we can drop off a container at one of their project sites since the last time I talked to her she said that they had several big jobs coming up.",Follow-Up,Nurture,Interested (Warm),2026-02-20,,,Neutral,General follow,Kyle Buzbee,,Visit,FALSE,None
LID-011,CID-HOL001,Holliday Sheet Metal,2026-02-06,"Sent him an email even though he rushed m out the last time I was there and did not respond to my previous email. I am hoping to get a response because they do produce a fair amount of scrap metal.",Follow-Up,Nurture,Interested (Warm),2026-02-20,,,Neutral,General follow,Kyle Buzbee,,Visit,FALSE,None</pre>
</div>

</body>
</html>

[FILE_END: report.html]
################################################################################

================================================================================
FILE_BEGIN: CRM_BLUEPRINT_REPORT.html
METADATA: Size=50888 bytes | Last_Modified=2026-02-09 01:17:38.816035
================================================================================
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K&L CRM - Blueprint & Health Report</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .health-score {
            display: inline-block;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(#dc3545 0.0deg, #e0e0e0 0deg);
            position: relative;
            margin: 20px auto;
        }
        .health-score::before {
            content: '0';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            font-weight: bold;
            color: #333;
        }
        .content { padding: 40px; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-number { font-size: 2.5em; font-weight: bold; }
        .stat-label { opacity: 0.9; margin-top: 5px; }
        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .section h2 {
            color: #1e3c72;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .issue-card {
            background: white;
            border-left: 5px solid #dc3545;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .issue-card.critical { border-left-color: #dc3545; }
        .issue-card.high { border-left-color: #fd7e14; }
        .issue-card.medium { border-left-color: #ffc107; }
        .issue-card.low { border-left-color: #17a2b8; }
        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .issue-severity {
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }
        .issue-location {
            color: #666;
            font-family: monospace;
            margin-bottom: 10px;
        }
        .issue-message { color: #333; margin-bottom: 10px; }
        .issue-recommendation {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            color: #1565c0;
            font-size: 0.9em;
        }
        .file-tree {
            background: white;
            border-radius: 10px;
            padding: 20px;
        }
        .file-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-item:hover { background: #f5f5f5; }
        .file-name { font-family: monospace; color: #333; }
        .file-stats { color: #666; font-size: 0.9em; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @media print {
            body { background: white; }
            .container { box-shadow: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ K&L Recycling CRM</h1>
            <p>Comprehensive Blueprint & Health Analysis Report</p>
            <p>Generated: 2026-02-09 01:17:38</p>
            <div class="health-score"></div>
            <p>Overall Health Score</p>
        </div>
        
        <div class="content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">68</div>
                    <div class="stat-label">Files Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">217</div>
                    <div class="stat-label">Functions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">33,575</div>
                    <div class="stat-label">Lines of Code</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">496</div>
                    <div class="stat-label">Issues Found</div>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('issues')">üö® Issues</div>
                <div class="tab" onclick="showTab('files')">üìÅ Files</div>
                <div class="tab" onclick="showTab('architecture')">üèóÔ∏è Architecture</div>
            </div>
            
            <div id="issues" class="tab-content active">
                <div class="section">
                    <h2>üö® Issues by Severity</h2>
<h3 style="color: #fd7e14; margin: 20px 0 15px;">HIGH (33)</h3>
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:968</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ dashboard.html:2178</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ HtmlSafeRenderer.js:170</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ HtmlSafeRenderer.js:267</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ HtmlSafeRenderer.js:477</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ HtmlSafeRenderer.js:488</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ HtmlSafeRenderer.js:553</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ test_runner.html:541</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>‚ö° Performance</span>
                        </div>
                        <div class="issue-location">üìÑ BatchProcessor.js:459</div>
                        <div class="issue-message">Loading entire sheet into memory - consider batching for large datasets</div>
                        <div class="issue-recommendation">üí° Consider using batch operations or caching</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>‚ö° Performance</span>
                        </div>
                        <div class="issue-location">üìÑ BusinessValidation.js:1315</div>
                        <div class="issue-message">Loading entire sheet into memory - consider batching for large datasets</div>
                        <div class="issue-recommendation">üí° Consider using batch operations or caching</div>
                    </div>
                    <p style="text-align: center; color: #666; margin-top: 15px;">... and 23 more HIGH issues</p><h3 style="color: #ffc107; margin: 20px 0 15px;">MEDIUM (102)</h3>
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üîß Maintainability</span>
                        </div>
                        <div class="issue-location">üìÑ test_workflow.js:26</div>
                        <div class="issue-message">Function 'testOutreachWorkflowAutomation' appears to be orphaned (never called) but has high complexity</div>
                        <div class="issue-recommendation">üí° Verify if this function is needed or remove if dead code</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ test_integration.js:0</div>
                        <div class="issue-message">Test 'testFuzzyMatchingLogic' failing: Fuzzy matching failed on punctuation/spacing</div>
                        <div class="issue-recommendation">üí° Fix fuzzy matching logic to handle punctuation, spacing, and case variations</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ test_integration.js:0</div>
                        <div class="issue-message">Test 'testFuzzyMatchingLogicExtended' failing: Should match with fuzzy logic</div>
                        <div class="issue-recommendation">üí° Fix fuzzy matching logic to handle punctuation, spacing, and case variations</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ test_integration.js:0</div>
                        <div class="issue-message">Test 'testDataSynchronizationBasic' failing: Should match with fuzzy logic</div>
                        <div class="issue-recommendation">üí° Fix fuzzy matching logic to handle punctuation, spacing, and case variations</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ test_integration.js:0</div>
                        <div class="issue-message">Test 'testCSVImportWorkflow' failing: Should parse company name correctly</div>
                        <div class="issue-recommendation">üí° Fix fuzzy matching logic to handle punctuation, spacing, and case variations</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:57</div>
                        <div class="issue-message">Function 'processNewAccount' has high complexity (18)</div>
                        <div class="issue-recommendation">üí° Refactor to reduce cyclomatic complexity</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üõ°Ô∏è Error Handling</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:241</div>
                        <div class="issue-message">Function 'testProspectValidation' lacks error handling</div>
                        <div class="issue-recommendation">üí° Add try/catch blocks for robust error handling</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üõ°Ô∏è Error Handling</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:306</div>
                        <div class="issue-message">Function 'testOutreachValidation' lacks error handling</div>
                        <div class="issue-recommendation">üí° Add try/catch blocks for robust error handling</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üõ°Ô∏è Error Handling</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:371</div>
                        <div class="issue-message">Function 'testAccountValidation' lacks error handling</div>
                        <div class="issue-recommendation">üí° Add try/catch blocks for robust error handling</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üõ°Ô∏è Error Handling</span>
                        </div>
                        <div class="issue-location">üìÑ BatchProcessor.js:407</div>
                        <div class="issue-message">Function '_groupUpdatesByRange' lacks error handling</div>
                        <div class="issue-recommendation">üí° Add try/catch blocks for robust error handling</div>
                    </div>
                    <p style="text-align: center; color: #666; margin-top: 15px;">... and 92 more MEDIUM issues</p><h3 style="color: #17a2b8; margin: 20px 0 15px;">LOW (358)</h3>
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>üîß Maintainability</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:57</div>
                        <div class="issue-message">Function 'processNewAccount' is 118 lines long</div>
                        <div class="issue-recommendation">üí° Functions should ideally be under 50 lines</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>üîß Maintainability</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:177</div>
                        <div class="issue-message">Function 'checkNewAccounts' is 100 lines long</div>
                        <div class="issue-recommendation">üí° Functions should ideally be under 50 lines</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>üîß Maintainability</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:686</div>
                        <div class="issue-message">Function 'runComprehensiveTests' is 51 lines long</div>
                        <div class="issue-recommendation">üí° Functions should ideally be under 50 lines</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>üîß Maintainability</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:742</div>
                        <div class="issue-message">Function 'runIntegrationTests' is 66 lines long</div>
                        <div class="issue-recommendation">üí° Functions should ideally be under 50 lines</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:19</div>
                        <div class="issue-message">Function 'generateProspect' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:49</div>
                        <div class="issue-message">Function 'generateOutreach' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:78</div>
                        <div class="issue-message">Function 'generateAccount' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>üîß Maintainability</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:241</div>
                        <div class="issue-message">Function 'testProspectValidation' is 60 lines long</div>
                        <div class="issue-recommendation">üí° Functions should ideally be under 50 lines</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>üîß Maintainability</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:306</div>
                        <div class="issue-message">Function 'testOutreachValidation' is 60 lines long</div>
                        <div class="issue-recommendation">üí° Functions should ideally be under 50 lines</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>üîß Maintainability</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:371</div>
                        <div class="issue-message">Function 'testAccountValidation' is 60 lines long</div>
                        <div class="issue-recommendation">üí° Functions should ideally be under 50 lines</div>
                    </div>
                    <p style="text-align: center; color: #666; margin-top: 15px;">... and 348 more LOW issues</p><h3 style="color: #6c757d; margin: 20px 0 15px;">INFO (3)</h3>
                    <div class="issue-card info">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #6c757d;">INFO</span>
                            <span>‚ö° Performance</span>
                        </div>
                        <div class="issue-location">üìÑ ErrorHandling.js:180</div>
                        <div class="issue-message">SpreadsheetApp.flush() can impact performance</div>
                        <div class="issue-recommendation">üí° Consider using batch operations or caching</div>
                    </div>
                    
                    <div class="issue-card info">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #6c757d;">INFO</span>
                            <span>‚ö° Performance</span>
                        </div>
                        <div class="issue-location">üìÑ PerformanceUtils.js:92</div>
                        <div class="issue-message">SpreadsheetApp.flush() can impact performance</div>
                        <div class="issue-recommendation">üí° Consider using batch operations or caching</div>
                    </div>
                    
                    <div class="issue-card info">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #6c757d;">INFO</span>
                            <span>‚ö° Performance</span>
                        </div>
                        <div class="issue-location">üìÑ PerformanceUtils.js:779</div>
                        <div class="issue-message">SpreadsheetApp.flush() can impact performance</div>
                        <div class="issue-recommendation">üí° Consider using batch operations or caching</div>
                    </div>
                    
                </div>
            </div>
            
            <div id="files" class="tab-content">
                <div class="section">
                    <h2>üìÅ File Analysis</h2>
                    <div class="file-tree">
<h3 style="margin: 20px 0 10px; color: #1e3c72;">üì¶ Core Services</h3>
                        <div class="file-item">
                            <span class="file-name">CRM_API.js</span>
                            <span class="file-stats">8 lines | 0 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">Config.js</span>
                            <span class="file-stats">150 lines | 2 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">MenuFunctions.js</span>
                            <span class="file-stats">33 lines | 1 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">Settings.js</span>
                            <span class="file-stats">177 lines | 3 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">üé® UI Components</h3>
                        <div class="file-item">
                            <span class="file-name">CRM_BLUEPRINT_REPORT.html</span>
                            <span class="file-stats">857 lines | 1 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">CRM_Styles.html</span>
                            <span class="file-stats">927 lines | 0 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">CRM_Suite.html</span>
                            <span class="file-stats">1392 lines | 21 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">DashboardBackend.js</span>
                            <span class="file-stats">243 lines | 7 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ReportFunctions.js</span>
                            <span class="file-stats">1409 lines | 24 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">dashboard.html</span>
                            <span class="file-stats">3422 lines | 60 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">dateRangeReport.html</span>
                            <span class="file-stats">193 lines | 7 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">report.html</span>
                            <span class="file-stats">219 lines | 1 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">reports\CRM_BLUEPRINT_REPORT.html</span>
                            <span class="file-stats">857 lines | 1 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">üîÑ Sync & Workflow</h3>
                        <div class="file-item">
                            <span class="file-name">OutreachSyncFunctions.js</span>
                            <span class="file-stats">228 lines | 4 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">Sync.js</span>
                            <span class="file-stats">535 lines | 28 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">WorkflowAutomationService.js</span>
                            <span class="file-stats">293 lines | 8 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">‚úÖ Validation</h3>
                        <div class="file-item">
                            <span class="file-name">BusinessValidation.js</span>
                            <span class="file-stats">1427 lines | 56 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ComprehensiveValidationSystem.js</span>
                            <span class="file-stats">1660 lines | 29 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">DataValidation.js</span>
                            <span class="file-stats">1834 lines | 32 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">SettingsValidation.js</span>
                            <span class="file-stats">943 lines | 17 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ValidationUtils.js</span>
                            <span class="file-stats">202 lines | 12 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">üß™ Testing</h3>
                        <div class="file-item">
                            <span class="file-name">run_tests.js</span>
                            <span class="file-stats">172 lines | 5 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">simple_test.js</span>
                            <span class="file-stats">8 lines | 1 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_autofill_implementation.js</span>
                            <span class="file-stats">79 lines | 2 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_comprehensive_validation.js</span>
                            <span class="file-stats">526 lines | 9 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_data_operations.js</span>
                            <span class="file-stats">151 lines | 17 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_fixes.js</span>
                            <span class="file-stats">288 lines | 8 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_integration.js</span>
                            <span class="file-stats">268 lines | 23 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_normalization.js</span>
                            <span class="file-stats">291 lines | 10 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_robust.js</span>
                            <span class="file-stats">658 lines | 25 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_rowindex_fix.js</span>
                            <span class="file-stats">238 lines | 3 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_runner.html</span>
                            <span class="file-stats">546 lines | 8 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_runners.js</span>
                            <span class="file-stats">148 lines | 9 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_runtime_fixes.js</span>
                            <span class="file-stats">369 lines | 5 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_schema_alignment.js</span>
                            <span class="file-stats">85 lines | 3 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_settings_validation.js</span>
                            <span class="file-stats">221 lines | 8 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_unit.js</span>
                            <span class="file-stats">251 lines | 32 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_validation.js</span>
                            <span class="file-stats">150 lines | 10 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_workflow.js</span>
                            <span class="file-stats">221 lines | 12 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">validate_tests.gs</span>
                            <span class="file-stats">151 lines | 6 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">validate_tests.js</span>
                            <span class="file-stats">185 lines | 5 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">üîß Utilities</h3>
                        <div class="file-item">
                            <span class="file-name">DataHelpers.js</span>
                            <span class="file-stats">812 lines | 19 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">FuzzyMatchingUtils.js</span>
                            <span class="file-stats">160 lines | 4 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">PerformanceUtils.js</span>
                            <span class="file-stats">789 lines | 26 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">SharedUtils.js</span>
                            <span class="file-stats">702 lines | 6 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">StringUtils.js</span>
                            <span class="file-stats">139 lines | 15 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">üìÑ Other</h3>
                        <div class="file-item">
                            <span class="file-name">AccountFunction.js</span>
                            <span class="file-stats">278 lines | 3 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">AlertingService.js</span>
                            <span class="file-stats">158 lines | 5 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">AutoFillService.js</span>
                            <span class="file-stats">79 lines | 3 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">BatchProcessor.js</span>
                            <span class="file-stats">719 lines | 18 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">CSVImport.js</span>
                            <span class="file-stats">278 lines | 5 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ColumnMapper.js</span>
                            <span class="file-stats">126 lines | 4 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ErrorBoundary.js</span>
                            <span class="file-stats">557 lines | 15 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ErrorHandling.js</span>
                            <span class="file-stats">279 lines | 10 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">FunctionRefactorer.js</span>
                            <span class="file-stats">544 lines | 23 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">HtmlSafeRenderer.js</span>
                            <span class="file-stats">569 lines | 25 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">LoggerInjector.js</span>
                            <span class="file-stats">556 lines | 34 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">Normalization.js</span>
                            <span class="file-stats">455 lines | 7 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">OutreachFunctions.js</span>
                            <span class="file-stats">1050 lines | 13 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">PipelineService.js</span>
                            <span class="file-stats">140 lines | 7 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ProspectFunctions.js</span>
                            <span class="file-stats">701 lines | 14 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ProspectScoringService.js</span>
                            <span class="file-stats">322 lines | 8 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">RouteFunction.js</span>
                            <span class="file-stats">161 lines | 3 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">SchemaNormalizer.js</span>
                            <span class="file-stats">674 lines | 21 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">SetupFunctions.js</span>
                            <span class="file-stats">24 lines | 1 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">SystemAlignment.gs</span>
                            <span class="file-stats">289 lines | 7 functions</span>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <div id="architecture" class="tab-content">
                <div class="section">
                    <h2>üèóÔ∏è System Architecture</h2>
                    <h3 style="margin: 20px 0 10px;">üìä Schema Objects</h3>

                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">OUTREACH</h4>
                        <p style="color: #666;">18 columns defined</p>
                    </div>
            
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">PROSPECTS</h4>
                        <p style="color: #666;">18 columns defined</p>
                    </div>
            
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">ACCOUNTS</h4>
                        <p style="color: #666;">13 columns defined</p>
                    </div>
            
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">CONTACTS</h4>
                        <p style="color: #666;">8 columns defined</p>
                    </div>
            
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">SETTINGS</h4>
                        <p style="color: #666;">8 columns defined</p>
                    </div>
            
                    <h3 style="margin: 30px 0 10px;">üîó External Dependencies</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
<div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">CacheService</div><div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">MailApp</div><div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">ScriptApp</div><div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">SpreadsheetApp</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function showTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }
    </script>
</body>
</html>


[FILE_END: CRM_BLUEPRINT_REPORT.html]
################################################################################

================================================================================
FILE_BEGIN: CRM_Styles.html
METADATA: Size=24214 bytes | Last_Modified=2026-02-06 14:54:14.915298
================================================================================
<style>
    /* ===== CSS Variables & Theme ===== */
    :root {
        /* Primary Palette - K&L Green Inspired */
        --primary: #10b981;
        --primary-dark: #059669;
        --primary-light: #34d399;
        --primary-bg: #ecfdf5;
        
        /* Accent Colors */
        --accent-hot: #ef4444;
        --accent-warm: #f59e0b;
        --accent-cold: #3b82f6;
        --accent-won: #10b981;
        
        /* Neutral Palette */
        --bg-main: #0f172a;
        --bg-secondary: #1e293b;
        --bg-card: #ffffff;
        --bg-hover: #f1f5f9;
        
        /* Text Colors */
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --text-inverse: #ffffff;
        
        /* Semantic Colors */
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --info: #3b82f6;
        
        /* Shadows */
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --shadow-glow: 0 0 20px rgba(16, 185, 129, 0.3);
        
        /* Spacing */
        --spacing-xs: 0.25rem;
        --spacing-sm: 0.5rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --spacing-xl: 2rem;
        
        /* Border Radius */
        --radius-sm: 0.375rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        --radius-full: 9999px;
        
        /* Transitions */
        --transition-fast: 150ms ease;
        --transition-normal: 250ms ease;
        --transition-slow: 350ms ease;
        
        /* Sidebar Width */
        --sidebar-width: 280px;
    }

    /* ===== Base Reset ===== */
    *, *::before, *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    html {
        font-size: 16px;
        scroll-behavior: smooth;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        background: var(--bg-main);
        color: var(--text-primary);
        line-height: 1.6;
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* ===== Scrollbar Styling ===== */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: var(--radius-full);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: var(--radius-full);
        transition: var(--transition-fast);
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-light);
    }

    /* ===== Layout ===== */
    .suite-wrapper {
        display: flex;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
    }

    /* ===== Sidebar Navigation ===== */
    .suite-nav {
        width: var(--sidebar-width);
        background: linear-gradient(180deg, var(--bg-secondary) 0%, #0f172a 100%);
        color: var(--text-inverse);
        display: flex;
        flex-direction: column;
        position: relative;
        z-index: 100;
        box-shadow: var(--shadow-xl);
    }

    .suite-nav::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.5), transparent);
    }

    .brand {
        padding: var(--spacing-xl) var(--spacing-lg);
        font-weight: 800;
        font-size: 1.25rem;
        letter-spacing: 2px;
        color: var(--primary);
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        position: relative;
    }

    .brand::before {
        content: '';
    }

    .brand::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: var(--spacing-lg);
        right: var(--spacing-lg);
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
    }

    .nav-links {
        flex: 1;
        padding: var(--spacing-md);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        overflow-y: auto;
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-md) var(--spacing-lg);
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: all var(--transition-normal);
        color: var(--text-muted);
        font-weight: 500;
        position: relative;
        overflow: hidden;
    }

    .nav-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 0;
        background: var(--primary);
        border-radius: var(--radius-full);
        transition: height var(--transition-normal);
    }

    .nav-item:hover {
        background: rgba(16, 185, 129, 0.1);
        color: var(--text-inverse);
        transform: translateX(4px);
    }

    .nav-item:hover::before {
        height: 24px;
    }

    .nav-item.active {
        background: linear-gradient(90deg, rgba(16, 185, 129, 0.2), transparent);
        color: var(--primary);
        font-weight: 600;
    }

    .nav-item.active::before {
        height: 32px;
        box-shadow: var(--shadow-glow);
    }

    .nav-item i {
        width: 24px;
        text-align: center;
        font-size: 1.1rem;
    }

    .nav-footer {
        padding: var(--spacing-lg);
        text-align: center;
        font-size: 0.75rem;
        color: var(--text-muted);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
    }

    .nav-footer::before {
        content: '';
        position: absolute;
        top: -1px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 2px;
        background: var(--primary);
        border-radius: var(--radius-full);
    }

    /* ===== Main Content Area ===== */
    .suite-main {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }

    .suite-header {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: var(--spacing-lg) var(--spacing-xl);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 50;
    }

    .suite-header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        position: relative;
        padding-left: var(--spacing-md);
    }

    .suite-header h1::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 24px;
        background: var(--primary);
        border-radius: var(--radius-full);
    }

    .user-profile {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-sm) var(--spacing-lg);
        background: var(--bg-card);
        border-radius: var(--radius-full);
        box-shadow: var(--shadow-sm);
        font-weight: 500;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .user-profile::before {
        content: '';
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.875rem;
    }

    /* ===== Tab Content ===== */
    .tab-content {
        padding: var(--spacing-xl);
        flex: 1;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ===== Stats Grid ===== */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .stat-card {
        background: var(--bg-card);
        padding: var(--spacing-xl);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        transition: all var(--transition-normal);
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary);
        opacity: 0;
        transition: opacity var(--transition-normal);
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
    }

    .stat-card:hover::before {
        opacity: 1;
    }

    .stat-card.accent {
        border-top: none;
    }

    .stat-card.accent::before {
        background: linear-gradient(90deg, var(--accent-hot), #fca5a5);
        opacity: 1;
    }

    .stat-card.win::before {
        background: linear-gradient(90deg, var(--accent-won), #6ee7b7);
        opacity: 1;
    }

    .stat-card h4 {
        margin: 0;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
        margin-bottom: var(--spacing-sm);
    }

    .stat-card h2 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, var(--text-primary), var(--primary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-card .trend {
        position: absolute;
        bottom: var(--spacing-lg);
        right: var(--spacing-lg);
        font-size: 0.75rem;
        color: var(--success);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .stat-card .trend.down {
        color: var(--error);
    }

    /* ===== Content Split ===== */
    .content-split {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: var(--spacing-xl);
    }

    .card {
        background: var(--bg-card);
        padding: var(--spacing-xl);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .card h3 {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: var(--spacing-lg);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding-bottom: var(--spacing-md);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .card h3 i {
        color: var(--primary);
    }

    .data-list {
        margin-top: var(--spacing-md);
        max-height: 400px;
        overflow-y: auto;
    }

    .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
        cursor: pointer;
    }

    .list-item:hover {
        background: var(--bg-hover);
        transform: translateX(4px);
    }

    .list-item span:first-child {
        font-weight: 500;
        color: var(--text-primary);
    }

    .list-item small {
        color: var(--text-muted);
        font-size: 0.75rem;
    }

    /* ===== Badge System ===== */
    .badge {
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-full);
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .badge.overdue {
        background: linear-gradient(135deg, #000000, #333333);
        color: #ffffff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .badge.high, .badge.hot {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #b91c1c;
    }

    .badge.medium, .badge.warm {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #d97706;
    }

    .badge.low, .badge.cold {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1d4ed8;
    }

    .badge.won, .badge.active {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        color: #059669;
    }

    /* ===== Pipeline View ===== */
    .pipeline-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--spacing-lg);
        height: calc(100vh - 200px);
    }

    .pipeline-stage {
        background: var(--bg-card);
        border-radius: var(--radius-xl);
        padding: var(--spacing-lg);
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-sm);
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: all var(--transition-normal);
    }

    .pipeline-stage:hover {
        box-shadow: var(--shadow-md);
    }

    .pipeline-stage h4 {
        margin: 0 0 var(--spacing-lg) 0;
        padding-bottom: var(--spacing-md);
        border-bottom: 2px solid;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .pipeline-stage h4::before {
        content: '';
        width: 8px;
        height: 8px;
        border-radius: var(--radius-full);
    }

    #pipeline-hot h4 { border-color: var(--accent-hot); color: var(--accent-hot); }
    #pipeline-hot h4::before { background: var(--accent-hot); box-shadow: 0 0 10px var(--accent-hot); }
    
    #pipeline-warm h4 { border-color: var(--accent-warm); color: var(--accent-warm); }
    #pipeline-warm h4::before { background: var(--accent-warm); box-shadow: 0 0 10px var(--accent-warm); }
    
    #pipeline-cold h4 { border-color: var(--accent-cold); color: var(--accent-cold); }
    #pipeline-cold h4::before { background: var(--accent-cold); box-shadow: 0 0 10px var(--accent-cold); }
    
    #pipeline-won h4 { border-color: var(--accent-won); color: var(--accent-won); }
    #pipeline-won h4::before { background: var(--accent-won); box-shadow: 0 0 10px var(--accent-won); }

    .pipeline-deals {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        overflow-y: auto;
        padding-right: var(--spacing-xs);
    }

    .pipeline-deal {
        background: linear-gradient(135deg, #f8fafc, #ffffff);
        padding: var(--spacing-md);
        border-radius: var(--radius-lg);
        border-left: 4px solid;
        transition: all var(--transition-fast);
        cursor: pointer;
        position: relative;
    }

    .pipeline-deal:hover {
        transform: translateX(4px);
        box-shadow: var(--shadow-sm);
    }

    #pipeline-hot .pipeline-deal { border-left-color: var(--accent-hot); }
    #pipeline-warm .pipeline-deal { border-left-color: var(--accent-warm); }
    #pipeline-cold .pipeline-deal { border-left-color: var(--accent-cold); }
    #pipeline-won .pipeline-deal { border-left-color: var(--accent-won); }

    .pipeline-deal strong {
        display: block;
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
    }

    .pipeline-deal small {
        color: var(--text-muted);
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .pipeline-deal .actions {
        position: absolute;
        top: var(--spacing-sm);
        right: var(--spacing-sm);
        opacity: 0;
        transition: opacity var(--transition-fast);
    }

    .pipeline-deal:hover .actions {
        opacity: 1;
    }

    .pipeline-deal .actions i {
        padding: var(--spacing-xs);
        border-radius: var(--radius-sm);
        background: var(--bg-hover);
        cursor: pointer;
        transition: var(--transition-fast);
    }

    .pipeline-deal .actions i:hover {
        background: var(--primary);
        color: white;
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .empty-state i {
        font-size: 2rem;
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
    }

    /* ===== Prospects View ===== */
    .prospects-toolbar {
        display: flex;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-xl);
        background: var(--bg-card);
        padding: var(--spacing-lg);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-sm);
    }

    .prospects-toolbar input {
        flex: 1;
        padding: var(--spacing-md) var(--spacing-lg);
        border: 2px solid transparent;
        border-radius: var(--radius-lg);
        font-size: 0.9rem;
        background: var(--bg-hover);
        transition: all var(--transition-fast);
    }

    .prospects-toolbar input:focus {
        outline: none;
        border-color: var(--primary);
        background: var(--bg-card);
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }

    .prospects-toolbar select {
        padding: var(--spacing-md) var(--spacing-lg);
        border: 2px solid transparent;
        border-radius: var(--radius-lg);
        font-size: 0.9rem;
        background: var(--bg-hover);
        cursor: pointer;
        transition: all var(--transition-fast);
        min-width: 150px;
    }

    .prospects-toolbar select:focus {
        outline: none;
        border-color: var(--primary);
        background: var(--bg-card);
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }

    .prospects-table-container {
        background: var(--bg-card);
        border-radius: var(--radius-xl);
        overflow: hidden;
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .prospects-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .prospects-table thead {
        background: linear-gradient(135deg, var(--bg-secondary), #0f172a);
    }

    .prospects-table th {
        background: transparent;
        padding: var(--spacing-lg);
        text-align: left;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .prospects-table td {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--bg-hover);
        vertical-align: middle;
    }

    .prospects-table tbody tr {
        transition: all var(--transition-fast);
        cursor: pointer;
    }

    .prospects-table tbody tr:hover {
        background: var(--bg-hover);
    }

    .prospects-table tbody tr td:first-child {
        border-radius: var(--radius-lg) 0 0 var(--radius-lg);
    }

    .prospects-table tbody tr td:last-child {
        border-radius: 0 var(--radius-lg) var(--radius-lg) 0;
    }

    .company-cell {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .company-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 0.875rem;
        box-shadow: var(--shadow-sm);
    }

    .company-info strong {
        display: block;
        color: var(--text-primary);
        font-weight: 600;
    }

    .company-info small {
        color: var(--text-muted);
        font-size: 0.75rem;
    }

    .score-cell {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .score-bar {
        width: 60px;
        height: 6px;
        background: var(--bg-hover);
        border-radius: var(--radius-full);
        overflow: hidden;
    }

    .score-bar-fill {
        height: 100%;
        border-radius: var(--radius-full);
        transition: width var(--transition-normal);
    }

    .score-bar-fill.high { background: linear-gradient(90deg, var(--accent-hot), #fca5a5); }
    .score-bar-fill.medium { background: linear-gradient(90deg, var(--accent-warm), #fcd34d); }
    .score-bar-fill.low { background: linear-gradient(90deg, var(--accent-cold), #93c5fd); }

    /* ===== Loading States ===== */
    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-xl);
        color: var(--text-muted);
    }

    .loading::after {
        content: '';
        width: 24px;
        height: 24px;
        border: 3px solid var(--bg-hover);
        border-top-color: var(--primary);
        border-radius: var(--radius-full);
        animation: spin 1s linear infinite;
        margin-left: var(--spacing-md);
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .skeleton {
        background: linear-gradient(90deg, var(--bg-hover) 25%, #e2e8f0 50%, var(--bg-hover) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: var(--radius-md);
    }

    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    /* ===== Toast Notifications ===== */
    .toast-container {
        position: fixed;
        bottom: var(--spacing-xl);
        right: var(--spacing-xl);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
    }

    .toast {
        padding: var(--spacing-md) var(--spacing-lg);
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        animation: slideIn 0.3s ease;
        min-width: 300px;
    }

    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--error); }
    .toast.warning { border-left: 4px solid var(--warning); }
    .toast.info { border-left: 4px solid var(--info); }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* ===== Responsive Design ===== */
    @media (max-width: 1400px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .pipeline-container {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 1024px) {
        .suite-nav {
            width: 80px;
        }
        
        .brand span,
        .nav-item span {
            display: none;
        }
        
        .nav-item {
            justify-content: center;
            padding: var(--spacing-md);
        }
        
        .content-split {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .pipeline-container {
            grid-template-columns: 1fr;
            height: auto;
        }
        
        .prospects-toolbar {
            flex-direction: column;
        }
    }
</style>

[FILE_END: CRM_Styles.html]
################################################################################

================================================================================
FILE_BEGIN: CRM_Suite.html
METADATA: Size=43473 bytes | Last_Modified=2026-02-09 14:01:31.445082
================================================================================
<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>K&L Recycling CRM Suite</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ===== CSS Variables & Theme ===== */
    :root {
        /* Primary Palette - K&L Green Inspired */
        --primary: #10b981;
        --primary-dark: #059669;
        --primary-light: #34d399;
        --primary-bg: #ecfdf5;
        
        /* Accent Colors */
        --accent-hot: #ef4444;
        --accent-warm: #f59e0b;
        --accent-cold: #3b82f6;
        --accent-won: #10b981;
        
        /* Neutral Palette */
        --bg-main: #0f172a;
        --bg-secondary: #1e293b;
        --bg-card: #ffffff;
        --bg-hover: #f1f5f9;
        
        /* Text Colors */
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        --text-inverse: #ffffff;
        
        /* Semantic Colors */
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --info: #3b82f6;
        
        /* Shadows */
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --shadow-glow: 0 0 20px rgba(16, 185, 129, 0.3);
        
        /* Spacing */
        --spacing-xs: 0.25rem;
        --spacing-sm: 0.5rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --spacing-xl: 2rem;
        
        /* Border Radius */
        --radius-sm: 0.375rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        --radius-full: 9999px;
        
        /* Transitions */
        --transition-fast: 150ms ease;
        --transition-normal: 250ms ease;
        --transition-slow: 350ms ease;
        
        /* Sidebar Width */
        --sidebar-width: 280px;
    }

    /* ===== Base Reset ===== */
    *, *::before, *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    html {
        font-size: 16px;
        scroll-behavior: smooth;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        background: var(--bg-main);
        color: var(--text-primary);
        line-height: 1.6;
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* ===== Scrollbar Styling ===== */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: var(--radius-full);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: var(--radius-full);
        transition: var(--transition-fast);
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-light);
    }

    /* ===== Layout ===== */
    .suite-wrapper {
        display: flex;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
    }

    /* ===== Sidebar Navigation ===== */
    .suite-nav {
        width: var(--sidebar-width);
        background: linear-gradient(180deg, var(--bg-secondary) 0%, #0f172a 100%);
        color: var(--text-inverse);
        display: flex;
        flex-direction: column;
        position: relative;
        z-index: 100;
        box-shadow: var(--shadow-xl);
    }

    .suite-nav::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.5), transparent);
    }

    .brand {
        padding: var(--spacing-xl) var(--spacing-lg);
        font-weight: 800;
        font-size: 1.25rem;
        letter-spacing: 2px;
        color: var(--primary);
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        position: relative;
    }

    .brand::before {
        content: '';
    }

    .brand::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: var(--spacing-lg);
        right: var(--spacing-lg);
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
    }

    .nav-links {
        flex: 1;
        padding: var(--spacing-md);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        overflow-y: auto;
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-md) var(--spacing-lg);
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: all var(--transition-normal);
        color: var(--text-muted);
        font-weight: 500;
        position: relative;
        overflow: hidden;
    }

    .nav-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 0;
        background: var(--primary);
        border-radius: var(--radius-full);
        transition: height var(--transition-normal);
    }

    .nav-item:hover {
        background: rgba(16, 185, 129, 0.1);
        color: var(--text-inverse);
        transform: translateX(4px);
    }

    .nav-item:hover::before {
        height: 24px;
    }

    .nav-item.active {
        background: linear-gradient(90deg, rgba(16, 185, 129, 0.2), transparent);
        color: var(--primary);
        font-weight: 600;
    }

    .nav-item.active::before {
        height: 32px;
        box-shadow: var(--shadow-glow);
    }

    .nav-item i {
        width: 24px;
        text-align: center;
        font-size: 1.1rem;
    }

    .nav-footer {
        padding: var(--spacing-lg);
        text-align: center;
        font-size: 0.75rem;
        color: var(--text-muted);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
    }

    .nav-footer::before {
        content: '';
        position: absolute;
        top: -1px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 2px;
        background: var(--primary);
        border-radius: var(--radius-full);
    }

    /* ===== Main Content Area ===== */
    .suite-main {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }

    .suite-header {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: var(--spacing-lg) var(--spacing-xl);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 50;
    }

    .suite-header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        position: relative;
        padding-left: var(--spacing-md);
    }

    .suite-header h1::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 24px;
        background: var(--primary);
        border-radius: var(--radius-full);
    }

    .user-profile {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-sm) var(--spacing-lg);
        background: var(--bg-card);
        border-radius: var(--radius-full);
        box-shadow: var(--shadow-sm);
        font-weight: 500;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .user-profile::before {
        content: '';
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, var(--primary), var(--primary-light));
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.875rem;
    }

    /* ===== Tab Content ===== */
    .tab-content {
        padding: var(--spacing-xl);
        flex: 1;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ===== Stats Grid ===== */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .stat-card {
        background: var(--bg-card);
        padding: var(--spacing-xl);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        transition: all var(--transition-normal);
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary);
        opacity: 0;
        transition: opacity var(--transition-normal);
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
    }

    .stat-card:hover::before {
        opacity: 1;
    }

    .stat-card.accent {
        border-top: none;
    }

    .stat-card.accent::before {
        background: linear-gradient(90deg, var(--accent-hot), #fca5a5);
        opacity: 1;
    }

    .stat-card.win::before {
        background: linear-gradient(90deg, var(--accent-won), #6ee7b7);
        opacity: 1;
    }

    .stat-card h4 {
        margin: 0;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
        margin-bottom: var(--spacing-sm);
    }

    .stat-card h2 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, var(--text-primary), var(--primary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-card .trend {
        position: absolute;
        bottom: var(--spacing-lg);
        right: var(--spacing-lg);
        font-size: 0.75rem;
        color: var(--success);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .stat-card .trend.down {
        color: var(--error);
    }

    /* ===== Content Split ===== */
    .content-split {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: var(--spacing-xl);
    }

    .card {
        background: var(--bg-card);
        padding: var(--spacing-xl);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .card h3 {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: var(--spacing-lg);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding-bottom: var(--spacing-md);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .card h3 i {
        color: var(--primary);
    }

    .data-list {
        margin-top: var(--spacing-md);
        max-height: 400px;
        overflow-y: auto;
    }

    .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
        cursor: pointer;
    }

    .list-item:hover {
        background: var(--bg-hover);
        transform: translateX(4px);
    }

    .list-item span:first-child {
        font-weight: 500;
        color: var(--text-primary);
    }

    .list-item small {
        color: var(--text-muted);
        font-size: 0.75rem;
    }

    /* ===== Badge System ===== */
    .badge {
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-full);
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .badge.overdue {
        background: linear-gradient(135deg, #000000, #333333);
        color: #ffffff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .badge.high, .badge.hot {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #b91c1c;
    }

    .badge.medium, .badge.warm {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #d97706;
    }

    .badge.low, .badge.cold {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1d4ed8;
    }

    .badge.won, .badge.active {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        color: #059669;
    }

    /* ===== Pipeline View ===== */
    .pipeline-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--spacing-lg);
        height: calc(100vh - 200px);
    }

    .pipeline-stage {
        background: var(--bg-card);
        border-radius: var(--radius-xl);
        padding: var(--spacing-lg);
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-sm);
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: all var(--transition-normal);
    }

    .pipeline-stage:hover {
        box-shadow: var(--shadow-md);
    }

    .pipeline-stage h4 {
        margin: 0 0 var(--spacing-lg) 0;
        padding-bottom: var(--spacing-md);
        border-bottom: 2px solid;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .pipeline-stage h4::before {
        content: '';
        width: 8px;
        height: 8px;
        border-radius: var(--radius-full);
    }

    #pipeline-hot h4 { border-color: var(--accent-hot); color: var(--accent-hot); }
    #pipeline-hot h4::before { background: var(--accent-hot); box-shadow: 0 0 10px var(--accent-hot); }
    
    #pipeline-warm h4 { border-color: var(--accent-warm); color: var(--accent-warm); }
    #pipeline-warm h4::before { background: var(--accent-warm); box-shadow: 0 0 10px var(--accent-warm); }
    
    #pipeline-cold h4 { border-color: var(--accent-cold); color: var(--accent-cold); }
    #pipeline-cold h4::before { background: var(--accent-cold); box-shadow: 0 0 10px var(--accent-cold); }
    
    #pipeline-won h4 { border-color: var(--accent-won); color: var(--accent-won); }
    #pipeline-won h4::before { background: var(--accent-won); box-shadow: 0 0 10px var(--accent-won); }

    .pipeline-deals {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        overflow-y: auto;
        padding-right: var(--spacing-xs);
    }

    .pipeline-deal {
        background: linear-gradient(135deg, #f8fafc, #ffffff);
        padding: var(--spacing-md);
        border-radius: var(--radius-lg);
        border-left: 4px solid;
        transition: all var(--transition-fast);
        cursor: pointer;
        position: relative;
    }

    .pipeline-deal:hover {
        transform: translateX(4px);
        box-shadow: var(--shadow-sm);
    }

    #pipeline-hot .pipeline-deal { border-left-color: var(--accent-hot); }
    #pipeline-warm .pipeline-deal { border-left-color: var(--accent-warm); }
    #pipeline-cold .pipeline-deal { border-left-color: var(--accent-cold); }
    #pipeline-won .pipeline-deal { border-left-color: var(--accent-won); }

    .pipeline-deal strong {
        display: block;
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
    }

    .pipeline-deal small {
        color: var(--text-muted);
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    .empty-state i {
        font-size: 2rem;
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
    }

    /* ===== Prospects View ===== */
    .prospects-toolbar {
        display: flex;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-xl);
        background: var(--bg-card);
        padding: var(--spacing-lg);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-sm);
    }

    .prospects-toolbar input {
        flex: 1;
        padding: var(--spacing-md) var(--spacing-lg);
        border: 2px solid transparent;
        border-radius: var(--radius-lg);
        font-size: 0.9rem;
        background: var(--bg-hover);
        transition: all var(--transition-fast);
    }

    .prospects-toolbar input:focus {
        outline: none;
        border-color: var(--primary);
        background: var(--bg-card);
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }

    .prospects-toolbar select {
        padding: var(--spacing-md) var(--spacing-lg);
        border: 2px solid transparent;
        border-radius: var(--radius-lg);
        font-size: 0.9rem;
        background: var(--bg-hover);
        cursor: pointer;
        transition: all var(--transition-fast);
        min-width: 150px;
    }

    .prospects-toolbar select:focus {
        outline: none;
        border-color: var(--primary);
        background: var(--bg-card);
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }

    .prospects-table-container {
        background: var(--bg-card);
        border-radius: var(--radius-xl);
        overflow: hidden;
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .prospects-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .prospects-table thead {
        background: linear-gradient(135deg, var(--bg-secondary), #0f172a);
    }

    .prospects-table th {
        background: transparent;
        padding: var(--spacing-lg);
        text-align: left;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-muted);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .prospects-table td {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--bg-hover);
        vertical-align: middle;
    }

    .prospects-table tbody tr {
        transition: all var(--transition-fast);
        cursor: pointer;
    }

    .prospects-table tbody tr:hover {
        background: var(--bg-hover);
    }

    /* ===== Responsive Design ===== */
    @media (max-width: 1400px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        .pipeline-container {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 1024px) {
        .suite-nav {
            width: 80px;
        }
        .brand span, .nav-item span {
            display: none;
        }
        .nav-item {
            justify-content: center;
            padding: var(--spacing-md);
        }
        .content-split {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        .pipeline-container {
            grid-template-columns: 1fr;
            height: auto;
        }
        .prospects-toolbar {
            flex-direction: column;
        }
    }
  </style>
</head>

<body>
  <div class="suite-wrapper">
    <nav class="suite-nav">
      <div class="brand">K&L RECYCLING</div>
      <div class="nav-links">
        <div class="nav-item active" onclick="switchTab('dashboard', this)">
          <i class="fas fa-th-large"></i> <span>Dashboard</span>
        </div>
        <div class="nav-item" onclick="switchTab('pipeline', this)">
          <i class="fas fa-filter"></i> <span>Pipeline</span>
        </div>
        <div class="nav-item" onclick="switchTab('prospects', this)">
          <i class="fas fa-address-book"></i> <span>Prospects</span>
        </div>
      </div>
      <div class="nav-footer">System v2.6.0</div>
    </nav>

    <main class="suite-main">
      <header class="suite-header">
        <h1 id="tab-title">Executive Dashboard</h1>
        <div class="user-profile">Operations Analyst</div>
      </header>

      <div id="view-dashboard" class="tab-content">
        <div class="stats-grid" id="stat-cards">
        </div>

        <div class="content-split">
          <div class="card">
            <h3><i class="fas fa-fire"></i> Urgent Follow-ups</h3>
            <div id="urgent-list" class="data-list">Loading...</div>
          </div>
          <div class="card">
            <h3><i class="fas fa-trophy"></i> Recent Wins</h3>
            <div id="wins-list" class="data-list">Loading...</div>
          </div>
        </div>
      </div>

      <div id="view-pipeline" class="tab-content" style="display: none;">
        <div class="pipeline-container" id="pipeline-container">
          <div class="pipeline-stage">
            <h4><i class="fas fa-fire"></i> Hot</h4>
            <div id="pipeline-hot" class="pipeline-deals">Loading...</div>
          </div>
          <div class="pipeline-stage">
            <h4><i class="fas fa-sun"></i> Warm</h4>
            <div id="pipeline-warm" class="pipeline-deals">Loading...</div>
          </div>
          <div class="pipeline-stage">
            <h4><i class="fas fa-snowflake"></i> Cold</h4>
            <div id="pipeline-cold" class="pipeline-deals">Loading...</div>
          </div>
          <div class="pipeline-stage">
            <h4><i class="fas fa-check"></i> Won</h4>
            <div id="pipeline-won" class="pipeline-deals">Loading...</div>
          </div>
        </div>
      </div>

      <div id="view-prospects" class="tab-content" style="display: none;">
        <div class="prospects-toolbar">
          <input type="text" id="prospects-search" list="company-suggestions" placeholder="Search prospects..." onkeyup="filterProspects()">
          <datalist id="company-suggestions"></datalist>
          <select id="prospects-filter" onchange="filterProspects()">
            <option value="all">All Statuses</option>
            <option value="hot">Hot</option>
            <option value="warm">Warm</option>
            <option value="cold">Cold</option>
          </select>
        </div>
        <div class="prospects-table-container">
          <table class="prospects-table">
            <thead>
              <tr>
                <th>Company Name</th>
                <th>Contact Status</th>
                <th>Urgency</th>
                <th>Priority Score</th>
                <th>Last Outreach</th>
              </tr>
            </thead>
            <tbody id="prospects-table-body">
              <tr><td colspan="5">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ============================================================================
    // HTML SAFE RENDERER INTEGRATION
    // ============================================================================
    
    /**
     * HtmlSafeRenderer - Prevents XSS vulnerabilities
     * Provides safe DOM manipulation methods
     */
    var HtmlSafeRenderer = (function() {
      // ============================================================================
      // ESCAPE FUNCTIONS
      // ============================================================================
      
      /**
       * Escape HTML special characters to prevent XSS
       * @param {string} str - String to escape
       * @return {string} Escaped string
       */
      function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        var div = document.createElement('div');
        div.textContent = String(str);
        return div.innerHTML;
      }
      
      /**
       * Escape HTML attributes (more restrictive than escapeHtml)
       * @param {string} str - String to escape
       * @return {string} Escaped string for attributes
       */
      function escapeAttribute(str) {
        if (str === null || str === undefined) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      }
      
      /**
       * Sanitize HTML by removing dangerous tags and attributes
       * @param {string} html - HTML string to sanitize
       * @return {string} Sanitized HTML
       */
      function sanitizeHtml(html) {
        if (!html || typeof html !== 'string') return '';
        
        // Remove script tags and their contents
        html = html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
        
        // Remove event handlers
        html = html.replace(/\s+on\w+\s*=\s*(['"])[^'"]*\1/gi, '');
        html = html.replace(/\s+on\w+\s*=\s*[^\s>]*/gi, '');
        
        // Remove javascript: URLs
        html = html.replace(/href\s*=\s*(['"])\s*javascript:[^'"]*\1/gi, 'href="#"');
        html = html.replace(/href\s*=\s*javascript:[^\s>]+/gi, 'href="#"');
        
        // Remove data: URLs (can contain JavaScript)
        html = html.replace(/src\s*=\s*(['"])\s*data:[^'"]*\1/gi, 'src=""');
        
        return html;
      }
      
      // ============================================================================
      // DOM MANIPULATION FUNCTIONS
      // ============================================================================
      
      /**
       * Safely set text content of an element (replaces innerHTML for text-only)
       * @param {string} elementId - ID of the element
       * @param {string} text - Text to set
       */
      function setText(elementId, text) {
        var el = document.getElementById(elementId);
        if (el) {
          el.textContent = text || '';
        }
      }
      
      /**
       * Safely append text to an element
       * @param {string} elementId - ID of the element
       * @param {string} text - Text to append
       */
      function appendText(elementId, text) {
        var el = document.getElementById(elementId);
        if (el) {
          el.textContent += text || '';
        }
      }
      
      /**
       * Safely set innerHTML with escaping (safeInnerHTML)
       * @param {string} elementId - ID of the element
       * @param {string} html - HTML string (will be sanitized)
       */
      function setInnerHtml(elementId, html) {
        var el = document.getElementById(elementId);
        if (el) {
          el.innerHTML = sanitizeHtml(html);
        }
      }
      
      /**
       * Safely append innerHTML with escaping
       * @param {string} elementId - ID of the element
       * @param {string} html - HTML string to append (will be sanitized)
       */
      function appendInnerHtml(elementId, html) {
        var el = document.getElementById(elementId);
        if (el) {
          el.innerHTML += sanitizeHtml(html);
        }
      }
      
      /**
       * Create an element with safe properties
       * @param {string} tagName - Tag name of the element
       * @param {Object} attributes - Attributes to set
       * @param {string} textContent - Text content (optional)
       * @return {HTMLElement} Created element
       */
      function createElement(tagName, attributes, textContent) {
        var el = document.createElement(tagName);
        
        if (attributes && typeof attributes === 'object') {
          for (var key in attributes) {
            if (attributes.hasOwnProperty(key)) {
              var value = attributes[key];
              
              // Only set safe attributes
              var safeAttributes = ['class', 'className', 'id', 'title', 'style', 'href', 'target', 
                                   'src', 'alt', 'data-*', 'role', 'aria-*'];
              
              var isSafe = false;
              for (var i = 0; i < safeAttributes.length; i++) {
                var safeAttr = safeAttributes[i];
                if (safeAttr === key || 
                    (safeAttr.endsWith('-*') && key.startsWith(safeAttr.slice(0, -2))) ||
                    key.startsWith('data-') ||
                    key.startsWith('aria-')) {
                  isSafe = true;
                  break;
                }
              }
              
              if (isSafe) {
                var attrName = key === 'className' ? 'class' : key;
                el.setAttribute(attrName, value);
              }
            }
          }
        }
          
        if (textContent !== undefined && textContent !== null) {
          el.textContent = textContent;
        }
        
        return el;
      }
      
      /**
       * Safely build a list item
       * @param {string} primary - Primary text (company name)
       * @param {string} secondary - Secondary text (badge/status)
       * @param {Object} options - Options for the list item
       * @return {string} HTML string for list item
       */
      function buildListItem(primary, secondary, options) {
        options = options || {};
        var primaryEscaped = escapeHtml(primary || 'Unknown');
        var secondaryEscaped = escapeHtml(secondary || '');
        
        var badgeClass = escapeAttribute((options.badgeClass || secondary || '').toLowerCase());
        var onclick = options.onclick ? 'onclick="' + escapeAttribute(options.onclick) + '"' : '';
        
        return '<div class="list-item" ' + onclick + '>' +
                 '<span><strong>' + primaryEscaped + '</strong></span>' +
                 (secondary ? '<span class="badge ' + badgeClass + '">' + secondaryEscaped + '</span>' : '') +
               '</div>';
      }
      
      /**
       * Safely build a table row
       * @param {Array} cells - Array of cell data objects
       * @return {string} HTML string for table row
       */
      function buildTableRow(cells) {
        if (!Array.isArray(cells)) return '';
        
        var html = '<tr>';
        cells.forEach(function(cell) {
          var text = escapeHtml(cell.text || cell || 'N/A');
          var colspan = cell.colspan ? ' colspan="' + escapeAttribute(String(cell.colspan)) + '"' : '';
          var className = cell.className ? ' class="' + escapeAttribute(cell.className) + '"' : '';
          html += '<td' + colspan + className + '>' + text + '</td>';
        });
        html += '</tr>';
        
        return html;
      }
      
      /**
       * Safely build a pipeline deal card
       * @param {Object} deal - Deal data object
       * @param {Array} fields - Fields to display
       * @return {string} HTML string for deal card
       */
      function buildPipelineDeal(deal, fields) {
        fields = fields || ['company name', 'urgencyband'];
        
        var html = '<div class="pipeline-deal">';
        fields.forEach(function(field) {
          var value = deal[field] || '';
          var escaped = escapeHtml(value);
          if (field === 'company name') {
            html += '<strong>' + escaped + '</strong><br>';
          } else {
            html += '<small>' + escaped + '</small><br>';
          }
        });
        html += '</div>';
        
        return html;
      }
      
      /**
       * Safely build stat card HTML
       * @param {string} title - Card title
       * @param {string|number} value - Card value
       * @param {Object} options - Card options
       * @return {string} HTML string for stat card
       */
      function buildStatCard(title, value, options) {
        options = options || {};
        var titleEscaped = escapeHtml(title || '');
        var valueEscaped = escapeHtml(String(value || 0));
        var className = 'stat-card' + (options.accent ? ' ' + options.accent : '') + (options.win ? ' win' : '');
        
        return '<div class="' + escapeAttribute(className) + '">' +
                 '<h4>' + titleEscaped + '</h4>' +
                 '<h2>' + valueEscaped + '</h2>' +
               '</div>';
      }
      
      // ============================================================================
      // PUBLIC API
      // ============================================================================
      
      return {
        escapeHtml: escapeHtml,
        escapeAttribute: escapeAttribute,
        sanitizeHtml: sanitizeHtml,
        setText: setText,
        appendText: appendText,
        setInnerHtml: setInnerHtml,
        appendInnerHtml: appendInnerHtml,
        createElement: createElement,
        buildListItem: buildListItem,
        buildTableRow: buildTableRow,
        buildPipelineDeal: buildPipelineDeal,
        buildStatCard: buildStatCard
      };
    })();

    // ============================================================================
    // CRM APPLICATION CODE
    // ============================================================================

    // Global data storage
    var crmData = {
      dashboard: null,
      pipeline: null,
      prospects: null
    };

    function callAPI(action, payload) {
      return new Promise(function(resolve, reject) {
        google.script.run
          .withSuccessHandler(function(res) {
            // DEFENSIVE: Ensure response is always an object with success property
            if (res === null || res === undefined) {
              console.warn('API returned null/undefined for action:', action);
              resolve({ success: false, error: 'No data returned', data: null });
              return;
            }
            // DEFENSIVE: Check if response has success property
            if (typeof res.success === 'undefined') {
              console.warn('API returned object without success property for action:', action, res);
              // Assume success if data is present
              resolve({ success: true, data: res, error: null });
              return;
            }
            resolve(res);
          })
          .withFailureHandler(function(error) {
            console.error('API call failed for action:', action, error);
            reject({ success: false, error: error.message || 'Unknown error', data: null });
          })
          .crmGateway({ action: action, payload: payload || {} });
      });
    }

    function init() {
      console.log('CRM Dashboard initializing...');
      callAPI('GET_DASHBOARD_STATS')
        .then(function(res) {
          console.log('API Response:', res);
          // DEFENSIVE: Check for null/undefined response
          if (!res || res === null) {
            console.error('init: API response was null');
            showError('No data returned from server');
            return;
          }
          if (res.success === true && res.data) {
            console.log('Dashboard data loaded successfully, rendering...');
            crmData.dashboard = res;
            renderDashboard(res.data);
          } else {
            console.error('Failed to load dashboard stats:', res.error);
            showError('Failed to load dashboard data: ' + (res.error || 'Unknown error'));
          }
        })
        .catch(function(e) {
          console.error('Error initializing dashboard:', e);
          showError('Error loading dashboard: ' + (e.message || 'Unknown error'));
        });
    }

    function showError(message) {
      var safeMessage = HtmlSafeRenderer.escapeHtml(message);
      HtmlSafeRenderer.setInnerHtml('stat-cards', 
        '<div style="color: red; padding: 10px;">' + safeMessage + '</div>');
      HtmlSafeRenderer.setInnerHtml('urgent-list', 
        '<div style="color: red; padding: 10px;">' + safeMessage + '</div>');
      HtmlSafeRenderer.setInnerHtml('wins-list', 
        '<div style="color: red; padding: 10px;">' + safeMessage + '</div>');
    }

    function renderDashboard(data) {
      if (!data) {
        console.error('renderDashboard: data is null or undefined');
        showError('No data available');
        return;
      }

      var stats = data.pipeline || { total: 0, hot: 0, warm: 0, won: 0 };
      
      var statCardsHtml = 
        HtmlSafeRenderer.buildStatCard('PROSPECTS', stats.total || 0, {}) +
        HtmlSafeRenderer.buildStatCard('HOT LEADS', stats.hot || 0, { accent: 'accent' }) +
        HtmlSafeRenderer.buildStatCard('WARM LEADS', stats.warm || 0, {}) +
        HtmlSafeRenderer.buildStatCard('TOTAL WINS', stats.won || 0, { win: true });
      
      HtmlSafeRenderer.setInnerHtml('stat-cards', statCardsHtml);

      if (data.prospects && Array.isArray(data.prospects) && data.prospects.length > 0) {
        var urgentHtml = data.prospects.map(function(p) {
          return HtmlSafeRenderer.buildListItem(
            p.companyName || 'Unknown',
            p.urgencyBand || 'N/A',
            { badgeClass: (p.urgencyBand || '').toLowerCase() }
          );
        }).join('');
        HtmlSafeRenderer.setInnerHtml('urgent-list', urgentHtml);
      } else {
        HtmlSafeRenderer.setInnerHtml('urgent-list', 
          '<div style="padding: 10px; color: #666;">No urgent prospects</div>');
      }

      if (data.accounts && Array.isArray(data.accounts) && data.accounts.length > 0) {
        var winsHtml = data.accounts.map(function(a) {
          return HtmlSafeRenderer.buildListItem(
            a.companyName || 'Unknown Company',
            a.rolloffContainerSize || 'N/A'
          );
        }).join('');
        HtmlSafeRenderer.setInnerHtml('wins-list', winsHtml);
      } else {
        HtmlSafeRenderer.setInnerHtml('wins-list', 
          '<div style="padding: 10px; color: #666;">No recent wins</div>');
      }
    }

    function renderPipeline(data) {
      if (!data) {
        console.error('renderPipeline: data is null or undefined');
        return;
      }

      var stages = {
        hot: data.hot || [],
        warm: data.warm || [],
        cold: data.cold || [],
        won: data.won || []
      };

      var hotHtml = stages.hot.length > 0 ? 
        stages.hot.map(function(p) { 
          return HtmlSafeRenderer.buildPipelineDeal(p, ['companyName', 'urgencyBand']); 
        }).join('') : 
        '<div class="empty-state"><i class="fas fa-inbox"></i>No hot prospects</div>';
      
      var warmHtml = stages.warm.length > 0 ? 
        stages.warm.map(function(p) { 
          return HtmlSafeRenderer.buildPipelineDeal(p, ['companyName', 'urgencyBand']); 
        }).join('') : 
        '<div class="empty-state"><i class="fas fa-inbox"></i>No warm prospects</div>';
      
      var coldHtml = stages.cold.length > 0 ? 
        stages.cold.map(function(p) { 
          return HtmlSafeRenderer.buildPipelineDeal(p, ['companyName', 'urgencyBand']); 
        }).join('') : 
        '<div class="empty-state"><i class="fas fa-inbox"></i>No cold prospects</div>';
      
      var wonHtml = stages.won.length > 0 ? 
        stages.won.map(function(p) { 
          return HtmlSafeRenderer.buildPipelineDeal(p, ['companyName', 'timestamp']); 
        }).join('') : 
        '<div class="empty-state"><i class="fas fa-trophy"></i>No wins yet</div>';
      
      HtmlSafeRenderer.setInnerHtml('pipeline-hot', hotHtml);
      HtmlSafeRenderer.setInnerHtml('pipeline-warm', warmHtml);
      HtmlSafeRenderer.setInnerHtml('pipeline-cold', coldHtml);
      HtmlSafeRenderer.setInnerHtml('pipeline-won', wonHtml);
    }

    function renderProspects(data) {
      if (!data || !data.all) {
        console.error('renderProspects: invalid data');
        crmData.prospects = [];
      } else {
        crmData.prospects = data.all;
      }
      updateProspectsTable(crmData.prospects);
    }

    function updateProspectsTable(prospects) {
      if (!prospects || prospects.length === 0) {
        HtmlSafeRenderer.setInnerHtml('prospects-table-body', 
          '<tr><td colspan="5" style="text-align: center; color: #666;">No prospects found</td></tr>');
        return;
      }
      
      var rowsHtml = prospects.map(function(p) {
        return HtmlSafeRenderer.buildTableRow([
          { text: p.companyName || 'Unknown', className: '' },
          { text: p.contactStatus || 'N/A', className: 'badge ' + (p.contactStatus || '').toLowerCase() },
          { text: p.urgencyBand || 'N/A', className: '' },
          { text: p.priorityScore || 'N/A', className: '' },
          { text: p.lastOutreachDate || 'N/A', className: '' }
        ]);
      }).join('');
      
      HtmlSafeRenderer.setInnerHtml('prospects-table-body', rowsHtml);
    }

    function filterProspects() {
      var searchTerm = document.getElementById('prospects-search').value.toLowerCase();
      var filterStatus = document.getElementById('prospects-filter').value;

      if (!crmData.prospects) return;

      var filtered = crmData.prospects.filter(function(p) {
        var matchesSearch = (p.companyName || '').toLowerCase().includes(searchTerm);
        var status = (p.contactStatus || '').toLowerCase();
        var matchesFilter = filterStatus === 'all' || status === filterStatus;
        return matchesSearch && matchesFilter;
      });

      updateProspectsTable(filtered);
    }

    async function switchTab(view, el) {
      // Update nav state
      document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
      el.classList.add('active');
      
      var tabTitle = document.getElementById('tab-title');
      tabTitle.textContent = view.charAt(0).toUpperCase() + view.slice(1);

      // Hide all views
      document.querySelectorAll('.tab-content').forEach(function(c) { c.style.display = 'none'; });

      var viewEl = document.getElementById('view-' + view);
      if (viewEl) {
        viewEl.style.display = 'block';
      }

      if (view === 'pipeline' && !crmData.pipeline) {
        try {
          var res = await callAPI('GET_PIPELINE');
          if (res.success) {
            crmData.pipeline = res.data;
            renderPipeline(res.data);
          } else {
            console.error('Failed to load pipeline:', res.error);
          }
        } catch (e) {
          console.error('Error loading pipeline:', e);
        }
      } else if (view === 'pipeline' && crmData.pipeline) {
        renderPipeline(crmData.pipeline);
      }

      if (view === 'prospects' && !crmData.prospects) {
        try {
          var res = await callAPI('GET_PROSPECTS');
          if (res.success) {
            renderProspects(res.data);
          } else {
            console.error('Failed to load prospects:', res.error);
          }
        } catch (e) {
          console.error('Error loading prospects:', e);
        }
      }
    }

    window.onload = init;
  </script>
</body>

</html>

[FILE_END: CRM_Suite.html]
################################################################################

================================================================================
FILE_BEGIN: dashboard.html
METADATA: Size=111012 bytes | Last_Modified=2026-02-09 14:00:33.344083
================================================================================
<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>K&L CRM Dashboard</title>
  <style>
    /* ========================================
       CSS Variables - Design System
       ======================================== */
    :root {
      --primary: #0F2537;
      --primary-light: #1a3a52;
      --primary-dark: #0a1929;
      --success: #27ae60;
      --success-light: #2ecc71;
      --warning: #f39c12;
      --warning-light: #f1c40f;
      --danger: #c0392b;
      --danger-light: #e74c3c;
      --bg: #f2f2f6;
      --bg-dark: #e5e5ea;
      --card-bg: #ffffff;
      --text: #1c1c1e;
      --text-secondary: #8e8e93;
      --text-light: #ffffff;
      --border: #dcdde1;
      --border-light: #e9ecef;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
      --shadow-hover: 0 4px 16px rgba(0, 0, 0, 0.12);
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
      --transition: all 0.2s ease;
      --transition-slow: all 0.3s ease;
      --sidebar-width: 450px;
      --sidebar-min-width: 320px;
      --sidebar-max-width: 600px;
      --header-height: 64px;
    }

    /* CRM Dashboard Panel */
    .crm-summary-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .crm-tile {
      padding: 10px;
      border-radius: var(--radius-sm);
      text-align: center;
      font-size: 12px;
      font-weight: 700;
      box-shadow: var(--shadow);
    }

    .crm-tile.red {
      background: var(--danger);
      color: var(--text-light);
    }

    .crm-tile.yellow {
      background: var(--warning);
      color: var(--text);
    }

    .crm-tile.green {
      background: var(--success);
      color: var(--text-light);
    }

    .crm-tile.orange {
      background: var(--warning-light);
      color: var(--text);
    }

    .crm-tile.blue {
      background: var(--primary-light);
      color: var(--text-light);
    }

    .crm-tile.teal {
      background: #1abc9c;
      color: var(--text-light);
    }

    .crm-tile.gray {
      background: var(--text-secondary);
      color: var(--text-light);
    }

    .crm-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }

    .crm-table th,
    .crm-table td {
      padding: 8px;
      border-bottom: 1px solid var(--border-light);
      font-size: 12px;
    }

    .crm-table th {
      text-transform: uppercase;
      font-size: 10px;
      color: var(--text-secondary);
    }

    /* ========================================
       Reset & Base Styles
       ======================================== */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ========================================
       Sidebar Container (works in both dialog and sidebar contexts)
       ======================================== */
    .sidebar-container {
      position: relative;
      height: 100%;
      width: 100%;
      min-width: var(--sidebar-min-width);
      max-width: var(--sidebar-max-width);
      background: var(--card-bg);
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      z-index: 999999;
      transition: box-shadow var(--transition), transform var(--transition-slow);
      overflow: hidden;
      /* Prevent container overflow */
    }

    /* Dialog context - make it floating */
    body:has(.dialog-context) .sidebar-container {
      position: absolute;
      top: 0;
      left: 0;
      width: var(--sidebar-width);
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
    }

    .sidebar-container.floating {
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
      transform: translateX(-10px);
    }

    .sidebar-container.resizing {
      transition: none;
    }

    /* ========================================
       Resize Handle
       ======================================== */
    .resize-handle {
      position: absolute;
      top: 0;
      right: -8px;
      width: 16px;
      height: 100%;
      cursor: ew-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000000;
      background: linear-gradient(90deg, transparent, rgba(15, 37, 55, 0.1));
      border-radius: 0 8px 8px 0;
    }

    .resize-handle::before {
      content: '';
      height: 60px;
      width: 6px;
      background: var(--border);
      border-radius: 3px;
      transition: var(--transition);
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .resize-handle:hover::before,
    .resize-handle.active::before {
      background: var(--primary);
      box-shadow: 0 0 8px rgba(15, 37, 55, 0.4);
    }

    /* ========================================
       Sidebar Header
       ======================================== */
    .sidebar-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-shrink: 0;
      cursor: move;
      user-select: none;
      position: relative;
    }

    .sidebar-header::before {
      content: '‚ãÆ‚ãÆ';
      position: absolute;
      left: 8px;
      font-size: 10px;
      opacity: 0.6;
      letter-spacing: 2px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-icon {
      font-size: 24px;
      line-height: 1;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
    }

    .brand-title {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.3px;
      line-height: 1.2;
    }

    .brand-subtitle {
      font-size: 11px;
      opacity: 0.85;
      font-weight: 500;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .time-badge {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(8px);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }

    /* ========================================
       Sidebar Content
       ======================================== */
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      scroll-behavior: smooth;
    }

    .sidebar-content::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar-content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .sidebar-content::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* ========================================
       Section Styles
       ======================================== */
    .section {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid var(--border-light);
      transition: var(--transition);
    }

    .section:hover {
      box-shadow: var(--shadow-hover);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .section-title-icon {
      font-size: 14px;
    }

    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, var(--border-light), transparent);
      margin-left: 8px;
    }

    /* ========================================
       Form Elements
       ======================================== */
    .form-group {
      margin-bottom: 8px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 9px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 3px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 6px 8px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-family: inherit;
      background: var(--card-bg);
      color: var(--text);
      transition: var(--transition);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(15, 37, 55, 0.1);
      transform: translateY(-1px);
    }

    .form-input::placeholder,
    .form-textarea::placeholder {
      color: var(--text-secondary);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
      max-height: 200px;
    }

    /* ========================================
       Status Buttons
       ======================================== */
    .status-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    /* ========================================
       Date Grid
       ======================================== */
    .date-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    /* ========================================
       Buttons
       ======================================== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
      opacity: 0;
      transition: var(--transition);
    }

    .btn:hover::before {
      opacity: 1;
    }

    .btn-primary {
      width: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      box-shadow: 0 4px 12px rgba(15, 37, 55, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(15, 37, 55, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-warning {
      width: 100%;
      background: linear-gradient(135deg, var(--warning) 0%, var(--warning-light) 100%);
      color: var(--text);
      box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
    }

    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
    }

    /* ========================================
       Stats Grid
       ======================================== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-dark) 100%);
      padding: 14px 10px;
      border-radius: var(--radius-sm);
      text-align: center;
      border: 1px solid var(--border-light);
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .stat-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--primary);
      line-height: 1.2;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ========================================
       Quick Links
       ======================================== */
    .quick-links {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .quick-link {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 12px 8px;
      background: var(--card-bg);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
      font-family: inherit;
      color: var(--text);
      text-decoration: none;
      cursor: pointer;
      transition: var(--transition);
    }

    .quick-link:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.05) 0%, transparent 100%);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    /* ========================================
       Suggestions / Autocomplete
       ======================================== */
    .suggestions-container {
      position: relative;
    }

    .suggestions {
      position: absolute;
      top: calc(100% - 2px);
      left: 0;
      right: 0;
      background: var(--card-bg);
      border: 2px solid var(--primary);
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      max-height: 180px;
      overflow-y: auto;
      display: none;
      z-index: 1000001;
      box-shadow: var(--shadow-lg);
      border-top: none;
    }

    .suggestions.active {
      display: block;
      animation: slideDown 0.2s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .suggestion-item {
      padding: 12px 14px;
      font-size: 14px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-light);
      transition: var(--transition);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item:hover,
    .suggestion-item.highlighted {
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.08) 0%, transparent 100%);
      color: var(--primary);
    }

    /* ========================================
       Last Touch Card
       ======================================== */
    .last-touch-card {
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-dark) 100%);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      padding: 14px;
      margin-top: 12px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .last-touch-card.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .last-touch-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .last-touch-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 13px;
    }

    .last-touch-item {
      background: var(--card-bg);
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border-light);
    }

    .last-touch-label {
      display: block;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 4px;
    }

    .last-touch-value {
      font-weight: 700;
      color: var(--text);
      word-break: break-word;
    }

    .days-since {
      font-weight: 800;
      color: var(--warning);
    }

    .days-since.low {
      color: var(--success);
    }

    .days-since.high {
      color: var(--danger);
    }

    /* ========================================
       Account Form
       ======================================== */
    .account-form {
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.08) 0%, rgba(46, 204, 113, 0.05) 100%);
      border: 2px solid var(--success);
      border-radius: var(--radius-sm);
      padding: 14px;
      margin-top: 12px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .account-form.active {
      display: block;
    }

    .account-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 700;
      color: var(--success);
      margin-bottom: 12px;
    }

    /* ========================================
       Voice Section
       ======================================== */
    .voice-section {
      margin-top: 12px;
    }

    .voice-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      font-family: inherit;
      transition: var(--transition);
      box-shadow: 0 4px 12px rgba(15, 37, 55, 0.3);
    }

    .voice-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(15, 37, 55, 0.4);
    }

    .voice-btn.recording {
      background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
      animation: pulse 1.2s ease-in-out infinite;
      box-shadow: 0 4px 12px rgba(192, 57, 43, 0.3);
    }

    .voice-btn.recording:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 20px rgba(192, 57, 43, 0.4);
    }

    @keyframes pulse {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.4);
      }

      50% {
        box-shadow: 0 0 0 12px rgba(192, 57, 43, 0);
      }
    }

    .voice-preview {
      background: var(--bg);
      border: 2px dashed var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 8px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      transition: var(--transition);
    }

    .voice-preview.has-content {
      border-style: solid;
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.05) 0%, transparent 100%);
      color: var(--text);
    }

    /* ========================================
       Shortcut Hint
       ======================================== */
    .shortcut-hint {
      font-size: 11px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 12px;
      font-style: italic;
      opacity: 0.8;
    }

    /* ========================================
       Toast Notifications
       ======================================== */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--primary);
      color: var(--text-light);
      padding: 14px 24px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 600;
      display: none;
      z-index: 1000002;
      box-shadow: var(--shadow-lg);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .toast.show {
      display: block;
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.warning {
      background: var(--warning);
      color: var(--text);
    }

    /* ========================================
       Loading Overlay
       ======================================== */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .loading-overlay.active {
      display: flex;
      opacity: 1;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ========================================
       Prospect Status Indicator
       ======================================== */
    .prospect-status-indicator {
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-dark) 100%);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      margin-bottom: 12px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .status-icon {
      font-size: 18px;
      margin-bottom: 6px;
    }

    .status-message {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .prospect-status-indicator.existing {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.08) 0%, transparent 100%);
    }

    .prospect-status-indicator.new {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.08) 0%, transparent 100%);
    }

    .prospect-status-indicator.existing .status-icon {
      color: var(--success);
    }

    .prospect-status-indicator.new .status-icon {
      color: var(--primary);
    }

    /* ========================================
       Workflow Display
       ======================================== */
    .workflow-display {
      background: linear-gradient(135deg, var(--bg) 0%, var(--bg-dark) 100%);
      border: 2px solid var(--primary);
      border-radius: var(--radius-sm);
      padding: 14px;
      margin-top: 12px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .workflow-display.urgent {
      border-color: var(--danger);
      background: linear-gradient(135deg, rgba(192, 57, 43, 0.08) 0%, rgba(192, 57, 43, 0.05) 100%);
    }

    .workflow-display.high {
      border-color: var(--warning);
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.08) 0%, rgba(243, 156, 18, 0.05) 100%);
    }

    .workflow-display.medium {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.08) 0%, rgba(15, 37, 55, 0.05) 100%);
    }

    .workflow-display.low {
      border-color: var(--text-secondary);
      background: linear-gradient(135deg, rgba(142, 142, 147, 0.08) 0%, rgba(142, 142, 147, 0.05) 100%);
    }

    .workflow-status {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .workflow-item {
      background: var(--card-bg);
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid var(--border-light);
      text-align: center;
    }

    .workflow-label {
      display: block;
      font-size: 9px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .workflow-value {
      font-size: 12px;
      font-weight: 700;
      color: var(--text);
    }

    .workflow-value.success {
      color: var(--success);
    }

    .workflow-value.warning {
      color: var(--warning);
    }

    .workflow-value.info {
      color: var(--primary);
    }

    .workflow-value.danger {
      color: var(--danger);
    }

    /* ========================================
       Outcome Buttons
       ======================================== */
    .outcome-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 4px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--card-bg);
      cursor: pointer;
      font-size: 11px;
      font-weight: 700;
      font-family: inherit;
      color: var(--text-secondary);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      text-align: center;
      min-height: 48px;
    }

    .outcome-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
      opacity: 0;
      transition: var(--transition);
    }

    .outcome-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .outcome-btn:hover::before {
      opacity: 1;
    }

    .outcome-btn.active {
      border-color: var(--primary);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      box-shadow: 0 4px 12px rgba(15, 37, 55, 0.3);
      transform: translateY(-2px);
    }

    .outcome-btn.active::before {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
      opacity: 1;
    }

    .outcome-btn-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    /* ========================================
       Quick Date Options
       ======================================== */
    .quick-date-options {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .quick-date-btn {
      flex: 1;
      min-width: 70px;
      padding: 8px 6px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 600;
      font-family: inherit;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
    }

    .quick-date-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.05) 0%, transparent 100%);
    }

    /* ========================================
       Report Output
       ======================================== */
    .copy-report-btn {
      padding: 6px 12px;
      background: var(--success);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .copy-report-btn:hover {
      background: var(--success-light);
    }

    .report-textarea {
      width: 100%;
      min-height: 150px;
      max-height: 300px;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
      font-size: 11px;
      line-height: 1.5;
      background: var(--bg);
      color: var(--text);
      resize: vertical;
    }

    .report-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* ========================================
       Control Center - Tabbed Utilities
       ======================================== */
    .control-center-content {
      display: block;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .control-center-content.collapsed {
      max-height: 0;
      overflow: hidden;
    }

    .control-center-tabs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      margin-bottom: 12px;
    }

    .control-tab {
      padding: 8px 4px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 600;
      font-family: inherit;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
    }

    .control-tab:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: linear-gradient(135deg, rgba(15, 37, 55, 0.05) 0%, transparent 100%);
    }

    .control-tab.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(15, 37, 55, 0.2);
      transform: translateY(-1px);
    }

    .control-tool {
      display: none;
      animation: fadeIn 0.2s ease;
    }

    .control-tool.active {
      display: block;
    }

    /* ========================================
       Responsive Design
       ======================================== */
    @media (max-width: 768px) {
      .sidebar-container {
        width: 100% !important;
        min-width: 100% !important;
        max-width: 100% !important;
        height: 100vh;
        border-radius: 0;
      }

      .resize-handle {
        display: none;
      }

      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
      }

      .stat-card {
        padding: 10px 6px;
      }

      .stat-value {
        font-size: 20px;
      }

      .control-center-tabs {
        grid-template-columns: repeat(2, 1fr);
      }

      .control-tab {
        font-size: 9px;
        padding: 6px 4px;
      }
    }
  </style>
</head>

<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
  </div>

  <!-- Floating Sidebar -->
  <div class="sidebar-container" id="sidebar">
    <!-- Resize Handle -->
    <div class="resize-handle" id="resizeHandle"></div>

    <!-- Header -->
    <div class="sidebar-header">
      <div class="header-left">
        <span class="brand-icon">üó∫Ô∏è</span>
        <div class="brand-text">
          <span class="brand-title">K&L CRM</span>
          <span class="brand-subtitle">Field Operations</span>
        </div>
      </div>
      <div class="header-right">
        <div class="time-badge" id="currentTime">--:--</div>
      </div>
    </div>

    <!-- Content -->
    <div class="sidebar-content">
      <!-- Visit Entry Section -->
      <div class="section">
        <div class="visit-header">
          <div class="visit-title">
            <span>üìù</span>
            <span>Log Visit</span>
          </div>
        </div>

        <!-- Outreach ID -->
        <div class="form-group">
          <label for="outreachId" class="form-label">Outreach ID</label>
          <input type="text" id="outreachId" class="form-input"
            placeholder="Leave empty to auto-generate (e.g., LID-00128)">
        </div>

        <!-- Company Search with Autocomplete -->
        <div class="form-group suggestions-container">
          <label for="companyInput" class="form-label">Company <span class="required">*</span></label>
          <input type="text" id="companyInput" list="companyList" class="form-input"
            oninput="handleCompanySearchInput(this.value)" placeholder="Search or type new company..."
            autocomplete="off">
          <datalist id="companyList"></datalist>
          <input type="hidden" id="selectedCompanyId">
        </div>

        <!-- New Company Info Toggle -->
        <div class="form-group">
          <button type="button" class="quick-link" style="width:100%;" onclick="toggleNewCompanyFields()">
            <span id="newCompanyToggleIcon">+</span>
            <span id="newCompanyToggleText">Add New Company Details</span>
          </button>
        </div>

        <!-- New Company Additional Fields -->
        <div id="newCompanyFields" class="new-company-fields" style="display:none;">
          <div class="form-group">
            <label for="newAddress" class="form-label">Address</label>
            <input type="text" id="newAddress" class="form-input" placeholder="Street address">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newCity" class="form-label">City</label>
              <input type="text" id="newCity" class="form-input" placeholder="City" value="Tyler">
            </div>
            <div class="form-group">
              <label for="newState" class="form-label">State</label>
              <input type="text" id="newState" class="form-input" placeholder="State" value="TX">
            </div>
            <div class="form-group">
              <label for="newZip" class="form-label">Zip</label>
              <input type="text" id="newZip" class="form-input" placeholder="Zip Code">
            </div>
          </div>
          <div class="form-group">
            <label for="newIndustry" class="form-label">Industry</label>
            <select id="newIndustry" class="form-select">
              <option value="">Select Industry...</option>
              <option value="Agriculture">Agriculture</option>
              <option value="Appliance">Appliance</option>
              <option value="Automotive">Automotive</option>
              <option value="Business to business">Business to business</option>
              <option value="Construction">Construction</option>
              <option value="Electrical">Electrical</option>
              <option value="Fabrication">Fabrication</option>
              <option value="Fence">Fence</option>
              <option value="Gutter">Gutter</option>
              <option value="HVAC">HVAC</option>
              <option value="Junk Removal">Junk Removal</option>
              <option value="Manufacturing">Manufacturing</option>
              <option value="Metal Fabrication">Metal Fabrication</option>
              <option value="Other">Other</option>
              <option value="Plumbing">Plumbing</option>
              <option value="Retail">Retail</option>
              <option value="Roofing">Roofing</option>
              <option value="Trailer Dealer">Trailer Dealer</option>
              <option value="Warehouses">Warehouses</option>
              <option value="Welding">Welding</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newContact" class="form-label">Contact Name</label>
              <input type="text" id="newContact" class="form-input" placeholder="Contact">
            </div>
            <div class="form-group">
              <label for="newPhone" class="form-label">Phone</label>
              <input type="tel" id="newPhone" class="form-input" placeholder="Phone">
            </div>
          </div>
          <div class="form-group">
            <label for="newEmail" class="form-label">Email</label>
            <input type="email" id="newEmail" class="form-input" placeholder="Email">
          </div>
        </div>

        <!-- Last Touch Card -->
        <div class="last-touch-card" id="lastTouchCard">
          <div class="last-touch-header">
            <span>üìä</span>
            <span>Last Touch</span>
          </div>
          <div class="last-touch-grid">
            <div class="last-touch-item">
              <span class="last-touch-label">Last Contact</span>
              <span class="last-touch-value" id="lastContactDate">--</span>
            </div>
            <div class="last-touch-item">
              <span class="last-touch-label">Days Since</span>
              <span class="last-touch-value days-since" id="daysSince">--</span>
            </div>
            <div class="last-touch-item">
              <span class="last-touch-label">Last Outcome</span>
              <span class="last-touch-value" id="lastOutcome">--</span>
            </div>
            <div class="last-touch-item">
              <span class="last-touch-label">Next Steps</span>
              <span class="last-touch-value" id="nextSteps">--</span>
            </div>
          </div>
        </div>

        <!-- Outcome Selection (UPDATED TO MATCH SETTINGS) -->
        <label class="visit-type-label">Visit Outcome</label>
        <div class="outcome-btn-grid">
          <button type="button" class="outcome-btn" onclick="setOutcome('Account Won', this)">
            <span>üèÜ</span> Account Won
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Interested (Hot)', this)">
            <span>üî•</span> Interested (Hot)
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Interested (Warm)', this)">
            <span>üéØ</span> Interested (Warm)
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Initial Contact', this)">
            <span>üëã</span> Initial Contact
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Follow-Up', this)">
            <span>üîÑ</span> Follow-Up
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('No Answer', this)">
            <span>üìû</span> No Answer
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Not Interested', this)">
            <span>üö´</span> Not Interested
          </button>
          <button type="button" class="outcome-btn" onclick="setOutcome('Disqualified', this)">
            <span>‚ùå</span> Disqualified
          </button>
        </div>

        <!-- Stage & Status Display (Auto-populated based on Outcome) -->
        <div class="workflow-display" id="workflowDisplay" style="display:none;">
          <div class="form-group">
            <label class="visit-type-label">Workflow Status</label>
            <div class="workflow-status">
              <div class="workflow-item">
                <span class="workflow-label">Outcome:</span>
                <span class="workflow-value" id="outcomeValue">--</span>
              </div>
              <div class="workflow-item">
                <span class="workflow-label">Stage:</span>
                <span class="workflow-value" id="stageValue">--</span>
              </div>
              <div class="workflow-item">
                <span class="workflow-label">Status:</span>
                <span class="workflow-value" id="statusValue">--</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Date and Type -->
        <div class="date-grid">
          <div class="form-group">
            <label for="nextDate" class="form-label">Next Action</label>
            <input type="date" id="nextDate" class="form-input">
          </div>
          <div class="form-group">
            <label for="activityType" class="form-label">Type</label>
            <select id="activityType" class="form-select">
              <option value="Visit">Visit</option>
              <option value="Phone">Phone</option>
              <option value="Email">Email</option>
            </select>
          </div>
        </div>

        <!-- Competitor -->
        <div class="form-group">
          <label for="competitor" class="form-label">Current Competitor</label>
          <select id="competitor" class="form-select">
            <option value="None">None / Unknown</option>
            <option value="AIM">AIM</option>
            <option value="Tyler Iron">Tyler Iron</option>
            <option value="Huntwell">Huntwell</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <!-- Notes -->
        <div class="form-group">
          <label for="notes" class="form-label">Notes</label>
          <textarea id="notes" class="form-textarea" rows="3" placeholder="Site details..."></textarea>
        </div>

        <!-- New Account Form (Only shows for WON) -->
        <div class="account-form" id="accountForm">
          <div class="account-title">
            <span>üöÄ</span>
            <span>New Account Details</span>
          </div>
          <div class="form-group">
            <input type="text" id="newContact" class="form-input" placeholder="Contact Name">
          </div>
          <div class="date-grid">
            <input type="text" id="newPhone" class="form-input" placeholder="Phone">
            <input type="text" id="newAddress" class="form-input" placeholder="Address">
          </div>
        </div>

        <!-- Prospect Status Indicator -->
        <div class="prospect-status-indicator" id="prospectStatusIndicator" style="margin-bottom: 12px; display: none;">
          <div class="status-icon" id="prospectStatusIcon">‚è≥</div>
          <div class="status-message" id="prospectStatusMessage">Checking company status...</div>
        </div>

        <!-- Save Button -->
        <button type="button" class="btn btn-primary" onclick="saveEntry()">
          <span>üíæ</span> Save Entry
        </button>

        <!-- Voice Section -->
        <div class="voice-section">
          <button type="button" class="voice-btn" id="voiceBtn" onclick="toggleVoice()">
            <span id="micIcon">üé§</span>
            <span id="micText">Voice Notes</span>
          </button>
          <div class="voice-preview" id="voicePreview">Tap to record...</div>
        </div>

        <!-- Keyboard Shortcuts -->
        <div class="shortcut-hint">Keyboard: Enter=Save ‚Ä¢ /=Search ‚Ä¢ R=Route</div>
      </div>

      <!-- Stats Section -->
      <div class="section">
        <div class="section-header">
          <div class="section-title">
            <span class="section-title-icon">üìä</span>
            Today's Overview
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statWon">0</div>
            <div class="stat-label">Wins</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statHot">0</div>
            <div class="stat-label">Hot</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statVisits">0</div>
            <div class="stat-label">Visits</div>
          </div>
        </div>
      </div>

      <!-- Summary Tiles -->
      <div id="crm-summary" class="crm-summary-grid"></div>

      <!-- Control Center - Collapsible Utility Panel -->
      <div class="section">
        <div class="section-header">
          <div class="section-title">
            <span class="section-title-icon">‚öôÔ∏è</span>
            Control Center
          </div>
          <button type="button" class="quick-link" style="padding: 4px 8px; font-size: 10px;"
            onclick="toggleControlCenter()">
            <span id="controlCenterToggleIcon">‚ñº</span>
          </button>
        </div>

        <div id="controlCenterContent" class="control-center-content">
          <!-- Control Center Tabs -->
          <div class="control-center-tabs">
            <button type="button" class="control-tab active" onclick="showTool('route', this)">
              üó∫Ô∏è Route
            </button>
            <button type="button" class="control-tab" onclick="showTool('quick-actions', this)">
              ‚ö° Quick Actions
            </button>
            <button type="button" class="control-tab" onclick="showTool('csv', this)">
              üìÅ CSV Import
            </button>
            <button type="button" class="control-tab" onclick="showTool('report', this)">
              üìä Reports
            </button>
          </div>

          <!-- Route Planning Tool -->
          <div id="tool-route" class="control-tool active">
            <div class="date-grid">
              <div class="form-group">
                <label for="routeStart" class="form-label">Start</label>
                <input type="date" id="routeStart" class="form-input">
              </div>
              <div class="form-group">
                <label for="routeEnd" class="form-label">End</label>
                <input type="date" id="routeEnd" class="form-input">
              </div>
            </div>
            <button type="button" class="btn btn-warning" onclick="generateRoute()">
              <span>üó∫Ô∏è</span> Generate Route
            </button>
          </div>

          <!-- Quick Actions Tool -->
          <div id="tool-quick-actions" class="control-tool">
            <div class="quick-links">
              <button type="button" class="quick-link" onclick="quickAction('pipeline')">
                <span>üìä</span> Pipeline
              </button>
              <button type="button" class="quick-link" onclick="quickAction('accounts')">
                <span>üè¢</span> Accounts
              </button>
              <button type="button" class="quick-link" onclick="quickAction('calendar')">
                <span>üìÖ</span> Calendar
              </button>
              <button type="button" class="quick-link" onclick="quickAction('reports')">
                <span>üìà</span> Reports
              </button>
            </div>
          </div>

          <!-- CSV Import Tool -->
          <div id="tool-csv" class="control-tool">
            <div class="form-group">
              <label for="csvText" class="form-label">Paste CSV Data</label>
              <textarea id="csvText" class="form-textarea" rows="4"
                placeholder="Paste your CSV data here..."></textarea>
            </div>
            <div class="form-group">
              <label for="importSheet" class="form-label">Target Sheet</label>
              <select id="importSheet" class="form-select">
                <option value="Outreach">Outreach</option>
                <option value="Prospects">Prospects</option>
                <option value="New Accounts">New Accounts</option>
              </select>
            </div>
            <button type="button" class="btn btn-warning" onclick="importCSV()">
              <span>üì•</span> Import CSV
            </button>
          </div>

          <!-- Report Generation Tool -->
          <div id="tool-report" class="control-tool">
            <!-- Quick Date Options -->
            <div class="quick-date-options">
              <button type="button" class="quick-date-btn" onclick="setReportDates('thisWeek')">This Week</button>
              <button type="button" class="quick-date-btn" onclick="setReportDates('thisMonth')">This Month</button>
              <button type="button" class="quick-date-btn" onclick="setReportDates('last7')">Last 7 Days</button>
              <button type="button" class="quick-date-btn" onclick="setReportDates('last30')">Last 30 Days</button>
            </div>

            <div class="date-grid">
              <div class="form-group">
                <label for="reportStart" class="form-label">Start Date</label>
                <input type="date" id="reportStart" class="form-input">
              </div>
              <div class="form-group">
                <label for="reportEnd" class="form-label">End Date</label>
                <input type="date" id="reportEnd" class="form-input">
              </div>
            </div>
            <button type="button" class="btn btn-primary" onclick="generateDateRangeReport()">
              <span>üìä</span> Generate Report
            </button>
          </div>
        </div>
      </div>

      <!-- Report Output Section (hidden until report generated) -->
      <div class="section" id="reportOutputSection" style="display: none;">
        <div class="section-header">
          <div class="section-title">
            <span class="section-title-icon">üìã</span>
            Report Output
          </div>
          <button type="button" class="copy-report-btn" onclick="copyReportToClipboard()">
            üìã Copy
          </button>
        </div>
        <textarea id="reportOutput" class="report-textarea" readonly></textarea>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <script>
    // ========================================
    // Non-Blocking UI Logic
    // ========================================

    const state = {
      selectedStatus: '',
      isRecording: false,
      recognition: null,
      searchTimeout: null,
      selectedCompanyData: null
    };

    document.addEventListener('DOMContentLoaded', () => {
      detectDisplayContext();
      initializeDates();
      initializeResize();
      initializeEventListeners();
      updateTime();
      setInterval(updateTime, 60000);

      // Initialize control center tabs
      showTool('route');

      // Staggered loading to prevent server-side queuing bottlenecks
      setTimeout(loadStats, 100);
      setTimeout(loadValidationLists, 500);

      // Load company list for autocomplete
      loadCompanyAutocompleteList();
    });

    function initializeDates() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('nextDate').value = today;
      document.getElementById('routeStart').value = today;
      document.getElementById('routeEnd').value = today;
    }

    function initializeEventListeners() {
      // Close suggestions on outside click
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#companyInput') && !e.target.closest('.suggestions')) {
          document.getElementById('suggestions').classList.remove('active');
        }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', handleKeyboardShortcuts);
    }

    // ========================================
    // Company Autocomplete Logic
    // ========================================
    function loadCompanyAutocompleteList() {
      google.script.run
        .withSuccessHandler(function (companies) {
          const list = document.getElementById('companyList');
          if (companies && companies.length > 0) {
            companies.forEach(c => {
              const option = document.createElement('option');
              option.value = c.name || c.companyName || '';
              option.dataset.id = c.id || c.companyId || '';
              list.appendChild(option);
            });
            console.log('Loaded ' + companies.length + ' companies for autocomplete');
          }
        })
        .withFailureHandler(function (error) {
          console.warn('Failed to load company autocomplete list:', error);
        })
        .getCompanyAutocompleteList();
    }

    function handleCompanySearchInput(value) {
      clearTimeout(state.searchTimeout);

      if (value.length < 2) {
        document.getElementById('selectedCompanyId').value = '';
        document.getElementById('lastTouchCard').classList.remove('active');
        document.getElementById('prospectStatusIndicator').classList.remove('active');
        return;
      }

      // Check if value matches a datalist option
      const options = document.querySelectorAll('#companyList option');
      let matchedCompanyId = '';

      for (let opt of options) {
        if (opt.value === value) {
          matchedCompanyId = opt.dataset.id;
          break;
        }
      }

      if (matchedCompanyId) {
        document.getElementById('selectedCompanyId').value = matchedCompanyId;
        // Fetch and autofill prospect data
        google.script.run
          .withSuccessHandler(fillProspectData)
          .withFailureHandler(function (error) {
            console.warn('Failed to get prospect details:', error);
          })
          .getProspectDetails(matchedCompanyId);

        // Load last touch info
        loadLastTouchInfo(value);
        checkProspectStatus(value);
      } else {
        // New company - clear stored ID
        document.getElementById('selectedCompanyId').value = '';
      }
    }

    function fillProspectData(details) {
      if (details) {
        // Show the new company fields section
        const newCompanyFields = document.getElementById('newCompanyFields');
        const toggleIcon = document.getElementById('newCompanyToggleIcon');
        const toggleText = document.getElementById('newCompanyToggleText');

        if (newCompanyFields.style.display === 'none') {
          newCompanyFields.style.display = 'block';
          toggleIcon.textContent = '-';
          toggleText.textContent = 'Hide New Company Details';
        }

        // Autofill available fields
        if (details.address) {
          const field = document.getElementById('newAddress');
          if (field) field.value = details.address;
        }
        if (details.industry) {
          const field = document.getElementById('newIndustry');
          if (field) field.value = details.industry;
        }
        if (details.contactName) {
          const field = document.getElementById('newContact');
          if (field) field.value = details.contactName;
        }
        if (details.phone) {
          const field = document.getElementById('newPhone');
          if (field) field.value = details.phone;
        }
        if (details.email) {
          const field = document.getElementById('newEmail');
          if (field) field.value = details.email;
        }

        console.log('Autofilled prospect data:', details);
      }
    }

    // ========================================
    // Sidebar Resize & Drag Functionality
    // ========================================
    function initializeResize() {
      const sidebar = document.getElementById('sidebar');
      const handle = document.getElementById('resizeHandle');
      const header = document.querySelector('.sidebar-header');
      let isResizing = false;
      let isDragging = false;
      let startX, startY, startWidth, startLeft, startTop;

      // Resize functionality
      handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startWidth = sidebar.offsetWidth;
        sidebar.classList.add('resizing');
        handle.classList.add('active');
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
      });

      document.addEventListener('mousemove', (e) => {
        if (isResizing) {
          const diff = e.clientX - startX;
          const minWidth = 280;
          const maxWidth = 600;
          const newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth + diff));
          sidebar.style.width = newWidth + 'px';
        } else if (isDragging) {
          const diffX = e.clientX - startX;
          const diffY = e.clientY - startY;
          sidebar.style.left = (startLeft + diffX) + 'px';
          sidebar.style.top = (startTop + diffY) + 'px';
          sidebar.style.right = 'auto';
        }
      });

      document.addEventListener('mouseup', () => {
        if (isResizing || isDragging) {
          isResizing = false;
          isDragging = false;
          sidebar.classList.remove('resizing');
          handle.classList.remove('active');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });

      // Drag functionality (from header)
      header.addEventListener('mousedown', (e) => {
        // Only start drag if not clicking on header buttons
        if (e.target.closest('.header-right')) return;

        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        startLeft = sidebar.offsetLeft;
        startTop = sidebar.offsetTop;
        sidebar.classList.add('floating');
        document.body.style.cursor = 'move';
        document.body.style.userSelect = 'none';
      });

      // Touch support for resize
      handle.addEventListener('touchstart', (e) => {
        isResizing = true;
        startX = e.touches[0].clientX;
        startWidth = sidebar.offsetWidth;
        sidebar.classList.add('resizing');
      });

      document.addEventListener('touchmove', (e) => {
        if (isResizing) {
          e.preventDefault();
          const diff = e.touches[0].clientX - startX;
          const newWidth = Math.max(280, Math.min(600, startWidth + diff));
          sidebar.style.width = newWidth + 'px';
        }
      });

      document.addEventListener('touchend', () => {
        if (isResizing) {
          isResizing = false;
          sidebar.classList.remove('resizing');
        }
      });
    }

    // ========================================
    // Time Display
    // ========================================
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').innerText =
        now.toLocaleDateString('en-US', { weekday: 'short' }) + ' ' +
        now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    // ========================================
    // Keyboard Shortcuts
    // ========================================
    function handleKeyboardShortcuts(e) {
      // Ignore if typing in form fields
      if (e.target.matches('input, textarea, select')) {
        // Allow Enter to submit if in input and Shift not pressed
        if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey) {
          const tagName = e.target.tagName.toLowerCase();
          if (tagName !== 'textarea') {
            e.preventDefault();
            saveEntry();
          }
        }
        return;
      }

      switch (e.key) {
        case 'Enter':
          e.preventDefault();
          saveEntry();
          break;
        case '/':
          e.preventDefault();
          document.getElementById('companyInput').focus();
          break;
        case 'r':
        case 'R':
          generateRoute();
          break;
      }
    }

    // ========================================
    // Workflow-Based Status Selection
    // ========================================

    // Standardized workflow mapping based on user's unified approach
    const workflowMap = {
      'Account Won': {
        stage: 'Won',
        status: 'Active',
        priority: 'urgent',
        days: 1
      },
      'Interested (Hot)': {
        stage: 'Nurture',
        status: 'Interested (Hot)',
        priority: 'high',
        days: 7
      },
      'Interested (Warm)': {
        stage: 'Nurture',
        status: 'Interested (Warm)',
        priority: 'medium',
        days: 14
      },
      'Initial Contact': {
        stage: 'Outreach',
        status: 'Interested (Warm)',
        priority: 'medium',
        days: 30
      },
      'Follow-Up': {
        stage: 'Nurture',
        status: 'Interested (Warm)',
        priority: 'medium',
        days: 14
      },
      'No Answer': {
        stage: 'Outreach',
        status: 'Cold',
        priority: 'high',
        days: 3
      },
      'Not Interested': {
        stage: 'Lost',
        status: 'Disqualified',
        priority: 'low',
        days: 180
      },
      'Disqualified': {
        stage: 'Lost',
        status: 'Disqualified',
        priority: 'low',
        days: 0
      }
    };

    // Set outcome and auto-populate workflow
    function setOutcome(outcome, btn) {
      // Clear previous selections
      document.querySelectorAll('.outcome-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Get workflow details for this outcome
      const workflow = workflowMap[outcome];
      if (workflow) {
        // Update state with full workflow status
        state.selectedOutcome = outcome;
        state.selectedStage = workflow.stage;
        state.selectedStatus = workflow.status;

        // Update display
        document.getElementById('outcomeValue').textContent = outcome;
        document.getElementById('stageValue').textContent = workflow.stage;
        document.getElementById('statusValue').textContent = workflow.status;

        // Show workflow display
        document.getElementById('workflowDisplay').style.display = 'block';

        // Show account form for won accounts
        document.getElementById('accountForm').classList.toggle('active', outcome === 'Account Won');

        // Auto-set next date
        const nextDate = new Date();
        nextDate.setDate(nextDate.getDate() + workflow.days);
        document.getElementById('nextDate').value = nextDate.toISOString().split('T')[0];

        // Visual feedback based on priority
        updateWorkflowStyling(workflow.priority);
      }
    }

    // Update workflow display styling based on priority
    function updateWorkflowStyling(priority) {
      const display = document.getElementById('workflowDisplay');
      display.className = 'workflow-display';

      // Remove previous priority classes
      display.classList.remove('urgent', 'high', 'medium', 'low');

      // Add new priority class
      display.classList.add(priority);

      // Update status value styling
      const statusEl = document.getElementById('statusValue');
      statusEl.className = 'workflow-value';

      const statusColors = {
        'Won': 'success',
        'Interested (Hot)': 'warning',
        'Interested (Warm)': 'info',
        'Disqualified': 'danger',
        'Cold': 'danger',
        'Active': 'success',
        'Lost': 'danger',
        'Nurture': 'info',
        'Outreach': 'warning',
        'Prospect': 'info'
      };

      const status = state.selectedStatus;
      if (statusColors[status]) {
        statusEl.classList.add(statusColors[status]);
      }
    }

    // ========================================
    // Company Search
    // ========================================
    function searchCompany(input) {
      console.log('searchCompany called with input:', input.value);
      clearTimeout(state.searchTimeout);

      if (input.value.length < 2) {
        console.log('Input too short, hiding suggestions');
        document.getElementById('suggestions').classList.remove('active');
        document.getElementById('lastTouchCard').classList.remove('active');
        document.getElementById('prospectStatusIndicator').classList.remove('active');
        return;
      }

      console.log('Setting timeout for search');
      state.searchTimeout = setTimeout(() => {
        console.log('Calling apiSearchProspects with:', input.value);
        google.script.run
          .withSuccessHandler(handleSearchResults)
          .withFailureHandler(error => handleApiError(error, 'Search failed'))
          .apiSearchProspects(input.value);
      }, 300);
    }

    function handleSearchResults(result) {
      console.log('handleSearchResults called with:', result);
      let companies = [];

      if (result && typeof result === 'object') {
        if (Array.isArray(result)) {
          companies = result;
          console.log('Direct array result:', companies.length, 'companies');
        } else if (result.success && result.data) {
          companies = result.data;
          console.log('Object result with data:', companies.length, 'companies');
        } else if (result.success === false) {
          console.log('Search failed with error:', result.error);
          showToast('‚ùå ' + (result.error || 'Search failed'), 'error');
          return;
        } else {
          console.log('Unexpected result format:', result);
        }
      } else {
        console.log('Invalid result:', result);
      }

      console.log('Final companies array:', companies);
      if (companies.length > 0) {
        console.log('Calling showSuggestions with', companies.length, 'companies');
        showSuggestions(companies);
      } else {
        console.log('No companies found, hiding suggestions');
        // No results found - still hide dropdown
        document.getElementById('suggestions').classList.remove('active');
      }
    }

    // ========================================
    // Toast & Loading Helpers
    // ========================================
    function handleApiError(error, defaultMsg) {
      showLoading(false);
      showToast('‚ùå ' + (error.message || defaultMsg), 'error');
    }

    function showSuggestions(results) {
      console.log('showSuggestions called with:', results);
      const dropdown = document.getElementById('suggestions');
      console.log('Dropdown element:', dropdown);

      if (results && results.length > 0) {
        console.log('Generating HTML for', results.length, 'results');
        // Use data attributes with escaped values for safety
        dropdown.innerHTML = results.map((r, index) => {
          const escapedName = HtmlSafeRenderer.escapeHtml(r.companyName || r.company);
          const companyId = r.companyId || '';
          const address = HtmlSafeRenderer.escapeHtml(r.address || '');
          const phone = HtmlSafeRenderer.escapeHtml(r.phone || '');
          const email = HtmlSafeRenderer.escapeHtml(r.email || '');
          const contactName = HtmlSafeRenderer.escapeHtml(r.contactName || '');
          return '<div class="suggestion-item" data-index="' + index + '" data-name="' + escapedName + '" data-id="' + companyId + '" data-address="' + address + '" data-phone="' + phone + '" data-email="' + email + '" data-contact="' + contactName + '">' + escapedName + '</div>';
        }).join('');

        console.log('HTML set, adding click listeners');
        // Add click listeners to suggestion items
        dropdown.querySelectorAll('.suggestion-item').forEach(item => {
          item.onclick = function () {
            console.log('Suggestion clicked:', this.dataset.name);
            const companyData = {
              companyName: this.dataset.name,
              companyId: this.dataset.id,
              address: this.dataset.address,
              phone: this.dataset.phone,
              email: this.dataset.email,
              contactName: this.dataset.contact
            };
            selectCompany(companyData);
          };
        });

        console.log('Adding active class to dropdown');
        dropdown.classList.add('active');
      } else {
        console.log('No results, removing active class');
        dropdown.classList.remove('active');
      }
    }

    function selectCompany(companyData) {
      // Handle both object and string input for backwards compatibility
      if (typeof companyData === 'string') {
        // Legacy: received just company name string
        document.getElementById('companyInput').value = companyData;
        document.getElementById('suggestions').classList.remove('active');
        loadLastTouchInfo(companyData);
        checkProspectStatus(companyData);
        return;
      }

      // New: receive company object with companyId - get comprehensive data for autofill
      const companyId = companyData.companyId;
      const companyName = companyData.companyName || companyData.company || '';

      document.getElementById('companyInput').value = companyName;
      document.getElementById('suggestions').classList.remove('active');

      // Visual feedback
      const input = document.getElementById('companyInput');
      input.style.borderColor = 'var(--success)';
      setTimeout(() => input.style.borderColor = 'var(--border)', 500);

      // Get comprehensive company details for autofill
      if (companyId) {
        showLoading(true);
        google.script.run
          .withSuccessHandler(function (result) {
            showLoading(false);
            if (result && result.success && result.data) {
              // Store comprehensive company data
              state.selectedCompanyData = result.data;
              // Autofill form with comprehensive data
              autofillCompanyData(result.data);
            } else {
              // Fallback to basic data if API call fails
              state.selectedCompanyData = companyData;
              autofillCompanyData(companyData);
            }
          })
          .withFailureHandler(function (error) {
            showLoading(false);
            console.warn('Failed to get comprehensive company details:', error);
            // Fallback to basic data
            state.selectedCompanyData = companyData;
            autofillCompanyData(companyData);
          })
          .getCompanyDetailsForAutofill(companyId);
      } else {
        // No companyId available, use basic data
        state.selectedCompanyData = companyData;
        autofillCompanyData(companyData);
      }

      // Load last touch information
      loadLastTouchInfo(companyName);

      // Check prospect status
      checkProspectStatus(companyName);
    }

    function autofillCompanyData(companyData) {
      console.log('üîç autofillCompanyData called with:', companyData);

      // Only autofill if we have a companyId (meaning it came from prospect sheet)
      if (!companyData.companyId) {
        console.log('‚ùå Skipping autofill - no companyId (company not found in prospect sheet)');
        console.log('Available data:', {
          companyName: companyData.companyName,
          companyId: companyData.companyId,
          hasContact: !!companyData.contactName,
          hasPhone: !!companyData.phone,
          hasAddress: !!companyData.address,
          hasEmail: !!companyData.email
        });
        showToast('‚ö†Ô∏è Company not found in prospects - manual entry required', 'warning');
        return;
      }

      console.log('‚úÖ Autofilling company data for:', companyData.companyName);
      console.log('Data to fill:', {
        contactName: companyData.contactName,
        phone: companyData.phone,
        address: companyData.address,
        email: companyData.email
      });

      // Show the "Add New Company Details" section so user can see the autofilled data
      const newCompanyFields = document.getElementById('newCompanyFields');
      const toggleIcon = document.getElementById('newCompanyToggleIcon');
      const toggleText = document.getElementById('newCompanyToggleText');

      if (newCompanyFields.style.display === 'none') {
        console.log('üìÇ Expanding new company details section');
        newCompanyFields.style.display = 'block';
        toggleIcon.textContent = '-';
        toggleText.textContent = 'Hide New Company Details';
      }

      let filledCount = 0;
      const autofillResults = [];

      // Autofill the expanded new company fields with existing company data
      // Contact Name
      if (companyData.contactName && companyData.contactName.trim()) {
        const contactField = document.getElementById('newContact');
        if (contactField) {
          contactField.value = companyData.contactName.trim();
          autofillResults.push('Contact Name');
          filledCount++;
          console.log('‚úÖ Autofilled contact name:', companyData.contactName);
        } else {
          console.log('‚ùå Contact field not found');
        }
      }

      // Phone
      if (companyData.phone && companyData.phone.trim()) {
        const phoneField = document.getElementById('newPhone');
        if (phoneField) {
          phoneField.value = companyData.phone.trim();
          autofillResults.push('Phone');
          filledCount++;
          console.log('‚úÖ Autofilled phone:', companyData.phone);
        } else {
          console.log('‚ùå Phone field not found');
        }
      }

      // Address
      if (companyData.address && companyData.address.trim()) {
        const addressField = document.getElementById('newAddress');
        if (addressField) {
          addressField.value = companyData.address.trim();
          autofillResults.push('Address');
          filledCount++;
          console.log('‚úÖ Autofilled address:', companyData.address);
        } else {
          console.log('‚ùå Address field not found');
        }
      }

      // Email
      if (companyData.email && companyData.email.trim()) {
        const emailField = document.getElementById('newEmail');
        if (emailField) {
          emailField.value = companyData.email.trim();
          autofillResults.push('Email');
          filledCount++;
          console.log('‚úÖ Autofilled email:', companyData.email);
        } else {
          console.log('‚ùå Email field not found');
        }
      }

      // Industry (if available)
      if (companyData.industry && companyData.industry.trim()) {
        const industryField = document.getElementById('newIndustry');
        if (industryField) {
          industryField.value = companyData.industry.trim();
          autofillResults.push('Industry');
          filledCount++;
          console.log('‚úÖ Autofilled industry:', companyData.industry);
        } else {
          console.log('‚ùå Industry field not found');
        }
      }

      // City (if available)
      if (companyData.city && companyData.city.trim()) {
        const cityField = document.getElementById('newCity');
        if (cityField) {
          cityField.value = companyData.city.trim();
          autofillResults.push('City');
          filledCount++;
          console.log('‚úÖ Autofilled city:', companyData.city);
        } else {
          console.log('‚ùå City field not found');
        }
      }

      // State (if available)
      if (companyData.state && companyData.state.trim()) {
        const stateField = document.getElementById('newState');
        if (stateField) {
          stateField.value = companyData.state.trim();
          autofillResults.push('State');
          filledCount++;
          console.log('‚úÖ Autofilled state:', companyData.state);
        } else {
          console.log('‚ùå State field not found');
        }
      }

      // Zip Code (if available)
      if (companyData.zip && companyData.zip.trim()) {
        const zipField = document.getElementById('newZip');
        if (zipField) {
          zipField.value = companyData.zip.trim();
          autofillResults.push('Zip Code');
          filledCount++;
          console.log('‚úÖ Autofilled zip code:', companyData.zip);
        } else {
          console.log('‚ùå Zip field not found');
        }
      }

      console.log(`üìä Filled ${filledCount} fields:`, autofillResults);

      // Show success feedback with detailed information
      if (filledCount > 0) {
        const fieldList = autofillResults.join(', ');
        showToast(`‚úÖ Company data loaded from prospects (${filledCount} fields: ${fieldList})`, 'success');
      } else {
        showToast('‚ö†Ô∏è Company found but no additional data available', 'warning');
      }

      // Ensure consistent company naming by using the exact name from prospect sheet
      if (companyData.companyName && companyData.companyName.trim()) {
        document.getElementById('companyInput').value = companyData.companyName.trim();
      }

      // Highlight the autofilled fields temporarily
      if (filledCount > 0) {
        autofillResults.forEach(function (fieldName) {
          const fieldId = fieldName.toLowerCase().replace(' ', '');
          const field = document.getElementById('new' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1));
          if (field) {
            const originalBackground = field.style.backgroundColor;
            field.style.backgroundColor = 'rgba(39, 174, 96, 0.1)';
            field.style.borderColor = 'var(--success)';
            field.style.boxShadow = '0 0 0 3px rgba(39, 174, 96, 0.1)';

            // Remove highlight after 2 seconds
            setTimeout(() => {
              field.style.backgroundColor = originalBackground;
              field.style.borderColor = 'var(--border)';
              field.style.boxShadow = 'none';
            }, 2000);
          }
        });
      }
    }

    // ========================================
    // Last Touch Info
    // ========================================
    function loadLastTouchInfo(companyName) {
      google.script.run
        .withSuccessHandler(displayLastTouchInfo)
        .withFailureHandler((error) => handleApiError(error, 'Last touch info failed'))
        .getLastTouchInfo(companyName);
    }

    function displayLastTouchInfo(result) {
      const card = document.getElementById('lastTouchCard');

      if (result && result.success && result.data) {
        const data = result.data;

        document.getElementById('lastContactDate').innerText = data.lastContact || '--';
        document.getElementById('daysSince').innerText = (data.daysSince || 0) + ' days';
        document.getElementById('lastOutcome').innerText = data.lastOutcome || '--';
        document.getElementById('nextSteps').innerText = data.nextSteps || '--';

        // Color coding based on days since
        const daysEl = document.getElementById('daysSince');
        daysEl.className = 'last-touch-value days-since';

        if (data.daysSince <= 7) {
          daysEl.classList.add('low');
        } else if (data.daysSince > 30) {
          daysEl.classList.add('high');
        }

        card.classList.add('active');
      } else {
        card.classList.remove('active');
      }
    }

    // ========================================
    // Prospect Status Checking
    // ========================================
    function checkProspectStatus(companyName) {
      if (!companyName || companyName.length < 2) {
        document.getElementById('prospectStatusIndicator').classList.remove('active');
        return;
      }

      // Show loading state
      const statusIndicator = document.getElementById('prospectStatusIndicator');
      const statusIcon = document.getElementById('prospectStatusIcon');
      const statusMessage = document.getElementById('prospectStatusMessage');

      statusIcon.textContent = '‚è≥';
      statusMessage.textContent = 'Checking company status...';
      statusIndicator.classList.remove('existing', 'new');
      statusIndicator.classList.add('active');

      google.script.run
        .withSuccessHandler(handleProspectStatusResult)
        .withFailureHandler(handleProspectStatusError)
        .checkProspectStatus(companyName);
    }

    function handleProspectStatusResult(result) {
      const statusIndicator = document.getElementById('prospectStatusIndicator');
      const statusIcon = document.getElementById('prospectStatusIcon');
      const statusMessage = document.getElementById('prospectStatusMessage');

      if (result && result.success) {
        if (result.exists) {
          // Company exists in prospects
          statusIndicator.classList.remove('new');
          statusIndicator.classList.add('existing');
          statusIcon.textContent = '‚úÖ';
          statusMessage.textContent = 'Existing prospect - ' + (result.status || 'Active');

          // Store company data for later use
          state.selectedCompanyData = {
            companyName: document.getElementById('companyInput').value,
            companyId: result.companyId,
            status: result.status,
            lastOutcome: result.lastOutcome,
            daysSinceLastContact: result.daysSinceLastContact
          };
        } else {
          // Company does not exist in prospects
          statusIndicator.classList.remove('existing');
          statusIndicator.classList.add('new');
          statusIcon.textContent = 'üÜï';
          statusMessage.textContent = 'New prospect - not in database';

          // Clear any stored company data
          state.selectedCompanyData = null;
        }
      } else {
        // Error case
        statusIndicator.classList.remove('existing', 'new');
        statusIcon.textContent = '‚ùå';
        statusMessage.textContent = 'Error checking status: ' + (result.error || 'Unknown error');
      }
    }

    function handleProspectStatusError(error) {
      const statusIndicator = document.getElementById('prospectStatusIndicator');
      const statusIcon = document.getElementById('prospectStatusIcon');
      const statusMessage = document.getElementById('prospectStatusMessage');

      statusIndicator.classList.remove('existing', 'new');
      statusIcon.textContent = '‚ùå';
      statusMessage.textContent = 'Error checking status: ' + (error.message || 'Unknown error');
      console.error('Prospect status check error:', error);
    }

    // ========================================
    // Save Entry with Duplicate LID Check
    // ========================================
    function loadStats() {
      const today = new Date().toISOString().split('T')[0];

      google.script.run
        .withSuccessHandler(res => {
          if (res && res.success && res.data) {
            const accs = res.data;
            document.getElementById('statVisits').innerText = accs.length || 0;
            document.getElementById('statWon').innerText = accs.filter(a => a.Status === 'WON').length || 0;
            document.getElementById('statHot').innerText = accs.filter(a =>
              (a.Status && a.Status.includes('HOT')) || (a.Status && a.Status.includes('STRONG'))
            ).length || 0;
          }
        })
        .withFailureHandler(error => console.error('Failed to load stats:', error))
        .getOutreachData(today, today);
    }

    // ========================================
    // Voice Recording
    // ========================================
    function toggleVoice() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showToast('‚ùå Voice not supported in this browser', 'error');
        return;
      }

      state.isRecording ? stopVoice() : startVoice();
    }

    function startVoice() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      state.recognition = new SpeechRecognition();
      state.recognition.continuous = true;
      state.recognition.interimResults = true;
      state.recognition.lang = 'en-US';

      state.recognition.onstart = () => {
        state.isRecording = true;
        updateVoiceUI(true);
      };

      state.recognition.onresult = (event) => {
        let transcript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          transcript += event.results[i][0].transcript;
        }

        const preview = document.getElementById('voicePreview');
        preview.textContent = transcript || 'Listening...';
        preview.classList.toggle('has-content', transcript.length > 0);
      };

      state.recognition.onend = () => {
        if (state.isRecording) {
          stopVoice();
        }
      };

      state.recognition.onerror = (event) => {
        console.error('Voice recognition error:', event.error);
        showToast('‚ùå Voice error: ' + event.error, 'error');
        stopVoice();
      };

      try {
        state.recognition.start();
      } catch (e) {
        showToast('‚ùå Failed to start voice recognition', 'error');
      }
    }

    function stopVoice() {
      if (state.recognition) {
        state.recognition.stop();
      }

      state.isRecording = false;
      updateVoiceUI(false);

      const text = document.getElementById('voicePreview').textContent;

      if (text && text !== 'Tap to record...' && text !== 'Listening...') {
        document.getElementById('notes').value = text;
        document.getElementById('voicePreview').classList.add('has-content');
      } else {
        document.getElementById('voicePreview').textContent = 'Tap to record...';
        document.getElementById('voicePreview').classList.remove('has-content');
      }
    }

    function updateVoiceUI(recording) {
      const btn = document.getElementById('voiceBtn');
      const icon = document.getElementById('micIcon');
      const text = document.getElementById('micText');

      btn.classList.toggle('recording', recording);
      icon.textContent = recording ? 'üéôÔ∏è' : 'üé§';
      text.textContent = recording ? 'Stop Recording' : 'Voice Notes';
    }

    /**
     * REFACTORED: Route Generation (Tab-Safe)
     */
    function generateRoute() {
      const today = new Date().toISOString().split('T')[0];
      showLoading(true);
      showToast('üöõ Fetching today\'s stops...', 'info');

      google.script.run
        .withSuccessHandler(res => {
          showLoading(false);
          if (res.success && res.data && res.data.length > 0) {
            const companies = res.data.map(e => e.company || e.Company || '').filter(n => n !== '');

            // Open in NEW TAB via Backend to bypass popup blockers
            google.script.run.generateRouteForCompanies(companies);
            showToast('üó∫Ô∏è Route sent to Maps!', 'success');
          } else {
            showToast('‚ö†Ô∏è No stops logged for today.', 'warning');
          }
        })
        .withFailureHandler(e => handleApiError(e, 'Route failed'))
        .getOutreachData(today, today);
    }

    function handleRouteResult(result) {
      showLoading(false);

      if (result.success && result.data) {
        const url = result.data.url;
        const failures = result.data.failures;

        // Open route in new tab
        if (url) {
          window.open(url, '_blank');
        }

        let message = 'üöõ Route generated!';

        if (failures && failures.length > 0) {
          message += ` (${failures.length} not found)`;
        }

        showToast(message, 'success');
      } else {
        showToast('‚ùå Route generation failed', 'error');
      }
    }

    /**
     * REFACTORED: Quick Action Handler (Non-Blocking)
     */
    function quickAction(action) {
      console.log('Action triggered:', action);

      // Turn off loading spinner immediately for UI fluidity
      if (action === 'reports') {
        showToast('üìä Initializing Report...', 'info');
        // Fire and Forget: Do not wait for success handler to finish before allowing interaction
        google.script.run
          .withFailureHandler(e => showToast('‚ùå Report Error: ' + e.message, 'error'))
          .showProfessionalReport();
        return;
      }

      switch (action) {
        case 'pipeline':
          showToast('üöÄ Opening Pipeline...', 'info');
          google.script.run.openSuiteCRM(); // Routes to the new Suite View
          break;
        case 'accounts':
          // Direct link to sheet to avoid modal blocking
          window.open('https://docs.google.com/spreadsheets/d/1veh2zY5h6sVktA7tdH8k85-TwNEEpdgUYYR16J2a3bdWFeLoTcP2TbJq/edit#gid=0', '_blank');
          break;
        case 'calendar':
          showCalendarView();
          break;
        default:
          showToast('‚ö†Ô∏è Feature in development', 'warning');
      }
    }

    // Show pipeline overview - delegates to backend
    function showPipelineView() {
      showLoading(true);
      showToast('üìä Loading pipeline...', 'info');
      
      google.script.run
        .withSuccessHandler(function (result) {
          showLoading(false);
          if (result.success) {
            showToast('‚úÖ Pipeline view opened', 'success');
          } else {
            showToast('‚ùå ' + (result.error || 'Failed to open pipeline'), 'error');
          }
        })
        .withFailureHandler(function (error) {
          showLoading(false);
          showToast('‚ùå Pipeline error: ' + (error.message || 'Unknown error'), 'error');
        })
        .showPipelineModal();
    }

    // Show accounts management view - delegates to backend
    function showAccountsView() {
      showLoading(true);
      showToast('üè¢ Opening accounts...', 'info');
      
      google.script.run
        .withSuccessHandler(function (result) {
          showLoading(false);
          if (result.success) {
            showToast('‚úÖ Accounts view opened', 'success');
          } else {
            showToast('‚ùå ' + (result.error || 'Failed to open accounts'), 'error');
          }
        })
        .withFailureHandler(function (error) {
          showLoading(false);
          showToast('‚ùå Accounts error: ' + (error.message || 'Unknown error'), 'error');
        })
        .showAccountsModal();
    }

    // Show calendar view - delegates to backend
    function showCalendarView() {
      showLoading(true);
      showToast('üìÖ Loading calendar...', 'info');
      
      google.script.run
        .withSuccessHandler(function (result) {
          showLoading(false);
          if (result.success) {
            showToast('‚úÖ Calendar view opened', 'success');
          } else {
            showToast('‚ùå ' + (result.error || 'Failed to open calendar'), 'error');
          }
        })
        .withFailureHandler(function (error) {
          showLoading(false);
          showToast('‚ùå Calendar error: ' + (error.message || 'Unknown error'), 'error');
        })
        .showCalendarModal();
    }

    // ========================================
    // Generate Date Range Report
    // ========================================
    function generateDateRangeReport() {
      const startDate = document.getElementById('reportStart').value;
      const endDate = document.getElementById('reportEnd').value;

      if (!startDate || !endDate) {
        showToast('Please select both start and end dates', 'error');
        return;
      }

      // Show loading immediately
      showLoading(true);

      // Set timeout to prevent infinite freeze
      const timeoutId = setTimeout(() => {
        showLoading(false);
        showToast('Report generation timed out. Try a shorter date range.', 'error');
      }, 30000); // 30 second timeout

      google.script.run
        .withSuccessHandler(function () { showLoading(false); showToast('Report opened', 'success'); })
        .withFailureHandler(function (e) { showLoading(false); handleApiError(e, 'Report generation failed'); })
        .showProfessionalReport(startDate, endDate);
    }

    // ========================================
    // Quick Date Selection
    // ========================================
    function setReportDates(range) {
      const today = new Date();
      let start, end;

      switch (range) {
        case 'thisWeek':
          // Start from Sunday of current week
          start = new Date(today);
          start.setDate(today.getDate() - today.getDay());
          break;
        case 'thisMonth':
          start = new Date(today.getFullYear(), today.getMonth(), 1);
          break;
        case 'last7':
          start = new Date(today);
          start.setDate(today.getDate() - 7);
          break;
        case 'last30':
          start = new Date(today);
          start.setDate(today.getDate() - 30);
          break;
      }

      end = today;

      document.getElementById('reportStart').value = formatDate(start);
      document.getElementById('reportEnd').value = formatDate(end);
    }

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    // ========================================
    // Copy Report to Clipboard
    // ========================================
    function copyReportToClipboard() {
      const textarea = document.getElementById('reportOutput');

      // Try modern API first
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textarea.value)
          .then(() => {
            showToast('üìã Report copied to clipboard!', 'success');
          })
          .catch(err => {
            fallbackCopy(textarea);
          });
      } else {
        fallbackCopy(textarea);
      }
    }

    function fallbackCopy(textarea) {
      textarea.select();
      textarea.setSelectionRange(0, 99999); // For mobile

      try {
        document.execCommand('copy');
        showToast('üìã Report copied to clipboard!', 'success');
      } catch (err) {
        showToast('‚ùå Failed to copy. Please select and copy manually.', 'error');
      }
    }

    // ========================================
    // HTML SAFE RENDERER INTEGRATION
    // ========================================

    /**
     * HtmlSafeRenderer - Prevents XSS vulnerabilities
     * Provides safe DOM manipulation methods
     */
    var HtmlSafeRenderer = (function () {
      // Escape HTML special characters to prevent XSS
      function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        var div = document.createElement('div');
        div.textContent = String(str);
        return div.innerHTML;
      }

      // Escape HTML attributes more restrictively
      function escapeAttribute(str) {
        if (str === null || str === undefined) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/"/g, '"')
          .replace(/'/g, '&#39;')
          .replace(/</g, '<')
          .replace(/>/g, '>');
      }

      // Sanitize HTML by removing dangerous tags and attributes
      function sanitizeHtml(html) {
        if (!html || typeof html !== 'string') return '';
        // Remove script tags and event handlers
        html = html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
        html = html.replace(/\s+on\w+\s*=\s*(['"])[^'"]*\1/gi, '');
        html = html.replace(/href\s*=\s*(['"])\s*javascript:[^'"]*\1/gi, 'href="#"');
        return html;
      }

      // Build safe list item
      function buildListItem(primary, secondary, options) {
        options = options || {};
        var primaryEscaped = escapeHtml(primary || 'Unknown');
        var secondaryEscaped = escapeHtml(secondary || '');
        var style = escapeAttribute(options.style || '');
        return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; ' + style + '">' +
          '<div>' +
          '<div style="font-weight: 600; color: #2c3e50;">' + primaryEscaped + '</div>' +
          (secondary ? '<div style="font-size: 12px; color: #7f8c8d;">' + secondaryEscaped + '</div>' : '') +
          '</div>' +
          '</div>';
      }

      return {
        escapeHtml: escapeHtml,
        escapeAttribute: escapeAttribute,
        sanitizeHtml: sanitizeHtml,
        buildListItem: buildListItem
      };
    })();

    // ========================================
    // Utility Functions
    // ========================================
    function showLoading(show) {
      const loading = document.getElementById('loading');
      loading.classList.toggle('active', show);
    }

    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.innerText = message;
      toast.className = 'toast ' + type;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========================================
    // New Company Fields Toggle
    // ========================================
    function toggleNewCompanyFields() {
      const fields = document.getElementById('newCompanyFields');
      const icon = document.getElementById('newCompanyToggleIcon');
      const text = document.getElementById('newCompanyToggleText');

      if (fields.style.display === 'none') {
        fields.style.display = 'block';
        icon.textContent = '-';
        text.textContent = 'Hide New Company Details';
      } else {
        fields.style.display = 'none';
        icon.textContent = '+';
        text.textContent = 'Add New Company Details';
      }
    }

    // ========================================
    // Control Center Toggle
    // ========================================
    function toggleControlCenter() {
      const content = document.getElementById('controlCenterContent');
      const icon = document.getElementById('controlCenterToggleIcon');

      content.classList.toggle('collapsed');
      icon.textContent = content.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
    }

    // ========================================
    // Control Center Tab Switching
    // ========================================
    function showTool(toolId, clickedTab = null) {
      // Hide all tools
      document.querySelectorAll('.control-tool').forEach(tool => {
        tool.classList.remove('active');
      });

      // Remove active class from all tabs
      document.querySelectorAll('.control-tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Show selected tool
      const selectedTool = document.getElementById('tool-' + toolId);
      if (selectedTool) {
        selectedTool.classList.add('active');
      }

      // Add active class to clicked tab (or find it if called programmatically)
      if (clickedTab) {
        clickedTab.classList.add('active');
      } else {
        // Find the tab by its onclick attribute
        const tab = document.querySelector(`[onclick="showTool('${toolId}')"]`);
        if (tab) {
          tab.classList.add('active');
        }
      }
    }

    // ========================================
    // CSV Import
    // ========================================
    function importCSV() {
      const csvText = document.getElementById('csvText').value.trim();
      const targetSheet = document.getElementById('importSheet').value;

      if (!csvText) {
        showToast('‚ö†Ô∏è Please paste CSV data first', 'warning');
        document.getElementById('csvText').focus();
        return;
      }

      showLoading(true);

      google.script.run
        .withSuccessHandler(handleCSVImportSuccess)
        .withFailureHandler(handleCSVImportError)
        .importCSVData(csvText, targetSheet);
    }

    function handleCSVImportSuccess(result) {
      showLoading(false);

      if (result.success) {
        const importedCount = result.data.importedCount || 0;
        const skippedCount = result.data.skippedCount || 0;

        let message = `‚úÖ Successfully imported ${importedCount} rows to ${result.data.sheetName}`;
        if (skippedCount > 0) {
          message += ` (${skippedCount} skipped due to validation)`;
        }

        showToast(message, 'success');

        // Clear the form
        document.getElementById('csvText').value = '';
      } else {
        showToast('‚ùå ' + (result.error || 'Import failed'), 'error');
      }
    }

    function handleCSVImportError(error) {
      showLoading(false);
      showToast('‚ùå CSV import error: ' + (error.message || error), 'error');
    }



    // ========================================
    // Context Detection (Dialog vs Sidebar)
    // ========================================
    function detectDisplayContext() {
      // Check if we're in a narrow container (sidebar) vs wide (dialog)
      const isSidebar = window.innerWidth < 500 || document.body.clientWidth < 500;

      if (isSidebar) {
        // Sidebar context - ensure proper styling
        document.body.classList.remove('dialog-context');
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
          sidebar.style.position = 'relative';
          sidebar.style.width = '100%';
          sidebar.style.left = 'auto';
          sidebar.style.top = 'auto';
        }
      } else {
        // Dialog context - apply floating styles
        document.body.classList.add('dialog-context');
      }
    }

    // ========================================
    // Load Validation Lists
    // ========================================
    function loadValidationLists() {
      google.script.run
        .withSuccessHandler(function (result) {
          if (result.success && result.data) {
            populateValidationLists(result.data);
          } else {
            console.warn('Failed to load validation lists:', result.error);
          }
        })
        .withFailureHandler(function (error) {
          console.warn('Error loading validation lists:', error);
        })
        .getValidationLists();
    }

    function populateValidationLists(validationLists) {
      // Populate activity types
      const activityTypeSelect = document.getElementById('activityType');
      if (validationLists['Activity Types']) {
        // Clear existing options except the first
        while (activityTypeSelect.options.length > 1) {
          activityTypeSelect.remove(1);
        }
        // Add new options
        validationLists['Activity Types'].values.forEach(function (type) {
          const option = document.createElement('option');
          option.value = type;
          option.textContent = type;
          activityTypeSelect.appendChild(option);
        });
      }

      // Populate competitor dropdown from Settings (dynamic - no hardcoding)
      const competitorSelect = document.getElementById('competitor');
      if (validationLists['Competitors'] && validationLists['Competitors'].values) {
        // Clear existing options except the first ("None / Unknown")
        while (competitorSelect.options.length > 1) {
          competitorSelect.remove(1);
        }
        // Add new options from Settings
        validationLists['Competitors'].values.forEach(function (competitor) {
          const option = document.createElement('option');
          option.value = competitor;
          option.textContent = competitor;
          competitorSelect.appendChild(option);
        });
        console.log('‚úÖ Populated ' + validationLists['Competitors'].values.length + ' competitors from Settings');
      }

      // Populate container sizes for new accounts
      // This would be used when implementing the account form validation

      // Store validation lists for form validation
      state.validationLists = validationLists;

      console.log('Validation lists loaded:', validationLists);
    }

    // ========================================
    // Save Callbacks
    // ========================================
    function handleSaveSuccess(result) {
      showLoading(false);

      if (result && result.success) {
        // Success - show confirmation and reset form
        const company = document.getElementById('companyInput').value.trim();
        showToast('‚úÖ Visit logged for ' + company, 'success');

        // Reset ALL form fields comprehensively
        document.getElementById('companyInput').value = '';
        document.getElementById('notes').value = '';
        document.getElementById('outreachId').value = '';

        // Reset new company fields
        document.getElementById('newAddress').value = '';
        document.getElementById('newPhone').value = '';
        document.getElementById('newContact').value = '';
        document.getElementById('newCity').value = 'Tyler';
        document.getElementById('newState').value = 'TX';
        document.getElementById('newZip').value = '';
        document.getElementById('newEmail').value = '';
        document.getElementById('newCompetitor').value = '';
        document.getElementById('newIndustry').value = '';

        // Reset date fields to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('nextDate').value = today;
        document.getElementById('activityType').value = 'Visit';

        // Reset status selection and UI elements
        state.selectedStatus = '';
        state.selectedOutcome = '';
        state.selectedStage = '';
        document.querySelectorAll('.outcome-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('workflowDisplay').style.display = 'none';

        // Hide informational cards
        document.getElementById('lastTouchCard').classList.remove('active');
        document.getElementById('prospectStatusIndicator').classList.remove('active');
        document.getElementById('accountForm').classList.remove('active');

        // Collapse new company fields section if it was expanded
        const newCompanyFields = document.getElementById('newCompanyFields');
        if (newCompanyFields.style.display !== 'none') {
          newCompanyFields.style.display = 'none';
          document.getElementById('newCompanyToggleIcon').textContent = '+';
          document.getElementById('newCompanyToggleText').textContent = 'Add New Company Details';
        }

        // Clear company data and voice preview
        state.selectedCompanyData = null;
        const voicePreview = document.getElementById('voicePreview');
        voicePreview.textContent = 'Tap to record...';
        voicePreview.classList.remove('has-content');

        // Refresh stats to show updated counts
        loadStats();

        // Focus on company input for quick next entry
        document.getElementById('companyInput').focus();
      } else {
        // Server returned failure
        showToast('‚ùå ' + (result.error || 'Save failed'), 'error');
      }
    }

    function handleSaveError(error) {
      showLoading(false);
      showToast('‚ùå ' + (error.message || error || 'Save failed'), 'error');
      console.error('Save error:', error);
    }

    /**
     * Standard Save Entry (Reliable Pattern)
     */
    function saveEntry() {
      const company = document.getElementById('companyInput').value.trim();
      
      // Enhanced validation per schema requirements
      if (!company) {
        showToast('‚ö†Ô∏è Company name is required', 'warning');
        document.getElementById('companyInput').focus();
        return;
      }
      
      if (!state.selectedOutcome) {
        showToast('‚ö†Ô∏è Please select a visit outcome', 'warning');
        return;
      }
      
      if (!state.selectedStatus) {
        showToast('‚ùå Status could not be determined from outcome', 'error');
        console.error('Workflow mapping failed for outcome:', state.selectedOutcome);
        return;
      }

      showLoading(true);
      const formData = {
        company: company,
        companyName: company,
        outcome: state.selectedOutcome,
        stage: state.selectedStage,
        status: state.selectedStatus,
        notes: document.getElementById('notes').value,
        nextVisitDate: document.getElementById('nextDate').value,
        activityType: document.getElementById('activityType').value,
        outreachId: document.getElementById('outreachId').value.trim()
      };

      google.script.run
        .withSuccessHandler(res => {
          showLoading(false);
          if (res.success) {
            showToast('‚úÖ Logged: ' + company, 'success');
            resetForm();
            loadStats();
          } else {
            showToast('‚ùå ' + (res.error || 'Save failed'), 'error');
          }
        })
        .withFailureHandler(e => {
          showLoading(false);
          showToast('‚ùå Server error during save: ' + (e.message || 'Unknown error'), 'error');
          console.error('Save error:', e);
        })
        .addOutreachComplete(formData);
    }

    function resetForm() {
      document.getElementById('companyInput').value = '';
      document.getElementById('notes').value = '';
      document.querySelectorAll('.outcome-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('workflowDisplay').style.display = 'none';

      // Reset other form elements to ensure no white text issues
      const formInputs = document.querySelectorAll('.form-input, .form-select, .form-textarea');
      formInputs.forEach(input => {
        input.style.color = '';
        input.style.backgroundColor = '';
      });
    }

    function handleDuplicateCheck(result) {
      const company = document.getElementById('companyInput').value.trim();
      const outreachId = document.getElementById('outreachId').value.trim();

      if (result.success && result.isDuplicate) {
        showLoading(false);
        const message = `‚ö†Ô∏è Duplicate Outreach ID: ${outreachId}\n\n` +
          `Already exists for: ${result.existingCompany || 'Unknown'}\n` +
          `Do you want to save anyway?`;

        if (confirm(message)) {
          proceedWithSave(company, outreachId);
        }
      } else {
        proceedWithSave(company, outreachId);
      }
    }

    function handleDuplicateCheckError(error) {
      console.warn('Duplicate check failed, proceeding anyway:', error);
      const company = document.getElementById('companyInput').value.trim();
      const outreachId = document.getElementById('outreachId').value.trim();

      showLoading(false);
      if (confirm('‚ö†Ô∏è Could not verify Outreach ID uniqueness.\n\nSave anyway?')) {
        proceedWithSave(company, outreachId);
      }
    }

    function proceedWithSave(company, outreachId) {
      const data = {
        company: company,
        companyName: company,
        outcome: state.selectedOutcome, // NEW: Pass the Outcome
        stage: state.selectedStage,     // NEW: Pass the Stage
        status: state.selectedStatus,   // NEW: Pass the Status
        notes: document.getElementById('notes').value,
        nextVisitDate: document.getElementById('nextDate').value,
        activityType: document.getElementById('activityType').value
      };

      if (outreachId) {
        data.outreachId = outreachId;
      }

      if (state.selectedCompanyData && state.selectedCompanyData.companyId) {
        data.companyId = state.selectedCompanyData.companyId;
      }

      // Collect new company details for prospect creation
      const newCompanyFields = document.getElementById('newCompanyFields');
      if (newCompanyFields && newCompanyFields.style.display !== 'none') {
        // Only collect new company data if the section is expanded
        data.newCompanyData = {
          address: document.getElementById('newAddress').value,
          city: document.getElementById('newCity').value,
          state: document.getElementById('newState').value,
          zip: document.getElementById('newZip').value,
          industry: document.getElementById('newIndustry').value,
          contactName: document.getElementById('newContact').value,
          phone: document.getElementById('newPhone').value,
          email: document.getElementById('newEmail').value,
          competitor: document.getElementById('competitor').value
        };
      }

      if (state.selectedOutcome === 'Account Won') {
        data.contact = document.getElementById('newContact').value;
        data.phone = document.getElementById('newPhone').value;
        data.site = document.getElementById('newAddress').value;
      }

      showLoading(true);

      google.script.run
        .withSuccessHandler(handleSaveSuccess)
        .withFailureHandler(handleSaveError)
        .addOutreachComplete(data);
    }
  </script>
</body>

</html>


[FILE_END: dashboard.html]
################################################################################

================================================================================
FILE_BEGIN: dateRangeReport.html
METADATA: Size=5402 bytes | Last_Modified=2026-02-05 14:37:16.025731
================================================================================
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #666;
      margin-bottom: 5px;
      text-transform: uppercase;
    }
    input[type="date"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .btn {
      width: 100%;
      padding: 12px;
      background: #0F2537;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }
    .btn:hover {
      background: #1a3a52;
    }
    .quick-options {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .quick-btn {
      flex: 1;
      padding: 8px;
      background: #e0e0e0;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
    }
    .quick-btn:hover {
      background: #d0d0d0;
    }
    #reportOutput {
      display: none;
      margin-top: 20px;
    }
    #reportText {
      width: 100%;
      height: 300px;
      font-family: monospace;
      font-size: 11px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }
    .copy-btn {
      width: 100%;
      padding: 10px;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="inputForm">
    <h3 style="margin-top: 0; color: #0F2537;">Generate Date Range Report</h3>
    
    <div class="quick-options">
      <button class="quick-btn" onclick="setThisWeek()">This Week</button>
      <button class="quick-btn" onclick="setThisMonth()">This Month</button>
      <button class="quick-btn" onclick="setLast7Days()">Last 7 Days</button>
      <button class="quick-btn" onclick="setLast30Days()">Last 30 Days</button>
    </div>
    
    <div class="form-group">
      <label for="startDate">Start Date</label>
      <input type="date" id="startDate">
    </div>
    
    <div class="form-group">
      <label for="endDate">End Date</label>
      <input type="date" id="endDate">
    </div>
    
    <button class="btn" onclick="generateReport()">Generate Report</button>
  </div>
  
  <div id="reportOutput">
    <button class="copy-btn" onclick="copyReport()">üìã Copy to Clipboard</button>
    <textarea id="reportText" readonly></textarea>
  </div>
  
  <script>
    // Set default dates to this week
    function setThisWeek() {
      var today = new Date();
      var startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - today.getDay());
      
      document.getElementById('startDate').value = formatDate(startOfWeek);
      document.getElementById('endDate').value = formatDate(today);
    }
    
    function setThisMonth() {
      var today = new Date();
      var startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      
      document.getElementById('startDate').value = formatDate(startOfMonth);
      document.getElementById('endDate').value = formatDate(today);
    }
    
    function setLast7Days() {
      var today = new Date();
      var sevenDaysAgo = new Date(today);
      sevenDaysAgo.setDate(today.getDate() - 7);
      
      document.getElementById('startDate').value = formatDate(sevenDaysAgo);
      document.getElementById('endDate').value = formatDate(today);
    }
    
    function setLast30Days() {
      var today = new Date();
      var thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 30);
      
      document.getElementById('startDate').value = formatDate(thirtyDaysAgo);
      document.getElementById('endDate').value = formatDate(today);
    }
    
    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }
    
    function generateReport() {
      var startDate = document.getElementById('startDate').value;
      var endDate = document.getElementById('endDate').value;
      
      if (!startDate || !endDate) {
        alert('Please select both start and end dates.');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(report) {
          document.getElementById('reportText').value = report;
          document.getElementById('inputForm').style.display = 'none';
          document.getElementById('reportOutput').style.display = 'block';
        })
        .withFailureHandler(function(error) {
          alert('Error: ' + error.message);
        })
        .generatePlainTextReportForRange(startDate, endDate);
    }
    
    function copyReport() {
      var textarea = document.getElementById('reportText');
      textarea.select();
      document.execCommand('copy');
      alert('Report copied to clipboard!');
    }
    
    // Initialize with this week
    setThisWeek();
  </script>
</body>
</html>


[FILE_END: dateRangeReport.html]
################################################################################

================================================================================
FILE_BEGIN: report.html
METADATA: Size=15016 bytes | Last_Modified=2026-02-06 15:23:22.659470
================================================================================
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K&L Daily Operations Report</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 15px; color: #333; }
        .app-header { background: #1a472a; color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .app-title { font-size: 24px; font-weight: bold; }
        .app-meta { font-size: 14px; opacity: 0.9; margin-top: 5px; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .kpi-box { background: white; padding: 15px; border-radius: 10px; text-align: center; border-bottom: 4px solid #ddd; }
        .kpi-val { font-size: 22px; font-weight: bold; display: block; }
        .kpi-label { font-size: 12px; text-transform: uppercase; color: #666; }
        
        .visit-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 8px solid #ccc; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .company-name { font-weight: bold; font-size: 18px; color: #1a472a; }
        
        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .visit-card.won { border-left-color: #27ae60; } .status-won { background: #eafaf1; color: #27ae60; }
        .visit-card.hot { border-left-color: #e67e22; } .status-hot { background: #fdf5e6; color: #e67e22; }
        .visit-card.warm { border-left-color: #3498db; } .status-warm { background: #ebf5fb; color: #3498db; }
        .visit-card.cold { border-left-color: #95a5a6; } .status-cold { background: #f2f4f4; color: #95a5a6; }
        
        .section-label { font-size: 11px; text-transform: uppercase; color: #999; margin-top: 10px; font-weight: bold; }
        .notes-text { font-size: 14px; line-height: 1.4; margin-top: 4px; color: #444; }
        .action-box { background: #f9f9f9; padding: 8px; border-radius: 6px; margin-top: 5px; border: 1px dashed #ddd; }
        .action-text { font-size: 13px; color: #2c3e50; font-style: italic; }

        .export-section { margin-top: 30px; text-align: center; padding-bottom: 50px; }
        .export-btn { background: #1a472a; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .csv-data { display: none; text-align: left; background: #222; color: #0f0; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 11px; overflow-x: auto; margin-top: 15px; white-space: pre; }
    </style>
    <script>
        function toggleCSV() {
            var x = document.getElementById("csvData");
            x.style.display = (x.style.display === "none" || x.style.display === "") ? "block" : "none";
        }
    </script>
</head>
<body>

<div class="app-header">
    <div class="app-title">‚ôªÔ∏è K&L Daily Report</div>
    <div class="app-meta">üìÖ 2026-02-06 ‚Ä¢ üë§ Kyle Buzbee</div>
</div>

<div class="kpi-grid">
    <div class="kpi-box" style="border-bottom-color: #3498db;"><span class="kpi-val">11</span><span class="kpi-label">Total Visits</span></div>
    <div class="kpi-box" style="border-bottom-color: #27ae60;"><span class="kpi-val">1</span><span class="kpi-label">Wins</span></div>
    <div class="kpi-box" style="border-bottom-color: #e67e22;"><span class="kpi-val">0</span><span class="kpi-label">Hot Leads</span></div>
    <div class="kpi-box" style="border-bottom-color: #95a5a6;"><span class="kpi-val">2</span><span class="kpi-label">Cold/DQ</span></div>
</div>

<div class="visit-card cold">
    <div class="card-header">
        <div class="company-name">Calibur Collision</div>
        <span class="status-pill status-cold">‚ùÑÔ∏è Not Interested</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Was not able to speak to anyone who could do anything, but I did get his card and so I will send them an email today.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">Try again</div></div>
    </div>
</div>

<div class="visit-card warm">
    <div class="card-header">
        <div class="company-name">Joe Hudson</div>
        <span class="status-pill status-warm">‚è≥ Follow-Up</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">They are being bought out by Gerber and are going to let me know once everything is finalized if they want to continue doing what they have been doing or switch to something new</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">Check periodic</div></div>
    </div>
</div>

<div class="visit-card warm">
    <div class="card-header">
        <div class="company-name">Cox Construction</div>
        <span class="status-pill status-warm">‚è≥ Follow-Up</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Spoke to Joey and because Waskom is about 70 miles from Madfos, Corey told me to charge a $125 dump fee. He said that it was fine and so we will get it delivered as soon as one is available.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">See Notes</div></div>
    </div>
</div>

<div class="visit-card warm">
    <div class="card-header">
        <div class="company-name">TDI Air Condition</div>
        <span class="status-pill status-warm">‚è≥ Follow-Up</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Talked to the receptionist and was not able to talk to a manager or anything because they were all on service calls, but I did get his card so I will send him an email first thing in the morning.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">Try again</div></div>
    </div>
</div>

<div class="visit-card cold">
    <div class="card-header">
        <div class="company-name">Barbin Fence Inc</div>
        <span class="status-pill status-cold">üö´ Disqualified</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Only has enough scrap to fill a trailer and take it to the scrap yard about twice a year so I have disqualified them as a prospect.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">See Notes</div></div>
    </div>
</div>

<div class="visit-card cold">
    <div class="card-header">
        <div class="company-name">Champion Fence</div>
        <span class="status-pill status-cold">üö´ Disqualified</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Reached out via email letting them know that I am interested in buying their metal. They are currently with Athens Iron and Metal so we will see.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">Try again</div></div>
    </div>
</div>

<div class="visit-card won">
    <div class="card-header">
        <div class="company-name">Glenwood Blind & Awning</div>
        <span class="status-pill status-won">üèÜ Account Won</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Visited him this morning and won the account and he is wanting a 30 yard container, but might switch to a 20 yard container if needed. Pricing is as follows: "AL 5052: $1.50 (Clean) / $1.40 (Painted) AL 6063: $1.10 (Clean) / $1.00 (Painted) Siding: $0.68 | Break: $0.10"</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">Onboard Account</div></div>
    </div>
</div>

<div class="visit-card warm">
    <div class="card-header">
        <div class="company-name">Dealer's Collision</div>
        <span class="status-pill status-warm">‚è≥ Follow-Up</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Sent Dealer's Collision an email touching base about my interest in getting them a roll-off container.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">General follow</div></div>
    </div>
</div>

<div class="visit-card warm">
    <div class="card-header">
        <div class="company-name">One-Ten Welding</div>
        <span class="status-pill status-warm">‚è≥ Follow-Up</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Sent One-Ten Welding an email to see if he had a chance to look at the agreement I gave him.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">General follow</div></div>
    </div>
</div>

<div class="visit-card warm">
    <div class="card-header">
        <div class="company-name">Rub-A-Dub Plumbing</div>
        <span class="status-pill status-warm">‚è≥ Follow-Up</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Sent Ashley an email letting her know that we can drop off a container at one of their project sites since the last time I talked to her she said that they had several big jobs coming up.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">General follow</div></div>
    </div>
</div>

<div class="visit-card warm">
    <div class="card-header">
        <div class="company-name">Holliday Sheet Metal</div>
        <span class="status-pill status-warm">‚è≥ Follow-Up</span>
    </div>
    <div class="card-body">
        <div class="section-label">Visit Notes</div>
        <div class="notes-text">Sent him an email even though he rushed m out the last time I was there and did not respond to my previous email. I am hoping to get a response because they do produce a fair amount of scrap metal.</div>
        <div class="section-label">Follow-Up Action</div>
        <div class="action-box"><div class="action-text">General follow</div></div>
    </div>
</div>

<div class="export-section">
    <div class="section-label">Export CRM Data</div>
    <button class="export-btn" onclick="toggleCSV()">üì• Show CSV Export</button>
    <pre class="csv-data" id="csvData">outreachID,companyID,company,visitDate,notes,outcome,stage,status,nextVisitDate,daysSinceLastVisit,nextVisitCountdown,outcomeCategory,followUpAction,owner,prospectsMatch,contactType,emailSent,competitor
LID-001,CID-CAL001,Calibur Collision,2026-02-06,"Was not able to speak to anyone who could do anything, but I did get his card and so I will send them an email today.",Not Interested,Lost,Disqualified,2026-08-05,,,Negative,Try again,Kyle Buzbee,,Visit,FALSE,None
LID-002,CID-JOE001,Joe Hudson,2026-02-06,"They are being bought out by Gerber and are going to let me know once everything is finalized if they want to continue doing what they have been doing or switch to something new",Follow-Up,Nurture,Interested (Warm),2026-02-20,,,Neutral,Check periodic,Kyle Buzbee,,Visit,FALSE,None
LID-003,CID-COX001,Cox Construction,2026-02-06,"Spoke to Joey and because Waskom is about 70 miles from Madfos, Corey told me to charge a $125 dump fee. He said that it was fine and so we will get it delivered as soon as one is available.",Follow-Up,Nurture,Interested (Warm),2026-02-20,,,Neutral,See Notes,Kyle Buzbee,,Visit,FALSE,None
LID-004,CID-TDI001,TDI Air Condition,2026-02-06,"Talked to the receptionist and was not able to talk to a manager or anything because they were all on service calls, but I did get his card so I will send him an email first thing in the morning.",Follow-Up,Nurture,Interested (Warm),2026-02-20,,,Neutral,Try again,Kyle Buzbee,,Visit,FALSE,None
LID-005,CID-BAR001,Barbin Fence Inc,2026-02-06,"Only has enough scrap to fill a trailer and take it to the scrap yard about twice a year so I have disqualified them as a prospect.",Disqualified,Lost,Disqualified,2026-02-06,,,Negative,See Notes,Kyle Buzbee,,Visit,FALSE,None
LID-006,CID-CHA001,Champion Fence,2026-02-06,"Reached out via email letting them know that I am interested in buying their metal. They are currently with Athens Iron and Metal so we will see.",Disqualified,Lost,Disqualified,2026-02-06,,,Negative,Try again,Kyle Buzbee,,Visit,FALSE,AIM
LID-007,CID-GLE001,Glenwood Blind & Awning,2026-02-06,"Visited him this morning and won the account and he is wanting a 30 yard container, but might switch to a 20 yard container if needed. Pricing is as follows: ""AL 5052: $1.50 (Clean) / $1.40 (Painted) AL 6063: $1.10 (Clean) / $1.00 (Painted) Siding: $0.68 | Break: $0.10""",Account Won,Won,Active,2026-02-07,,,Positive,Onboard Account,Kyle Buzbee,,Visit,FALSE,None
LID-008,CID-DEA001,Dealer's Collision,2026-02-06,"Sent Dealer's Collision an email touching base about my interest in getting them a roll-off container.",Follow-Up,Nurture,Interested (Warm),2026-02-20,,,Neutral,General follow,Kyle Buzbee,,Visit,FALSE,None
LID-009,CID-ONE001,One-Ten Welding,2026-02-06,"Sent One-Ten Welding an email to see if he had a chance to look at the agreement I gave him.",Follow-Up,Nurture,Interested (Warm),2026-02-20,,,Neutral,General follow,Kyle Buzbee,,Visit,FALSE,None
LID-010,CID-RUB001,Rub-A-Dub Plumbing,2026-02-06,"Sent Ashley an email letting her know that we can drop off a container at one of their project sites since the last time I talked to her she said that they had several big jobs coming up.",Follow-Up,Nurture,Interested (Warm),2026-02-20,,,Neutral,General follow,Kyle Buzbee,,Visit,FALSE,None
LID-011,CID-HOL001,Holliday Sheet Metal,2026-02-06,"Sent him an email even though he rushed m out the last time I was there and did not respond to my previous email. I am hoping to get a response because they do produce a fair amount of scrap metal.",Follow-Up,Nurture,Interested (Warm),2026-02-20,,,Neutral,General follow,Kyle Buzbee,,Visit,FALSE,None</pre>
</div>

</body>
</html>

[FILE_END: report.html]
################################################################################

================================================================================
FILE_BEGIN: reports\CRM_BLUEPRINT_REPORT.html
METADATA: Size=46704 bytes | Last_Modified=2026-02-07 00:34:33.945554
================================================================================
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K&L CRM - Blueprint & Health Report</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .health-score {
            display: inline-block;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(#dc3545 0.0deg, #e0e0e0 0deg);
            position: relative;
            margin: 20px auto;
        }
        .health-score::before {
            content: '0';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            font-weight: bold;
            color: #333;
        }
        .content { padding: 40px; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-number { font-size: 2.5em; font-weight: bold; }
        .stat-label { opacity: 0.9; margin-top: 5px; }
        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .section h2 {
            color: #1e3c72;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .issue-card {
            background: white;
            border-left: 5px solid #dc3545;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .issue-card.critical { border-left-color: #dc3545; }
        .issue-card.high { border-left-color: #fd7e14; }
        .issue-card.medium { border-left-color: #ffc107; }
        .issue-card.low { border-left-color: #17a2b8; }
        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .issue-severity {
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }
        .issue-location {
            color: #666;
            font-family: monospace;
            margin-bottom: 10px;
        }
        .issue-message { color: #333; margin-bottom: 10px; }
        .issue-recommendation {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            color: #1565c0;
            font-size: 0.9em;
        }
        .file-tree {
            background: white;
            border-radius: 10px;
            padding: 20px;
        }
        .file-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-item:hover { background: #f5f5f5; }
        .file-name { font-family: monospace; color: #333; }
        .file-stats { color: #666; font-size: 0.9em; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @media print {
            body { background: white; }
            .container { box-shadow: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ K&L Recycling CRM</h1>
            <p>Comprehensive Blueprint & Health Analysis Report</p>
            <p>Generated: 2026-02-07 00:34:33</p>
            <div class="health-score"></div>
            <p>Overall Health Score</p>
        </div>
        
        <div class="content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">53</div>
                    <div class="stat-label">Files Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">428</div>
                    <div class="stat-label">Functions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">25,870</div>
                    <div class="stat-label">Lines of Code</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">376</div>
                    <div class="stat-label">Issues Found</div>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('issues')">üö® Issues</div>
                <div class="tab" onclick="showTab('files')">üìÅ Files</div>
                <div class="tab" onclick="showTab('architecture')">üèóÔ∏è Architecture</div>
            </div>
            
            <div id="issues" class="tab-content active">
                <div class="section">
                    <h2>üö® Issues by Severity</h2>
<h3 style="color: #fd7e14; margin: 20px 0 15px;">HIGH (39)</h3>
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:144</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:145</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:146</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:159</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:168</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:175</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:180</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:187</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:205</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    
                    <div class="issue-card high">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #fd7e14;">HIGH</span>
                            <span>üîí Security</span>
                        </div>
                        <div class="issue-location">üìÑ CRM_Suite.html:209</div>
                        <div class="issue-message">innerHTML can lead to XSS vulnerabilities</div>
                        <div class="issue-recommendation">üí° Review and use safer alternatives</div>
                    </div>
                    <p style="text-align: center; color: #666; margin-top: 15px;">... and 29 more HIGH issues</p><h3 style="color: #ffc107; margin: 20px 0 15px;">MEDIUM (204)</h3>
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:30</div>
                        <div class="issue-message">Potential schema typo: 'mailing location' is similar to 'mailingLocation'</div>
                        <div class="issue-recommendation">üí° Verify if 'mailing location' should be 'mailingLocation'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:32</div>
                        <div class="issue-message">Potential schema typo: 'handling of metal' is similar to 'Handling of Metal'</div>
                        <div class="issue-recommendation">üí° Verify if 'handling of metal' should be 'Handling of Metal'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:61</div>
                        <div class="issue-message">Potential schema typo: 'Accounts' is similar to 'Account'</div>
                        <div class="issue-recommendation">üí° Verify if 'Accounts' should be 'Account'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:65</div>
                        <div class="issue-message">Potential schema typo: 'Company name' is similar to 'Company Name'</div>
                        <div class="issue-recommendation">üí° Verify if 'Company name' should be 'Company Name'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:96</div>
                        <div class="issue-message">Potential schema typo: 'Company name' is similar to 'Company Name'</div>
                        <div class="issue-recommendation">üí° Verify if 'Company name' should be 'Company Name'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:106</div>
                        <div class="issue-message">Potential schema typo: 'Company name' is similar to 'Company Name'</div>
                        <div class="issue-recommendation">üí° Verify if 'Company name' should be 'Company Name'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:188</div>
                        <div class="issue-message">Potential schema typo: 'Accounts' is similar to 'Account'</div>
                        <div class="issue-recommendation">üí° Verify if 'Accounts' should be 'Account'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ AccountFunction.js:192</div>
                        <div class="issue-message">Potential schema typo: 'Company name' is similar to 'Company Name'</div>
                        <div class="issue-recommendation">üí° Verify if 'Company name' should be 'Company Name'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:33</div>
                        <div class="issue-message">Potential schema typo: 'contact status' is similar to 'contactStatus'</div>
                        <div class="issue-recommendation">üí° Verify if 'contact status' should be 'contactStatus'</div>
                    </div>
                    
                    <div class="issue-card medium">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #ffc107;">MEDIUM</span>
                            <span>üìä Schema</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:34</div>
                        <div class="issue-message">Potential schema typo: 'close probability' is similar to 'closeProbability'</div>
                        <div class="issue-recommendation">üí° Verify if 'close probability' should be 'closeProbability'</div>
                    </div>
                    <p style="text-align: center; color: #666; margin-top: 15px;">... and 194 more MEDIUM issues</p><h3 style="color: #17a2b8; margin: 20px 0 15px;">LOW (130)</h3>
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:19</div>
                        <div class="issue-message">Function 'generateProspect' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:49</div>
                        <div class="issue-message">Function 'generateOutreach' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:78</div>
                        <div class="issue-message">Function 'generateAccount' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ apply-fixes.js:602</div>
                        <div class="issue-message">Function 'standardizeDateHandling' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ AutoFillService.js:7</div>
                        <div class="issue-message">Function 'runMasterAutofill' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ AutoFillService.js:20</div>
                        <div class="issue-message">Function 'autofillProspects' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ AutoFillService.js:54</div>
                        <div class="issue-message">Function 'autofillOutreach' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ BusinessValidation.js:134</div>
                        <div class="issue-message">Function 'validateProspect' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ BusinessValidation.js:294</div>
                        <div class="issue-message">Function 'validateOutreach' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    
                    <div class="issue-card low">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #17a2b8;">LOW</span>
                            <span>‚ú® Code Quality</span>
                        </div>
                        <div class="issue-location">üìÑ BusinessValidation.js:422</div>
                        <div class="issue-message">Function 'validateNewAccount' has no logging</div>
                        <div class="issue-recommendation">üí° Add console.log or Logger.log for debugging</div>
                    </div>
                    <p style="text-align: center; color: #666; margin-top: 15px;">... and 120 more LOW issues</p><h3 style="color: #6c757d; margin: 20px 0 15px;">INFO (3)</h3>
                    <div class="issue-card info">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #6c757d;">INFO</span>
                            <span>‚ö° Performance</span>
                        </div>
                        <div class="issue-location">üìÑ ErrorHandling.js:180</div>
                        <div class="issue-message">SpreadsheetApp.flush() can impact performance</div>
                        <div class="issue-recommendation">üí° Consider using batch operations or caching</div>
                    </div>
                    
                    <div class="issue-card info">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #6c757d;">INFO</span>
                            <span>‚ö° Performance</span>
                        </div>
                        <div class="issue-location">üìÑ PerformanceUtils.js:92</div>
                        <div class="issue-message">SpreadsheetApp.flush() can impact performance</div>
                        <div class="issue-recommendation">üí° Consider using batch operations or caching</div>
                    </div>
                    
                    <div class="issue-card info">
                        <div class="issue-header">
                            <span class="issue-severity" style="background: #6c757d;">INFO</span>
                            <span>‚ö° Performance</span>
                        </div>
                        <div class="issue-location">üìÑ PerformanceUtils.js:779</div>
                        <div class="issue-message">SpreadsheetApp.flush() can impact performance</div>
                        <div class="issue-recommendation">üí° Consider using batch operations or caching</div>
                    </div>
                    
                </div>
            </div>
            
            <div id="files" class="tab-content">
                <div class="section">
                    <h2>üìÅ File Analysis</h2>
                    <div class="file-tree">
<h3 style="margin: 20px 0 10px; color: #1e3c72;">üì¶ Core Services</h3>
                        <div class="file-item">
                            <span class="file-name">CRM_API.js</span>
                            <span class="file-stats">8 lines | 0 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">Config.js</span>
                            <span class="file-stats">150 lines | 2 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">MenuFunctions.js</span>
                            <span class="file-stats">41 lines | 2 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">Settings.js</span>
                            <span class="file-stats">177 lines | 3 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">üé® UI Components</h3>
                        <div class="file-item">
                            <span class="file-name">CRM_BLUEPRINT_REPORT.html</span>
                            <span class="file-stats">852 lines | 1 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">CRM_Styles.html</span>
                            <span class="file-stats">927 lines | 0 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">CRM_Suite.html</span>
                            <span class="file-stats">349 lines | 11 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">DashboardBackend.js</span>
                            <span class="file-stats">82 lines | 2 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ReportFunctions.js</span>
                            <span class="file-stats">1409 lines | 24 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">dashboard.html</span>
                            <span class="file-stats">3619 lines | 59 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">dateRangeReport.html</span>
                            <span class="file-stats">193 lines | 7 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">report.html</span>
                            <span class="file-stats">219 lines | 1 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">üîÑ Sync & Workflow</h3>
                        <div class="file-item">
                            <span class="file-name">OutreachSyncFunctions.js</span>
                            <span class="file-stats">228 lines | 4 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">Sync.js</span>
                            <span class="file-stats">264 lines | 9 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">WorkflowAutomationService.js</span>
                            <span class="file-stats">293 lines | 7 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">‚úÖ Validation</h3>
                        <div class="file-item">
                            <span class="file-name">BusinessValidation.js</span>
                            <span class="file-stats">735 lines | 12 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ComprehensiveValidationSystem.js</span>
                            <span class="file-stats">1660 lines | 29 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">DataValidation.js</span>
                            <span class="file-stats">1834 lines | 32 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">SettingsValidation.js</span>
                            <span class="file-stats">943 lines | 17 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ValidationUtils.js</span>
                            <span class="file-stats">189 lines | 11 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">üß™ Testing</h3>
                        <div class="file-item">
                            <span class="file-name">simple_test.js</span>
                            <span class="file-stats">8 lines | 1 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_autofill_implementation.js</span>
                            <span class="file-stats">79 lines | 2 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_comprehensive_validation.js</span>
                            <span class="file-stats">526 lines | 9 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_fixes.js</span>
                            <span class="file-stats">288 lines | 8 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_integration.js</span>
                            <span class="file-stats">344 lines | 7 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_normalization.js</span>
                            <span class="file-stats">291 lines | 10 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_robust.js</span>
                            <span class="file-stats">658 lines | 25 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_rowindex_fix.js</span>
                            <span class="file-stats">238 lines | 3 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_runner.js</span>
                            <span class="file-stats">757 lines | 22 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_runtime_fixes.js</span>
                            <span class="file-stats">369 lines | 5 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_settings_validation.js</span>
                            <span class="file-stats">221 lines | 8 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">test_unit.js</span>
                            <span class="file-stats">431 lines | 8 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">üîß Utilities</h3>
                        <div class="file-item">
                            <span class="file-name">DataHelpers.js</span>
                            <span class="file-stats">598 lines | 5 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">FuzzyMatchingUtils.js</span>
                            <span class="file-stats">118 lines | 3 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">PerformanceUtils.js</span>
                            <span class="file-stats">789 lines | 26 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">SharedUtils.js</span>
                            <span class="file-stats">559 lines | 16 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">StringUtils.js</span>
                            <span class="file-stats">139 lines | 15 functions</span>
                        </div>
                        <h3 style="margin: 20px 0 10px; color: #1e3c72;">üìÑ Other</h3>
                        <div class="file-item">
                            <span class="file-name">AccountFunction.js</span>
                            <span class="file-stats">278 lines | 3 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">AlertingService.js</span>
                            <span class="file-stats">158 lines | 5 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">AutoFillService.js</span>
                            <span class="file-stats">79 lines | 3 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">CSVImport.js</span>
                            <span class="file-stats">278 lines | 5 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ColumnMapper.js</span>
                            <span class="file-stats">126 lines | 4 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ErrorHandling.js</span>
                            <span class="file-stats">279 lines | 10 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">Normalization.js</span>
                            <span class="file-stats">455 lines | 7 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">OutreachFunctions.js</span>
                            <span class="file-stats">1050 lines | 13 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">PipelineService.js</span>
                            <span class="file-stats">131 lines | 6 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ProspectFunctions.js</span>
                            <span class="file-stats">701 lines | 14 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">ProspectScoringService.js</span>
                            <span class="file-stats">322 lines | 8 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">RouteFunction.js</span>
                            <span class="file-stats">161 lines | 3 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">SetupFunctions.js</span>
                            <span class="file-stats">24 lines | 1 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">SystemAlignment.gs</span>
                            <span class="file-stats">289 lines | 7 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">WebApp.gs</span>
                            <span class="file-stats">105 lines | 4 functions</span>
                        </div>
                        
                        <div class="file-item">
                            <span class="file-name">apply-fixes.js</span>
                            <span class="file-stats">849 lines | 18 functions</span>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <div id="architecture" class="tab-content">
                <div class="section">
                    <h2>üèóÔ∏è System Architecture</h2>
                    <h3 style="margin: 20px 0 10px;">üìä Schema Objects</h3>

                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">Prospects</h4>
                        <p style="color: #666;">36 columns defined</p>
                    </div>
            
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">Outreach</h4>
                        <p style="color: #666;">36 columns defined</p>
                    </div>
            
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">Accounts</h4>
                        <p style="color: #666;">26 columns defined</p>
                    </div>
            
                    <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">Contacts</h4>
                        <p style="color: #666;">16 columns defined</p>
                    </div>
            
                    <h3 style="margin: 30px 0 10px;">üîó External Dependencies</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
<div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">CacheService</div><div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">MailApp</div><div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">ScriptApp</div><div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">SpreadsheetApp</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function showTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }
    </script>
</body>
</html>


[FILE_END: reports\CRM_BLUEPRINT_REPORT.html]
################################################################################
